<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Outils de classe - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        /* ====================== CSS CONFIGURATION ====================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

        :root {
            --bg-page: #121212; --text-page: #ffffff; --column-border: rgba(255, 255, 255, 0.1);
            --header-bg: #1e1e1e; --card-bg: #1e1e1e; --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee; --text-page: #111827; --column-border: #ddd;
            --header-bg: #ffffff; --card-bg: #ffffff; --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-page);
            color: var(--text-page); margin: 0; padding: 0;
            transition: background 0.3s ease;
        }

        /* Header */
        header {
            background: var(--header-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px;
            width: 100%; margin-bottom: 20px;
        }

        #btn-retour, #btn-search-trigger, #btn-aide {
            display: flex; align-items: center; justify-content: center;
            width: 38px; height: 38px; border-radius: 50%; flex-shrink: 0;
            transition: all 0.3s ease; border: none; cursor: pointer;
        }

        header h1 {
            font-size: 1.125rem; font-weight: 900; text-transform: uppercase;
            text-align: center; flex-grow: 1; letter-spacing: 0.1em;
        }

        /* Main Container */
        .main-wrapper {
            width: 100%; max-width: 500px; margin: 0 auto;
            padding: 0 15px 40px 15px; transition: max-width 0.4s ease;
        }

        @media (min-width: 768px) {
            .main-wrapper { max-width: 900px; }
        }

        @media (min-width: 1200px) {
            .main-wrapper { max-width: 1100px; }
        }

        /* Search Bar */
        #searchWrapper {
            max-height: 0; overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s, margin-bottom 0.3s;
            opacity: 0; margin-bottom: 0;
        }

        #searchWrapper.open {
            max-height: 100px; opacity: 1; margin-bottom: 1.5rem;
        }

        .search-container {
            position: relative;
        }

        #searchInput {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border-radius: 12px;
            border: 1px solid var(--column-border);
            background: var(--input-bg);
            color: var(--text-page);
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: all 0.3s ease;
        }

        #searchInput:focus {
            border-color: currentColor;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            pointer-events: none;
        }

        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
            display: none;
            padding: 4px;
            color: var(--text-page);
        }

        .search-clear:hover { opacity: 0.8; }
        .search-clear.visible { display: block; }

        /* Categories Container */
        #categoriesContainer {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Category Section */
        .category-section {
            animation: fadeIn 0.3s ease-out;
            position: relative;
            border-radius: 1.2rem;
            padding: 0 8px 8px 8px;
            background: rgba(128, 128, 128, 0.02);
            border: 0px solid var(--column-border);
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }

        .category-section:hover {
            background: rgba(128, 128, 128, 0.1);
        }

        .category-section.sortable-ghost {
            opacity: 0.5;
            background: rgba(128, 128, 128, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            padding: 0 0px 0px 0px;
            border-bottom: 0px solid var(--column-border);
            position: relative;
            justify-content: space-between;
        }

        .category-drag-handle {
            display: grid;
            grid-template-columns: repeat(3, 2px);
            gap: 2px;
            cursor: grab;
            opacity: 0.2;
            transition: opacity 0.3s;
            padding: 10px 4px;
            margin-right: 0px;
            order: 3;
            flex-shrink: 0;
        }

        .category-drag-handle:hover {
            opacity: 0.6;
        }

        .category-drag-handle:active {
            cursor: grabbing;
            opacity: 1;
        }

        .category-drag-handle span {
            width: 2px;
            height: 2px;
            background-color: var(--text-page);
            border-radius: 50%;
        }

        .category-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .category-title {
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            flex-grow: 1;
        }

        .category-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.2);
            color: currentColor;
            flex-shrink: 0;
        }

        /* Tools Grid */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            width: 100%;
        }

        @media (min-width: 768px) {
            .tools-grid { gap: 20px; }
        }

        @media (min-width: 1200px) {
            .tools-grid { grid-template-columns: repeat(3, 1fr); }
        }

        /* Tool Card */
        .tool-card {
            position: relative;
            background: var(--card-bg);
            border-radius: 1.5rem;
            padding: 10px;
            border: 1px solid var(--column-border);
            box-shadow: var(--shadow-custom);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            color: inherit;
            cursor: pointer;
            outline: 2px solid transparent;
            outline-offset: 2px;
            width: 100%;
            min-width: 0;
            overflow: hidden;
        }

        .tool-card:focus {
            outline-color: currentColor;
        }

        @media (min-width: 768px) {
            .tool-card {
                padding: 20px;
                gap: 12px;
                flex-direction: row;
                text-align: left;
                align-items: flex-start;
            }
            .tool-card:hover {
                transform: translateY(-4px);
                border-color: currentColor;
                background: rgba(128, 128, 128, 0.03);
            }
            .tool-card:hover .icon-box {
                transform: rotate(-5deg) scale(1.1);
            }
        }

        .tool-card:active { transform: scale(0.97); }

        /* Icon Box */
        .category-icon-wrapper {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .icon-box {
            width: 35px; height: 35px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; border: 1px solid var(--column-border);
            background: rgba(128, 128, 128, 0.05);
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .icon-box {
                width: 52px;
                height: 52px;
                font-size: 26px;
            }
        }

        /* Tool Info */
        .tool-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .tool-info h2 {
            font-size: 0.75rem;
            line-height: 1.2;
            margin: 0;
        }

        @media (min-width: 768px) {
            .tool-info h2 { font-size: 0.875rem; }
        }

        .tool-info p {
            font-size: 0.55rem;
            opacity: 0.5;
            margin: 0;
        }

        @media (min-width: 768px) {
            .tool-info p { font-size: 0.625rem; }
        }

        /* No Results */
        .no-results {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.6;
            font-size: 0.875rem;
        }

        .no-results-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        /* Modals */
        .modal-overlay {
            display: none; position: fixed; inset: 0; z-index: 1000;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            align-items: center; justify-content: center; padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg); width: 100%; max-width: 450px;
            border-radius: 1.5rem; border: 1px solid var(--column-border);
            padding: 30px; position: relative;
        }

        .modal-title {
            font-size: 1.125rem; font-weight: 900; text-transform: uppercase;
            margin-bottom: 1rem; margin-top: 0;
        }

        .modal-text {
            font-size: 0.6875rem;
            line-height: 1.5;
            opacity: 0.8;
            font-weight: 600;
        }

        @media (min-width: 768px) {
            .modal-text { font-size: 0.75rem; }
        }

        .modal-text p { margin-bottom: 0.75rem; margin-top: 0; }

        .btn-modal-close {
            width: 100%; padding: 14px; border-radius: 12px;
            font-weight: 900; font-size: 11px; text-transform: uppercase;
            margin-top: 20px; cursor: pointer; border: none;
            transition: transform 0.2s; color: white;
        }

        .btn-modal-close:active { transform: scale(0.95); }
        .btn-modal-close:focus { outline: 2px solid currentColor; outline-offset: 2px; }
    </style>
</head>
<body>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
</script>

<!-- ====================== HEADER ====================== -->
<header>
    <a href="index.html" id="btn-retour" aria-label="Retourner √† l'accueil">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1 id="pageTitle">Outils</h1>
    <div class="flex gap-1">
        <button id="btn-search-trigger" onclick="toggleSearch()" aria-label="Ouvrir la recherche">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        </button>
        <button id="btn-aide" onclick="ouvrirAide()" class="text-lg" aria-label="Ouvrir l'aide">üí°</button>
    </div>
</header>

<!-- ====================== MAIN CONTENT ====================== -->
<div class="main-wrapper">
    <!-- Search Bar (Hidden by default) -->
    <div id="searchWrapper">
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input
                type="text"
                id="searchInput"
                placeholder="Rechercher un outil..."
                aria-label="Rechercher parmi les outils"
                autocomplete="off"
            >
            <button class="search-clear" id="clearSearch" aria-label="Effacer la recherche">‚úï</button>
        </div>
    </div>

    <!-- Tools by Category -->
    <div id="categoriesContainer"></div>

    <!-- No Results -->
    <div id="noResults" class="no-results" style="display: none;">
        <div class="no-results-icon">üîç</div>
        <p>Aucun outil ne correspond √† votre recherche</p>
    </div>
</div>

<!-- ====================== HELP MODAL ====================== -->
<div id="modal-aide" class="modal-overlay" onclick="fermerAide()" role="dialog" aria-modal="true">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide" class="modal-title">üí° Aide</h2>
        <div id="aide-content" class="modal-text space-y-3"></div>
        <button id="btn-fermer-aide" onclick="fermerAide()" class="btn-modal-close">Compris</button>
    </div>
</div>

<script>
    // ====================== CONFIGURATION & CONSTANTS ======================
    const COLOR_MAP = {
        'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
        'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
        'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
        'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
        'rose': '#f43f5e'
    };

    const STORAGE_KEYS = {
        theme: 'theme_tuiles',
        themeMode: 'theme_mode',
        toolOrder: 'outils_order',
        categoryOrder: 'outils_category_order'
    };

    const CATEGORIES = {
        ambiance: {
            icon: 'üòå',
            name: 'Ambiance de Classe',
            color: '#000000'
        },
        organisation: {
            icon: 'üè´',
            name: 'Organisation',
            color: '#000000'
        },
        edition: {
            icon: 'üìú',
            name: '√âdition & Documents',
            color: '#000000'
        }
    };

    const TOOLS = [
        {
            id: 'bruit',
            href: 'outils_bruit.html',
            icon: 'üîä',
            title: 'Radar de bruit',
            description: 'Visualiser le bruit en classe',
            category: 'ambiance'
        },
        {
            id: 'deficalme',
            href: 'outils_deficalme.html',
            icon: 'ü§´',
            title: 'D√©fi calme',
            description: 'Et l\'image appara√Æt...',
            category: 'ambiance'
        },
        {
            id: 'feux',
            href: 'outils_feux.html',
            icon: 'üö¶',
            title: 'Feux tricolores',
            description: 'Mode de travail',
            category: 'ambiance'
        },
		{
			id: 'pausecalme',
			href: 'outils_pausecalme.html',
			icon: 'üßò',
			title: 'Pause Calme',
			description: 'Exercices de respiration guid√©e',
			category: 'ambiance'
		},
		{
            id: 'sondage',
            href: 'outils_sondage.html',
            icon: 'üìä',
            title: 'Sondage Express',
            description: 'Prendre le pouls de la classe',
            category: 'organisation'
        },
        {
            id: 'plan',
            href: 'outils_plan.html',
            icon: 'ü™ë',
            title: 'Plan de classe',
            description: 'Placer les √©l√®ves en un clic',
            category: 'organisation'
        },
        {
            id: 'structure',
            href: 'outils_structure_ecole.html',
            icon: 'üè´',
            title: 'Structure √âcole',
            description: 'R√©partition et effectifs',
            category: 'organisation'
        },
		{
            id: 'ephemeride',
            href: 'outils_ephemeride.html',
            icon: 'üìÖ',
            title: '√âph√©m√©ride',
            description: 'Date, f√™te et rituel du jour',
            category: 'organisation'
        },
		{
            id: 'timer',
            href: 'outils_timer.html',
            icon: '‚è±Ô∏è',
            title: 'Minuteur & Chrono',
            description: 'G√©rer le temps des activit√©s',
            category: 'organisation'
        },
		{
            id: 'tirage',
            href: 'outils_tirage.html',
            icon: 'üé≤',
            title: 'Tirage au sort',
            description: 'Tirer un pr√©nom au hasard',
            category: 'organisation'
        },
		{
            id: 'equipes',
            href: 'outils_equipes.html',
            icon: 'üë•',
            title: '√âquipes',
            description: 'G√©n√©rer des groupes √©quilibr√©s',
            category: 'organisation'
        },
        {
            id: 'edition',
            href: 'outils_edition.html',
            icon: 'üìÑ',
            title: 'Module √âdition',
            description: 'Listes, √©tiquettes et suivis',
            category: 'edition'
        },
        {
            id: 'motsfamilles',
            href: 'outils_mots_familles.html',
            icon: '‚úíÔ∏è',
            title: 'Mots aux familles',
            description: 'G√©n√©rer des billets de liaison',
            category: 'edition'
        },
        {
            id: 'qrcodes',
            href: 'outils_qrcodes.html',
            icon: 'üì±',
            title: 'QR-Planches',
            description: 'G√©n√©rer des planches de QR Codes',
            category: 'edition'
        },
    ];

    const HELP_CONTENT = [
        'Cette section regroupe des utilitaires class√©s par th√©matiques pour faciliter la gestion de votre classe :',
        '<br><strong>ü§´ AMBIANCE DE CLASSE</strong>',
        '‚Ä¢ <strong>Niveau Sonore</strong> : Pour r√©guler le volume sonore durant les ateliers.',
        '‚Ä¢ <strong>D√©fi calme</strong> : Encourage le silence pour faire appara√Ætre une image myst√®re.',
		'‚Ä¢ <strong>Pause Calme</strong> : Des exercices de respiration pour apaiser le groupe.',
        '‚Ä¢ <strong>Feux tricolores</strong> : Indique visuellement le mode de travail autoris√©.',
		'<br><strong>üè´ ORGANISATION</strong>',
        '‚Ä¢ <strong>Plan de classe</strong> : Pour placer vos √©l√®ves et m√©moriser les pr√©noms.',
        '‚Ä¢ <strong>Structure √âcole</strong> : Pour simuler et √©quilibrer la r√©partition des effectifs.',
        '‚Ä¢ <strong>√âph√©m√©ride</strong> : La date, le saint du jour et un rituel matinal.',
		'‚Ä¢ <strong>Sondage Express</strong> : Recueillir l\'avis des √©l√®ves en temps r√©el.',
		'‚Ä¢ <strong>Minuteur et timer</strong> : Pour rythmer les s√©ances, les activit√©s et les transitions.',
		'‚Ä¢ <strong>Tirage</strong> : D√©cochez les √©l√®ves absents puis tirez un pr√©nom d\'√©l√®ve au hasard parmi les pr√©sents.',
		'‚Ä¢ <strong>√âquipes</strong> : D√©cochez les √©l√®ves absents et g√©n√©rez des groupes mixtes et √©quilibr√©s par genre et par niveau automatiquement.',
        '<br><strong>üìú √âDITION & DOCUMENTS</strong>',
        '‚Ä¢ <strong>Module √âdition</strong> : G√©n√®re vos listes, √©tiquettes et fiches de suivi en PDF.',
        '‚Ä¢ <strong>Mots aux familles</strong> : Cr√©e des billets de liaison (Rdv, info) pr√™ts √† imprimer (10 par page).',
        '‚Ä¢ <strong>QR-Planches</strong> : Cr√©e des s√©ries de QR Codes identiques avec l√©gendes pour vos documents.',
    ];

    // ====================== UTILITY FUNCTIONS ======================
    function isDarkText(colorName) {
        return ['yellow', 'lime', 'amber', 'cyan'].includes(colorName);
    }

    function normalizeSearchText(text) {
        return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function toolMatchesSearch(tool, searchTerm) {
        const normalized = normalizeSearchText(searchTerm);
        return normalizeSearchText(tool.title).includes(normalized) ||
               normalizeSearchText(tool.description).includes(normalized) ||
               normalizeSearchText(tool.category).includes(normalized);
    }

    function getOrderedCategories() {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEYS.categoryOrder));
        if (saved) return saved;
        return Object.keys(CATEGORIES);
    }

    // ====================== RENDER TOOLS ======================
    function renderTools(searchTerm = '') {
        const container = document.getElementById('categoriesContainer');
        const noResults = document.getElementById('noResults');
        container.innerHTML = '';

        let totalVisibleTools = 0;

        // Group tools by category
        const toolsByCategory = {};
        Object.keys(CATEGORIES).forEach(catKey => {
            toolsByCategory[catKey] = [];
        });

        TOOLS.forEach(tool => {
            if (!searchTerm || toolMatchesSearch(tool, searchTerm)) {
                toolsByCategory[tool.category].push(tool);
                totalVisibleTools++;
            }
        });

        // Get ordered categories
        const orderedCategories = getOrderedCategories();

        // Render each category with tools
        orderedCategories.forEach(catKey => {
            if (!CATEGORIES[catKey]) return;

            const catData = CATEGORIES[catKey];
            const tools = toolsByCategory[catKey];
            if (tools.length === 0) return;

            const section = document.createElement('div');
            section.className = 'category-section';
            section.setAttribute('data-category', catKey);

            // Category header with drag handle
            const header = document.createElement('div');
            header.className = 'category-header';
            header.style.borderBottomColor = catData.color + '40';
            header.innerHTML = `
                <div class="category-drag-handle" title="Maintenez pour r√©organiser les cat√©gories">
                    <span></span><span></span><span></span>
                    <span></span><span></span><span></span>
                    <span></span><span></span><span></span>
                </div>
                <div class="category-icon-wrapper" data-category-circle="${catKey}">
                    ${catData.icon}
                </div>
                <h2 class="category-title" style="margin-left: 8px;">${catData.name}</h2>
            `;
            section.appendChild(header);

            // Tools grid
            const grid = document.createElement('div');
            grid.className = 'tools-grid';

            tools.forEach(tool => {
                const card = document.createElement('a');
                card.href = tool.href;
                card.className = 'tool-card';
                card.setAttribute('data-id', tool.id);
                card.setAttribute('tabindex', '0');
                card.setAttribute('role', 'link');
                card.setAttribute('aria-label', `${tool.title} - ${tool.description}`);

                // Handle Enter/Space keyboard navigation
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        card.click();
                    }
                });

                card.innerHTML = `
                    <div class="icon-box" id="icon-${tool.id}">${tool.icon}</div>
                    <div class="tool-info">
                        <h3 class="font-black text-[10px] md:text-[14px] uppercase tracking-wide leading-tight" id="title-${tool.id}">
                            ${tool.title}
                        </h3>
                        <p class="text-[9px] md:text-[12px] font-bold opacity-50 tracking-tighter">
                            ${tool.description}
                        </p>
                    </div>
                `;

                grid.appendChild(card);
            });

            section.appendChild(grid);
            container.appendChild(section);
        });

        // Show/hide no results message
        noResults.style.display = totalVisibleTools === 0 ? 'block' : 'none';
    }

    // ====================== SEARCH FUNCTIONALITY ======================
    function toggleSearch() {
        const searchWrapper = document.getElementById('searchWrapper');
        searchWrapper.classList.toggle('open');
        if (searchWrapper.classList.contains('open')) {
            setTimeout(() => document.getElementById('searchInput').focus(), 300);
        } else {
            // Quand on ferme la recherche, r√©initialiser et afficher tous les outils
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').classList.remove('visible');
            renderTools('');
            applyTheme();
            setupCategoryDragDrop();
        }
    }

    function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearSearch');

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value;
            clearBtn.classList.toggle('visible', searchTerm.length > 0);
            renderTools(searchTerm);
            applyTheme();
            setupCategoryDragDrop();
        });

        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchInput.focus();
            clearBtn.classList.remove('visible');
            renderTools('');
            applyTheme();
            setupCategoryDragDrop();
        });

        // Clear on Escape and close search
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                searchInput.value = '';
                searchInput.blur();
                clearBtn.classList.remove('visible');
                document.getElementById('searchWrapper').classList.remove('open');
                renderTools('');
                applyTheme();
                setupCategoryDragDrop();
            }
        });
    }

    // ====================== CATEGORY DRAG & DROP (avec Sortable) ======================
    function setupCategoryDragDrop() {
        const container = document.getElementById('categoriesContainer');

        // D√©truire l'instance pr√©c√©dente si elle existe
        if (container._sortableInstance) {
            container._sortableInstance.destroy();
        }

        // Cr√©er une nouvelle instance Sortable
        container._sortableInstance = new Sortable(container, {
            animation: 250,
            ghostClass: 'sortable-ghost',
            handle: '.category-drag-handle',
            filter: '.tool-card',
            preventOnFilter: false,
            onEnd: function(evt) {
                saveCategoryOrder();
            }
        });
    }

    function saveCategoryOrder() {
        const container = document.getElementById('categoriesContainer');
        const order = Array.from(container.querySelectorAll('.category-section'))
            .map(section => section.getAttribute('data-category'));
        localStorage.setItem(STORAGE_KEYS.categoryOrder, JSON.stringify(order));
    }

    // ====================== THEME APPLICATION ======================
    function applyTheme() {
        const themePrefs = JSON.parse(localStorage.getItem(STORAGE_KEYS.theme)) || {};
        const colorPref = themePrefs.outils || 'blue';
        const colorHex = COLOR_MAP[colorPref];
        const textColor = isDarkText(colorPref) ? '#000' : '#fff';

        // Apply theme to buttons
        const buttons = [
            document.getElementById('btn-retour'),
            document.getElementById('btn-search-trigger'),
            document.getElementById('btn-aide'),
            document.getElementById('btn-fermer-aide')
        ];

        buttons.forEach(el => {
            if (el) {
                el.style.backgroundColor = colorHex;
                el.style.color = textColor;
            }
        });

        // Apply theme to help title
        const helpTitle = document.getElementById('titre-aide');
        if (helpTitle) helpTitle.style.color = colorHex;

        // Apply theme to tool cards
        TOOLS.forEach(tool => {
            const icon = document.getElementById(`icon-${tool.id}`);
            const title = document.getElementById(`title-${tool.id}`);

            if (icon) {
                icon.style.color = colorHex;
                icon.style.borderColor = colorHex + '40';
                icon.style.backgroundColor = colorHex + '15';
            }

            if (title) {
                title.style.color = colorHex;
            }
        });

        // Apply theme to close button
        const closeBtn = document.getElementById('btn-fermer-aide');
        if (closeBtn) {
            closeBtn.style.backgroundColor = colorHex;
            closeBtn.style.color = textColor;
        }

        // Apply theme to category icon circles
        const categoryCircles = document.querySelectorAll('[data-category-circle]');
        categoryCircles.forEach(circle => {
            circle.style.backgroundColor = colorHex + '33';
            circle.style.color = colorHex;
        });
    }

    // ====================== MODAL MANAGEMENT ======================
    function ouvrirAide() {
        const content = document.getElementById('aide-content');
        content.innerHTML = HELP_CONTENT.map(text => `<p>${text}</p>`).join('');
        document.getElementById('modal-aide').classList.add('active');
    }

    function fermerAide() {
        document.getElementById('modal-aide').classList.remove('active');
    }

    // Close modal on Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            fermerAide();
        }
    });

    // ====================== KEYBOARD SHORTCUTS ======================
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // ? to open help
            if ((e.key === '?' || e.key === 'h') && e.target === document.body) {
                e.preventDefault();
                ouvrirAide();
            }
        });
    }

    // ====================== INITIALIZATION ======================
    window.onload = () => {
        renderTools();
        applyTheme();
        setupSearch();
        setupKeyboardShortcuts();
        setupCategoryDragDrop();
    };
</script>
</body>
</html>