<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rituel Op√©rations - Expert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --accent-color: #f59e0b; --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #f3f4f6; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f9fafb;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; transition: all 0.3s ease; }
        
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }

        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; transition: all 0.2s ease; cursor: pointer; border: none; background: var(--accent-color); color: #000; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }

        .main-wrapper { width: 100%; max-width: 450px; margin: 0 auto; padding: 1px 1px 40px; }
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 10px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 10px; }
        
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border); border-radius: 0.75rem; padding: 10px; font-size: 0.85rem; font-weight: 700; width: 100%; color: var(--text-main); outline: none; text-align: center; }
        
        .btn-add { width: 100%; padding: 14px; border-radius: 50px; font-weight: 900; font-size: 12px; text-transform: uppercase; border: none; cursor: pointer; transition: transform 0.1s; background: var(--accent-color); color: #000; }

        .day-box { background: rgba(122,122,122,0.05); border-radius: 1rem; padding: 8px; border: 1px solid var(--column-border); }
        
        .q-card { background: var(--card-bg); border-radius: 0.75rem; padding: 10px; border: 1px solid var(--column-border); display: flex; justify-content: space-between; align-items: center; }
        .res-text { color: #10b981; font-weight: 800; }

        /* Styles Seyes pour le PDF */
        .seyes-container { position: relative; height: 48mm; width: 100%; background: white; border: 1px solid #cbd5e1; overflow: hidden; box-sizing: border-box; }
        .seyes-vertical-lines { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: linear-gradient(90deg, rgba(173, 216, 230, 1) 1px, transparent 1px); background-size: 8mm 100%; z-index: 1; }
        .seyes-line { position: absolute; left: 0; right: 0; height: 1px; z-index: 2; }
        .line-principale { background: rgba(138, 43, 226, 0.4); height: 1.5px; }
        .line-interligne { background: rgba(173, 216, 230, 1); }
        .empty-frame-pdf { height: 48mm; width: 100%; background: transparent; }

        /* Modale Aide */
        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; color: var(--text-main); }
    </style>
</head>
<body>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
    </a>
    <h1>Rituel Op√©rations</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div id="setup-zone" class="space-y-4">
        <div class="light-card">
            <label class="block text-[10px] font-black uppercase opacity-60 mb-3 tracking-widest text-center">1. Niveau Scolaire</label>
            <select id="niveau-select" class="input-field" onchange="appliquerPresetsNiveau()">
                <option value="cp">CP</option>
                <option value="ce1">CE1</option>
                <option value="ce2">CE2</option>
                <option value="cm1">CM1</option>
                <option value="cm2" selected>CM2</option>
            </select>
        </div>

        <div class="light-card">
            <label class="block text-[10px] font-black uppercase opacity-60 mb-4 tracking-widest text-center">2. Quantit√© par jour (Total 4)</label>
            <div id="days-container" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div class="light-card space-y-5">
            <label class="block text-[10px] font-black uppercase opacity-60 mb-2 tracking-widest text-center">3. R√©glages des termes</label>
            <div id="group-settings-as" class="space-y-3 p-3 bg-white/5 rounded-2xl border border-white/5 text-center">
                <span class="block text-[9px] font-black opacity-30 uppercase">Additions & Soustractions</span>
                <div class="flex gap-3">
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1">Mini</label><input type="number" id="as-min" class="input-field"></div>
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1">Maxi</label><input type="number" id="as-max" class="input-field"></div>
                </div>
            </div>
            <div id="group-settings-mult" class="space-y-3 p-3 bg-white/5 rounded-2xl border border-white/5 text-center">
                <span class="block text-[9px] font-black opacity-30 uppercase">Multiplications</span>
                <div class="flex gap-3">
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1">Chiffres T1</label><input type="number" id="mult-t1" class="input-field"></div>
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1">Chiffres T2</label><input type="number" id="mult-t2" class="input-field"></div>
                </div>
            </div>
            <div id="group-settings-div" class="space-y-3 p-3 bg-white/5 rounded-2xl border border-white/5 text-center">
                <span class="block text-[9px] font-black opacity-30 uppercase">Divisions</span>
                <div class="flex gap-3">
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1">Chiffres Dividende</label><input type="number" id="div-t1" class="input-field"></div>
                    <div class="flex-1"><label class="block text-[8px] opacity-50 mb-1">Diviseur Max</label><input type="number" id="div-t2" class="input-field"></div>
                </div>
            </div>
        </div>
        <button onclick="genererRituel()" class="btn-add">G√©n√©rer la semaine</button>
    </div>

    <div id="result-zone" class="hidden space-y-4">
        <div id="questions-grid" class="grid grid-cols-1 gap-2"></div>
        <div class="grid grid-cols-2 gap-3 pt-6">
            <button onclick="location.reload()" class="flex items-center justify-center gap-2 py-3 rounded-3xl text-[10px] font-black uppercase tracking-widest bg-gray-500/10 border border-gray-500/20 text-gray-500 hover:bg-gray-500/20 transition-all active:scale-95">Configuration</button>
            <button onclick="exportPDF()" class="btn-add flex items-center justify-center gap-2 shadow-lg shadow-[var(--accent-color)]/20">Exporter PDF</button>
            <button onclick="toggleCorrection()" class="col-span-2 flex items-center justify-center gap-2 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest bg-emerald-500/10 border border-emerald-500/20 text-emerald-500 hover:bg-emerald-500/20 transition-all active:scale-95">Afficher la correction</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerAide()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="text-lg font-black uppercase mb-4 text-center">üí° Rituel op√©rations</h2>
        <div class="text-[11px] leading-relaxed space-y-4 opacity-90">
            <div>
                <p class="font-black uppercase text-[9px] mb-1 opacity-50 tracking-wider">Fonctionnement</p>
                <p>G√©n√©rez un programme d'entra√Ænement pour la semaine. Vous pouvez choisir jusqu'√† <b>4 op√©rations par jour</b>.</p>
            </div>
            <div>
                <p class="font-black uppercase text-[9px] mb-1 opacity-50 tracking-wider">R√©glages</p>
                <ul class="list-disc pl-4 space-y-1">
                    <li><b>Niveaux :</b> Les r√©glages s'adaptent automatiquement du CP au CM2.</li>
                    <li><b>Compteurs :</b> G√©rez les quantit√©s quotidiennes avec les fl√®ches.</li>
                    <li><b>Param√®tres :</b> Ajustez le nombre de chiffres pour chaque type d'op√©ration.</li>
                </ul>
            </div>
            <div>
                <p class="font-black uppercase text-[9px] mb-1 opacity-50 tracking-wider">Export PDF</p>
                <p>Le PDF g√©n√®re automatiquement un <b>quadrillage Seyes complet</b> (lignes violettes et interlignes bleues) pour aider les √©l√®ves √† poser les op√©rations.</p>
            </div>
        </div>
        <button id="btn-fermer-aide" onclick="fermerAide()" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest active:scale-95 transition-transform">
            Compris
        </button>
    </div>
</div>

<script>
    const jours = ["Lundi", "Mardi", "Jeudi", "Vendredi"];
    const ops = [{id:'add', label:'+', color:'#60a5fa'}, {id:'sub', label:'-', color:'#f87171'}, {id:'mul', label:'x', color:'#fbbf24'}, {id:'div', label:'√∑', color:'#a78bfa'}];

    function init() {
        const container = document.getElementById('days-container');
        const niv = document.getElementById('niveau-select').value;
        container.innerHTML = ''; 
        jours.forEach((j, dayIdx) => {
            let html = `<div class="day-box"><div class="text-[10px] font-black mb-3 opacity-60 uppercase text-center">${j}</div><div class="flex justify-around items-center">`;
            ops.forEach((op) => {
                if (niv === 'cp' && (op.id === 'mul' || op.id === 'div')) return;
                if (niv === 'ce1' && op.id === 'div') return;
                let val = 1;
                html += `<div class="counter-group flex flex-col items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center mb-2" style="background:${op.color}20; border:1.5px solid ${op.color}"><span class="text-lg font-black" style="color:${op.color}">${op.label}</span></div>
                    <div class="flex flex-col items-center bg-black/5 rounded-xl p-1 border border-black/5">
                        <button onclick="changeVal(${dayIdx},'${op.id}',1)" class="w-9 h-7 flex items-center justify-center opacity-50 hover:opacity-100" style="color:var(--accent-color)"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4"><path d="M5 15l7-7 7 7"/></svg></button>
                        <div id="cnt-${dayIdx}-${op.id}" class="w-9 h-6 flex items-center justify-center font-black text-sm text-[var(--accent-color)]">${val}</div>
                        <button onclick="changeVal(${dayIdx},'${op.id}',-1)" class="w-9 h-7 flex items-center justify-center opacity-50 hover:opacity-100" style="color:var(--accent-color)"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4"><path d="M19 9l-7 7-7-7"/></svg></button>
                        <input type="hidden" data-day="${dayIdx}" data-op="${op.id}" data-day-name="${j}" value="${val}">
                    </div>
                </div>`;
            });
            container.innerHTML += html + `</div></div>`;
        });
        appliquerTheme();
    }

    function changeVal(dayIdx, opId, delta) {
        const input = document.querySelector(`input[data-day="${dayIdx}"][data-op="${opId}"]`);
        const display = document.getElementById(`cnt-${dayIdx}-${opId}`);
        const total = Array.from(document.querySelectorAll(`input[data-day="${dayIdx}"]`)).reduce((a, b) => a + (parseInt(b.value)||0), 0);
        let newVal = (parseInt(input.value)||0) + delta;
        if (newVal < 0 || (delta > 0 && total >= 4)) return;
        input.value = newVal; display.innerText = newVal;
    }

    function appliquerPresetsNiveau() {
        const niv = document.getElementById('niveau-select').value;
        const config = { 'cp':[1,50,1,1,1,2], 'ce1':[10,99,1,1,1,5], 'ce2':[100,9999,2,1,2,9], 'cm1':[1000,99999,3,2,3,9], 'cm2':[1000,999999,3,2,4,15] };
        const p = config[niv];
        ['as-min','as-max','mult-t1','mult-t2','div-t1','div-t2'].forEach((id,i) => document.getElementById(id).value = p[i]);
        document.getElementById('group-settings-mult').style.display = (niv==='cp')?'none':'block';
        document.getElementById('group-settings-div').style.display = (niv==='cp'||niv==='ce1')?'none':'block';
        init();
    }

    function getRandomNDigits(n) { const min=Math.pow(10,n-1), max=Math.pow(10,n)-1; return Math.floor(Math.random()*(max-min+1))+min; }

    function genererRituel() {
        const grid = document.getElementById('questions-grid'); grid.innerHTML = '';
        jours.forEach((j, dayIdx) => {
            grid.innerHTML += `<div class="col-span-full font-black text-center py-1 mt-4 opacity-30 text-[10px] tracking-widest uppercase border-b border-white/10">‚Ä¢ ${j} ‚Ä¢</div>`;
            document.querySelectorAll(`input[data-day="${dayIdx}"]`).forEach(input => {
                for(let i=0; i<parseInt(input.value); i++) {
                    let a, b, opSign, res, type=input.dataset.op;
                    if(type==='add'||type==='sub'){
                        const min=parseInt(document.getElementById('as-min').value), max=parseInt(document.getElementById('as-max').value);
                        a=Math.floor(Math.random()*(max-min+1))+min; b=Math.floor(Math.random()*(max-min+1))+min;
                        if(type==='add'){opSign='+'; res=a+b;}else{if(a<b)[a,b]=[b,a]; opSign='-'; res=a-b;}
                    } else if(type==='mul'){
                        a=getRandomNDigits(document.getElementById('mult-t1').value); b=getRandomNDigits(document.getElementById('mult-t2').value); opSign='x'; res=a*b;
                    } else {
                        b=Math.floor(Math.random()*(document.getElementById('div-t2').value-2+1))+2; a=Math.floor(getRandomNDigits(document.getElementById('div-t1').value)/b)*b; opSign='√∑'; res=a/b;
                    }
                    grid.innerHTML += `<div class="q-card" data-day-name="${j}"><span class="text-[13px] font-black">${a.toLocaleString('fr-FR')} ${opSign} ${b.toLocaleString('fr-FR')} =</span><span class="res-text hidden">${res.toLocaleString('fr-FR')}</span></div>`;
                }
            });
        });
        document.getElementById('setup-zone').classList.add('hidden'); document.getElementById('result-zone').classList.remove('hidden');
    }

    function exportPDF() {
        const niv = document.getElementById('niveau-select').value.toUpperCase();
        const container = document.createElement('div');
        Object.assign(container.style, { width: "175mm", margin: "0 auto", padding: "0mm", backgroundColor: "white", display: "block", boxSizing: "border-box" });

        let currentDay = ""; 
        document.querySelectorAll('.q-card').forEach(q => {
            const day = q.getAttribute('data-day-name');
            if(day !== currentDay) {
                if(day === "Jeudi") { 
                    const pb = document.createElement('div'); pb.style.pageBreakBefore = "always"; container.appendChild(pb); 
                }
                currentDay = day;
                const h = document.createElement('div'); h.innerHTML = `‚Ä¢ ${day} ‚Ä¢`;
                Object.assign(h.style, { textAlign:"center", fontWeight:"900", padding:"4px", borderBottom:"1.5px solid black", marginBottom:"6px", marginTop: day === "Mardi" || day === "Vendredi" ? "10px" : "0px", fontSize:"14px", textTransform:"uppercase", width: "100%", color: "black" });
                container.appendChild(h);
                const currentGrid = document.createElement('div');
                Object.assign(currentGrid.style, { display:"grid", gridTemplateColumns:"1fr 1fr", gap:"6mm", marginBottom:"10px", width: "100%" });
                container.appendChild(currentGrid);
                q.parentElement._currentGrid = currentGrid;
            }

            const card = document.createElement('div');
            const enonce = q.querySelector('span:first-child').innerText;
            const isDiv = enonce.includes('√∑');
            Object.assign(card.style, { border: isDiv ? "none" : "1px solid #e2e8f0", padding: "5px", borderRadius: "6px", boxSizing: "border-box" });
            let frameContent = isDiv ? `<div class="empty-frame-pdf"></div>` : `<div class="seyes-container"><div class="seyes-vertical-lines"></div>${Array.from({length:25}, (_,i)=>`<div class="seyes-line ${i%4===0?'line-principale':'line-interligne'}" style="top:${i*2}mm"></div>`).join('')}</div>`;
            card.innerHTML = `<div style="font-weight:bold; font-size:13px; margin-bottom:3px; color:black;">${enonce}</div>${frameContent}`;
            const activeGrid = Array.from(container.querySelectorAll('div[style*="display: grid"]')).pop();
            activeGrid.appendChild(card);
        });

        const opt = { margin: [8, 10], filename: `rituel_operations_${niv}.pdf`, image: { type: 'jpeg', quality: 1 }, html2canvas: { scale: 3, useCORS: true, backgroundColor: '#ffffff', scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(container).save();
    }

    function toggleCorrection() { document.querySelectorAll('.res-text').forEach(e => e.classList.toggle('hidden')); }
    
    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerAide() { document.getElementById('modal-aide').style.display = 'none'; }

    function appliquerTheme() {
        const col = (JSON.parse(localStorage.getItem('theme_tuiles')) || {}).gen || 'amber';
        const map = { 'red':'#ef4444','orange':'#f97316','amber':'#f59e0b','yellow':'#eab308','lime':'#84cc16','green':'#22c55e','emerald':'#10b981','teal':'#14b8a6','cyan':'#06b6d4','sky':'#0ea5e9','blue':'#3b82f6','indigo':'#6366f1','violet':'#8b5cf6','purple':'#a855f7','fuchsia':'#d946ef','pink':'#ec4899','rose':'#f43f5e','gray':'#6b7280' };
        document.documentElement.style.setProperty('--accent-color', map[col]);
        const hexa = map[col]; 
        const contrast = ['yellow','lime','amber','cyan'].includes(col) ? '#000' : '#fff';
        
        [document.getElementById('btn-retour-header'), document.getElementById('btn-aide'), document.querySelector('.btn-add'), document.getElementById('btn-fermer-aide')].forEach(el => { 
            if(el){ el.style.backgroundColor = hexa; el.style.color = contrast; }
        });

        if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
        else document.body.classList.remove('light-mode');
    }

    window.onload = function() {
        appliquerPresetsNiveau();
        appliquerTheme();
    };
</script>
</body>
</html>