<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√©n√©rateur d'√©quipes √©quilibr√©es - OutilsProfs</title>
    
    <script>
        (function() {
            const mode = localStorage.getItem('theme_mode');
            if (mode === 'light') {
                document.documentElement.classList.add('light-mode-init');
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ====================== CSS CONFIGURATION ====================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root { 
            --bg: #121212; --text: #ffffff; --card-bg: #0a0a0a; --header-bg: #1e1e1e;
            --header-border: rgba(255, 255, 255, 0.1); --border-color: rgba(255, 255, 255, 0.1);
            --pill-bg: #1a1a1a; --btn-num-bg: #0a0a0a; --btn-num-border: #262626;
            --title-gray: #888888; --student-name-boy: #bae6fd; --student-name-girl: #fbcfe8;
            --theme-color: #3b82f6; /* D√©faut Blue */
            --contrast-color: #ffffff;
        }

        body.light-mode, html.light-mode-init body {
            --bg: #eeeeee; --text: #000000; --card-bg: #ffffff; --header-bg: #ffffff;
            --header-border: #dddddd; --pill-bg: #ffffff; --btn-num-bg: #ffffff;
            --btn-num-border: #cccccc; --title-gray: #666666;
        }

        body { 
            font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); 
            padding: 0; margin: 0; transition: background 0.3s;
            display: flex; flex-direction: column; align-items: center;
            padding-left: 15px; padding-right: 15px; padding-bottom: 20px;
        }

        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--header-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: calc(100% + 30px); margin-left: -15px; margin-bottom: 10px;
        }

        .header-btn { 
            display: flex; align-items: center; justify-content: center; 
            width: 40px; height: 40px; border-radius: 50%; 
            border: 1px solid var(--header-border); 
            transition: transform 0.1s ease, background-color 0.3s ease;
            background-color: var(--theme-color);
            color: var(--contrast-color);
        }

        .section-title { 
            font-size: 10px; color: var(--title-gray); margin: 15px 0 5px 0; 
            font-weight: 900; letter-spacing: 1px; text-align: center; text-transform: uppercase;
        }

        .level-label { 
            text-align: center; font-size: 10px; font-weight: 900; margin: 15px 0 5px 0; 
            text-transform: uppercase; letter-spacing: 1px;
        }

        #attendance-container { width: 95%; margin: 0 auto; padding: 0 10px; }

        .attendance-grid { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; 
            margin-bottom: 20px; width: 100%;
        }

        @media (min-width: 768px) {
            .attendance-grid { grid-template-columns: repeat(10, 1fr); gap: 15px; }
        }

        .student-item { 
            padding: 6px 2px; border-radius: 999px; font-size: 0.6rem; font-weight: 800; 
            text-align: center; cursor: pointer; background-color: var(--pill-bg);
            border: 1px solid var(--header-border); transition: all 0.2s; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; user-select: none;
        }

		@media (min-width: 768px) {
            .student-item { font-size: 0.7rem; padding: 10px 2px; }
        }

        @media (min-width: 1024px) {
            .student-item { font-size: 0.9rem; padding: 10px 2px; }
        }
		
        .student-item.bg-f { color: var(--student-name-girl) !important; }
        .student-item.bg-m { color: var(--student-name-boy) !important; }

        .student-item.absent { 
            background-color: #0a0a0a !important; color: #444444 !important; 
            text-decoration: line-through; border-color: #1a1a1a !important;
            opacity: 0.5; transform: scale(0.96);
        }

        .num-btn { 
            background: var(--btn-num-bg); color: var(--text); border: 1px solid var(--btn-num-border); 
            width: 34px; height: 34px; border-radius: 50%; font-weight: 800; cursor: pointer;
            transition: all 0.2s;
        }

        .generate-btn { 
            width: 100%; max-width: 300px; padding: 14px; font-size: 10px; 
            font-weight: 900; border-radius: 50px; text-transform: uppercase; margin: 20px 0; 
            border: none; cursor: pointer; transition: all 0.2s;
            background-color: var(--theme-color);
            color: var(--contrast-color);
        }

        #btn-retour-liste {
            background-color: var(--theme-color);
            color: var(--contrast-color);
        }

        .grid-teams { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 10px;
        }
		
		@media (min-width: 768px) {
            .grid-teams { grid-template-columns: repeat(3, 1fr); }
        }
		
        @media (min-width: 1024px) {
            .grid-teams { grid-template-columns: repeat(4, 1fr); }
        }

        .team-card { 
            border-radius: 1.2rem; padding: 10px; background: var(--card-bg); 
            border: 1px solid var(--header-border);
        }

        .team-header { border-bottom: 1px solid var(--header-border); margin-bottom: 8px; padding-bottom: 4px; }
        .team-title { font-weight: 900; font-size: 0.65rem; color: var(--text); text-transform: uppercase; }
        .team-stats { font-size: 0.5rem; color: var(--title-gray); display: block; line-height: 1.4; }
        .team-member { display: flex; align-items: center; margin-bottom: 1px; font-size: 0.65rem; font-weight: bold; }

		@media (min-width: 768px) {
            .team-member {
                font-size: 0.8rem !important;
                margin-bottom: 8px;
            }
        }

        @media (min-width: 1024px) {
            .team-member {
                font-size: 0.9rem !important;
                margin-bottom: 9px;
            }
        }
		
        .tag { 
            font-size: 0.45rem; font-weight: 700; margin-right: 8px; padding: 2px 6px; 
            border-radius: 999px; color: #fff; min-width: 35px; text-align: center;
        }
		
		@media (min-width: 768px) {
            .tag {
                font-size: 0.55rem !important;
                padding: 4px 10px;
            }
        }

        @media (min-width: 1024px) {
            .tag {
                font-size: 0.6rem !important;
                padding: 5px 12px;
                min-width: 45px;
            }
        }
		
        .name-f { color: var(--student-name-girl); }
        .name-g { color: var(--student-name-boy); }

        .modal-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(4px); align-items: center; justify-content: center; 
            z-index: 1000; padding: 20px;
        }

        .modal-content { 
            background: var(--card-bg); padding: 24px; border-radius: 24px; 
            width: 100%; max-width: 360px; color: var(--text); 
            border: 1px solid var(--header-border);
        }
    </style>
</head>
<body>

    <header>
        <a href="index.html" id="btn-retour" class="header-btn shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="mainTitle" class="font-black text-lg uppercase flex-grow text-center">√âquipes</h1>
        <button id="btn-aide" onclick="ouvrirAide()" class="header-btn shadow-lg text-lg">üí°</button>
    </header>
    
    <div class="w-full flex justify-start mb-4 mt-2" style="max-width: 95%;">
        <a href="outils.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full font-black text-[10px] uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux outils
        </a>
    </div>

    <div id="attendance-container"></div>

    <p class="section-title">Nombre d'√©quipes</p>
    <div class="flex gap-2 mb-4" id="selector"></div>

    <button id="main-generate-btn" class="generate-btn" onclick="generateBalancedTeams()">G√©n√©rer les √©quipes</button>

    <div id="results" class="grid-teams"></div>

    <div class="w-full max-w-[400px] mt-5 mb-10 px-[10px]">
        <button onclick="resetTeams()" class="w-full font-extrabold p-3 rounded-full text-[10px] text-center cursor-pointer border-none bg-red-500 text-white shadow-lg uppercase">‚ö†Ô∏è effacer les √©quipes</button>
    </div>

    <div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="titre-aide" class="text-lg font-black uppercase mb-4">üí° √âquipes</h2>
            <div class="text-[11px] leading-relaxed space-y-2 opacity-80">
                <p>‚Ä¢ <b>Pr√©sence :</b> Cliquez sur un √©l√®ve pour le marquer absent. Il ne sera pas inclus.</p>
                <p>‚Ä¢ <b>√âquilibrage :</b> L'algorithme r√©partit les sexes et les niveaux √©quitablement.</p>
                <p>‚Ä¢ <b>Nombre :</b> Choisissez le nombre d'√©quipes avant de g√©n√©rer.</p>
            </div>
            <button id="btn-fermer-aide" onclick="fermerModal('modal-aide')" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest active:scale-95 transition-transform" style="background-color: var(--theme-color); color: var(--contrast-color);">Fermer</button>
        </div>
    </div>

    <div id="alertModal" class="modal-overlay" onclick="fermerModal('alertModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 class="font-black uppercase text-center mb-2">Confirmation</h3>
            <p id="alertText" class="text-center text-sm mb-4"></p>
            <div class="flex gap-2">
                <button onclick="fermerModal('alertModal')" class="flex-1 p-3 bg-gray-200 text-gray-700 rounded-xl font-bold text-[10px] uppercase">Annuler</button>
                <button id="alertConfirmBtn" class="flex-1 p-3 text-white rounded-xl font-bold text-[10px] uppercase">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        const COLOR_MAP = {
            'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
            'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
            'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
            'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
            'rose': '#f43f5e', 'gray': '#666666'
        };

        const LEVEL_COLORS = { 'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308', 'CM1': '#ef4444', 'CM2': '#22c55e', 'AUTRE': '#a855f7' };
        const LEVEL_ORDER = ['CP', 'CE1', 'CE2', 'CM1', 'CM2', 'AUTRE'];
        const STORAGE_KEYS = { students: 'maListeEleves', absents: 'absents_session_equipes', savedTeams: 'savedTeams', theme: 'theme_tuiles', themeMode: 'theme_mode', levelPalette: 'palette_niveaux' };

        let selectedNumTeams = 4;
        let allStudents = JSON.parse(localStorage.getItem(STORAGE_KEYS.students)) || [];
        let absentSet = new Set(JSON.parse(localStorage.getItem(STORAGE_KEYS.absents)) || []);

        function applyTheme() {
            const isLight = localStorage.getItem(STORAGE_KEYS.themeMode) === 'light';
            document.body.classList.toggle('light-mode', isLight);

            const themePrefs = JSON.parse(localStorage.getItem(STORAGE_KEYS.theme)) || {};
            // PRIORIT√â : Couleur 'outils' (comme sur la page tirage), sinon 'blue' par d√©faut
            const colorName = themePrefs.outils || 'blue';
            const colorHex = COLOR_MAP[colorName] || '#3b82f6';
            const needsDarkText = ['yellow', 'lime', 'amber', 'cyan'].includes(colorName);
            const textColor = needsDarkText ? '#000000' : '#ffffff';

            document.documentElement.style.setProperty('--theme-color', colorHex);
            document.documentElement.style.setProperty('--contrast-color', textColor);

            const helpTitle = document.getElementById('titre-aide');
            if (helpTitle) helpTitle.style.color = colorHex;
        }

        function getDisplayName(student, allStudentsArray) {
            const firstName = student.identite.trim().split(" ")[0];
            const hasDuplicate = allStudentsArray.some(s => s.id !== student.id && s.identite.trim().split(" ")[0].toLowerCase() === firstName.toLowerCase());
            return hasDuplicate && student.identite.split(" ")[1] ? `${firstName} ${student.identite.split(" ")[1].charAt(0)}.` : firstName;
        }

        function getTeamStats(team) {
            const stats = { f: 0, m: 0, total: team.length, levels: {} };
            LEVEL_ORDER.forEach(l => stats.levels[l.toLowerCase()] = { f: 0, m: 0, total: 0 });
            team.forEach(s => {
                const isF = s.sexe.toLowerCase().startsWith('f');
                const lvl = s.niveau.toString().toUpperCase();
                isF ? stats.f++ : stats.m++;
                if (stats.levels[lvl.toLowerCase()]) {
                    stats.levels[lvl.toLowerCase()].total++;
                    isF ? stats.levels[lvl.toLowerCase()].f++ : stats.levels[lvl.toLowerCase()].m++;
                }
            });
            return stats;
        }

        function calculateScore(s1, s2) {
            let score = Math.abs(s1.f - s2.f) * 10 + Math.abs(s1.m - s2.m) * 10;
            LEVEL_ORDER.forEach(l => {
                const k = l.toLowerCase();
                score += Math.abs(s1.levels[k].f - s2.levels[k].f) * 20 + Math.abs(s1.levels[k].total - s2.levels[k].total) * 5;
            });
            return score;
        }

        function renderAttendance() {
            const container = document.getElementById('attendance-container');
            container.innerHTML = '';
            const customPalette = JSON.parse(localStorage.getItem(STORAGE_KEYS.levelPalette)) || {};
            const groups = {};
            allStudents.forEach(s => {
                const l = s.niveau.toString().toUpperCase();
                if (!groups[l]) groups[l] = [];
                groups[l].push(s);
            });

            LEVEL_ORDER.forEach(l => {
                if (groups[l]) {
                    const color = customPalette[l] || LEVEL_COLORS[l];
                    let html = `<div class="level-label" style="color:${color}">${l}</div><div class="attendance-grid">`;
                    groups[l].sort((a,b) => a.identite.localeCompare(b.identite)).forEach(s => {
                        const isAbs = absentSet.has(String(s.id));
                        const gender = s.sexe.toLowerCase().startsWith('f') ? 'bg-f' : 'bg-m';
                        html += `<div class="student-item ${gender} ${isAbs?'absent':''}" onclick="toggleAbsent('${s.id}')">${getDisplayName(s, allStudents)}</div>`;
                    });
                    container.innerHTML += html + `</div>`;
                }
            });
        }

        function toggleAbsent(id) {
            absentSet.has(String(id)) ? absentSet.delete(String(id)) : absentSet.add(String(id));
            localStorage.setItem(STORAGE_KEYS.absents, JSON.stringify(Array.from(absentSet)));
            renderAttendance();
        }

        function selectTeamCount(count) {
            selectedNumTeams = count;
            const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim();
            const contrastColor = getComputedStyle(document.documentElement).getPropertyValue('--contrast-color').trim();
            
            document.querySelectorAll('.num-btn').forEach(btn => {
                const isSelected = parseInt(btn.innerText) === count;
                btn.style.backgroundColor = isSelected ? themeColor : 'var(--btn-num-bg)';
                btn.style.color = isSelected ? contrastColor : 'var(--text)';
                btn.style.borderColor = isSelected ? themeColor : 'var(--btn-num-border)';
            });
        }

        function generateBalancedTeams() {
            const present = allStudents.filter(s => !absentSet.has(String(s.id)));
            if (present.length < selectedNumTeams) return;
            let teams = Array.from({ length: selectedNumTeams }, () => []);
            [...present].sort(() => Math.random() - 0.5).forEach((s, i) => teams[i % selectedNumTeams].push(s));

            for (let iter = 0; iter < 300; iter++) {
                for (let i = 0; i < teams.length; i++) {
                    for (let j = 0; j < teams.length; j++) {
                        if (i === j) continue;
                        const score = calculateScore(getTeamStats(teams[i]), getTeamStats(teams[j]));
                        for (let x = 0; x < teams[i].length; x++) {
                            for (let y = 0; y < teams[j].length; y++) {
                                const temp = teams[i][x]; teams[i][x] = teams[j][y]; teams[j][y] = temp;
                                if (calculateScore(getTeamStats(teams[i]), getTeamStats(teams[j])) >= score) {
                                    teams[j][y] = teams[i][x]; teams[i][x] = temp;
                                }
                            }
                        }
                    }
                }
            }
            localStorage.setItem(STORAGE_KEYS.savedTeams, JSON.stringify(teams));
            renderTeams(teams);
        }

        function renderTeams(teams) {
            const res = document.getElementById('results');
            const pal = JSON.parse(localStorage.getItem(STORAGE_KEYS.levelPalette)) || {};
            res.innerHTML = '';
            teams.forEach((t, i) => {
                const stats = getTeamStats(t);
                let html = `<div class="team-card"><div class="team-header"><span class="team-title">√âquipe ${i+1}</span><span class="team-stats">${stats.f}F/${stats.m}G</span></div>`;
                t.sort((a,b) => LEVEL_ORDER.indexOf(a.niveau.toString().toUpperCase()) - LEVEL_ORDER.indexOf(b.niveau.toString().toUpperCase())).forEach(s => {
                    const lvl = s.niveau.toString().toUpperCase();
                    const c = pal[lvl] || LEVEL_COLORS[lvl] || '#888';
                    html += `<div class="team-member"><span class="tag" style="background-color:${c}">${lvl}</span><span class="${s.sexe.toLowerCase().startsWith('f')?'name-f':'name-g'}">${getDisplayName(s, allStudents)}</span></div>`;
                });
                res.innerHTML += html + `</div>`;
            });
        }

        function resetTeams() {
            document.getElementById('alertText').innerText = "Voulez-vous effacer les √©quipes ?";
            const confirmBtn = document.getElementById('alertConfirmBtn');
            confirmBtn.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-color');
            confirmBtn.onclick = () => { localStorage.removeItem(STORAGE_KEYS.savedTeams); document.getElementById('results').innerHTML = ''; fermerModal('alertModal'); };
            document.getElementById('alertModal').style.display = 'flex';
        }

        function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
        function fermerModal(id) { document.getElementById(id).style.display = 'none'; }

        window.onload = () => {
            applyTheme();
            const sel = document.getElementById('selector');
            for (let i = 2; i <= 8; i++) {
                const b = document.createElement('button'); b.className = 'num-btn'; b.innerText = i; b.onclick = () => selectTeamCount(i); sel.appendChild(b);
            }
            selectTeamCount(selectedNumTeams);
            renderAttendance();
            const saved = localStorage.getItem(STORAGE_KEYS.savedTeams);
            if (saved) renderTeams(JSON.parse(saved));
            
            const prefs = JSON.parse(localStorage.getItem(STORAGE_KEYS.theme));
            if (prefs) {
                if (prefs.fille) document.documentElement.style.setProperty('--student-name-girl', COLOR_MAP[prefs.fille]);
                if (prefs.garcon) document.documentElement.style.setProperty('--student-name-boy', COLOR_MAP[prefs.garcon]);
            }
        };
    </script>
</body>
</html>