<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√©n√©rateur d'√©quipes √©quilibr√©es - OutilsProfs</title>
    
    <!-- Initialisation du mode clair avant le chargement pour √©viter le flash -->
    <script>
        (function() {
            const mode = localStorage.getItem('theme_mode');
            if (mode === 'light') {
                document.documentElement.classList.add('light-mode-init');
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        /* ========== VARIABLES CSS ========== */
        :root { 
            --bg: #121212;
            --text: #ffffff;
            --card-bg: #0a0a0a;
            --header-bg: #1e1e1e;
            --header-border: rgba(255, 255, 255, 0.1);
            --border-color: rgba(255, 255, 255, 0.1);
            --pill-bg: #1a1a1a;
            --btn-num-bg: #0a0a0a;
            --btn-num-border: #262626;
            --title-gray: #888888;
            --student-name-boy: #bae6fd;
            --student-name-girl: #fbcfe8;
            --theme-color: #3b82f6;
            --contrast-color: #ffffff;
        }

        body.light-mode,
        html.light-mode-init body {
            --bg: #eeeeee;
            --text: #000000;
            --card-bg: #ffffff;
            --header-bg: #ffffff;
            --header-border: #dddddd;
            --pill-bg: #ffffff;
            --btn-num-bg: #ffffff;
            --btn-num-border: #cccccc;
            --title-gray: #666666;
        }

        /* ========== STYLES DE BASE ========== */
        body { 
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 0;
            margin: 0;
            transition: background 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-left: 15px;
            padding-right: 15px;
            padding-bottom: 20px;
        }

        /* ========== HEADER ========== */
        header { 
            background: var(--header-bg);
            border-bottom: 1px solid var(--header-border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px;
            width: calc(100% + 30px);
            margin-left: -15px;
            margin-bottom: 10px;
        }

        header h1 {
            font-weight: 900;
            font-size: 1.125rem;
            text-transform: uppercase;
            flex-grow: 1;
            text-align: center;
        }

        .header-btn { 
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--header-border);
            transition: transform 0.1s ease, background-color 0.3s ease;
            background-color: var(--theme-color);
            color: var(--contrast-color);
            cursor: pointer;
            text-decoration: none;
        }

        .header-btn:active {
            transform: scale(0.9);
        }

        /* ========== TITRES DE SECTION ========== */
        .section-title { 
            font-size: 10px;
            color: var(--title-gray);
            margin: 15px 0 5px 0;
            font-weight: 900;
            letter-spacing: 1px;
            text-align: center;
            text-transform: uppercase;
        }

        .level-label { 
            text-align: center;
            font-size: 10px;
            font-weight: 900;
            margin: 15px 0 5px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ========== CONTENEURS ========== */
        #attendance-container {
            width: 95%;
            margin: 0 auto;
            padding: 0 10px;
        }

        /* ========== GRILLE DE PR√âSENCE ========== */
        .attendance-grid { 
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin-bottom: 20px;
            width: 100%;
        }

        @media (min-width: 768px) {
            .attendance-grid {
                grid-template-columns: repeat(10, 1fr);
                gap: 15px;
            }
        }

        /* ========== √âTIQUETTES D'√âL√àVES ========== */
        .student-item { 
            padding: 6px 2px;
            border-radius: 999px;
            font-size: 0.6rem;
            font-weight: 800;
            text-align: center;
            cursor: pointer;
            background-color: var(--pill-bg);
            border: 1px solid var(--header-border);
            transition: all 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            user-select: none;
        }

        @media (min-width: 768px) {
            .student-item {
                font-size: 0.7rem;
                padding: 10px 2px;
            }
        }

        @media (min-width: 1024px) {
            .student-item {
                font-size: 0.9rem;
                padding: 10px 2px;
            }
        }

        .student-item.bg-f {
            color: var(--student-name-girl) !important;
        }

        .student-item.bg-m {
            color: var(--student-name-boy) !important;
        }

        .student-item.absent { 
            background-color: #0a0a0a !important;
            color: #444444 !important;
            text-decoration: line-through;
            border-color: #1a1a1a !important;
            opacity: 0.5;
            transform: scale(0.96);
        }

        body.light-mode .student-item.absent,
        html.light-mode-init body .student-item.absent {
            background-color: #e0e0e0 !important;
            color: #aaaaaa !important;
            border-color: #cccccc !important;
        }

        /* ========== BOUTONS ========== */
        .num-btn { 
            background: var(--btn-num-bg);
            color: var(--text);
            border: 1px solid var(--btn-num-border);
            width: 34px;
            height: 34px;
            border-radius: 50%;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
        }

        .num-btn:active {
            transform: scale(0.9);
        }

        .generate-btn { 
            width: 100%;
            max-width: 300px;
            padding: 14px;
            font-size: 10px;
            font-weight: 900;
            border-radius: 50px;
            text-transform: uppercase;
            margin: 20px 0;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--theme-color);
            color: var(--contrast-color);
        }

        .generate-btn:active {
            transform: scale(0.98);
        }

        .btn-retour-liste {
            background-color: var(--theme-color);
            color: var(--contrast-color);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 900;
            font-size: 10px;
            text-transform: uppercase;
            transition: transform 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            text-decoration: none;
        }

        .btn-retour-liste:active {
            transform: scale(0.95);
        }

        .btn-reset {
            width: 100%;
            font-weight: 800;
            padding: 12px;
            border-radius: 50px;
            font-size: 10px;
            text-align: center;
            cursor: pointer;
            border: none;
            text-transform: uppercase;
            transition: transform 0.2s;
        }

        .btn-reset:active {
            transform: scale(0.98);
        }

        /* ========== GRILLE D'√âQUIPES ========== */
        .grid-teams { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 10px;
        }

        @media (min-width: 768px) {
            .grid-teams {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .grid-teams {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* ========== CARTES D'√âQUIPES ========== */
        .team-card { 
            border-radius: 1.2rem;
            padding: 10px;
            background: var(--card-bg);
            border: 1px solid var(--header-border);
        }

        .team-header {
            border-bottom: 1px solid var(--header-border);
            margin-bottom: 8px;
            padding-bottom: 4px;
        }

        .team-title {
            font-weight: 900;
            font-size: 0.65rem;
            color: var(--text);
            text-transform: uppercase;
        }

        .team-stats {
            font-size: 0.5rem;
            color: var(--title-gray);
            display: block;
            line-height: 1.4;
        }

        .team-member {
            display: flex;
            align-items: center;
            margin-bottom: 1px;
            font-size: 0.65rem;
            font-weight: bold;
        }

        @media (min-width: 768px) {
            .team-member {
                font-size: 0.8rem !important;
                margin-bottom: 8px;
            }
        }

        @media (min-width: 1024px) {
            .team-member {
                font-size: 0.9rem !important;
                margin-bottom: 9px;
            }
        }

        .tag { 
            font-size: 0.45rem;
            font-weight: 700;
            margin-right: 8px;
            padding: 2px 6px;
            border-radius: 999px;
            color: #fff;
            min-width: 35px;
            text-align: center;
        }

        @media (min-width: 768px) {
            .tag {
                font-size: 0.55rem !important;
                padding: 4px 10px;
            }
        }

        @media (min-width: 1024px) {
            .tag {
                font-size: 0.6rem !important;
                padding: 5px 12px;
                min-width: 45px;
            }
        }

        .name-f {
            color: var(--student-name-girl);
        }

        .name-g {
            color: var(--student-name-boy);
        }

        /* ========== MODAUX ========== */
        .modal-overlay { 
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content { 
            background: var(--card-bg);
            padding: 24px;
            border-radius: 24px;
            width: 100%;
            max-width: 360px;
            color: var(--text);
            border: 1px solid var(--header-border);
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 900;
            font-size: 10px;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>

    <!-- ========== HEADER ========== -->
    <header>
        <a href="index.html" id="btn-retour" class="header-btn shadow-lg" aria-label="Retour √† l'accueil">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="mainTitle">√âquipes</h1>
        <button id="btn-aide" class="header-btn shadow-lg text-lg" aria-label="Aide">üí°</button>
    </header>
    
    <!-- ========== BOUTON RETOUR LISTE ========== -->
    <div class="w-full flex justify-start mb-4 mt-2" style="max-width: 95%;">
        <a href="outils.html" id="btn-retour-liste" class="btn-retour-liste">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux outils
        </a>
    </div>

    <!-- ========== SECTION DE PR√âSENCE ========== -->
    <div id="attendance-container"></div>

    <!-- ========== S√âLECTEUR DE NOMBRE D'√âQUIPES ========== -->
    <p class="section-title">Nombre d'√©quipes</p>
    <div class="flex gap-2 mb-4" id="selector"></div>

    <!-- ========== BOUTON G√âN√âRER ========== -->
    <button id="main-generate-btn" class="generate-btn">G√©n√©rer les √©quipes</button>

    <!-- ========== R√âSULTATS DES √âQUIPES ========== -->
    <div id="results" class="grid-teams"></div>

    <!-- ========== BOUTON R√âINITIALISATION ========== -->
    <div class="w-full max-w-[400px] mt-5 mb-10 px-[10px]">
        <button id="reset-btn" class="btn-reset bg-red-500 text-white shadow-lg">‚ö†Ô∏è effacer les √©quipes</button>
    </div>

    <!-- ========== MODAL D'AIDE ========== -->
    <div id="modal-aide" class="modal-overlay">
        <div class="modal-content">
            <h2 id="titre-aide" class="text-lg font-black uppercase mb-4">üí° √âquipes √©quilibr√©es</h2>
            <div class="text-[11px] leading-relaxed space-y-3 opacity-90">
                <p><b>üë• Gestion de la pr√©sence :</b></p>
                <p class="pl-3">Cliquez sur le nom d'un √©l√®ve pour le marquer absent (il appara√Ætra barr√© et gris√©). Les √©l√®ves absents ne seront pas inclus dans les √©quipes g√©n√©r√©es.</p>
                
                <p><b>üî¢ Nombre d'√©quipes :</b></p>
                <p class="pl-3">S√©lectionnez le nombre d'√©quipes souhait√© (de 2 √† 8) avant de cliquer sur "G√©n√©rer les √©quipes".</p>
                
                <p><b>‚öñÔ∏è Algorithme d'√©quilibrage :</b></p>
                <p class="pl-3">L'algorithme r√©partit automatiquement les √©l√®ves pour cr√©er des √©quipes les plus √©quilibr√©es possible en tenant compte de :</p>
                <ul class="pl-6 space-y-0">
                    <li>‚Ä¢ La r√©partition filles/gar√ßons</li>
                    <li>‚Ä¢ La distribution des niveaux scolaires (CP, CE1, CE2, CM1, CM2)</li>
                </ul>
                
                <p><b>üíæ Sauvegarde :</b></p>
                <p class="pl-3">Les √©quipes g√©n√©r√©es sont automatiquement sauvegard√©es. Elles restent affich√©es m√™me si vous quittez la page.</p>
                
                <p><b>‚ö†Ô∏è R√©initialisation :</b></p>
                <p class="pl-3">Le bouton rouge "Effacer les √©quipes" supprime les √©quipes g√©n√©r√©es et vous permet de recommencer.</p>
            </div>
            <button id="btn-fermer-aide" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest active:scale-95 transition-transform" style="background-color: var(--theme-color); color: var(--contrast-color);">Fermer</button>
        </div>
    </div>

    <!-- ========== MODAL DE CONFIRMATION ========== -->
    <div id="alertModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="font-black uppercase text-center mb-2">Confirmation</h3>
            <p id="alertText" class="text-center text-sm mb-4"></p>
            <div class="flex gap-2">
                <button id="btn-cancel" class="modal-btn bg-gray-200 text-gray-700">Annuler</button>
                <button id="alertConfirmBtn" class="modal-btn text-white">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION & CONSTANTES ========== 
        const CONFIG = {
            TEAM_RANGE: { min: 2, max: 8 },
            ALGORITHM_ITERATIONS: 300,
            DEFAULT_TEAM_COUNT: 4
        };

        const COLOR_MAP = {
            'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
            'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
            'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
            'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
            'rose': '#f43f5e', 'gray': '#666666'
        };

        const LEVEL_COLORS = {
            'CP': '#ec4899',
            'CE1': '#3b82f6',
            'CE2': '#eab308',
            'CM1': '#ef4444',
            'CM2': '#22c55e',
            'AUTRE': '#a855f7'
        };

        const LEVEL_ORDER = ['CP', 'CE1', 'CE2', 'CM1', 'CM2', 'AUTRE'];

        const STORAGE_KEYS = {
            students: 'maListeEleves',
            absents: 'absents_session_equipes',
            savedTeams: 'savedTeams',
            theme: 'theme_tuiles',
            themeMode: 'theme_mode',
            levelPalette: 'palette_niveaux'
        };

        const LIGHT_CONTRAST_COLORS = ['yellow', 'lime', 'amber', 'cyan'];

        // ========== √âTAT DE L'APPLICATION ========== 
        const state = {
            selectedNumTeams: CONFIG.DEFAULT_TEAM_COUNT,
            allStudents: JSON.parse(localStorage.getItem(STORAGE_KEYS.students)) || [],
            absentSet: new Set(JSON.parse(localStorage.getItem(STORAGE_KEYS.absents)) || [])
        };

        // ========== √âL√âMENTS DOM ========== 
        const elements = {
            mainTitle: document.getElementById('mainTitle'),
            btnRetour: document.getElementById('btn-retour'),
            btnRetourListe: document.getElementById('btn-retour-liste'),
            btnAide: document.getElementById('btn-aide'),
            btnFermerAide: document.getElementById('btn-fermer-aide'),
            btnReset: document.getElementById('reset-btn'),
            btnCancel: document.getElementById('btn-cancel'),
            attendanceContainer: document.getElementById('attendance-container'),
            selector: document.getElementById('selector'),
            mainGenerateBtn: document.getElementById('main-generate-btn'),
            results: document.getElementById('results'),
            modalAide: document.getElementById('modal-aide'),
            alertModal: document.getElementById('alertModal'),
            alertText: document.getElementById('alertText'),
            alertConfirmBtn: document.getElementById('alertConfirmBtn'),
            titreAide: document.getElementById('titre-aide')
        };

        // ========== FONCTIONS UTILITAIRES ========== 
        function getDisplayName(student, allStudentsArray) {
            const firstName = student.identite.trim().split(" ")[0];
            const hasDuplicate = allStudentsArray.some(s =>
                s.id !== student.id &&
                s.identite.trim().split(" ")[0].toLowerCase() === firstName.toLowerCase()
            );
            return hasDuplicate && student.identite.split(" ")[1]
                ? `${firstName} ${student.identite.split(" ")[1].charAt(0)}.`
                : firstName;
        }

        function getNormalizedLevel(student) {
            return student.niveau.toString().trim().toUpperCase();
        }

        function getGenderClass(student) {
            return student.sexe.toLowerCase().startsWith('f') ? 'bg-f' : 'bg-m';
        }

        function getGenderNameClass(student) {
            return student.sexe.toLowerCase().startsWith('f') ? 'name-f' : 'name-g';
        }

        function isFemale(student) {
            return student.sexe.toLowerCase().startsWith('f');
        }

        // ========== STATISTIQUES D'√âQUIPE ========== 
        function getTeamStats(team) {
            const stats = {
                f: 0,
                m: 0,
                total: team.length,
                levels: {}
            };
            
            // Initialiser les statistiques de niveau
            LEVEL_ORDER.forEach(level => {
                stats.levels[level.toLowerCase()] = { f: 0, m: 0, total: 0 };
            });

            // Calculer les statistiques
            team.forEach(student => {
                const female = isFemale(student);
                const level = getNormalizedLevel(student);
                const levelKey = level.toLowerCase();

                if (female) stats.f++;
                else stats.m++;

                if (stats.levels[levelKey]) {
                    stats.levels[levelKey].total++;
                    if (female) stats.levels[levelKey].f++;
                    else stats.levels[levelKey].m++;
                }
            });

            return stats;
        }

        function calculateScore(stats1, stats2) {
            let score = 0;
            
            // P√©nalit√© pour diff√©rence de genre
            score += Math.abs(stats1.f - stats2.f) * 10;
            score += Math.abs(stats1.m - stats2.m) * 10;

            // P√©nalit√© pour diff√©rence de niveau
            LEVEL_ORDER.forEach(level => {
                const levelKey = level.toLowerCase();
                score += Math.abs(stats1.levels[levelKey].f - stats2.levels[levelKey].f) * 20;
                score += Math.abs(stats1.levels[levelKey].total - stats2.levels[levelKey].total) * 5;
            });

            return score;
        }

        // ========== GESTION DES COULEURS ET TH√àMES ========== 
        function applySexColors() {
            const prefs = JSON.parse(localStorage.getItem(STORAGE_KEYS.theme));
            if (!prefs) return;

            if (prefs.fille && COLOR_MAP[prefs.fille]) {
                document.documentElement.style.setProperty('--student-name-girl', COLOR_MAP[prefs.fille]);
            }
            if (prefs.garcon && COLOR_MAP[prefs.garcon]) {
                document.documentElement.style.setProperty('--student-name-boy', COLOR_MAP[prefs.garcon]);
            }
        }

        function applyTheme() {
            const isLight = localStorage.getItem(STORAGE_KEYS.themeMode) === 'light';
            document.body.classList.toggle('light-mode', isLight);

            const themePrefs = JSON.parse(localStorage.getItem(STORAGE_KEYS.theme)) || {};
            // PRIORIT√â : Couleur 'outils' pour harmoniser avec les autres pages
            const colorName = themePrefs.outils || 'blue';
            const colorHex = COLOR_MAP[colorName] || '#3b82f6';
            const textColor = LIGHT_CONTRAST_COLORS.includes(colorName) ? '#000000' : '#ffffff';

            document.documentElement.style.setProperty('--theme-color', colorHex);
            document.documentElement.style.setProperty('--contrast-color', textColor);

            // Appliquer au titre de l'aide
            if (elements.titreAide) {
                elements.titreAide.style.color = colorHex;
            }
        }

        // ========== GESTION DES MODAUX ========== 
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
        }

        // ========== RENDU DE LA PR√âSENCE ========== 
        function renderAttendance() {
            const customPalette = JSON.parse(localStorage.getItem(STORAGE_KEYS.levelPalette)) || {};
            const groups = {};

            // Grouper les √©l√®ves par niveau
            state.allStudents.forEach(student => {
                const level = getNormalizedLevel(student);
                if (!groups[level]) groups[level] = [];
                groups[level].push(student);
            });

            let html = '';

            // Rendre chaque niveau dans l'ordre
            LEVEL_ORDER.forEach(level => {
                if (groups[level] && groups[level].length > 0) {
                    const levelColor = customPalette[level] || customPalette[level.toLowerCase()] || LEVEL_COLORS[level];
                    html += `<div class="level-label" style="color:${levelColor}">${level}</div><div class="attendance-grid">`;

                    groups[level]
                        .sort((a, b) => a.identite.localeCompare(b.identite))
                        .forEach(student => {
                            const isAbsent = state.absentSet.has(String(student.id));
                            const genderClass = getGenderClass(student);
                            const absentClass = isAbsent ? 'absent' : '';
                            const displayName = getDisplayName(student, state.allStudents);
                            html += `<div class="student-item ${genderClass} ${absentClass}" data-student-id="${student.id}">${displayName}</div>`;
                        });

                    html += `</div>`;
                }
            });

            elements.attendanceContainer.innerHTML = html;

            // Ajouter les √©v√©nements de clic
            document.querySelectorAll('.student-item').forEach(item => {
                item.addEventListener('click', () => toggleAbsent(item.dataset.studentId));
            });
        }

        function toggleAbsent(studentId) {
            const id = String(studentId);
            
            if (state.absentSet.has(id)) {
                state.absentSet.delete(id);
            } else {
                state.absentSet.add(id);
            }
            
            localStorage.setItem(STORAGE_KEYS.absents, JSON.stringify(Array.from(state.absentSet)));
            renderAttendance();
        }

        // ========== S√âLECTION DU NOMBRE D'√âQUIPES ========== 
        function selectTeamCount(count) {
            state.selectedNumTeams = count;
            const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-color').trim();
            const contrastColor = getComputedStyle(document.documentElement).getPropertyValue('--contrast-color').trim();

            document.querySelectorAll('.num-btn').forEach(btn => {
                const btnValue = parseInt(btn.dataset.count);
                const isSelected = btnValue === count;
                
                btn.style.backgroundColor = isSelected ? themeColor : 'var(--btn-num-bg)';
                btn.style.color = isSelected ? contrastColor : 'var(--text)';
                btn.style.borderColor = isSelected ? themeColor : 'var(--btn-num-border)';
            });
        }

        // ========== ALGORITHME DE G√âN√âRATION D'√âQUIPES ========== 
        function generateBalancedTeams() {
            const presentStudents = state.allStudents.filter(s => !state.absentSet.has(String(s.id)));

            if (presentStudents.length < state.selectedNumTeams) {
                alert(`Pas assez d'√©l√®ves pr√©sents pour former ${state.selectedNumTeams} √©quipes.`);
                return;
            }

            // Initialiser les √©quipes
            let teams = Array.from({ length: state.selectedNumTeams }, () => []);
            let shuffled = [...presentStudents].sort(() => Math.random() - 0.5);
            shuffled.forEach((student, idx) => teams[idx % state.selectedNumTeams].push(student));

            // Algorithme d'optimisation
            for (let iteration = 0; iteration < CONFIG.ALGORITHM_ITERATIONS; iteration++) {
                for (let i = 0; i < teams.length; i++) {
                    for (let j = 0; j < teams.length; j++) {
                        if (i === j) continue;

                        const currentScore = calculateScore(getTeamStats(teams[i]), getTeamStats(teams[j]));

                        for (let x = 0; x < teams[i].length; x++) {
                            for (let y = 0; y < teams[j].length; y++) {
                                // √âchanger
                                const temp = teams[i][x];
                                teams[i][x] = teams[j][y];
                                teams[j][y] = temp;

                                const newScore = calculateScore(getTeamStats(teams[i]), getTeamStats(teams[j]));

                                if (newScore >= currentScore) {
                                    // Annuler l'√©change si pas d'am√©lioration
                                    teams[j][y] = teams[i][x];
                                    teams[i][x] = temp;
                                }
                            }
                        }
                    }
                }
            }

            localStorage.setItem(STORAGE_KEYS.savedTeams, JSON.stringify(teams));
            renderTeams(teams);
        }

        // ========== RENDU DES √âQUIPES ========== 
        function renderTeams(teams) {
            const customPalette = JSON.parse(localStorage.getItem(STORAGE_KEYS.levelPalette)) || {};
            let html = '';

            teams.forEach((team, teamIdx) => {
                const stats = getTeamStats(team);
                
                html += `<div class="team-card">
                    <div class="team-header">
                        <span class="team-title">√âquipe ${teamIdx + 1}</span>
                        <span class="team-stats">${stats.f}F/${stats.m}G</span>
                    </div>`;

                // Trier l'√©quipe par ordre de niveau
                team.sort((a, b) => {
                    const levelA = getNormalizedLevel(a);
                    const levelB = getNormalizedLevel(b);
                    const indexA = LEVEL_ORDER.indexOf(levelA);
                    const indexB = LEVEL_ORDER.indexOf(levelB);
                    return (indexA === -1 ? 99 : indexA) - (indexB === -1 ? 99 : indexB);
                });

                // Ajouter les membres de l'√©quipe
                team.forEach(student => {
                    const level = getNormalizedLevel(student);
                    const tagColor = customPalette[level] || customPalette[level.toLowerCase()] || LEVEL_COLORS[level] || '#888';
                    const genderClass = getGenderNameClass(student);
                    const displayName = getDisplayName(student, state.allStudents);
                    
                    html += `<div class="team-member">
                        <span class="tag" style="background-color:${tagColor}">${level}</span>
                        <span class="${genderClass}">${displayName}</span>
                    </div>`;
                });

                html += `</div>`;
            });

            elements.results.innerHTML = html;
        }

        // ========== R√âINITIALISATION DES √âQUIPES ========== 
        function resetTeams() {
            elements.alertText.innerText = "Voulez-vous effacer les √©quipes ?";
            
            const themeColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-color');
            elements.alertConfirmBtn.style.backgroundColor = themeColor;
            elements.alertConfirmBtn.onclick = () => {
                localStorage.removeItem(STORAGE_KEYS.savedTeams);
                elements.results.innerHTML = '';
                closeModal('alertModal');
            };
            
            openModal('alertModal');
        }

        // ========== INITIALISATION DES √âV√âNEMENTS ========== 
        function initEventListeners() {
            // Boutons du header
            elements.btnAide.addEventListener('click', () => openModal('modal-aide'));
            elements.btnFermerAide.addEventListener('click', () => closeModal('modal-aide'));
            
            // Bouton g√©n√©rer
            elements.mainGenerateBtn.addEventListener('click', generateBalancedTeams);
            
            // Bouton r√©initialiser
            elements.btnReset.addEventListener('click', resetTeams);
            
            // Bouton annuler du modal
            elements.btnCancel.addEventListener('click', () => closeModal('alertModal'));
            
            // Fermeture des modaux en cliquant sur l'overlay
            elements.modalAide.addEventListener('click', (e) => {
                if (e.target === elements.modalAide) closeModal('modal-aide');
            });
            
            elements.alertModal.addEventListener('click', (e) => {
                if (e.target === elements.alertModal) closeModal('alertModal');
            });
            
            // Emp√™cher la fermeture en cliquant sur le contenu
            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', (e) => e.stopPropagation());
            });
        }

        // ========== INITIALISATION DU S√âLECTEUR D'√âQUIPES ========== 
        function initTeamSelector() {
            for (let i = CONFIG.TEAM_RANGE.min; i <= CONFIG.TEAM_RANGE.max; i++) {
                const btn = document.createElement('button');
                btn.className = 'num-btn';
                btn.innerText = i;
                btn.dataset.count = i;
                btn.addEventListener('click', () => selectTeamCount(i));
                elements.selector.appendChild(btn);
            }
            
            selectTeamCount(state.selectedNumTeams);
        }

        // ========== INITIALISATION PRINCIPALE ========== 
        function init() {
            applySexColors();
            applyTheme();
            initTeamSelector();
            initEventListeners();
            renderAttendance();

            // Charger les √©quipes sauvegard√©es si elles existent
            const savedTeams = localStorage.getItem(STORAGE_KEYS.savedTeams);
            if (savedTeams) {
                renderTeams(JSON.parse(savedTeams));
            }
        }

        // D√©marrage de l'application
        window.onload = init;
    </script>

</body>
</html>