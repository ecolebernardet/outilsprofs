<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>G√©n√©rateur de Quizz - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        /* ===== VARIABLES CSS ===== */
        :root {
            --bg-page: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1);
            --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee;
            --card-bg: #ffffff;
            --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1);
            --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* ===== BASE ===== */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            transition: background 0.3s ease;
        }
        
        /* ===== HEADER ===== */
        header { 
            background: var(--card-bg);
            border-bottom: 1px solid var(--column-border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px;
            width: 100%;
            margin-bottom: 12px;
        }

        header h1 {
            font-size: 1.125rem;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            flex-grow: 1;
        }

        /* ===== BOUTONS ===== */
        .ui-btn-round {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }

        .btn-add {
            width: 100%;
            padding: 14px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 12px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-add:active {
            transform: scale(0.95);
        }

        .btn-game-action {
            height: 40px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 900;
            color: white;
            transition: all 0.2s ease;
            text-transform: uppercase;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        /* ===== LAYOUT ===== */
        .main-wrapper {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            padding: 10px 15px 40px;
            transition: all 0.3s ease;
        }

        .light-card {
            background: var(--card-bg);
            border-radius: 1.5rem;
            padding: 20px;
            border: 1px solid var(--column-border);
            box-shadow: var(--shadow-custom);
            margin-bottom: 20px;
        }
        
        /* ===== INPUTS ===== */
        .input-field {
            background: var(--input-bg);
            border: 1px solid var(--column-border);
            border-radius: 0.75rem;
            padding: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            width: 100%;
            color: var(--text-main);
            outline: none;
        }

        /* ===== QUESTIONS ===== */
        .q-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 12px;
            border: 1px solid var(--column-border);
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 60px;
        }
            
        .res-text {
            color: #10b981;
            font-weight: 800;
            font-size: 0.9rem;
            border-top: 1px dashed var(--column-border);
            padding-top: 8px;
        }

        /* ===== UTILITY ===== */
        .hidden {
            display: none !important;
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 1.5rem;
            border: 1px solid var(--column-border);
            padding: 25px;
            position: relative;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 767px) {
            #game-zone .grid-cols-2 {
                grid-template-columns: repeat(2, 1fr) !important;
                display: grid !important;
            }
            
            .btn-game-action {
                height: 48px;
                font-size: 11px;
            }

            .main-wrapper {
                padding-bottom: 120px !important;
            }
            
            #game-zone {
                padding-bottom: 40px;
            }
        }

        #game-zone .grid-cols-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding-bottom: 20px;
        }
    </style>
</head>
<body>

<script>
    if (localStorage.getItem('theme_mode') === 'light') {
        document.body.classList.add('light-mode');
    }
</script>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1>G√©n√©rateur de Quiz</h1>
    <button id="btn-aide" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div id="container-retour-liste" class="mb-4">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux g√©n√©rateurs
        </a>
    </div>

    <div id="setup-zone" class="light-card space-y-4">
        <div class="space-y-4">
            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest">Titre du Quiz</label>
                <input type="text" id="quiz-title" class="input-field mb-2" placeholder="Ex: Histoire - Les Rois de France">

                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest">Questions / R√©ponses</label>
                <textarea id="quiz-data" class="input-field h-48 text-left font-normal" placeholder="Question 1 ; R√©ponse 1&#10;Question 2 ; R√©ponse 2"></textarea>
                
                <div class="flex flex-row items-center justify-between gap-2 mt-4">
                    <div class="flex gap-2">
                        <button id="btn-example" class="px-2 py-1.5 rounded-lg border border-cyan-500/30 text-[8px] font-bold uppercase text-cyan-500 hover:bg-cyan-500/10 transition-colors">Exemple</button>
                        <button id="btn-clear-all" class="px-2 py-1.5 rounded-lg border border-red-500/30 text-[8px] font-bold uppercase text-red-500 hover:bg-red-500/10 transition-colors">Vider</button>
                    </div>
    
                    <label id="label-import" class="cursor-pointer px-4 py-2 rounded-full bg-emerald-500 text-white text-[9px] font-black uppercase flex items-center gap-2 shadow-md active:scale-95 transition-transform whitespace-nowrap">
                        üì• Importer .txt
                        <input type="file" id="import-txt" class="hidden" accept=".txt">
                    </label>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <div class="flex items-end gap-3">
                <div class="pb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[var(--accent-color)] opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div class="grid grid-cols-2 gap-3 flex-grow">
                    <div>
                        <label class="block text-[8px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Minutes</label>
                        <input type="number" id="timer-min" value="0" min="0" class="input-field text-center">
                    </div>
                    <div>
                        <label class="block text-[8px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Secondes</label>
                        <input type="number" id="timer-sec" value="30" min="0" max="59" class="input-field text-center">
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Sonnerie de fin</label>
                <div class="flex gap-2">
                    <select id="sound-select" class="input-field text-center">
                        <option value="zen">üîî Zen Bowl (Gong)</option>
                        <option value="none">üîá Muet</option>
                    </select>
                    <button id="btn-test-sound" class="ui-btn-round active:scale-90" title="Tester le son">üîä</button>
                </div>
            </div>
            
            <label class="flex items-center gap-3 cursor-pointer p-2 bg-white/5 rounded-xl border border-white/5">
                <input type="checkbox" id="shuffle-order" class="w-4 h-4 accent-cyan-500" checked>
                <span class="text-[10px] font-black uppercase">M√©langer les questions</span>
            </label>
        </div>

        <button id="btn-start-quiz" class="btn-add">Lancer le Quiz</button>
    </div>

    <div id="game-zone" class="hidden space-y-6 px-4 md:px-0">
        <div id="timer-display" class="text-center p-3 rounded-xl bg-amber-500/10 border border-amber-500/20">
            <span class="text-[10px] font-black uppercase opacity-50 tracking-widest">Temps restant</span>
            <div id="seconds-left" class="text-2xl font-black text-amber-500">0:00</div>
        </div>
        
        <div id="questions-grid" class="grid grid-cols-1 gap-3"></div>
        
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 pt-4">
            <button id="btn-back" class="btn-game-action bg-gray-500">‚¨ÖÔ∏è retour</button>
            <button id="btn-replay" class="btn-game-action bg-amber-500">üîÑ rejouer</button>
            <button id="btn-validate" class="btn-game-action bg-green-500">üëÅÔ∏è correction</button>
            <button id="btn-export-pdf" class="btn-game-action bg-blue-500">üìÑ PDF</button>
            <button id="btn-export-txt" class="btn-game-action bg-zinc-600">üìù TXT</button>
        </div>
    </div>
</div>

<!-- Modal Aide -->
<div id="modal-aide" class="modal-overlay">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide" class="text-lg font-black uppercase mb-4">üí° Aide Quiz</h2>
        <div class="text-[11px] leading-relaxed space-y-4">
            <p>1. <b>Saisie :</b> Saisissez un titre puis une question par ligne au format <br><code class="bg-black/20 p-1 rounded">Question ; R√©ponse</code></p>
            <p>2. <b>Import :</b> Vous pouvez importer un fichier texte (.txt) d√©j√† pr√©par√©.</p>
            <p>3. <b>Chrono :</b> Param√©trez le temps. Si vous r√©glez √† 0:00, le temps est illimit√©.</p>
            <p>4. <b>Export :</b> G√©n√©rez une fiche PDF ou un fichier TXT nomm√© selon votre titre et la date.</p>
        </div>
        <button id="btn-close-aide" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">J'ai compris</button>
    </div>
</div>

<!-- Modal Erreur -->
<div id="modal-erreur" class="modal-overlay">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="text-center">
            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
            <h2 id="titre-erreur" class="text-lg font-black uppercase mb-2">Saisie vide</h2>
            <p class="text-[11px] opacity-80 leading-relaxed mb-6">
                Veuillez saisir au moins une question au format : <br>
                <span class="font-bold italic">Question ; R√©ponse</span>
            </p>
            <button id="btn-close-erreur" class="w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest text-white">D'accord</button>
        </div>
    </div>
</div>

<!-- Modal Fin -->
<div id="modal-fin" class="modal-overlay">
    <div class="modal-content text-center">
        <div class="text-6xl mb-4">üîî</div>
        <h2 id="titre-fin" class="text-2xl font-black uppercase mb-2">Temps √©coul√© !</h2>
        <button id="btn-close-fin" class="btn-game-action bg-green-500 w-full h-12 text-sm">Voir les r√©sultats</button>
    </div>
</div>

<!-- Modal Effacer -->
<div id="modal-effacer" class="modal-overlay">
    <div class="modal-content text-center" onclick="event.stopPropagation()">
        <div class="text-4xl mb-4">üóëÔ∏è</div>
        <h2 id="titre-effacer" class="text-lg font-black uppercase mb-2">Tout effacer ?</h2>
        <p class="text-[11px] opacity-80 leading-relaxed mb-6">Cette action supprimera le titre et toutes les questions.</p>
        <div class="flex gap-3">
            <button id="btn-cancel-effacer" class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest bg-gray-500 text-white">Annuler</button>
            <button id="btn-confirm-effacer" class="flex-1 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest text-white">Effacer</button>
        </div>
    </div>
</div>

<script>
    // ===== CONFIGURATION =====
    const CONFIG = {
        exampleData: {
            title: "Culture G√©n√©rale",
            questions: "Capitale du Japon ? ; Tokyo\nQuel est le plus grand oc√©an ? ; Pacifique\nCombien font 9 x 8 ? ; 72\nQui a peint la Joconde ? ; L√©onard de Vinci"
        },
        storageKeys: {
            theme: 'theme_mode',
            themeTiles: 'theme_tuiles'
        },
        colors: {
            'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
            'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
            'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
            'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
            'rose': '#f43f5e', 'gray': '#6b7280'
        },
        lightColors: ['yellow', 'lime', 'amber', 'cyan']
    };

    // ===== STATE =====
    let currentQuestions = [];
    let countdown = null;

    // ===== DOM ELEMENTS =====
    const elements = {
        // Setup zone
        setupZone: document.getElementById('setup-zone'),
        containerRetourListe: document.getElementById('container-retour-liste'),
        quizTitle: document.getElementById('quiz-title'),
        quizData: document.getElementById('quiz-data'),
        timerMin: document.getElementById('timer-min'),
        timerSec: document.getElementById('timer-sec'),
        soundSelect: document.getElementById('sound-select'),
        shuffleOrder: document.getElementById('shuffle-order'),
        importTxt: document.getElementById('import-txt'),
        
        // Game zone
        gameZone: document.getElementById('game-zone'),
        timerDisplay: document.getElementById('timer-display'),
        secondsLeft: document.getElementById('seconds-left'),
        questionsGrid: document.getElementById('questions-grid'),
        
        // Buttons
        btnExample: document.getElementById('btn-example'),
        btnClearAll: document.getElementById('btn-clear-all'),
        btnTestSound: document.getElementById('btn-test-sound'),
        btnStartQuiz: document.getElementById('btn-start-quiz'),
        btnBack: document.getElementById('btn-back'),
        btnReplay: document.getElementById('btn-replay'),
        btnValidate: document.getElementById('btn-validate'),
        btnExportPdf: document.getElementById('btn-export-pdf'),
        btnExportTxt: document.getElementById('btn-export-txt'),
        btnAide: document.getElementById('btn-aide'),
        btnCloseAide: document.getElementById('btn-close-aide'),
        btnCloseErreur: document.getElementById('btn-close-erreur'),
        btnCloseFin: document.getElementById('btn-close-fin'),
        btnCancelEffacer: document.getElementById('btn-cancel-effacer'),
        btnConfirmEffacer: document.getElementById('btn-confirm-effacer'),
        
        // Modals
        modalAide: document.getElementById('modal-aide'),
        modalErreur: document.getElementById('modal-erreur'),
        modalFin: document.getElementById('modal-fin'),
        modalEffacer: document.getElementById('modal-effacer')
    };

    // ===== UTILITY FUNCTIONS =====
    function cleanStringForFilename(str) {
        return str
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .replace(/\s+/g, '_')
            .replace(/[^a-z0-9_]/gi, '');
    }

    function getCurrentDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function parseQuestions(text) {
        return text
            .split('\n')
            .map(line => {
                const parts = line.split(';');
                return {
                    q: parts[0] ? parts[0].trim() : "",
                    r: parts[1] ? parts[1].trim() : "???"
                };
            })
            .filter(item => item.q);
    }

    // ===== MODAL FUNCTIONS =====
    function openModal(modal) {
        modal.style.display = 'flex';
    }

    function closeModal(modal) {
        modal.style.display = 'none';
    }

    // ===== THEME FUNCTIONS =====
    function applyTheme() {
        const themePrefs = JSON.parse(localStorage.getItem(CONFIG.storageKeys.themeTiles) || '{}');
        const colorName = themePrefs.gen || 'cyan';
        const accentColor = CONFIG.colors[colorName];
        const isLight = CONFIG.lightColors.includes(colorName);
        const contrastColor = isLight ? '#000' : '#fff';
        
        document.documentElement.style.setProperty('--accent-color', accentColor);
        
        const themedElements = [
            document.getElementById('btn-retour-header'),
            document.getElementById('btn-retour-liste'),
            elements.btnAide,
            elements.btnStartQuiz,
            elements.btnCloseAide,
            elements.btnCloseFin,
            elements.btnTestSound,
            elements.btnCloseErreur,
            elements.btnConfirmEffacer,
            document.getElementById('label-import')
        ];

        themedElements.forEach(el => {
            if (el) {
                el.style.backgroundColor = accentColor;
                el.style.color = contrastColor;
            }
        });
        
        ['titre-aide', 'titre-erreur', 'titre-effacer'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.color = accentColor;
        });
    }

    // ===== EXAMPLE AND CLEAR FUNCTIONS =====
    function addExample() {
        elements.quizTitle.value = CONFIG.exampleData.title;
        elements.quizData.value = CONFIG.exampleData.questions;
    }

    function clearAll() {
        openModal(elements.modalEffacer);
    }
    
    function confirmClear() {
        elements.quizTitle.value = "";
        elements.quizData.value = "";
        closeModal(elements.modalEffacer);
    }

    // ===== SOUND FUNCTIONS =====
    function playSound() {
        const soundType = elements.soundSelect.value;
        if (soundType === 'none') return;
        
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const now = context.currentTime;
        const osc = context.createOscillator();
        const gain = context.createGain();
        
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, now);
        gain.gain.setValueAtTime(0.4, now);
        gain.gain.exponentialRampToValueAtTime(0.001, now + 2.5);
        
        osc.connect(gain);
        gain.connect(context.destination);
        osc.start();
        osc.stop(now + 2.5);
    }

    // ===== IMPORT/EXPORT FUNCTIONS =====
    function importFromTXT(file) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split('\n');
            
            // Extract title if present
            const titleLine = lines.find(l => l.toUpperCase().startsWith('TITRE :'));
            if (titleLine) {
                elements.quizTitle.value = titleLine.split(':')[1].trim();
            }
            
            // Extract questions
            const data = lines.filter(l => l.includes(';'));
            if (data.length > 0) {
                elements.quizData.value = data.map(l => l.trim()).join('\n');
            }
        };
        reader.readAsText(file);
        elements.importTxt.value = '';
    }

    function exportToTXT() {
        const titleInput = elements.quizTitle.value || "quizz";
        const textData = elements.quizData.value.trim();
        
        if (!textData) {
            openModal(elements.modalErreur);
            return;
        }

        const dateStr = getCurrentDate();
        const filename = `outilsprofs_quizz_${cleanStringForFilename(titleInput)}_${dateStr}.txt`;
        const content = `TITRE : ${titleInput}\nDATE : ${dateStr}\n\n${textData}`;

        if (window.Android && window.Android.savePdfFromBase64) {
            const base64String = btoa(unescape(encodeURIComponent(content)));
            window.Android.savePdfFromBase64(base64String, filename);
        } else {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 300);
        }
    }

    function exportToPDF() {
        const textData = elements.quizData.value.trim();
        if (!textData) {
            openModal(elements.modalErreur);
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const titleInput = elements.quizTitle.value || "quizz";
        const dateStr = getCurrentDate();
        const filename = `outilsprofs_quiz_${cleanStringForFilename(titleInput)}_${dateStr}_.pdf`;

        const questionsToPrint = parseQuestions(textData);

        const drawPage = (subTitle, showAnswers) => {
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.text(`${titleInput} - ${subTitle}`, 105, 20, { align: 'center' });
            doc.setFontSize(10);
            
            let y = 40;
            questionsToPrint.forEach((item, i) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFont("helvetica", "bold");
                doc.text(`${i + 1}. ${item.q}`, 20, y);
                y += 7;
                
                if (showAnswers) {
                    doc.setFont("helvetica", "italic");
                    doc.setTextColor(16, 185, 129);
                    doc.text(item.r, 25, y);
                    doc.setTextColor(0, 0, 0);
                    y += 10;
                } else {
                    doc.text("________________________________________________", 25, y);
                    y += 12;
                }
            });
        };

        // Student sheet
        drawPage("Fiche Eleve", false);
        
        // Answer key
        doc.addPage();
        drawPage("Corrig√©", true);

        // Save PDF (Android compatibility)
        if (window.Android && window.Android.savePdfFromBase64) {
            const pdfBase64 = doc.output('datauristring').split(',')[1];
            window.Android.savePdfFromBase64(pdfBase64, filename);
        } else {
            doc.save(filename);
        }
    }

    // ===== TIMER FUNCTIONS =====
    function startTimer() {
        clearInterval(countdown);
        
        const mins = parseInt(elements.timerMin.value) || 0;
        const secs = parseInt(elements.timerSec.value) || 0;
        let timeLeft = (mins * 60) + secs;
        
        if (timeLeft <= 0) {
            elements.timerDisplay.classList.add('hidden');
            return;
        }
        
        elements.timerDisplay.classList.remove('hidden');
        
        const updateDisplay = () => {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            elements.secondsLeft.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            
            if (timeLeft <= 0) {
                clearInterval(countdown);
                playSound();
                openModal(elements.modalFin);
            }
            timeLeft--;
        };
        
        updateDisplay();
        countdown = setInterval(updateDisplay, 1000);
    }

    // ===== QUIZ FUNCTIONS =====
    function generateQuiz() {
        const text = elements.quizData.value.trim();
        
        if (!text || !text.includes(';')) {
            openModal(elements.modalErreur);
            return;
        }

        // Hide setup zone
        elements.setupZone.classList.add('hidden');
        elements.containerRetourListe.classList.add('hidden');
        
        // Parse and shuffle questions if needed
        currentQuestions = parseQuestions(text);
        if (elements.shuffleOrder.checked) {
            currentQuestions.sort(() => Math.random() - 0.5);
        }
        
        // Show game zone
        elements.gameZone.classList.remove('hidden');
        window.scrollTo(0, 0);
        
        startTimer();
        renderQuestions();
    }

    function renderQuestions() {
        const title = elements.quizTitle.value.trim();
        let html = '';
        
        if (title) {
            html = `<div class="col-span-full mb-4 text-center">
                <h2 class="text-xl font-black uppercase tracking-tight text-[var(--accent-color)]">${title}</h2>
                <div class="h-1 w-20 bg-[var(--accent-color)] mx-auto mt-2 rounded-full opacity-50"></div>
            </div>`;
        }
        
        currentQuestions.forEach((item, i) => {
            html += `<div class="q-card">
                <div class="flex items-start gap-2">
                    <span class="opacity-30 text-[10px] font-black mt-1">${i + 1}.</span>
                    <span class="text-sm font-bold leading-tight">${item.q}</span>
                </div>
                <div class="res-text hidden">${item.r}</div>
            </div>`;
        });
        
        elements.questionsGrid.innerHTML = html;
        
        // Reset validation button
        elements.btnValidate.innerText = "üëÅÔ∏è correction";
        elements.btnValidate.classList.remove('bg-red-500');
        elements.btnValidate.classList.add('bg-green-500');
    }

    function showCorrection() {
        const resElements = document.querySelectorAll('.res-text');
        if (resElements.length === 0) return;
        
        const isHidden = resElements[0].classList.contains('hidden');
        
        resElements.forEach(el => {
            if (isHidden) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        });
        
        if (isHidden) {
            clearInterval(countdown);
            elements.btnValidate.innerText = "üôà masquer";
            elements.btnValidate.classList.remove('bg-green-500');
            elements.btnValidate.classList.add('bg-red-500');
        } else {
            elements.btnValidate.innerText = "üëÅÔ∏è correction";
            elements.btnValidate.classList.remove('bg-red-500');
            elements.btnValidate.classList.add('bg-green-500');
        }
    }

    function returnToSettings() {
        clearInterval(countdown);
        elements.setupZone.classList.remove('hidden');
        elements.containerRetourListe.classList.remove('hidden');
        elements.gameZone.classList.add('hidden');
    }

    function closeModalAndShowResults() {
        closeModal(elements.modalFin);
        showCorrection();
    }

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
        // Setup buttons
        elements.btnExample.onclick = addExample;
        elements.btnClearAll.onclick = clearAll;
        elements.btnTestSound.onclick = playSound;
        elements.btnStartQuiz.onclick = generateQuiz;
        
        // Game buttons
        elements.btnBack.onclick = returnToSettings;
        elements.btnReplay.onclick = generateQuiz;
        elements.btnValidate.onclick = showCorrection;
        elements.btnExportPdf.onclick = exportToPDF;
        elements.btnExportTxt.onclick = exportToTXT;
        
        // Modal buttons
        elements.btnAide.onclick = () => openModal(elements.modalAide);
        elements.btnCloseAide.onclick = () => closeModal(elements.modalAide);
        elements.btnCloseErreur.onclick = () => closeModal(elements.modalErreur);
        elements.btnCloseFin.onclick = closeModalAndShowResults;
        elements.btnCancelEffacer.onclick = () => closeModal(elements.modalEffacer);
        elements.btnConfirmEffacer.onclick = confirmClear;
        
        // File import
        elements.importTxt.onchange = (e) => importFromTXT(e.target.files[0]);
        
        // Modal overlays
        elements.modalAide.onclick = () => closeModal(elements.modalAide);
        elements.modalErreur.onclick = () => closeModal(elements.modalErreur);
        elements.modalEffacer.onclick = () => closeModal(elements.modalEffacer);
    }

    // ===== INITIALIZATION =====
    window.onload = () => {
        applyTheme();
        setupEventListeners();
    };
</script>

</body>
</html>
