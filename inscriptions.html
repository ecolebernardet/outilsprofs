<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Inscriptions - Outils Profs</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-body: #eeeeee;
            --text-main: #111827;
            --header-bg: #ffffff;
            --header-border: #ddd;
            --card-bg: #ffffff; 
            --input-bg: #ffffff;
            --sub-text: #71717a;
            --student-item-bg: #ffffff;
            --student-name-girl: #db2777;
            --student-name-boy: #2563eb;
            --modal-bg: rgba(255, 255, 255, 0.8);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            padding: 0 15px 20px 15px; margin: 0; 
            transition: background-color 0.2s ease;
        }
        
        header { 
            background: var(--header-bg); 
            border-bottom: 1px solid var(--header-border);
            position: sticky; top: 0; z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            padding: calc(env(safe-area-inset-top) + 10px) 10px 10px 10px;
            width: calc(100% + 30px); margin-left: -15px;
        }

        .light-card { background: var(--card-bg); border-radius: 1.5rem; border: 1px solid var(--header-border); }

        .card-input { display: none; }
        
        .card-label {
            display: flex; align-items: center; justify-content: center; text-align: center;
            background: #e5e7eb; border: 1px solid #d1d5db; color: #374151;
            height: 40px; border-radius: 0.75rem; cursor: pointer;
            font-size: 0.75rem; font-weight: 800; text-transform: uppercase;
        }
		
		.columns-container {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 15px;
			width: 100%;
			max-width: 600px;
			margin: 0 auto;
			align-items: start;
			padding: 0 10px;
		}

        .input-garcon:checked + .card-label { color: #2563eb; border-color: #2563eb; font-weight: 900; background: rgba(59, 130, 246, 0.1); }
        .input-fille:checked + .card-label { color: #db2777; border-color: #db2777; font-weight: 900; background: rgba(219, 39, 119, 0.1); }

        .input-cp:checked + .card-label { background: #ec4899; border-color: #ec4899; color: #fff; } 
        .input-ce1:checked + .card-label { background: #3b82f6; border-color: #3b82f6; color: #fff; } 
        .input-ce2:checked + .card-label { background: #eab308; border-color: #eab308; color: #000; } 
        .input-cm1:checked + .card-label { background: #ef4444; border-color: #ef4444; color: #fff; } 
        .input-cm2:checked + .card-label { background: #22c55e; border-color: #22c55e; color: #fff; } 
        .input-autre:checked + .card-label { background: #8b5cf6; border-color: #8b5cf6; color: #fff; } 

        .level-column { background: transparent; border: none; padding: 10px; height: fit-content; }
        
        .student-item { 
            background: #ffffff; 
            padding: 8px 12px; 
            border-radius: 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 4px; 
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .text-girl-custom { color: var(--student-name-girl); }
        .text-boy-custom { color: var(--student-name-boy); }
        
        .btn-nav { font-weight: 800; padding: 12px 4px; border-radius: 50px; font-size: 8px; text-align: center; width: 100%; cursor: pointer; }
        
        .input-field { background: #f3f4f6; border: 1px solid #d1d5db; color: var(--text-main); border-radius: 0.75rem; padding: 10px; outline: none; font-size: 0.75rem; font-weight: 600; }
        
        .select-date { 
            background: #e5e7eb; border: 1px solid #d1d5db; color: #374151; 
            border-radius: 0.75rem; height: 42px; outline: none; 
            font-size: 0.75rem; font-weight: 600; appearance: none; text-align: center;
        }

        .stat-pill { padding: 4px 10px; border-radius: 99px; font-size: 10px; font-weight: 800; text-transform: uppercase; display: flex; align-items: center; gap: 4px; }
        #btn-retour { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; }

        #custom-confirm {
            display: none; position: fixed; inset: 0; z-index: 9999;
            background: var(--modal-bg); backdrop-filter: blur(4px);
            align-items: center; justify-content: center; padding: 20px;
        }
        .confirm-card {
            background: var(--card-bg); border: 1px solid var(--header-border);
            width: 100%; max-width: 320px; border-radius: 1.5rem; padding: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); text-align: center;
        }
		
    </style>
</head>
<body class="pb-10">
    <div id="custom-confirm">
        <div class="confirm-card">
            <p id="confirm-msg" class="font-bold text-sm mb-6 leading-tight"></p>
            <div id="confirm-buttons" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <header>
        <a href="index.html" id="btn-retour" class="shadow-lg active:scale-90">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
        </a>
        <h1 id="page-title" class="text-lg font-black tracking-normal uppercase flex-grow text-center">Inscriptions</h1>
        <div style="width:40px"></div>
    </header>

    <div class="max-w-4xl mx-auto p-4 mt-4">
        <div id="scroll-target"></div>
        
        <div id="form-container" class="max-w-md mx-auto light-card p-4 mb-4 shadow-xl">
            <form id="eleveForm" class="flex flex-col gap-3">
                <input type="hidden" id="edit-id" value="">
                <input type="text" id="nomComplet" placeholder="Pr√©nom NOM" class="input-field w-full" required autocomplete="off">
                
                <div class="flex flex-col gap-1">
                    <label class="text-[9px] font-bold uppercase ml-2" style="color:var(--sub-text)">Date de naissance (optionnel)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <select id="birth-day" class="select-date"></select>
                        <select id="birth-month" class="select-date"></select>
                        <select id="birth-year" class="select-date"></select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <label><input type="radio" name="sexe" value="f" class="card-input input-fille"><div class="card-label">Fille</div></label>
                    <label><input type="radio" name="sexe" value="m" class="card-input input-garcon" checked><div class="card-label">Gar√ßon</div></label>
                </div>
                
                <div class="grid grid-cols-6 gap-1">
                    <label><input type="radio" name="niveau" value="CP" class="card-input input-cp"><div class="card-label">CP</div></label>
                    <label><input type="radio" name="niveau" value="CE1" class="card-input input-ce1"><div class="card-label">CE1</div></label>
                    <label><input type="radio" name="niveau" value="CE2" class="card-input input-ce2" checked><div class="card-label">CE2</div></label>
                    <label><input type="radio" name="niveau" value="CM1" class="card-input input-cm1"><div class="card-label">CM1</div></label>
                    <label><input type="radio" name="niveau" value="CM2" class="card-input input-cm2"><div class="card-label">CM2</div></label>
                    <label><input type="radio" name="niveau" value="AUTRE" class="card-input input-autre"><div class="card-label">Autre</div></label>
                </div>
                <button type="submit" id="btn-submit" class="font-black py-2.5 rounded-full uppercase text-xs active:scale-95 transition-transform mt-1">Enregistrer</button>
            </form>
        </div>

        <div id="stats-container" class="max-w-md mx-auto mb-4 flex flex-wrap justify-center gap-2"></div>

        <div id="sort-controls" class="max-w-md mx-auto mb-5 flex justify-center items-center gap-4 bg-white/50 p-2 rounded-xl border border-gray-200">
            <span class="text-[9px] font-black uppercase opacity-60">Trier par :</span>
            <div class="flex gap-5">
                <button onclick="changerTriApp('prenom')" id="sort-prenom" class="text-[9px] font-black uppercase px-3 py-1.5 rounded-lg border border-gray-300">Pr√©nom</button>
                <button onclick="changerTriApp('nom')" id="sort-nom" class="text-[9px] font-black uppercase px-3 py-1.5 rounded-lg border border-gray-300">Nom</button>
            </div>
        </div>

        <div id="listeContainer"></div>

        <div class="max-w-md mx-auto flex flex-col gap-3 mt-6 mb-10">
            <div class="grid grid-cols-3 gap-2">
                <label class="btn-nav bg-neutral-800 text-white shadow-md flex items-center justify-center">üëá importer .txt üëá<input type="file" id="fileInput" accept=".txt,.csv" class="hidden"></label>
                <button onclick="exporterListe()" class="btn-nav bg-neutral-800 text-white shadow-md">üëÜ exporter.txt üëÜ</button>
                <button onclick="genererPDF()" class="btn-nav bg-neutral-800 text-white shadow-md">üìÑ .pdf</button>
            </div>
            <button onclick="toutEffacer()" class="btn-nav bg-red-500 text-red-100 shadow-md">‚ö†Ô∏è effacer la liste</button>
        </div>
    </div>

    <script>
        const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#6b7280' };
        const couleurParNiveau = { 'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308', 'CM1': '#ef4444', 'CM2': '#22c55e', 'AUTRE': '#8b5cf6' };
        const ordreNiveaux = ['CP', 'CE1', 'CE2', 'CM1', 'CM2', 'AUTRE'];
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const couleurInscr = themePrefs.inscr || 'lime';
        const hexaTheme = mapCouleurs[couleurInscr];

        let modeTriApp = localStorage.getItem('tri_eleves_app') || 'prenom';
        let eleves = JSON.parse(localStorage.getItem('maListeEleves')) || [];

        function initDateSelectors() {
            const daySel = document.getElementById('birth-day');
            const monthSel = document.getElementById('birth-month');
            const yearSel = document.getElementById('birth-year');
            const derniereAnnee = localStorage.getItem('derniereAnneeSaisie') || "";
            daySel.innerHTML = ''; monthSel.innerHTML = ''; yearSel.innerHTML = '';
            for(let i=1; i<=31; i++) {
                let val = i < 10 ? '0'+i : i;
                daySel.innerHTML += `<option value="${val}">${i}</option>`;
            }
            const mois = ["Jan.", "F√©v.", "Mar.", "Avr.", "Mai", "Juin", "Juil.", "Ao√ªt", "Sep.", "Oct.", "Nov.", "D√©c."];
            mois.forEach((m, index) => {
                let val = (index + 1) < 10 ? '0'+(index+1) : (index+1);
                monthSel.innerHTML += `<option value="${val}">${m}</option>`;
            });
            const currentYear = new Date().getFullYear();
            for(let i=currentYear; i>=currentYear-20; i--) {
                const selected = (String(i) === derniereAnnee) ? "selected" : "";
                yearSel.innerHTML += `<option value="${i}" ${selected}>${i}</option>`;
            }
        }

        function nettoyerDatesFormat() {
            let modifie = false;
            eleves = eleves.map(el => {
                if (el.dateNaissance && el.dateNaissance.includes('-')) {
                    const parts = el.dateNaissance.split('-');
                    if (parts[0].length === 4) {
                        el.dateNaissance = `${parts[2]}-${parts[1]}-${parts[0]}`;
                        modifie = true;
                    }
                }
                return el;
            });
            if (modifie) localStorage.setItem('maListeEleves', JSON.stringify(eleves));
        }

        function appliquerCouleursTheme() {
            const btnSubmit = document.getElementById('btn-submit');
            const isDarkTxt = ['yellow', 'lime', 'amber', 'cyan'].includes(couleurInscr);
            if (btnSubmit) { btnSubmit.style.backgroundColor = hexaTheme; btnSubmit.style.color = isDarkTxt ? '#000' : '#fff'; }
            majBoutonsTri();
        }

        function majBoutonsTri() {
            const btnP = document.getElementById('sort-prenom');
            const btnN = document.getElementById('sort-nom');
            const isDarkTxt = ['yellow', 'lime', 'amber', 'cyan'].includes(couleurInscr);
            [btnP, btnN].forEach(b => { b.style.backgroundColor = 'transparent'; b.style.color = 'inherit'; b.style.opacity = '0.4'; b.style.borderColor = '#ddd'; });
            const actif = modeTriApp === 'prenom' ? btnP : btnN;
            actif.style.opacity = '1'; actif.style.backgroundColor = hexaTheme; actif.style.borderColor = hexaTheme; actif.style.color = isDarkTxt ? '#000' : '#fff';
        }

        function changerTriApp(mode) {
            modeTriApp = mode;
            localStorage.setItem('tri_eleves_app', mode);
            majBoutonsTri();
            render();
        }

        function customConfirm(msg, onAction, buttons) {
            document.getElementById('confirm-msg').innerText = msg;
            const container = document.getElementById('confirm-buttons');
            container.innerHTML = "";
            const isDarkTxt = ['yellow', 'lime', 'amber', 'cyan'].includes(couleurInscr);
            buttons.forEach(btn => {
                const b = document.createElement('button');
                b.className = "w-full py-3 rounded-full text-[10px] font-black uppercase shadow-sm transition-transform active:scale-95";
                b.innerText = btn.text;
                if (btn.type === 'primary') { b.style.backgroundColor = hexaTheme; b.style.color = isDarkTxt ? '#000' : '#fff'; }
                else { b.className += " bg-neutral-500 text-white"; }
                b.onclick = () => { document.getElementById('custom-confirm').style.display = 'none'; onAction(btn.value); };
                container.appendChild(b);
            });
            document.getElementById('custom-confirm').style.display = 'flex';
        }

        function formaterIdentite(prenom, nom) { 
            const p = prenom.trim();
            const formatedPrenom = p.charAt(0).toUpperCase() + p.slice(1).toLowerCase();
            return formatedPrenom + " " + nom.trim().toUpperCase(); 
        }

        function renderStats() {
            const statsDiv = document.getElementById('stats-container');
            if (eleves.length === 0) { statsDiv.innerHTML = ""; return; }
            statsDiv.innerHTML = `<div class="stat-pill bg-white text-gray-800 border border-gray-300">Total: ${eleves.length}</div><div class="stat-pill bg-blue-100 text-blue-700 border border-blue-200">‚ôÇ ${eleves.filter(e => e.sexe === 'm').length}</div><div class="stat-pill bg-pink-100 text-pink-700 border border-pink-200">‚ôÄ ${eleves.filter(e => e.sexe === 'f').length}</div>`;
        }

        function render() {
    renderStats();
    const container = document.getElementById('listeContainer');
    if (!container) return;
    
    container.innerHTML = eleves.length === 0 ? `<p class="text-center text-xs py-10 italic" style="color:var(--sub-text)">Aucun √©l√®ve inscrit.</p>` : "";
    
    const groupes = {};
    eleves.forEach(el => { 
        if (!groupes[el.niveau]) groupes[el.niveau] = []; 
        groupes[el.niveau].push(el); 
    });

    const pr√©sents = Object.keys(groupes).sort((a, b) => ordreNiveaux.indexOf(a) - ordreNiveaux.indexOf(b));

    // Affichage sur 2 colonnes
    container.className = "grid grid-cols-2 gap-3 items-start w-full"; 

    pr√©sents.forEach(niv => {
        const levelColumn = document.createElement('div');
        levelColumn.className = "flex flex-col";
        
        const couleurNiveau = couleurParNiveau[niv] || hexaTheme;
        levelColumn.innerHTML = `<h3 style="color:${couleurNiveau}" class="text-[11px] font-black uppercase tracking-widest text-center mb-3">${niv}</h3>`;
        
        const list = document.createElement('div');
        list.className = "flex flex-col gap-1.5";
        
        groupes[niv].sort((a, b) => {
            const partsA = a.identite.split(" ");
            const partsB = b.identite.split(" ");
            const pA = partsA[0], nA = partsA.slice(1).join(" ");
            const pB = partsB[0], nB = partsB.slice(1).join(" ");
            return modeTriApp === 'nom' ? nA.localeCompare(nB) : pA.localeCompare(pB);
        }).forEach(el => {
            const item = document.createElement('div');
            const genderClass = el.sexe === 'f' ? 'text-girl-custom' : 'text-boy-custom';
            item.className = `student-item ${genderClass}`;
            
            // Formatage de l'identit√© : Pr√©nom (Majuscule puis minuscules) + NOM (Majuscules)
            const parts = el.identite.split(" ");
            const prenomRaw = parts[0];
            const nomRaw = parts.slice(1).join(" ");
            
            const prenomPropre = prenomRaw.charAt(0).toUpperCase() + prenomRaw.slice(1).toLowerCase();
            const nomPropre = nomRaw.toUpperCase();

            let identiteAffiche = modeTriApp === 'nom' ? `${nomPropre} ${prenomPropre}` : `${prenomPropre} ${nomPropre}`;

            item.innerHTML = `
                <div class="flex flex-col flex-grow overflow-hidden" onclick="preparerModification('${el.id}')">
                    <span class="text-[10px] font-black truncate leading-tight">${identiteAffiche}</span>
                    ${el.dateNaissance ? `<span class="text-[8px] text-gray-400 italic leading-none mt-0.5">${el.dateNaissance}</span>` : ""}
                </div>
                <button onclick="supprimer('${el.id}')" class="ml-1 opacity-20 hover:opacity-100 transition-opacity p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>`;
            list.appendChild(item);
        });

        levelColumn.appendChild(list);
        container.appendChild(levelColumn);
    });
}

        document.getElementById('eleveForm').onsubmit = (e) => {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const saisie = document.getElementById('nomComplet').value.trim().split(" ");
            const day = document.getElementById('birth-day').value;
            const month = document.getElementById('birth-month').value;
            const year = document.getElementById('birth-year').value;
            let dateStockee = (day && month && year) ? `${day}-${month}-${year}` : "";
            if (year) localStorage.setItem('derniereAnneeSaisie', year);
            const data = { 
                identite: formaterIdentite(saisie[0], saisie.slice(1).join(" ")), 
                sexe: document.querySelector('input[name="sexe"]:checked').value, 
                niveau: document.querySelector('input[name="niveau"]:checked').value, 
                dateNaissance: dateStockee 
            };
            if (editId) { 
                const idx = eleves.findIndex(el => String(el.id) === String(editId)); 
                if(idx !== -1) eleves[idx] = { ...eleves[idx], ...data }; 
                document.getElementById('edit-id').value = ""; 
                document.getElementById('btn-submit').innerText = "Enregistrer"; 
            }
            else { eleves.push({ id: String(Date.now()), ...data }); }
            localStorage.setItem('maListeEleves', JSON.stringify(eleves)); 
            render(); e.target.reset(); initDateSelectors(); majBoutonsTri();
        };

        function preparerModification(id) {
            const el = eleves.find(e => String(e.id) === String(id)); if (!el) return;
            document.getElementById('edit-id').value = el.id; 
            document.getElementById('nomComplet').value = el.identite; 
            if (el.dateNaissance) {
                const parts = el.dateNaissance.split('-');
                if (parts[0].length === 4) {
                    document.getElementById('birth-day').value = parts[2];
                    document.getElementById('birth-month').value = parts[1];
                    document.getElementById('birth-year').value = parts[0];
                } else {
                    document.getElementById('birth-day').value = parts[0];
                    document.getElementById('birth-month').value = parts[1];
                    document.getElementById('birth-year').value = parts[2];
                }
            } else {
                document.getElementById('birth-day').value = "01";
                document.getElementById('birth-month').value = "01";
                document.getElementById('birth-year').value = localStorage.getItem('derniereAnneeSaisie') || "";
            }
            document.querySelector(`input[name="sexe"][value="${el.sexe}"]`).checked = true; 
            document.querySelector(`input[name="niveau"][value="${el.niveau}"]`).checked = true;
            document.getElementById('btn-submit').innerText = "Mettre √† jour"; 
            const target = document.getElementById('scroll-target');
            const headerOffset = 100; const elementPosition = target.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
            window.scrollTo({ top: offsetPosition, behavior: "smooth" });
        }

        function supprimer(id) { 
            customConfirm("Supprimer cet √©l√®ve ?", (val) => { if(val === 'yes') { eleves = eleves.filter(e => String(e.id) !== String(id)); localStorage.setItem('maListeEleves', JSON.stringify(eleves)); render(); }}, [{text: 'Supprimer', value: 'yes', type: 'primary'}, {text: 'Annuler', value: 'no'}]); 
        }

        function toutEffacer() { 
            customConfirm("‚ö†Ô∏è Supprimer toute la liste ?", (val) => { if(val === 'yes') { eleves = []; localStorage.setItem('maListeEleves', JSON.stringify(eleves)); render(); }}, [{text: 'Tout effacer', value: 'yes', type: 'primary'}, {text: 'Annuler', value: 'no'}]); 
        }

        function exporterListe() {
            if (eleves.length === 0) return alert("Liste vide !");
            let contenu = eleves.map(el => { const p = el.identite.split(" "); return `${p[0]};${p.slice(1).join(" ")};${el.sexe};${el.niveau};${el.dateNaissance||''}`; }).join("\n");
            const blob = new Blob([contenu], { type: 'text/plain' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `export_eleves_${new Date().toISOString().split('T')[0]}.txt`; a.click();
        }

        // FONCTION POUR RENDRE LES COULEURS TR√àS CLAIRES (PASTEL)
        function estomperCouleur(hex, facteur = 0.3) {
            let r = 0, g = 0, b = 0;
            if (hex.length == 4) {
                r = parseInt(hex[1] + hex[1], 16); g = parseInt(hex[2] + hex[2], 16); b = parseInt(hex[3] + hex[3], 16);
            } else {
                r = parseInt(hex[1] + hex[2], 16); g = parseInt(hex[3] + hex[4], 16); b = parseInt(hex[5] + hex[6], 16);
            }
            r = Math.round(r * facteur + 255 * (1 - facteur));
            g = Math.round(g * facteur + 255 * (1 - facteur));
            b = Math.round(b * facteur + 255 * (1 - facteur));
            return [r, g, b];
        }

        function genererPDF() {
    if (eleves.length === 0) return alert("La liste est vide !");
    
    const parNom = (modeTriApp === 'nom');
    const { jsPDF } = window.jspdf; 
    const doc = new jsPDF();
    
    const nomEns = localStorage.getItem('nom_enseignant') || "Non renseign√©";
    const dateExport = new Date().toLocaleDateString('fr-FR');
    const niveauxUniques = [...new Set(eleves.map(e => e.niveau))]
        .sort((a, b) => ordreNiveaux.indexOf(a) - ordreNiveaux.indexOf(b))
        .join(" / ");
    
    doc.setFontSize(16); doc.text("LISTE DES √âL√àVES", 105, 15, { align: "center" });
    doc.setFontSize(11); doc.text(niveauxUniques, 105, 21, { align: "center" });
    doc.setFontSize(9); doc.text(`Enseignant : ${nomEns}`, 14, 28); 
    doc.text(`Date : ${dateExport}`, 196, 28, { align: "right" });
    
    const elevesTries = [...eleves].sort((a, b) => {
        if (a.niveau !== b.niveau) return ordreNiveaux.indexOf(a.niveau) - ordreNiveaux.indexOf(b.niveau);
        const partsA = a.identite.split(" "), partsB = b.identite.split(" ");
        const prenomA = partsA[0], nomA = partsA.slice(1).join(" ");
        const prenomB = partsB[0], nomB = partsB.slice(1).join(" ");
        return parNom ? nomA.localeCompare(nomB) : prenomA.localeCompare(prenomB);
    });

    const headColName = parNom ? "NOM Pr√©nom" : "Pr√©nom NOM";
    const body = [];
    
    body.push([{ content: '', colSpan: 5, styles: { cellPadding: 0.5, fillColor: [255, 255, 255] } }]);

    let currentNiveau = null;
    let compteurGlobal = 0;
    
    elevesTries.forEach((el) => {
        if (el.niveau !== currentNiveau) {
            if (currentNiveau !== null) {
                body.push([{ content: '', colSpan: 5, styles: { cellPadding: 0.5, fillColor: [255, 255, 255] } }]);
            }
            currentNiveau = el.niveau;
            const couleurPastel = estomperCouleur(couleurParNiveau[currentNiveau] || '#cccccc', 0.3);
            body.push([{ 
                content: `NIVEAU : ${currentNiveau}`, 
                colSpan: 5, 
                styles: { fillColor: couleurPastel, textColor: [80, 80, 80], fontStyle: 'bold', halign: 'center', fontSize: 7.5, cellPadding: 0.8 } 
            }]);
        }
        
        compteurGlobal++;
        let nomAffichage = el.identite;
        if (parNom) {
            const parts = el.identite.split(" ");
            nomAffichage = parts.slice(1).join(" ") + " " + parts[0];
        }
        
        body.push([compteurGlobal, nomAffichage, el.dateNaissance || '-', el.sexe === 'm' ? 'M' : 'F', el.niveau]);
    });

    doc.autoTable({
        startY: 35,
        head: [['#', headColName, 'Date Naiss.', 'S.', 'Niveau']],
        body: body,
        headStyles: { fillColor: [0, 0, 0], textColor: 255, fontStyle: 'bold', fontSize: 9 },
        styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' }, // overflow linebreak √©vite les coupures
        alternateRowStyles: { fillColor: [250, 250, 250] },
        margin: { top: 35 },
        columnStyles: { 
            0: { cellWidth: 8, halign: 'center' },   // # r√©duit
            1: { cellWidth: 'auto' },                // Nom prend l'espace n√©cessaire
            2: { cellWidth: 25, halign: 'center' },  // Date Naissance fixe et serr√©e
            3: { cellWidth: 8, halign: 'center' },   // Sexe r√©duit
            4: { cellWidth: 15, halign: 'center' }   // Niveau r√©duit
        }
    });

    doc.save(`Liste_Eleves_${new Date().toISOString().split('T')[0]}.pdf`);
}

        document.getElementById('fileInput').onchange = function(e) {
            const file = e.target.files[0]; if (!file) return;
            customConfirm("Importer cette liste ?", (val) => { if(val === 'yes') {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const data = [];
                    event.target.result.split(/\r?\n/).forEach(l => {
                        const p = l.trim().split(';'); 
                        if(p.length >= 4) {
                            let dateImp = p[4] || "";
                            if (dateImp.includes('-')) {
                                const pts = dateImp.split('-');
                                if (pts[0].length === 4) dateImp = `${pts[2]}-${pts[1]}-${pts[0]}`;
                            }
                            data.push({ id: String(Date.now() + Math.random()), identite: formaterIdentite(p[0], p[1]), sexe: p[2].trim().toLowerCase(), niveau: p[3].trim().toUpperCase(), dateNaissance: dateImp });
                        }
                    });
                    if (data.length > 0) { eleves = data; localStorage.setItem('maListeEleves', JSON.stringify(eleves)); render(); }
                    majBoutonsTri();
                };
                reader.readAsText(file);
            }}, [{text: 'Importer', value: 'yes', type: 'primary'}, {text: 'Annuler', value: 'no'}]);
        };

        window.addEventListener('DOMContentLoaded', () => { 
            nettoyerDatesFormat(); initDateSelectors(); appliquerCouleursTheme(); render(); 
        });
    </script>
</body>
</html>