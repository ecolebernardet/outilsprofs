<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√©n√©rateur d'√©quipes √©quilibr√©es - OutilsProfs</title>
    
    <script>
        (function() {
            const mode = localStorage.getItem('theme_mode');
            if (mode === 'light') {
                document.documentElement.classList.add('light-mode-init');
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root { 
            --bg: #121212; --text: #ffffff; --card-bg: #0a0a0a; --header-bg: #1e1e1e;
            --header-border: rgba(255, 255, 255, 0.1); --border-color: rgba(255, 255, 255, 0.1); --pill-bg: #1a1a1a; --btn-num-bg: #0a0a0a;
            --btn-num-border: #262626; --title-gray: #888888; 
            --student-name-boy: #bae6fd; --student-name-girl: #fbcfe8;
        }

        body.light-mode, html.light-mode-init body {
            --bg: #eeeeee; --text: #000000; --card-bg: #ffffff; --header-bg: #ffffff;
            --header-border: #dddddd; --pill-bg: #ffffff; --btn-num-bg: #ffffff;
            --btn-num-border: #cccccc; --title-gray: #666666; 
        }

        body { 
            font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); 
            padding: 0; margin: 0; transition: background 0.3s;
            display: flex; flex-direction: column; align-items: center;
            padding-left: 15px; padding-right: 15px; padding-bottom: 20px;
        }

        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--header-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: calc(100% + 30px); margin-left: -15px; margin-bottom: 10px;
        }

        .header-btn { 
            display: flex; align-items: center; justify-content: center; 
            width: 40px; height: 40px; border-radius: 50%; 
            border: 1px solid var(--header-border); 
            transition: transform 0.1s ease, background-color 0.3s ease;
        }

        .section-title { font-size: 10px; color: var(--title-gray); margin: 15px 0 5px 0; font-weight: 900; letter-spacing: 1px; text-align: center; text-transform: uppercase; }
        #attendance-container { width: 100%; max-width: 600px; margin: 0 auto; padding: 0 10px; }
        .attendance-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 20px; width: 100%; }
        .level-label { text-align: center; font-size: 10px; font-weight: 900; margin: 15px 0 5px 0; text-transform: uppercase; letter-spacing: 1px; }

        .student-item { 
            padding: 6px 2px; border-radius: 999px; font-size: 0.55rem; font-weight: 800; 
            text-align: center; cursor: pointer; background-color: var(--pill-bg);
            border: 1px solid var(--header-border); transition: all 0.2s; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; user-select: none;
        }

        .bg-f { color: var(--student-name-girl) !important; } 
        .bg-m { color: var(--student-name-boy) !important; } 
        .name-f { color: var(--student-name-girl); } 
        .name-g { color: var(--student-name-boy); }

        .absent { 
            background-color: #0a0a0a !important; color: #444444 !important; 
            text-decoration: line-through; border-color: #1a1a1a !important;
            opacity: 0.5; transform: scale(0.96);
        }

        body.light-mode .absent, html.light-mode-init .absent { 
            background: #e0e0e0 !important; color: #aaaaaa !important; border-color: #cccccc !important;
        }

        .num-btn { background: var(--btn-num-bg); color: var(--text); border: 1px solid var(--btn-num-border); width: 34px; height: 34px; border-radius: 50%; font-weight: 800; cursor: pointer; }
        .generate-btn { width: 100%; max-width: 300px; color: white; padding: 14px; font-size: 10px; font-weight: 900; border-radius: 50px; text-transform: uppercase; margin: 20px 0; border: none; cursor: pointer; }
        
        .grid-teams { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 500px; margin: 0 auto; padding: 0 10px; }
        .team-card { border-radius: 1.2rem; padding: 10px; background: var(--card-bg); border: 1px solid var(--header-border); }
        .team-header { border-bottom: 1px solid var(--header-border); margin-bottom: 8px; padding-bottom: 4px; }
        .team-title { font-weight: 900; font-size: 0.65rem; color: var(--text); text-transform: uppercase; }
        .team-stats { font-size: 0.5rem; color: var(--title-gray); display: block; line-height: 1.4; }
        
        .tag { font-size: 0.45rem; font-weight: 700; margin-right: 8px; padding: 2px 6px; border-radius: 999px; color: #fff; min-width: 35px; text-align: center; }
        
        .bottom-nav { width: 100%; max-width: 400px; margin: 20px 0 40px 0; padding: 0 10px; }
        .btn-nav { font-weight: 800; padding: 12px; border-radius: 50px; font-size: 10px; text-align: center; cursor: pointer; width: 100%; border: none; }
        
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: var(--card-bg); padding: 24px; border-radius: 24px; width: 100%; max-width: 360px; color: var(--text); border: 1px solid var(--header-border); }
        .modal-btn { flex: 1; padding: 14px; border: none; border-radius: 16px; font-weight: 900; font-size: 11px; text-transform: uppercase; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <a href="index.html" id="btn-retour" class="header-btn shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="mainTitle" class="font-black text-lg uppercase flex-grow text-center">√âquipes</h1>
        <button id="btn-aide" onclick="ouvrirAide()" class="header-btn shadow-lg text-lg">üí°</button>
    </header>

    <div id="attendance-container"></div>
    <p class="section-title">Nombre d'√©quipes</p>
    <div class="flex gap-2 mb-4" id="selector"></div>
    <button id="main-generate-btn" class="generate-btn" onclick="generateBalancedTeams()">G√©n√©rer les √©quipes</button>
    <div id="results" class="grid-teams"></div>

    <div class="bottom-nav">
        <button onclick="resetTeams()" class="btn-nav bg-red-500 text-white shadow-lg">‚ö†Ô∏è effacer les √©quipes</button>
    </div>

    <div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="titre-aide" class="text-lg font-black uppercase mb-4">üí° √âquipes</h2>
            <div class="text-[11px] leading-relaxed space-y-2 opacity-80">
                <p>‚Ä¢ <b>Pr√©sence :</b> Cliquez sur un √©l√®ve pour le marquer absent (barr√©). Il ne sera pas inclus dans les √©quipes.</p>
                <p>‚Ä¢ <b>√âquilibrage :</b> L'algorithme r√©partit automatiquement les √©l√®ves pour que le nombre de filles, de gar√ßons et les niveaux soient identiques dans chaque √©quipe.</p>
                <p>‚Ä¢ <b>Nombre :</b> S√©lectionnez le nombre d'√©quipes souhait√© avant de cliquer sur "G√©n√©rer".</p>
            </div>
            <button id="btn-fermer-aide" onclick="fermerModal('modal-aide')" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest active:scale-95 transition-transform">Fermer</button>
        </div>
    </div>

    <div id="alertModal" class="modal-overlay" onclick="fermerModal('alertModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="alertTitle" class="font-black uppercase text-center mb-2">Confirmation</h3>
            <p id="alertText" class="text-center text-sm mb-4"></p>
            <div class="flex gap-2">
                <button onclick="closeModal()" class="modal-btn bg-gray-200 text-gray-700">Annuler</button>
                <button id="alertConfirmBtn" class="modal-btn text-white">Confirmer</button>
            </div>
        </div>
    </div>

<script>
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#666666' };
    const couleursDecidees = { "CP": "#ec4899", "CE1": "#3b82f6", "CE2": "#eab308", "CM1": "#ef4444", "CM2": "#22c55e", "AUTRE": "#a855f7" };
    const ORDRE_SCOLAIRE = ["CP", "CE1", "CE2", "CM1", "CM2", "AUTRE"];

    let selectedNumTeams = 4;
    let ALL_STUDENTS = JSON.parse(localStorage.getItem('maListeEleves')) || [];
    let absents = new Set(JSON.parse(localStorage.getItem('absents_session_equipes')) || []);

    function appliquerCouleursSexe() {
        const prefs = JSON.parse(localStorage.getItem('theme_tuiles'));
        if (prefs) {
            if (prefs.fille && mapCouleurs[prefs.fille]) {
                document.documentElement.style.setProperty('--student-name-girl', mapCouleurs[prefs.fille]);
            }
            if (prefs.garcon && mapCouleurs[prefs.garcon]) {
                document.documentElement.style.setProperty('--student-name-boy', mapCouleurs[prefs.garcon]);
            }
        }
    }

    function appliquerTheme() {
        const isLight = localStorage.getItem('theme_mode') === 'light';
        document.body.classList.toggle('light-mode', isLight);
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.equipes || 'pink';
        const cHex = mapCouleurs[colPref];
        const isDark = ['yellow', 'lime', 'amber', 'cyan'].includes(colPref);

        document.getElementById('mainTitle').style.color = isLight ? '#000' : '#fff';
        
        const headerBtns = [document.getElementById('btn-retour'), document.getElementById('btn-aide')];
        headerBtns.forEach(btn => {
            if(btn) {
                btn.style.backgroundColor = cHex;
                btn.style.color = isDark ? '#000' : '#fff';
            }
        });

        const genBtn = document.getElementById('main-generate-btn');
        if(genBtn) {
            genBtn.style.backgroundColor = cHex;
            genBtn.style.color = isDark ? '#000' : '#fff';
        }

        const btnFermerAide = document.getElementById('btn-fermer-aide');
        if(btnFermerAide) {
            btnFermerAide.style.backgroundColor = cHex;
            btnFermerAide.style.color = isDark ? '#000' : '#fff';
        }

        const titreAide = document.getElementById('titre-aide');
        if(titreAide) titreAide.style.color = cHex;
    }

    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }
    function closeModal() { document.getElementById('alertModal').style.display = 'none'; }

    function getDisplayName(eleve, all) {
        const prenom = eleve.identite.trim().split(" ")[0];
        const aUnDoublon = all.some(s => s.id !== eleve.id && s.identite.trim().split(" ")[0].toLowerCase() === prenom.toLowerCase());
        return aUnDoublon && eleve.identite.split(" ")[1] ? `${prenom} ${eleve.identite.split(" ")[1].charAt(0)}.` : prenom;
    }

    function getDetailedStats(team) {
        const s = { f: 0, m: 0, total: team.length, levels: {} };
        ORDRE_SCOLAIRE.forEach(n => {
            s.levels[n.toLowerCase()] = { f: 0, m: 0, total: 0 };
        });
        team.forEach(e => {
            const isF = e.sexe.toLowerCase().startsWith('f');
            const niv = e.niveau.toString().trim().toUpperCase(); 
            if(isF) s.f++; else s.m++;
            const key = niv.toLowerCase();
            if(s.levels[key]) {
                s.levels[key].total++;
                if(isF) s.levels[key].f++; else s.levels[key].m++;
            }
        });
        return s;
    }

    function generateBalancedTeams() {
        let presents = ALL_STUDENTS.filter(s => !absents.has(String(s.id)));
        if (presents.length < selectedNumTeams) return;

        let teams = Array.from({ length: selectedNumTeams }, () => []);
        presents.sort(() => Math.random() - 0.5);
        presents.forEach((s, i) => teams[i % selectedNumTeams].push(s));

        let improved = true;
        let iterations = 0;
        while(improved && iterations < 300) {
            improved = false;
            iterations++;
            for(let i=0; i < teams.length; i++) {
                for(let j=0; j < teams.length; j++) {
                    if(i === j) continue;
                    let sI = getDetailedStats(teams[i]), sJ = getDetailedStats(teams[j]);
                    const getScore = (st1, st2) => {
                        let score = Math.abs(st1.f - st2.f) * 10 + Math.abs(st1.m - st2.m) * 10;
                        ORDRE_SCOLAIRE.forEach(n => {
                            const niv = n.toLowerCase();
                            score += Math.abs(st1.levels[niv].f - st2.levels[niv].f) * 20;
                            score += Math.abs(st1.levels[niv].total - st2.levels[niv].total) * 5;
                        });
                        return score;
                    };
                    let currentScore = getScore(sI, sJ);
                    for(let x=0; x < teams[i].length; x++) {
                        for(let y=0; y < teams[j].length; y++) {
                            let temp = teams[i][x];
                            teams[i][x] = teams[j][y];
                            teams[j][y] = temp;
                            let nI = getDetailedStats(teams[i]), nJ = getDetailedStats(teams[j]);
                            if(getScore(nI, nJ) < currentScore) {
                                improved = true;
                                currentScore = getScore(nI, nJ);
                            } else {
                                teams[j][y] = teams[i][x];
                                teams[i][x] = temp;
                            }
                        }
                    }
                }
            }
        }
        localStorage.setItem('savedTeams', JSON.stringify(teams));
        renderTeams(teams);
    }

    function renderTeams(teams) {
        const res = document.getElementById('results');
        const pal = JSON.parse(localStorage.getItem('palette_niveaux')) || {};
        res.innerHTML = '';
        teams.forEach((t, i) => {
            const s = getDetailedStats(t);
            let statsText = `${s.f}F/${s.m}G`;
            
            // Affichage des stats dans l'ordre strict
            ORDRE_SCOLAIRE.forEach(n => { 
                const lv = n.toLowerCase();
                if(s.levels[lv] && s.levels[lv].total > 0) statsText += ` ‚Ä¢ ${s.levels[lv].total}${n}`; 
            });

            let h = `<div class="team-card"><div class="team-header"><span class="team-title">√âquipe ${i+1}</span><span class="team-stats">${statsText}</span></div>`;
            
            // TRI DES √âL√àVES DANS LA CARTE SELON L'ORDRE SCOLAIRE
            t.sort((a, b) => {
                const nivA = a.niveau.toString().trim().toUpperCase();
                const nivB = b.niveau.toString().trim().toUpperCase();
                const indexA = ORDRE_SCOLAIRE.indexOf(nivA);
                const indexB = ORDRE_SCOLAIRE.indexOf(nivB);
                return (indexA === -1 ? 99 : indexA) - (indexB === -1 ? 99 : indexB);
            }).forEach(e => {
                const niv = e.niveau.toString().trim().toUpperCase();
                const cTag = pal[niv] || pal[niv.toLowerCase()] || couleursDecidees[niv] || '#888';
                const genderClass = e.sexe.toLowerCase().startsWith('f') ? 'name-f' : 'name-g';
                h += `<div class="flex items-center mb-1 text-[0.65rem] font-bold"><span class="tag" style="background-color:${cTag}">${niv}</span><span class="${genderClass}">${getDisplayName(e, ALL_STUDENTS)}</span></div>`;
            });
            res.innerHTML += h + `</div>`;
        });
    }

    function renderAttendance() {
        const container = document.getElementById('attendance-container');
        container.innerHTML = '';
        const pal = JSON.parse(localStorage.getItem('palette_niveaux')) || {};
        const groups = {};
        
        // Groupement avec nettoyage des cl√©s
        ALL_STUDENTS.forEach(s => { 
            const n = s.niveau.toString().trim().toUpperCase(); 
            if(!groups[n]) groups[n] = []; 
            groups[n].push(s); 
        });

        // AFFICHAGE DES SECTIONS DE PR√âSENCE DANS L'ORDRE SCOLAIRE
        ORDRE_SCOLAIRE.forEach(niv => {
            if(groups[niv] && groups[niv].length > 0) {
                let h = `<div class="level-label" style="color:${pal[niv]||couleursDecidees[niv]}">${niv}</div><div class="attendance-grid">`;
                groups[niv].sort((a,b) => a.identite.localeCompare(b.identite)).forEach(s => {
                    const isAbs = absents.has(String(s.id));
                    const genderClass = s.sexe.toLowerCase().startsWith('f') ? 'bg-f' : 'bg-m';
                    h += `<div class="student-item ${genderClass} ${isAbs?'absent':''}" onclick="toggleAbs('${s.id}')">${getDisplayName(s, ALL_STUDENTS)}</div>`;
                });
                container.innerHTML += h + `</div>`;
            }
        });
    }

    function toggleAbs(id) {
        const sid = String(id);
        if(absents.has(sid)) absents.delete(sid); else absents.add(sid);
        localStorage.setItem('absents_session_equipes', JSON.stringify(Array.from(absents)));
        renderAttendance();
    }

    function selectNum(n) {
        selectedNumTeams = n;
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const cHex = mapCouleurs[themePrefs.equipes || 'pink'];
        document.querySelectorAll('.num-btn').forEach(b => {
            b.style.backgroundColor = b.innerText == n ? cHex : 'var(--btn-num-bg)';
            b.style.color = b.innerText == n ? '#fff' : 'var(--text)';
            b.style.borderColor = b.innerText == n ? cHex : 'var(--btn-num-border)';
        });
    }

    function resetTeams() { 
        document.getElementById('alertText').innerText = "Voulez-vous effacer les √©quipes ?";
        document.getElementById('alertConfirmBtn').onclick = () => { localStorage.removeItem('savedTeams'); document.getElementById('results').innerHTML = ''; closeModal(); };
        document.getElementById('alertConfirmBtn').style.backgroundColor = mapCouleurs[JSON.parse(localStorage.getItem('theme_tuiles'))?.equipes || 'pink'];
        document.getElementById('alertModal').style.display = 'flex';
    }

    window.onload = () => {
        appliquerCouleursSexe();
        appliquerTheme();
        const sel = document.getElementById('selector');
        for(let i=2; i<=8; i++) {
            const b = document.createElement('button');
            b.className = 'num-btn'; b.innerText = i; b.onclick = () => selectNum(i);
            sel.appendChild(b);
        }
        selectNum(selectedNumTeams);
        renderAttendance();
        const s = localStorage.getItem('savedTeams');
        if(s) renderTeams(JSON.parse(s));
    };
</script>
</body>
</html>