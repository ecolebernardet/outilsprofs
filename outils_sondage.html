<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sondage Express - OutilsProfs</title>

    <script>
        (function() {
            const mode = localStorage.getItem('theme_mode');
            if (mode === 'light') {
                document.documentElement.classList.add('light-mode-init');
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ====================== CSS CONFIGURATION ====================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --text-page: #ffffff; --header-bg: #1e1e1e;
            --header-border: rgba(255, 255, 255, 0.1); --border-color: rgba(255, 255, 255, 0.1);
            --card-bg: #1e1e1e; --card-text: #ffffff; --input-bg: #2a2a2a;
            --input-border: rgba(255, 255, 255, 0.1); --input-text: #ffffff;
        }

        body.light-mode, html.light-mode-init body {
            --bg-page: #eeeeee; --text-page: #111827; --header-bg: #ffffff;
            --header-border: #ddd; --border-color: #ddd; --card-bg: #ffffff;
            --card-text: #111827; --input-bg: #f3f4f6; --input-border: #9ca3af;
            --input-text: #111827;
        }

        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-page); color: var(--text-page); 
            padding: 0; margin: 0; display: flex; flex-direction: column; align-items: center;
            padding-left: 15px; padding-right: 15px; padding-bottom: 20px;
        }

        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--header-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: calc(100% + 30px); margin-left: -15px; margin-bottom: 12px;
        }

        .container { width: 100%; max-width: 600px; padding: 0 4px; }

        .input-field { 
            background: var(--input-bg); border: 1px solid var(--input-border); 
            color: var(--input-text); border-radius: 0.75rem; padding: 10px; 
            outline: none; font-size: 0.8rem; font-weight: 600; width: 100%;
        }

        #btn-retour, #btn-aide { 
            display: flex; align-items: center; justify-content: center; 
            width: 38px; height: 38px; border-radius: 50%; flex-shrink: 0;
        }

        #btn-retour-liste {
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; 
            border-radius: 9999px; font-size: 10px; font-weight: 900; text-transform: uppercase; 
            transition: transform 0.2s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .poll-card {
            background: var(--card-bg); border-radius: 1rem; padding: 15px;
            border: 1px solid var(--border-color); margin-bottom: 10px;
            position: relative; overflow: hidden; cursor: pointer; transition: transform 0.1s;
        }
        .poll-card:active { transform: scale(0.98); }
        .progress-fill { position: absolute; left: 0; top: 0; bottom: 0; opacity: 0.15; transition: width 0.4s ease; }

        .option-row { display: flex; gap: 8px; align-items: center; }
        .btn-remove-option { opacity: 0.4; transition: all 0.2s; padding: 5px; font-size: 14px; }
        .btn-remove-option:hover { opacity: 1; color: #ef4444; }

        #btnAddPoll {
            position: fixed; bottom: 60px; right: 20px; width: 64px; height: 64px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            z-index: 50; border: none; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); align-items: center; justify-content: center; padding: 20px; z-index: 1000; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 1.5rem; width: 100%; max-width: 450px; border: 1px solid var(--border-color); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>

    <button id="btnAddPoll" onclick="declencherNouveauSondage()">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <header>
        <a href="index.html" id="btn-retour">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="pageTitle" class="font-black text-lg uppercase tracking-normal text-center flex-grow">Sondage</h1>
        <button id="btn-aide" onclick="ouvrirAide()" class="text-lg">üí°</button>
    </header>

    <div class="container">
        <div id="container-retour-liste" class="mb-6">
            <a href="outils.html" id="btn-retour-liste">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
                </svg>
                Retour aux outils
            </a>
        </div>

        <div id="pollDisplay">
            <h2 id="currentQuestion" class="text-xl font-black uppercase text-center mb-6 opacity-40">Aucun sondage actif</h2>
            <div id="optionsContainer" class="space-y-3"></div>
            
            <div id="pollFooter" class="hidden mt-8 text-center space-y-4">
                <p class="text-[10px] font-bold uppercase opacity-50 tracking-widest">Total : <span id="totalVotes">0</span> votes</p>
                
                <div class="flex flex-wrap justify-center gap-2 pt-4">
                    <button onclick="confirmerAction('RESET')" class="py-2 px-4 rounded-xl bg-orange-500/10 text-orange-500 text-[9px] font-black uppercase border border-orange-500/20">üîÑ R√©initialiser</button>
                    <button onclick="ouvrirFormulaire(true)" class="py-2 px-4 rounded-xl bg-blue-500/10 text-blue-500 text-[9px] font-black uppercase border border-blue-500/20">‚úèÔ∏è Corriger</button>
                    <button onclick="confirmerAction('DELETE')" class="py-2 px-4 rounded-xl bg-red-500/10 text-red-500 text-[9px] font-black uppercase border border-red-500/20">üóëÔ∏è Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-form" class="modal-overlay" onclick="fermerModal('modal-form')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="form-title" class="text-lg font-black uppercase mb-4 text-center">Nouveau Sondage</h2>
            <div class="space-y-3">
                <input type="text" id="pollQuestionInput" class="input-field" placeholder="Votre question...">
                <div id="optionsInputs" class="space-y-2">
                    </div>
                <button onclick="addOptionInput()" class="text-[9px] font-black uppercase opacity-60">+ Ajouter une option</button>
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="fermerModal('modal-form')" class="flex-1 py-3 bg-neutral-500/20 rounded-xl text-[10px] font-black uppercase">Annuler</button>
                <button id="btnAction" onclick="creerSondage()" class="flex-1 py-3 text-white rounded-xl text-[10px] font-black uppercase">Valider</button>
            </div>
        </div>
    </div>

    <div id="modal-alert" class="modal-overlay" onclick="fermerModal('modal-alert')">
        <div class="modal-content text-center" onclick="event.stopPropagation()">
            <div id="alert-icon" class="text-3xl mb-3">‚ö†Ô∏è</div>
            <h2 id="alert-title" class="text-sm font-black uppercase mb-2">Attention</h2>
            <p id="alert-message" class="text-[11px] opacity-80 mb-6 leading-relaxed"></p>
            <div id="alert-buttons" class="flex gap-2">
                <button id="btn-alert-cancel" onclick="fermerModal('modal-alert')" class="flex-1 py-3 bg-neutral-500/20 rounded-xl text-[10px] font-black uppercase">Annuler</button>
                <button id="btn-alert-confirm" class="flex-1 py-3 text-white rounded-xl text-[10px] font-black uppercase">Confirmer</button>
            </div>
        </div>
    </div>

    <div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="titre-aide" class="text-lg font-black uppercase mb-4 text-center">üí° Aide</h2>
            <div class="text-[11px] leading-relaxed space-y-4 opacity-90 text-center">
                <p>‚Ä¢ Le bouton <b>+</b> cr√©e un nouveau sondage (√©crase l'ancien).</p>
                <p>‚Ä¢ Utilisez <b>Corriger</b> pour modifier le texte sans perdre les votes (si possible).</p>
                <p>‚Ä¢ Appuyez sur les cartes pour voter.</p>
            </div>
            <button id="btn-fermer-aide" onclick="fermerModal('modal-aide')" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase">Fermer</button>
        </div>
    </div>

    <script>
        const COLOR_MAP = {
            'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
            'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
            'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
            'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
            'rose': '#f43f5e', 'gray': '#6b7280'
        };

        let currentPoll = null;
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const THEME_HEX = COLOR_MAP[themePrefs.outils || 'blue'] || '#3b82f6';
        const IS_DARK_TEXT = ['yellow', 'lime', 'amber', 'cyan'].includes(themePrefs.outils || 'blue');
        const CONTRAST = IS_DARK_TEXT ? '#000' : '#fff';

        function appliquerTheme() {
            const isLight = localStorage.getItem('theme_mode') === 'light';
            document.body.classList.toggle('light-mode', isLight);
            const elements = [
                document.getElementById('btn-retour'), document.getElementById('btn-aide'),
                document.getElementById('btnAddPoll'), document.getElementById('btnAction'),
                document.getElementById('btn-fermer-aide'), document.getElementById('btn-retour-liste'),
                document.getElementById('btn-alert-confirm')
            ];
            elements.forEach(el => { if(el) { el.style.backgroundColor = THEME_HEX; el.style.color = CONTRAST; }});
            document.getElementById('pageTitle').style.color = THEME_HEX;
            document.getElementById('alert-title').style.color = THEME_HEX;
        }

        function addOptionInput(val = "") {
            const container = document.getElementById('optionsInputs');
            const row = document.createElement('div');
            row.className = "option-row";
            row.innerHTML = `<input type="text" class="input-field option-input" placeholder="Option" value="${val}"><button onclick="this.parentElement.remove()" class="btn-remove-option">‚úï</button>`;
            container.appendChild(row);
        }

        function ouvrirFormulaire(isCorrection = false) {
            const title = document.getElementById('form-title');
            const questionInput = document.getElementById('pollQuestionInput');
            const optionsContainer = document.getElementById('optionsInputs');
            
            optionsContainer.innerHTML = '';
            
            if (isCorrection && currentPoll) {
                title.innerText = "Corriger le Sondage";
                questionInput.value = currentPoll.question;
                currentPoll.options.forEach(opt => addOptionInput(opt.text));
            } else {
                title.innerText = "Nouveau Sondage";
                questionInput.value = "";
                addOptionInput(); addOptionInput();
            }
            document.getElementById('modal-form').style.display = 'flex';
        }

        function declencherNouveauSondage() {
            if (currentPoll) {
                afficherAlerte("Cr√©er un nouveau sondage effacera le sondage actuel et tous ses votes. Continuer ?", "Nouveau Sondage", "üÜï", () => {
                    ouvrirFormulaire(false);
                });
            } else {
                ouvrirFormulaire(false);
            }
        }

        function afficherAlerte(message, titre = "Attention", icone = "‚ö†Ô∏è", callback = null) {
            document.getElementById('alert-title').innerText = titre;
            document.getElementById('alert-message').innerText = message;
            document.getElementById('alert-icon').innerText = icone;
            const btnConfirm = document.getElementById('btn-alert-confirm');
            const btnCancel = document.getElementById('btn-alert-cancel');
            btnCancel.style.display = callback ? 'block' : 'none';
            btnConfirm.onclick = () => { if(callback) callback(); fermerModal('modal-alert'); };
            document.getElementById('modal-alert').style.display = 'flex';
        }

        function confirmerAction(type) {
            if (type === 'RESET') {
                afficherAlerte("Remettre tous les compteurs √† z√©ro ?", "R√©initialisation", "üîÑ", () => {
                    currentPoll.options.forEach(o => o.votes = 0);
                    renderPoll();
                });
            } else if (type === 'DELETE') {
                afficherAlerte("Supprimer d√©finitivement ce sondage ?", "Suppression", "üóëÔ∏è", () => {
                    currentPoll = null;
                    document.getElementById('currentQuestion').innerText = "Aucun sondage actif";
                    document.getElementById('currentQuestion').classList.add('opacity-40');
                    document.getElementById('optionsContainer').innerHTML = '';
                    document.getElementById('pollFooter').classList.add('hidden');
                });
            }
        }

        function creerSondage() {
            const question = document.getElementById('pollQuestionInput').value.trim();
            const inputs = document.querySelectorAll('.option-input');
            const isCorrection = document.getElementById('form-title').innerText.includes("Corriger");
            
            const newOptions = [];
            inputs.forEach((input, index) => {
                if(input.value.trim() !== "") {
                    // Si c'est une correction, on essaie de garder les votes si le texte est identique
                    let existingVotes = 0;
                    if (isCorrection && currentPoll && currentPoll.options[index] && currentPoll.options[index].text === input.value.trim()) {
                        existingVotes = currentPoll.options[index].votes;
                    }
                    newOptions.push({ text: input.value.trim(), votes: existingVotes });
                }
            });

            if(question && newOptions.length >= 2) {
                currentPoll = { question, options: newOptions };
                fermerModal('modal-form');
                renderPoll();
            } else {
                afficherAlerte("Il faut une question et au moins 2 options.", "Erreur", "‚ùå");
            }
        }

        function renderPoll() {
            if(!currentPoll) return;
            document.getElementById('currentQuestion').innerText = currentPoll.question;
            document.getElementById('currentQuestion').classList.remove('opacity-40');
            document.getElementById('pollFooter').classList.remove('hidden');
            
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            const total = currentPoll.options.reduce((acc, curr) => acc + curr.votes, 0);
            document.getElementById('totalVotes').innerText = total;

            currentPoll.options.forEach(opt => {
                const percent = total === 0 ? 0 : Math.round((opt.votes / total) * 100);
                const card = document.createElement('div');
                card.className = "poll-card shadow-lg";
                card.onclick = () => { opt.votes++; renderPoll(); };
                card.innerHTML = `
                    <div class="progress-fill" style="width: ${percent}%; background-color: ${THEME_HEX}"></div>
                    <div class="relative flex justify-between items-center z-10">
                        <span class="text-[11px] font-bold uppercase tracking-wide">${opt.text}</span>
                        <span class="text-sm font-black" style="color: ${THEME_HEX}">${percent}%</span>
                    </div>`;
                container.appendChild(card);
            });
        }

        function fermerModal(id) { document.getElementById(id).style.display = 'none'; }
        function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
        window.onload = appliquerTheme;
    </script>
</body>
</html>