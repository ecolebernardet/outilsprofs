<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>G√©n√©rateur de Dominos - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --accent-color: #06b6d4; --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s ease; }
        
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }

        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; transition: all 0.2s ease; cursor: pointer; border: none; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }

        .main-wrapper { width: 100%; max-width: 500px; margin: 0 auto; padding: 10px 15px 40px; }
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 20px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 20px; }
        
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border); border-radius: 0.75rem; padding: 10px; font-size: 0.85rem; font-weight: 700; width: 100%; color: var(--text-main); outline: none; }
        
        .btn-add { width: 100%; padding: 14px; border-radius: 50px; font-weight: 900; font-size: 12px; text-transform: uppercase; border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-add:active { transform: scale(0.95); }

        .btn-game-action { height: 40px; border-radius: 9999px; font-size: 10px; font-weight: 900; color: white; transition: all 0.2s ease; text-transform: uppercase; padding: 0 15px; display: flex; align-items: center; justify-content: center; gap: 4px; }

        .domino-tile {
            display: flex; position: relative; width: 200px; height: 70px; border: 2px solid var(--accent-color);
            border-radius: 10px; overflow: hidden; background: var(--card-bg);
            box-shadow: var(--shadow-custom);
        }

        .domino-half {
            flex: 1; display: flex; align-items: center; justify-content: center;
            padding: 8px; text-align: center; font-size: 12px; font-weight: 800;
        }

        .domino-divider { width: 2px; background: var(--accent-color); height: 100%; position: relative; }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }

        @media (min-width: 768px) {
            .main-wrapper { max-width: 950px; }
            #dominos-grid { grid-template-columns: repeat(2, 1fr); gap: 24px; }
        }
    </style>
</head>
<body>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
</script>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
    </a>
    <h1>G√©n√©rateur de Dominos</h1>
    <button id="btn-aide" onclick="document.getElementById('modal-aide').style.display='flex'" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div id="container-retour-liste" class="mb-4 text-left">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" /></svg>
            Retour aux g√©n√©rateurs
        </a>
    </div>

    <div id="setup-zone" class="light-card space-y-4">
        <div>
            <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Titre de la fiche</label>
            <input type="text" id="quiz-title" class="input-field mb-4" placeholder="Ex: Dominos des calculs">
            
            <label class="block text-[9px] font-black uppercase opacity-50 mb-2 text-center">Op√©ration / Type</label>
            <div class="grid grid-cols-2 gap-1 bg-black/10 p-1 rounded-xl mb-4">
                <button onclick="setOp('+')" id="op-add" class="p-2 text-[9px] font-bold transition-all">Addition</button>
                <button onclick="setOp('*')" id="op-mult" class="p-2 text-[9px] font-bold transition-all">Mult.</button>
            </div>

            <div id="add-options" class="hidden bg-black/5 p-3 rounded-xl mb-4 space-y-2">
                <select id="auto-add-type" class="input-field text-center bg-transparent border-none">
                    <option value="none">-- Saisie Manuelle --</option>
                    <option value="c10">Compl√©ments √† 10</option>
                    <option value="c20">Compl√©ments √† 20</option>
                    <option value="c100">Compl√©ments √† 100</option>
                    <option value="doubles">Les Doubles</option>
                </select>
            </div>

            <div id="tables-selector" class="hidden bg-black/5 p-3 rounded-xl mb-4">
                <div class="grid grid-cols-5 gap-1 mb-2" id="tables-grid"></div>
                <button onclick="selectAllTables()" class="w-full py-1 text-[8px] font-bold uppercase border border-white/10 rounded">Toutes les tables</button>
            </div>
            
            <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Donn√©es personnalis√©es (Q ; R)</label>
            <textarea id="quiz-data" class="input-field h-28 font-normal" placeholder="Paris ; France&#10;Londres ; Angleterre"></textarea>
        </div>
        <button id="mainAddBtn" onclick="prepareAndGenerate()" class="btn-add">G√©n√©rer les Dominos</button>
    </div>

    <div id="game-zone" class="hidden space-y-6">
        <div id="dominos-grid" class="grid grid-cols-1 gap-4"></div>
        <div class="flex flex-wrap justify-center gap-3 pt-4">
            <button onclick="retourReglages()" class="btn-game-action bg-gray-500 shadow-lg">‚¨ÖÔ∏è retour</button>
            <button onclick="exportToPDF()" class="btn-game-action bg-blue-500 shadow-lg">üìÑ PDF √† d√©couper</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="text-lg font-black uppercase mb-4 text-center">üí° Aide</h2>
        <div class="text-[11px] leading-relaxed space-y-4">
            <p>Le domino affiche √† **gauche** la r√©ponse au domino pr√©c√©dent, et √† **droite** une nouvelle question.</p>
            <p>En mode manuel, utilisez le format : <br><code class="bg-black/10 px-1">Question ; R√©ponse</code> (une par ligne).</p>
            <p>D√©coupez les dominos pour cr√©er une boucle de jeu.</p>
        </div>
        <button id="btn-fermer-aide" onclick="document.getElementById('modal-aide').style.display='none'" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase text-white">Compris</button>
    </div>
</div>

<div id="modal-erreur" class="modal-overlay" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="text-lg font-black uppercase mb-4 text-center text-red-500">‚ö†Ô∏è Attention</h2>
        <div class="text-[11px] leading-relaxed text-center mb-6">
            <p id="msg-erreur">Veuillez choisir une option ou saisir des donn√©es.</p>
        </div>
        <button id="btn-fermer-erreur" onclick="document.getElementById('modal-erreur').style.display='none'" class="w-full py-3 rounded-xl text-[10px] font-black uppercase text-white">D'accord</button>
    </div>
</div>

<script>
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e' };
    let pairs = [], currentOp = '+', selectedTables = [];

    function appliquerTheme() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.gen || 'cyan'; 
        const hexa = mapCouleurs[colPref];
        const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(colPref) ? '#000' : '#fff';
        document.documentElement.style.setProperty('--accent-color', hexa);
        
        const btns = [
            document.getElementById('btn-retour-header'), 
            document.getElementById('btn-retour-liste'), 
            document.getElementById('btn-aide'), 
            document.getElementById('mainAddBtn'),
            document.getElementById('btn-fermer-aide'),
            document.getElementById('btn-fermer-erreur')
        ];
        
        btns.forEach(b => { 
            if(b) { 
                b.style.backgroundColor = hexa; 
                b.style.color = contrast; 
            } 
        });
        setOp(currentOp);
    }

    function initTables() {
        const grid = document.getElementById('tables-grid');
        grid.innerHTML = '';
        for(let i=1; i<=10; i++) {
            grid.innerHTML += `<button onclick="toggleTable(${i})" id="tab-${i}" class="p-2 text-[10px] font-bold rounded-lg border border-white/5 bg-black/10 hover:bg-black/20">${i}</button>`;
        }
    }

    function setOp(op) {
        currentOp = op;
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
        const bA = document.getElementById('op-add'), bM = document.getElementById('op-mult');
        const multSec = document.getElementById('tables-selector'), addSec = document.getElementById('add-options');
        
        [bA, bM].forEach(b => b.style.cssText = "background-color: transparent !important; color: inherit; border-radius: 9999px;");
        const active = (op === '+') ? bA : bM;
        const isLight = ['yellow', 'lime', 'amber', 'cyan'].some(c => accent.toLowerCase().includes(c));
        active.style.cssText = `background-color: ${accent} !important; color: ${isLight ? '#000' : '#fff'} !important; border-radius: 9999px;`;
        
        op === '*' ? (multSec.classList.remove('hidden'), addSec.classList.add('hidden')) : (multSec.classList.add('hidden'), addSec.classList.remove('hidden'));
    }

    function toggleTable(n) {
        const btn = document.getElementById(`tab-${n}`);
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
        if(selectedTables.includes(n)) {
            selectedTables = selectedTables.filter(t => t !== n);
            btn.style.backgroundColor = ''; btn.style.color = '';
        } else {
            selectedTables.push(n);
            btn.style.backgroundColor = accent; btn.style.color = '#fff';
        }
    }

    function selectAllTables() { for(let i=1; i<=10; i++) if(!selectedTables.includes(i)) toggleTable(i); }

    function prepareAndGenerate() {
        let finalData = document.getElementById('quiz-data').value.trim();
        let autoLines = [];

        if (currentOp === '*' && selectedTables.length > 0) {
            selectedTables.forEach(t => { for(let i=1; i<=10; i++) autoLines.push(`${i} x ${t} ; ${i*t}`); });
        } else if (currentOp === '+') {
            const type = document.getElementById('auto-add-type').value;
            if (type === 'c10') for(let i=1; i<10; i++) autoLines.push(`${i} + ... = 10 ; ${10-i}`);
            else if (type === 'c20') for(let i=1; i<20; i++) autoLines.push(`${i} + ... = 20 ; ${20-i}`);
            else if (type === 'c100') for(let i=10; i<100; i+=10) autoLines.push(`${i} + ... = 100 ; ${100-i}`);
            else if (type === 'doubles') for(let i=1; i<=20; i++) autoLines.push(`Double de ${i} ; ${i*2}`);
        }

        if (autoLines.length > 0) { autoLines.sort(() => Math.random() - 0.5); finalData = autoLines.join('\n'); }
        
        if (!finalData) {
            document.getElementById('modal-erreur').style.display = 'flex';
            return;
        }
        
        pairs = finalData.split('\n').map(l => ({ q: l.split(';')[0]?.trim(), a: l.split(';')[1]?.trim() })).filter(p => p.q && p.a);
        renderDominos();
    }

    function renderDominos() {
        const grid = document.getElementById('dominos-grid');
        grid.innerHTML = '';
        pairs.forEach((pair, i) => {
            const prevA = (i === 0) ? pairs[pairs.length - 1].a : pairs[i-1].a;
            grid.innerHTML += `
                <div class="flex flex-col items-center">
                    <div class="domino-tile">
                        <div class="domino-half">${prevA}</div>
                        <div class="domino-divider"></div>
                        <div class="domino-half">${pair.q}</div>
                    </div>
                </div>`;
        });
        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('container-retour-liste').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const titreDoc = document.getElementById('quiz-title').value.trim() || "Dominos";
        
        doc.setFontSize(16);
        doc.text(titreDoc, 105, 15, { align: "center" });

        let x = 20, y = 25, w = 80, h = 30;

        // 1. G√âN√âRATION DU DOMINO DE TITRE (ENTIER)
        doc.setDrawColor(150);
        doc.setLineWidth(0.5);
        doc.rect(x, y, w, h);
        doc.setFontSize(14); // Titre un peu plus grand que le contenu
        doc.setFont("helvetica", "bold");
        doc.text(titreDoc, x + w/2, y + h/2 + 2, { align: "center", maxWidth: w - 10 });
        
        x += w + 10;

        // 2. G√âN√âRATION DES DOMINOS DE JEU
        doc.setFont("helvetica", "bold"); // Applique le gras pour tout le contenu
        doc.setLineWidth(0.2);
        
        pairs.forEach((pair, i) => {
            const prevA = (i === 0) ? pairs[pairs.length - 1].a : pairs[i-1].a;
            
            if (y > 260) { doc.addPage(); x = 20; y = 20; }

            doc.setDrawColor(150); 
            doc.rect(x, y, w, h); 
            doc.line(x + w/2, y, x + w/2, y + h); 
            
            // Taille augment√©e √† 18 comme demand√©
            doc.setFontSize(18); 
            doc.setTextColor(0);
            
            // Affichage avec maxWidth ajust√© pour √©viter que le texte ne touche les bords avec la taille 18
            doc.text(prevA, x + w/4, y + h/2 + 3, { align: "center", maxWidth: w/2 - 8 });
            doc.text(pair.q, x + (3*w/4), y + h/2 + 3, { align: "center", maxWidth: w/2 - 8 });

            x += w + 10;
            if (x > 150) { 
                x = 20; 
                y += h + 10; 
            }
        });
        
        const cleanTitre = titreDoc.toLowerCase().replace(/[^a-z0-9]/g, '_');
        doc.save(`outilsprofs_dominos_${cleanTitre}.pdf`);
    }

    function retourReglages() {
        document.getElementById('game-zone').classList.add('hidden');
        document.getElementById('setup-zone').classList.remove('hidden');
        document.getElementById('container-retour-liste').classList.remove('hidden');
    }

    window.onload = () => { appliquerTheme(); initTables(); };
</script>
</body>
</html>