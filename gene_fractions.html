<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>G√©n√©rateur de Fractions - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --accent-color: #06b6d4; --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s ease; }
        
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }

        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; transition: all 0.2s ease; cursor: pointer; border: none; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }

        .main-wrapper { width: 100%; max-width: 500px; margin: 0 auto; padding: 10px 15px 40px; }
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 20px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 20px; }
        
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border); border-radius: 0.75rem; padding: 10px; font-size: 0.85rem; font-weight: 700; width: 100%; color: var(--text-main); outline: none; }
        
        .btn-add { width: 100%; padding: 14px; border-radius: 50px; font-weight: 900; font-size: 12px; text-transform: uppercase; border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-add:active { transform: scale(0.95); }

        .btn-game-action { height: 40px; border-radius: 9999px; font-size: 10px; font-weight: 900; color: white; transition: all 0.2s ease; text-transform: uppercase; padding: 0 15px; display: flex; align-items: center; justify-content: center; gap: 4px; }

        .q-card { background: var(--card-bg); border-radius: 0.75rem; padding: 15px; border: 1px solid var(--column-border); display: flex; flex-direction: column; align-items: center; gap: 12px; }
        
        .math-fraction { display: inline-flex; flex-direction: column; align-items: center; font-weight: 900; font-size: 1.3rem; line-height: 1; color: var(--accent-color); }
        .fraction-bar { width: 110%; height: 2px; background-color: currentColor; margin: 2px 0; }
        .fraction-svg { max-width: 140px; height: auto; display: block; }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }

        @media (min-width: 768px) {
            .main-wrapper { max-width: 950px; }
            #questions-grid { grid-template-columns: repeat(3, 1fr); gap: 15px; }
        }
    </style>
</head>
<body class="dark-mode">

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
</script>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
    </a>
    <h1>G√©n√©rateur de fractions</h1>
    <button id="btn-aide" onclick="document.getElementById('modal-aide').style.display='flex'" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div id="container-retour-liste" class="mb-4 text-left">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" /></svg>
            Retour aux g√©n√©rateurs
        </a>
    </div>

    <div id="setup-zone" class="light-card space-y-4">
        <div>
            <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Titre de la fiche</label>
            <input type="text" id="quiz-title" class="input-field mb-4" placeholder="Ex: Fractions CM1 - √âvaluation">
            
            <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Donn√©es (Fraction ; Forme)</label>
            <textarea id="quiz-data" class="input-field h-40 font-normal" placeholder="1/2 ; disque&#10;3/4 ; bande"></textarea>
            
            <div class="flex justify-start mt-2">
                <button onclick="addExample()" class="px-3 py-1.5 rounded-lg border border-cyan-500/30 text-[8px] font-bold uppercase text-cyan-500 hover:bg-cyan-500/10 transition-colors">Charger un exemple</button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 text-center">Mode de rendu</label>
                <div class="grid grid-cols-2 gap-1 bg-black/10 p-1 rounded-xl">
                    <button onclick="setMode('prof')" id="mode-prof" class="p-2 text-[9px] font-bold uppercase transition-all">Prof</button>
                    <button onclick="setMode('eleve')" id="mode-eleve" class="p-2 text-[9px] font-bold uppercase transition-all">√âl√®ve</button>
                </div>
            </div>
            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 text-center">Chrono (min : sec)</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="t-min" value="1" class="input-field text-center">
                    <span class="font-bold">:</span>
                    <input type="number" id="t-sec" value="0" class="input-field text-center">
                </div>
            </div>
        </div>
        <button id="mainAddBtn" onclick="generateQuiz()" class="btn-add">Lancer le G√©n√©rateur</button>
    </div>

    <div id="game-zone" class="hidden space-y-6">
        <div id="timer-display" class="text-center p-3 rounded-xl bg-amber-500/10 border border-amber-500/20">
            <div id="seconds-left" class="text-2xl font-black text-amber-500">0:00</div>
        </div>
        <div id="questions-grid" class="grid grid-cols-1 gap-3"></div>
        <div class="flex flex-wrap justify-center gap-3 pt-4">
            <button onclick="retourReglages()" class="btn-game-action bg-gray-500">‚¨ÖÔ∏è retour</button>
            <button id="validate-btn" onclick="showCorrection()" class="btn-game-action bg-green-500">üëÅÔ∏è correction</button>
            <button onclick="exportToPDF()" class="btn-game-action bg-blue-500">üìÑ PDF</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide" class="text-lg font-black uppercase mb-4">üí° Aide Fractions</h2>
        <div class="text-[11px] leading-relaxed space-y-4">
            <p>1. <b>Saisie :</b> √âcrivez une fraction par ligne au format :<br><code class="bg-black/20 p-1 rounded">Num√©rateur/D√©nominateur ; Forme</code></p>
            <p>2. <b>Formes :</b> Vous pouvez choisir entre <b class="text-cyan-500">disque</b> ou <b class="text-cyan-500">bande</b>.</p>
            <p>3. <b>Modes :</b><br>‚Ä¢ <b>Prof :</b> Les formes sont d√©j√† colori√©es.<br>‚Ä¢ <b>√âl√®ve :</b> Les formes sont vides et cliquables.</p>
            <p>4. <b>PDF :</b> G√©n√®re une fiche propre pr√™te √† imprimer.</p>
        </div>
        <button onclick="document.getElementById('modal-aide').style.display='none'" id="btn-fermer-aide" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">J'ai compris</button>
    </div>
</div>

<script>
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#6b7280' };
    let currentQuestions = [], currentMode = 'prof', userAnswers = {}, isCorr = false, countdown;

    function appliquerTheme() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.gen || 'cyan'; 
        const hexa = mapCouleurs[colPref];
        const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(colPref) ? '#000' : '#fff';
        
        document.documentElement.style.setProperty('--accent-color', hexa);
        const btns = [
            document.getElementById('btn-retour-header'), 
            document.getElementById('btn-retour-liste'), 
            document.getElementById('btn-aide'), 
            document.getElementById('mainAddBtn'), 
            document.getElementById('btn-fermer-aide')
        ];
        btns.forEach(b => { if(b) { b.style.backgroundColor = hexa; b.style.color = contrast; } });
        if(document.getElementById('titre-aide')) document.getElementById('titre-aide').style.color = hexa;
        setMode(currentMode);
    }

    function setMode(m) {
        currentMode = m;
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
        const btnProf = document.getElementById('mode-prof');
        const btnEleve = document.getElementById('mode-eleve');
        
        if(!btnProf || !btnEleve) return;

        btnProf.style.cssText = "background-color: transparent !important; color: inherit; border-radius: 9999px;";
        btnEleve.style.cssText = "background-color: transparent !important; color: inherit; border-radius: 9999px;";

        const activeBtn = document.getElementById('mode-' + m);
        const isLight = ['yellow', 'lime', 'amber', 'cyan'].some(c => accent.toLowerCase().includes(c));
        activeBtn.style.cssText = `background-color: ${accent} !important; color: ${isLight ? '#000' : '#fff'} !important; border-radius: 9999px;`;
    }

    function addExample() {
        document.getElementById('quiz-title').value = "R√©visions : les fractions";
        const exemples = [];
        for(let i = 1; i <= 5; i++) {
            exemples.push(`${i}/${i+1} ; ${i % 2 === 0 ? 'disque' : 'bande'}`);
        }
        document.getElementById('quiz-data').value = exemples.join('\n');
    }

    function createFractionSVG(item, qIdx) {
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
        let svg = `<svg viewBox="0 0 100 100" class="fraction-svg" xmlns="http://www.w3.org/2000/svg">`;
        if (item.type === 'disque') {
            const cx = 50, cy = 50, r = 44;
            for (let i = 0; i < item.den; i++) {
                const a1 = (i * 360) / item.den - 90, a2 = ((i + 1) * 360) / item.den - 90;
                const x1 = cx + r * Math.cos(a1 * Math.PI / 180), y1 = cy + r * Math.sin(a1 * Math.PI / 180);
                const x2 = cx + r * Math.cos(a2 * Math.PI / 180), y2 = cy + r * Math.sin(a2 * Math.PI / 180);
                let filled = (currentMode === 'prof') ? (i < item.num) : (userAnswers[qIdx]?.includes(i));
                svg += `<path d="M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 0 1 ${x2} ${y2} Z" fill="${filled ? accent : 'transparent'}" stroke="currentColor" stroke-width="1" onclick="togglePart(${qIdx}, ${i})" style="cursor:pointer" />`;
            }
        } else {
            const w = 90, h = 40, x = 5, y = 30, step = w / item.den;
            for (let i = 0; i < item.den; i++) {
                let filled = (currentMode === 'prof') ? (i < item.num) : (userAnswers[qIdx]?.includes(i));
                svg += `<rect x="${x + i * step}" y="${y}" width="${step}" height="${h}" fill="${filled ? accent : 'transparent'}" stroke="currentColor" stroke-width="1" onclick="togglePart(${qIdx}, ${i})" style="cursor:pointer" />`;
            }
        }
        return svg + `</svg>`;
    }

    function togglePart(qIdx, pIdx) {
        if (currentMode === 'prof') return;
        if (!userAnswers[qIdx]) userAnswers[qIdx] = [];
        const pos = userAnswers[qIdx].indexOf(pIdx);
        pos > -1 ? userAnswers[qIdx].splice(pos, 1) : userAnswers[qIdx].push(pIdx);
        document.getElementById(`svg-cont-${qIdx}`).innerHTML = createFractionSVG(currentQuestions[qIdx], qIdx);
    }

    function generateQuiz() {
        const text = document.getElementById('quiz-data').value.trim();
        if (!text) return;
        let lines = text.split('\n').filter(l => l.trim() !== '');
        if (lines.length > 50) lines = lines.slice(0, 50);
        
        userAnswers = {}; isCorr = false;
        currentQuestions = lines.map(line => {
            const p = line.split(';');
            const f = p[0].trim();
            return { frac: f, num: parseInt(f.split('/')[0]), den: parseInt(f.split('/')[1]), type: p[1]?.toLowerCase().includes('bande') ? 'bande' : 'disque' };
        }).filter(q => !isNaN(q.num));

        render();

        // Gestion du chrono selon le mode
        if (currentMode === 'prof') {
            clearInterval(countdown);
            document.getElementById('timer-display').classList.add('hidden');
        } else {
            startTimer();
        }

        document.getElementById('validate-btn').style.display = (currentMode === 'prof') ? 'none' : 'flex';
        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('container-retour-liste').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');
    }

    function render() {
        const grid = document.getElementById('questions-grid');
        grid.innerHTML = '';
        
        // Application de 2 colonnes sur mobile uniquement en mode Prof
        if (currentMode === 'prof') {
            grid.className = "grid grid-cols-2 md:grid-cols-3 gap-3";
        } else {
            grid.className = "grid grid-cols-1 md:grid-cols-3 gap-3";
        }

        currentQuestions.forEach((q, i) => {
            const [n, d] = q.frac.split('/');
            grid.innerHTML += `<div class="q-card">
                <div class="math-fraction"><span>${n}</span><span class="fraction-bar"></span><span>${d}</span></div>
                <div id="svg-cont-${i}" class="w-full flex justify-center">${createFractionSVG(q, i)}</div>
                <div id="res-${i}" class="hidden text-[10px] font-black uppercase mt-2"></div>
            </div>`;
        });
    }

    function startTimer() {
        clearInterval(countdown);
        const mins = parseInt(document.getElementById('t-min').value) || 0;
        const secs = parseInt(document.getElementById('t-sec').value) || 0;
        let tl = (mins * 60) + secs;

        if (tl <= 0) { document.getElementById('timer-display').classList.add('hidden'); return; }
        document.getElementById('timer-display').classList.remove('hidden');
        
        const display = document.getElementById('seconds-left');
        countdown = setInterval(() => {
            display.innerText = `${Math.floor(tl/60)}:${(tl%60).toString().padStart(2,'0')}`;
            if (tl-- <= 0) { clearInterval(countdown); showCorrection(); }
        }, 1000);
    }

    function showCorrection() {
        isCorr = !isCorr;
        currentQuestions.forEach((q, i) => {
            const res = document.getElementById(`res-${i}`);
            res.innerHTML = (userAnswers[i]?.length === q.num) ? '<span class="text-green-500">‚úÖ Juste</span>' : '<span class="text-red-500">‚ùå Faux</span>';
            res.classList.toggle('hidden', !isCorr);
        });
        document.getElementById('validate-btn').innerText = isCorr ? "üôà masquer" : "üëÅÔ∏è correction";
    }

    function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // G√©n√©ration de la date au format AAAA-MM-JJ
    const maintenant = new Date();
    const yyyy = maintenant.getFullYear();
    const mm = String(maintenant.getMonth() + 1).padStart(2, '0');
    const dd = String(maintenant.getDate()).padStart(2, '0');
    const dateStr = `${yyyy}-${mm}-${dd}`;
    
    const titre = document.getElementById('quiz-title').value || "Fractions";
    const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
    
    // Nouveau format de nom de fichier
    const nomFichier = `outilsprofs_fractions_${dateStr}.pdf`;

    const drawQuestions = (isCorrection) => {
        doc.setFontSize(18);
        doc.text(titre + (isCorrection ? " - Correction" : ""), 105, 20, { align: "center" });
        let x = 20, y = 45;

        currentQuestions.forEach((q, i) => {
            if (y > 250) { doc.addPage(); y = 30; }
            const [n, d] = q.frac.split('/');
            doc.setFontSize(14);
            doc.text(n, x + 25, y - 8, { align: "center" });
            doc.line(x + 21, y - 6.5, x + 29, y - 6.5);
            doc.text(d, x + 25, y - 2, { align: "center" });
            
            if (q.type === 'disque') {
                const cx = x + 25, cy = y + 20, r = 18;
                if (isCorrection || currentMode === 'prof') {
                    doc.setFillColor(accent);
                    for (let j = 0; j < q.num; j++) {
                        for (let a = (j * 360 / q.den - 90); a < ((j + 1) * 360 / q.den - 90); a += 2) {
                            let a1 = a * Math.PI / 180, a2 = (a + 2.1) * Math.PI / 180;
                            doc.triangle(cx, cy, cx + r * Math.cos(a1), cy + r * Math.sin(a1), cx + r * Math.cos(a2), cy + r * Math.sin(a2), 'F');
                        }
                    }
                }
                doc.circle(cx, cy, r, 'S');
                for (let j = 0; j < q.den; j++) {
                    let ang = (j * 360 / q.den - 90) * Math.PI / 180;
                    doc.line(cx, cy, cx + r * Math.cos(ang), cy + r * Math.sin(ang));
                }
            } else {
                const bx = x, by = y + 10, w = 50, h = 15, step = w / q.den;
                if (isCorrection || currentMode === 'prof') { 
                    doc.setFillColor(accent); 
                    doc.rect(bx, by, step * q.num, h, 'F'); 
                }
                doc.rect(bx, by, w, h, 'S');
                for (let j = 0; j <= q.den; j++) doc.line(bx + j * step, by, bx + j * step, by + h);
            }
            x += 65; if (x > 160) { x = 20; y += 70; }
        });
    };

    drawQuestions(false);
    doc.addPage();
    drawQuestions(true);

    if (window.Android && window.Android.savePdfFromBase64) {
        const pdfBase64 = doc.output('datauristring').split(',')[1];
        window.Android.savePdfFromBase64(pdfBase64, nomFichier);
    } else {
        doc.save(nomFichier);
    }
}

    function retourReglages() { 
        clearInterval(countdown);
        document.getElementById('game-zone').classList.add('hidden');
        document.getElementById('setup-zone').classList.remove('hidden');
        document.getElementById('container-retour-liste').classList.remove('hidden');
    }

    window.onload = () => { appliquerTheme(); };
</script>
</body>
</html>