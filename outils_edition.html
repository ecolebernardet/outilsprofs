<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>√âdition - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap');
        
        :root { --bg-color: #f1f5f9; --card-bg: #ffffff; --text-main: #1e293b; }
        body { font-family: 'Outfit', sans-serif; background-color: var(--bg-color); color: var(--text-main); -webkit-tap-highlight-color: transparent; }
        
        .header-glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        .edition-card { background: var(--card-bg); border-radius: 24px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.03); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .edition-card:active { transform: scale(0.96); }
        .card-accent { position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }

        .btn-header-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .icon-box { width: 44px; height: 44px; border-radius: 14px; display: flex; align-items: center; justify-content: center; }
        
        /* Bouton retour aux outils sp√©cifique (sous le header) */
		#container-retour-liste {
    max-width: 500px; /* Align√© sur ton wrapper mobile */
    margin: 0 auto 20px auto;
    padding: 0 15px;
    display: flex;
    justify-content: flex-start;
}
#btn-retour-liste {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 50px;
    font-size: 11px;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: rgba(128, 128, 128, 0.1); /* Couleur de fond par d√©faut */
    transition: all 0.2s ease;
    text-decoration: none;
}

#btn-retour-liste:active {
    transform: scale(0.95);
}

        .btn-sub-action { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; padding: 8px 16px; border-radius: 50px; transition: all 0.2s; }
    </style>
</head>
<body class="pb-10">

    <header class="header-glass sticky top-0 z-50 px-4 py-3">
    <div class="max-w-2xl mx-auto flex items-center justify-between">
        <a href="index.html" id="btn-retour" class="btn-header-round bg-neutral-800 text-white shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="pageTitle" class="text-[14px] font-black uppercase tracking-[0.2em] text-slate-800">√âdition</h1>
        <button id="btn-aide" onclick="ouvrirAide()" class="text-xl">üí°</button>
    </div>
</header>

    <main class="max-w-2xl mx-auto px-4 mt-4">
        
        <div id="container-retour-liste">
        <a href="outils.html" id="btn-retour-liste">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux outils
        </a>
    </div>

        <div class="space-y-4">
            <div class="edition-card p-5 flex items-center gap-4 cursor-pointer" onclick="genererPDF()">
                <div class="card-accent bg-blue-500"></div>
                <div class="icon-box bg-blue-50 text-blue-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" stroke-width="2"></path></svg>
                </div>
                <div>
                    <h2 class="font-bold text-[16px]">Liste de classe</h2>
                    <p class="text-[11px] text-slate-400">PDF complet (Identit√©s & Niveaux)</p>
                </div>
            </div>

            <div class="edition-card p-5 flex items-center gap-4 cursor-pointer" onclick="genererEmargement()">
                <div class="card-accent bg-emerald-500"></div>
                <div class="icon-box bg-emerald-50 text-emerald-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke-width="2"></path></svg>
                </div>
                <div>
                    <h2 class="font-bold text-[16px]">Feuille de pointage</h2>
                    <p class="text-[11px] text-slate-400">Grille de 15 colonnes vierges</p>
                </div>
            </div>

            <div class="edition-card p-5 flex items-center gap-4 cursor-pointer" onclick="genererEtiquettes()">
                <div class="card-accent bg-amber-500"></div>
                <div class="icon-box bg-amber-50 text-amber-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" stroke-width="2"></path></svg>
                </div>
                <div>
                    <h2 class="font-bold text-[16px]">Grandes √âtiquettes</h2>
                    <p class="text-[11px] text-slate-400">8 par page (Casiers)</p>
                </div>
            </div>

            <div class="edition-card p-5 flex items-center gap-4 cursor-pointer" onclick="genererPetitesEtiquettes()">
                <div class="card-accent bg-rose-500"></div>
                <div class="icon-box bg-rose-50 text-rose-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 10h16M4 14h16M4 18h16" stroke-width="2"></path></svg>
                </div>
                <div>
                    <h2 class="font-bold text-[16px]">Petites √âtiquettes</h2>
                    <p class="text-[11px] text-slate-400">27 par page (Cahiers)</p>
                </div>
            </div>

            <div class="edition-card p-5 flex items-center gap-4 cursor-pointer" onclick="genererSuiviIndividuel()">
                <div class="card-accent bg-purple-500"></div>
                <div class="icon-box bg-purple-50 text-purple-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-width="2"></path></svg>
                </div>
                <div>
                    <h2 class="font-bold text-[16px]">Fiches de suivi</h2>
                    <p class="text-[11px] text-slate-400">Fiches individuelles A5 paysage</p>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-aide" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-6" onclick="fermerAide(event)">
    <div class="bg-white rounded-[32px] w-full max-w-sm overflow-hidden shadow-2xl animate-in zoom-in duration-300">
        <div class="p-8">
            <h3 id="aide-titre" class="text-2xl font-black mb-4 uppercase italic tracking-tight text-center">Module √©dition</h3>
            
            <div class="space-y-4 text-slate-500 text-[13px] leading-relaxed">
                <p class="font-semibold text-slate-800">Comment g√©n√©rer vos documents ?</p>
                
                <ul class="space-y-3">
                    <li class="flex gap-2">
                        <span class="text-blue-500">‚Ä¢</span>
                        <span>S√©lectionnez un type de document (Liste, Pointage, √âtiquettes).</span>
                    </li>
                    <li class="flex gap-2">
                        <span class="text-blue-500">‚Ä¢</span>
                        <span>Le PDF sera g√©n√©r√© automatiquement avec les √©l√®ves enregistr√©s.</span>
                    </li>
                    <li class="flex gap-2">
                        <span class="text-blue-500">‚Ä¢</span>
                        <span>Sur mobile, le fichier s'enregistre directement dans vos t√©l√©chargements.</span>
                    </li>
                </ul>

                <p class="bg-slate-50 p-3 rounded-xl italic">
                    Astuce : Assurez-vous d'avoir bien renseign√© votre nom dans la page "Ma classe" pour qu'il apparaisse sur les documents.
                </p>
            </div>

            <button onclick="document.getElementById('modal-aide').style.display='none'" id="btn-fermer-aide" class="w-full mt-8 py-4 rounded-2xl font-black uppercase tracking-widest text-xs text-white active:scale-95 shadow-lg">
                J'ai compris
            </button>
        </div>
    </div>
</div>

<script>
    // 1. Donn√©es et Configuration
    const mapCouleurs = {
        'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6',
        'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e',
        'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b',
        'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e',
        'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4',
        'sky': '#0ea5e9', 'slate': '#64748b'
    };

    const eleves = JSON.parse(localStorage.getItem('eleves')) || [];
    const modeTriApp = localStorage.getItem('mode_tri') || 'nom';
    const ordreNiveaux = ["TPS", "PS", "MS", "GS", "CP", "CE1", "CE2", "CM1", "CM2"];

    // 2. Initialisation au chargement (Application de la couleur dynamique)
    window.onload = () => {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.outils || 'blue'; 
        const hexa = mapCouleurs[colPref] || '#3b82f6';
        const isDarkText = ['yellow', 'lime', 'amber', 'cyan'].includes(colPref);
        const contrast = isDarkText ? '#000' : '#fff';

        // Bouton retour index (Header)
        const btnRetour = document.getElementById('btn-retour');
        if(btnRetour) {
            btnRetour.style.backgroundColor = hexa;
            btnRetour.style.color = contrast;
        }

        // Bouton Aide (Header)
        const btnAide = document.getElementById('btn-aide');
        if(btnAide) {
            btnAide.style.backgroundColor = hexa;
            btnAide.style.color = contrast;
            btnAide.style.width = '38px';
            btnAide.style.height = '38px';
            btnAide.style.borderRadius = '50%';
            btnAide.style.display = 'flex';
            btnAide.style.alignItems = 'center';
            btnAide.style.justifyContent = 'center';
        }

        // Bouton "Retour aux outils" (Sous-header) - MODIFI√â : Fond plein + Texte blanc
        const btnRetourListe = document.getElementById('btn-retour-liste');
        if (btnRetourListe) {
            btnRetourListe.style.backgroundColor = hexa;
            btnRetourListe.style.color = contrast;
        }

        // Bouton fermer modal
        const btnFermerAide = document.getElementById('btn-fermer-aide');
        if(btnFermerAide) {
            btnFermerAide.style.backgroundColor = hexa;
            btnFermerAide.style.color = contrast;
        }

        const aideTitre = document.getElementById('aide-titre');
        if(aideTitre) aideTitre.style.color = hexa;
    };

    // 3. Gestion de l'Aide
    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerAide(e) { if(e.target.id === 'modal-aide' || e.target.id === 'btn-fermer-aide') document.getElementById('modal-aide').style.display = 'none'; }

    // 4. Utilitaire Export PDF (Compatible Android & PC)
    function finaliserExportPDF(doc, nomFichier) {
        try {
            if (window.Android && typeof window.Android.savePdfFromBase64 === "function") {
                const pdfBase64 = doc.output('datauristring').split(',')[1];
                window.Android.savePdfFromBase64(pdfBase64, nomFichier);
            } else { 
                doc.save(nomFichier); 
            }
        } catch (e) { 
            console.error("Erreur export:", e); 
            doc.save(nomFichier); 
        }
    }

    // 5. Fonctions de G√©n√©ration
    function genererEmargement() {
        if (eleves.length === 0) { alert("La liste est vide !"); return; }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const nomEnseignantBrut = localStorage.getItem('nom_enseignant') || "enseignant";
        const maintenant = new Date();
        const dateFormattee = `${maintenant.getFullYear()}-${String(maintenant.getMonth() + 1).padStart(2, '0')}-${String(maintenant.getDate()).padStart(2, '0')}`;
        
        const groupes = {};
        eleves.forEach(el => { if (!groupes[el.niveau]) groupes[el.niveau] = []; groupes[el.niveau].push(el); });
        const niveauxPresents = Object.keys(groupes).sort((a, b) => ordreNiveaux.indexOf(a) - ordreNiveaux.indexOf(b));
        
        doc.setFontSize(16); 
        doc.text(`Feuille de pointage - ${nomEnseignantBrut}`, 105, 15, { align: "center" });
        
        let finalBody = []; 
        let compteurGlobal = 1;
        
        niveauxPresents.forEach(niv => {
            finalBody.push([{ content: niv, colSpan: 17, styles: { fillColor: [160, 160, 160], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'left' } }]);
            groupes[niv].sort((a, b) => {
                const pA = a.identite.split(" ")[0], nA = a.identite.split(" ").slice(1).join(" ");
                const pB = b.identite.split(" ")[0], nB = b.identite.split(" ").slice(1).join(" ");
                return modeTriApp === 'nom' ? nA.localeCompare(nB) : pA.localeCompare(pB);
            }).forEach((el) => {
                finalBody.push([compteurGlobal++, el.identite, ...Array(15).fill('')]);
            });
        });

        doc.autoTable({ 
            head: [[...Array(17).fill('')]], 
            body: finalBody, 
            startY: 25, 
            theme: 'grid', 
            styles: { fontSize: 7, cellPadding: 1.5, lineColor: [0, 0, 0] },
            columnStyles: { 0: { cellWidth: 7 }, 1: { cellWidth: 'auto' } },
            didParseCell: function (data) { 
                if (data.section === 'body' && data.cell.raw && data.cell.raw.colSpan === 17) { 
                    data.cell.styles.fillColor = [160, 160, 160]; 
                } 
            } 
        });

        finaliserExportPDF(doc, `pointage_${dateFormattee}.pdf`);
    }

    function genererPDF() {
        if (eleves.length === 0) { alert("La liste est vide !"); return; }
        const { jsPDF } = window.jspdf; 
        const doc = new jsPDF();
        const nomEnseignantBrut = localStorage.getItem('nom_enseignant') || "enseignant";
        const maintenant = new Date(); 
        const dateFormattee = `${maintenant.getFullYear()}-${String(maintenant.getMonth() + 1).padStart(2, '0')}-${String(maintenant.getDate()).padStart(2, '0')}`;
        
        const groupes = {}; 
        eleves.forEach(el => { if (!groupes[el.niveau]) groupes[el.niveau] = []; groupes[el.niveau].push(el); });
        const niveauxPresents = Object.keys(groupes).sort((a, b) => ordreNiveaux.indexOf(a) - ordreNiveaux.indexOf(b));

        doc.setFontSize(18); 
        doc.text(`Liste de la classe de ${nomEnseignantBrut}`, 105, 15, { align: "center" });
        
        let finalBody = []; 
        let compteurGlobal = 1;
        niveauxPresents.forEach(niv => {
            finalBody.push([{ content: niv, colSpan: 5, styles: { fillColor: [160, 160, 160], textColor: [255, 255, 255], fontStyle: 'bold' } }]);
            groupes[niv].forEach(el => {
                finalBody.push([compteurGlobal++, el.identite, el.dateNaissance || '-', el.sexe.toUpperCase(), el.niveau]);
            });
        });

        doc.autoTable({ body: finalBody, startY: 30, theme: 'grid', styles: { fontSize: 9 } });
        finaliserExportPDF(doc, `liste_classe_${dateFormattee}.pdf`);
    }

    function genererEtiquettes() {
        if (eleves.length === 0) { alert("La liste est vide !"); return; }
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const margin = 10; const gap = 10; const cols = 2; const rows = 4;
        const cardWidth = (210 - (2 * margin) - gap) / cols;
        const cardHeight = (297 - (2 * margin) - (3 * gap)) / rows;
        let col = 0, row = 0;

        eleves.forEach((el, index) => {
            if (index > 0 && index % (cols * rows) === 0) { doc.addPage(); col = 0; row = 0; }
            const x = margin + (col * (cardWidth + gap));
            const y = margin + (row * (cardHeight + gap));
            doc.setDrawColor(200); doc.roundedRect(x, y, cardWidth, cardHeight, 3, 3, 'S');
            doc.setFontSize(20); doc.text(el.identite.split(" ")[0], x + cardWidth / 2, y + cardHeight / 2, { align: 'center' });
            col++; if (col === cols) { col = 0; row++; }
        });
        finaliserExportPDF(doc, "etiquettes_grandes.pdf");
    }

    function genererPetitesEtiquettes() {
        if (eleves.length === 0) { alert("La liste est vide !"); return; }
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const cols = 3, rows = 9, margin = 10;
        const cardW = (210 - 20) / cols, cardH = (297 - 20) / rows;
        let c = 0, r = 0;

        eleves.forEach((el, i) => {
            if (i > 0 && i % 27 === 0) { doc.addPage(); c = 0; r = 0; }
            doc.setDrawColor(230); doc.rect(10 + c * cardW, 10 + r * cardH, cardW, cardH);
            doc.setFontSize(10); doc.text(el.identite.split(" ")[0], 10 + c * cardW + cardW / 2, 10 + r * cardH + cardH / 2, { align: 'center' });
            c++; if (c === cols) { c = 0; r++; }
        });
        finaliserExportPDF(doc, "etiquettes_petites.pdf");
    }

    function genererSuiviIndividuel() {
        if (eleves.length === 0) { alert("La liste est vide !"); return; }
        const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4');
        eleves.forEach((el, index) => {
            if (index > 0 && index % 2 === 0) doc.addPage('l');
            const offsetX = (index % 2) * 148.5;
            doc.setFontSize(14); doc.text(el.identite, offsetX + 74, 40, { align: "center" });
            doc.rect(offsetX + 10, 50, 128, 140);
        });
        finaliserExportPDF(doc, "fiches_suivi.pdf");
    }
</script>
</body>
</html>