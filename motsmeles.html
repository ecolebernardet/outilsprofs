<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mots M√™l√©s - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s ease; }
        
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }

        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; transition: all 0.2s ease; cursor: pointer; border: none; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }

        .main-wrapper { width: 100%; max-width: 450px; margin: 0 auto; padding: 10px 15px 40px; }
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 20px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 20px; }
        
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border); border-radius: 0.75rem; padding: 12px; font-size: 0.85rem; font-weight: 700; width: 100%; color: var(--text-main); outline: none; }
        
        .btn-add { width: 100%; padding: 14px; border-radius: 50px; font-weight: 600; font-size: 12px; 
            border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-add:active { transform: scale(0.95); }

        #word-grid { display: grid; gap: 2px; margin: 0 auto; background: var(--column-border); border: 2px solid var(--column-border); border-radius: 8px; overflow: hidden; width: fit-content; }
        .grid-cell { width: 18px; height: 18px; background: var(--card-bg); display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 11px; text-transform: uppercase; }

        .bottom-nav { width: 100%; max-width: 450px; margin: 20px auto 0; display: flex; flex-direction: column; gap: 8px; }
        .nav-group { display: flex; gap: 8px; width: 100%; }
        .nav-btn { font-weight: 900; border-radius: 50px; font-size: 8px; padding: 12px; border: none; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; text-transform: uppercase; }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
    </style>
</head>
<body>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
</script>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1>Mots M√™l√©s</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div id="setup-zone" class="light-card space-y-6">
        <div>
            <label class="block text-[10px] font-black uppercase opacity-50 mb-2 tracking-widest">Titre de la grille</label>
            <input type="text" id="grid-title" placeholder="Ex: Les Animaux" class="input-field text-left">
        </div>

        <div>
            <label class="block text-[10px] font-black uppercase opacity-50 mb-2 tracking-widest">Liste des mots (s√©par√©s par une virgule)</label>
            <textarea id="word-list" rows="4" class="input-field text-left" placeholder="Lion, Tigre, Elephant..."></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-[10px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Taille (Max 20)</label>
                <input type="number" id="grid-size" value="10" min="5" max="20" class="input-field text-center">
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Difficult√©</label>
                <select id="difficulty" class="input-field">
                    <option value="easy">Facile (H/V)</option>
                    <option value="hard">Expert (Diag)</option>
                </select>
            </div>
        </div>

        <button id="mainAddBtn" onclick="generateWordSearch()" class="btn-add">G√©n√©rer la grille</button>
        <label class="btn-add bg-black text-white cursor-pointer flex items-center justify-center gap-2 mt-2">
            üëá charger un fichier .txt üëá
            <input type="file" class="hidden" accept=".txt" onchange="importData(event)">
        </label>        
    </div>
    
    <div id="game-zone" class="hidden space-y-6">
        <h2 id="display-title" class="text-center font-black uppercase tracking-widest"></h2>
        <div id="word-grid"></div>
        <div id="words-to-find" class="flex flex-wrap gap-2 justify-center text-[10px] font-bold opacity-70"></div>

        <footer class="bottom-nav">
            <div class="nav-group">
                <button onclick="exportToTXT()" class="nav-btn bg-black text-white flex-1">üëÜ exporter .txt</button>
                <button onclick="exportToPDF()" class="nav-btn bg-black text-white flex-1">üìÑ exporter .pdf</button>
            </div>
            <button onclick="retourReglages()" class="nav-btn bg-gray-500 text-white shadow-lg">‚¨ÖÔ∏è retour aux r√©glages</button>
        </footer>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide" class="text-lg font-black uppercase mb-4">üí° Aide Mots M√™l√©s</h2>
        <div class="text-[11px] leading-relaxed space-y-2 opacity-80">
            <p>1. Saisissez un titre et vos mots (s√©par√©s par des virgules).</p>
            <p>2. "Exporter .pdf" g√©n√®re la fiche pr√™te √† imprimer avec mots tri√©s.</p>
        </div>
        <button id="btn-fermer-aide" onclick="fermerModal('modal-aide')" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">Fermer</button>
    </div>
</div>

<div id="modal-import-success" class="modal-overlay" onclick="fermerModal('modal-import-success')">
    <div class="modal-content text-center" onclick="event.stopPropagation()">
        <div class="text-4xl mb-4">‚úÖ</div>
        <h2 class="text-lg font-black uppercase mb-2">Chargement r√©ussi</h2>
        <p class="text-[11px] opacity-80 mb-6">Votre grille a √©t√© import√©e avec succ√®s.</p>
        <button id="btn-fermer-import" onclick="fermerModal('modal-import-success')" class="w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">C'est parti !</button>
    </div>
</div>

<div id="modal-error-empty" class="modal-overlay" onclick="fermerModal('modal-error-empty')">
    <div class="modal-content text-center" onclick="event.stopPropagation()">
        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
        <h2 class="text-lg font-black uppercase mb-2">Oups !</h2>
        <p class="text-[11px] opacity-80 mb-6">Veuillez entrer au moins quelques mots s√©par√©s par des virgules.</p>
        <button id="btn-fermer-erreur" onclick="fermerModal('modal-error-empty')" class="w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">D'accord</button>
    </div>
</div>

<script>
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#6b7280' };
    let finalGrid = [];
    let gridSize = 10;

    function generateWordSearch() {
        const title = document.getElementById('grid-title').value || "Mots M√™l√©s";
        const rawWords = document.getElementById('word-list').value;
        gridSize = parseInt(document.getElementById('grid-size').value) || 10;
        
        if (!rawWords || rawWords.trim() === "") {
            document.getElementById('modal-error-empty').style.display = 'flex';
            return;
        }

        const words = rawWords.split(',').map(w => w.trim().toUpperCase()).filter(w => w.length > 0);
        finalGrid = Array(gridSize).fill().map(() => Array(gridSize).fill(''));

        words.forEach(word => {
            let placed = false, attempts = 0;
            while (!placed && attempts < 100) {
                const dir = document.getElementById('difficulty').value === 'easy' ? Math.floor(Math.random() * 2) : Math.floor(Math.random() * 4);
                let dr = 0, dc = 0;
                if (dir === 0) dc = 1; else if (dir === 1) dr = 1; else if (dir === 2) { dr = 1; dc = 1; } else if (dir === 3) dc = -1;
                let r = Math.floor(Math.random() * gridSize), c = Math.floor(Math.random() * gridSize);
                if (canPlace(word, r, c, dr, dc)) {
                    for (let i = 0; i < word.length; i++) finalGrid[r + i * dr][c + i * dc] = word[i];
                    placed = true;
                }
                attempts++;
            }
        });

        for (let r = 0; r < gridSize; r++) {
            for (let c = 0; c < gridSize; c++) if (finalGrid[r][c] === '') finalGrid[r][c] = String.fromCharCode(65 + Math.floor(Math.random() * 26));
        }
        renderGrid(title, words);
    }

    function canPlace(word, r, c, dr, dc) {
        if (r + (word.length - 1) * dr >= gridSize || r + (word.length - 1) * dr < 0) return false;
        if (c + (word.length - 1) * dc >= gridSize || c + (word.length - 1) * dc < 0) return false;
        for (let i = 0; i < word.length; i++) {
            const char = finalGrid[r + i * dr][c + i * dc];
            if (char !== '' && char !== word[i]) return false;
        }
        return true;
    }

    function renderGrid(title, words) {
        const gridEl = document.getElementById('word-grid');
        gridEl.style.gridTemplateColumns = `repeat(${gridSize}, 18px)`;
        gridEl.innerHTML = finalGrid.flat().map(l => `<div class="grid-cell">${l}</div>`).join('');
        document.getElementById('display-title').innerText = title;
        document.getElementById('words-to-find').innerHTML = words.sort().map(w => `<span>${w}</span>`).join(' ‚Ä¢ ');
        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const rawTitle = document.getElementById('grid-title').value || "Mots Meles";
        const dateStr = new Date().toISOString().split('T')[0];
        const cleanTitleForFile = rawTitle.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/gi, '');
        
        // TRI ALPHAB√âTIQUE
        const mots = document.getElementById('word-list').value.split(',')
            .map(w => w.trim().toUpperCase())
            .filter(w => w.length > 0)
            .sort((a, b) => a.localeCompare(b, 'fr'));

        doc.setFont("helvetica", "bold").setFontSize(18);
        doc.text(rawTitle, 105, 20, { align: "center" });

        const cellSize = 8, startX = (210 - (gridSize * cellSize)) / 2, startY = 40;
        finalGrid.forEach((row, r) => {
            row.forEach((letter, c) => {
                const x = startX + (c * cellSize), y = startY + (r * cellSize);
                doc.setDrawColor(180).rect(x, y, cellSize, cellSize);
                doc.setTextColor(0).setFontSize(11).text(letter, x + 4, y + 5.5, { align: "center" });
            });
        });

        const listY = startY + (gridSize * cellSize) + 15;
        doc.setFont("helvetica", "bold").setFontSize(11).text("MOTS √Ä TROUVER :", 20, listY);
        doc.setFont("helvetica", "normal").setFontSize(10);
        
        // LOGIQUE 3 COLONNES - CLASSEMENT PAR COLONNE
        const nbMots = mots.length;
        const nbLignes = Math.ceil(nbMots / 3);
        const colWidth = 63;

        mots.forEach((m, i) => {
            const col = Math.floor(i / nbLignes); // D√©termine la colonne
            const row = i % nbLignes;            // D√©termine la ligne dans la colonne
            doc.text("‚Ä¢ " + m, 20 + (col * colWidth), listY + 8 + (row * 7));
        });

        doc.save(`outilsprofs_mots_meles_${cleanTitleForFile}_${dateStr}.pdf`);
    }

    function exportToTXT() {
        const rawTitle = document.getElementById('grid-title').value || "grille";
        const dateStr = new Date().toISOString().split('T')[0];
        const cleanTitleForFile = rawTitle.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/gi, '');
        
        const data = { 
            title: rawTitle, 
            words: document.getElementById('word-list').value, 
            size: gridSize, 
            diff: document.getElementById('difficulty').value 
        };
        const blob = new Blob([JSON.stringify(data)], { type: 'text/plain' });
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = `outilsprofs_mots_meles_${cleanTitleForFile}_${dateStr}.txt`; 
        a.click();
    }

    function importData(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                document.getElementById('grid-title').value = d.title || "";
                document.getElementById('word-list').value = d.words || "";
                document.getElementById('grid-size').value = d.size || 10;
                document.getElementById('difficulty').value = d.diff || "easy";
                document.getElementById('modal-import-success').style.display = 'flex';
                retourReglages();
            } catch(e) { alert("Fichier invalide"); }
        };
        reader.readAsText(event.target.files[0]);
    }

    function appliquerTheme() {
        if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
        else document.body.classList.remove('light-mode');

        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const hexa = mapCouleurs[themePrefs.gen || 'cyan'];
        const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(themePrefs.gen || 'cyan') ? '#000' : '#fff';
        
        [document.getElementById('btn-retour-header'), document.getElementById('btn-aide'), document.getElementById('mainAddBtn'), document.getElementById('btn-fermer-aide'), document.getElementById('btn-fermer-import'), document.getElementById('btn-fermer-erreur')].forEach(el => {
            if(el) { el.style.backgroundColor = hexa; el.style.color = contrast; }
        });
    }

    function retourReglages() { document.getElementById('setup-zone').classList.remove('hidden'); document.getElementById('game-zone').classList.add('hidden'); }
    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onload = appliquerTheme;
</script>
</body>
</html>