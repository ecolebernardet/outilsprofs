<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ma classe - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* ====================== CSS CONFIGURATION ====================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-body: #121212; --text-main: #ffffff; --header-bg: #1e1e1e;
            --header-border: rgba(255, 255, 255, 0.1); --card-bg: #1e1e1e; --input-bg: #2a2a2a;
            --sub-text: #a1a1aa; --student-item-bg: #1e1e1e;
            --student-name-girl: #f472b6; --student-name-boy: #60a5fa;
            --modal-bg: rgba(0, 0, 0, 0.8); --shadow-color: rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-body: #eeeeee; --text-main: #111827; --header-bg: #ffffff; --header-border: #ddd;
            --card-bg: #ffffff; --input-bg: #f3f4f6; --sub-text: #71717a; --student-item-bg: #ffffff;
            --modal-bg: rgba(255, 255, 255, 0.8); --shadow-color: rgba(0, 0, 0, 0.1);
        }

        body { 
            font-family: 'Inter', sans-serif; background-color: var(--bg-body); 
            color: var(--text-main); padding: 0 15px 20px 15px; margin: 0; 
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Header & Navigation */
        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--header-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between;
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; width: calc(100% + 30px); margin-left: -15px;
        }

        .tab-nav { 
            display: flex; background: var(--header-bg); border-bottom: 1px solid var(--header-border);
            margin-left: -15px; width: calc(100% + 30px); position: sticky; top: 60px; z-index: 90;
        }

        .tab-btn { 
            flex: 1; padding: 12px; font-size: 10px; font-weight: 800; text-transform: uppercase;
            text-align: center; opacity: 0.5; border-bottom: 3px solid transparent; transition: all 0.3s; cursor: pointer;
        }

        .tab-btn.active { opacity: 1; border-bottom-color: var(--text-main); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards & Inputs */
        .light-card { 
            background: var(--card-bg); border-radius: 1.5rem; 
            border: 1px solid var(--header-border); box-shadow: 0 10px 25px -5px var(--shadow-color);
        }

        .input-field { 
            background: var(--input-bg); border: 1px solid var(--header-border); 
            color: var(--text-main); border-radius: 0.75rem; padding: 10px; 
            outline: none; font-size: 0.75rem; font-weight: 600;
        }

        .select-date { 
            background: var(--input-bg); border: 1px solid var(--header-border); 
            color: var(--text-main); border-radius: 0.75rem; height: 30px; 
            outline: none; font-size: 0.75rem; font-weight: 600; appearance: none; text-align: center;
        }

        /* Card Radio Selection */
        .card-input { display: none; }

        .card-label {
            display: flex; align-items: center; justify-content: center; text-align: center;
            background: var(--input-bg); border: 1px solid var(--header-border); color: var(--text-main);
            height: 30px; border-radius: 0.75rem; cursor: pointer; font-size: 0.75rem; font-weight: 800;
            text-transform: uppercase; transition: all 0.2s ease;
        }

        .input-garcon:checked + .card-label { 
            color: #fff; border-color: var(--student-name-boy); background: var(--student-name-boy); font-weight: 900;
        }

        .input-fille:checked + .card-label { 
            color: #fff; border-color: var(--student-name-girl); background: var(--student-name-girl); font-weight: 900;
        }

        .input-cp:checked + .card-label { background: #ec4899; border-color: #ec4899; color: #fff; } 
        .input-ce1:checked + .card-label { background: #3b82f6; border-color: #3b82f6; color: #fff; } 
        .input-ce2:checked + .card-label { background: #eab308; border-color: #eab308; color: #000; } 
        .input-cm1:checked + .card-label { background: #ef4444; border-color: #ef4444; color: #fff; } 
        .input-cm2:checked + .card-label { background: #22c55e; border-color: #22c55e; color: #fff; } 
        .input-autre:checked + .card-label { background: #8b5cf6; border-color: #8b5cf6; color: #fff; }

        /* Student Items */
        .student-item { 
            background: var(--student-item-bg); padding: 5px 12px; border-radius: 40px; 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; 
            border: 1px solid var(--header-border); box-shadow: 0 2px 5px var(--shadow-color); cursor: pointer;
        }

        .text-girl-custom { color: var(--student-name-girl) !important; }
        .text-boy-custom { color: var(--student-name-boy) !important; }

        /* Buttons & UI Elements */
        .btn-nav { 
            font-weight: 800; padding: 12px 4px; border-radius: 50px; font-size: 8px; 
            text-align: center; width: 100%; cursor: pointer; border: 2px solid transparent; transition: all 0.3s;
        }

        .stat-pill { 
            padding: 5px 10px; border-radius: 99px; font-size: 9px; font-weight: 800; text-transform: uppercase;
            display: flex; align-items: center; gap: 4px; background-color: var(--card-bg); 
            border: 1px solid var(--header-border); color: var(--text-main);
        }

        .header-btn { 
            display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; 
            border-radius: 50%; border: 1px solid var(--header-border); transition: transform 0.1s ease, background-color 0.3s ease;
        }

        /* Animations */
        @keyframes blink-border {
            0% { border-color: #f97316; box-shadow: 0 0 2px #f97316; }
            50% { border-color: transparent; box-shadow: 0 0 10px #f97316; }
            100% { border-color: #f97316; box-shadow: 0 0 2px #f97316; }
        }

        @keyframes blink-point {
            0% { transform: scale(0.9); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.5; }
        }

        .notif-export { border-color: #f97316 !important; animation: blink-border 1.5s infinite; }
        
        .mini-pastille {
            display: inline-block; width: 8px; height: 8px; background-color: #f97316; border-radius: 50%;
            margin-left: 4px; margin-right: 2px; box-shadow: 0 0 5px #f97316; animation: blink-point 1.5s infinite;
        }

        /* Modals */
        #custom-confirm { 
            display: none; position: fixed; inset: 0; z-index: 9999; 
            background: var(--modal-bg); backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 20px;
        }

        .confirm-card { 
            background: var(--card-bg); border: 1px solid var(--header-border); width: 100%; max-width: 320px; 
            border-radius: 1.5rem; padding: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); text-align: center;
        }

        #modal-aide { 
            display: none; position: fixed; inset: 0; z-index: 10000; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px;
        }

        .modal-content { 
            background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; 
            border: 1px solid var(--header-border); padding: 25px; position: relative; 
            box-shadow: 0 10px 25px -5px var(--shadow-color);
        }

        #modal-form { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; 
            align-items: center; justify-content: center;
        }

        .modal-content-form { 
            background: var(--card-bg); width: 90%; max-width: 500px; padding: 25px; 
            border-radius: 20px; max-height: 90vh; overflow-y: auto; 
            border: 1px solid var(--header-border); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        #niveauSelect option { background: var(--card-bg); color: var(--text-main); }

        /* Layout Grid */
        .pinterest-grid { column-count: 2; column-gap: 12px; width: 100%; }
        .pinterest-item { break-inside: avoid; margin-bottom: 20px; display: inline-block; width: 100%; }

        /* ============ FLOATING ACTION BUTTON ============ */
        .fab-add {
            position: fixed;
            bottom: 60px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.6), 0 8px 10px -6px rgba(0, 0, 0, 0.6);
            color: white;
        }

        .fab-add:hover {
            transform: scale(1.1);
        }

        .fab-add:active {
            transform: scale(0.9);
        }

    </style>
</head>

<body class="pb-10">
<script>
    if (localStorage.getItem('theme_mode') === 'light') { document.body.classList.add('light-mode'); }
</script>

    <!-- ====================== MODALS ====================== -->
    <div id="custom-confirm">
        <div class="confirm-card">
            <p id="confirm-msg" class="font-bold text-sm mb-6 leading-tight"></p>
            <div id="confirm-buttons" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <div id="modal-aide" onclick="fermerAide()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="aide-titre" class="text-lg font-black uppercase mb-4">üí° Ma classe</h2>
            <div class="text-[11px] leading-relaxed space-y-2 opacity-80">
                <strong>Onglet "Enregistrement" :</strong>
                <br>‚Ä¢ <strong>Nom de l'enseignant :</strong> Saisissez votre nom et validez avec "OK" pour personnaliser vos documents.
                <br>‚Ä¢ <strong>Ajouter un √©l√®ve :</strong> Cliquez sur le bouton <span class="font-bold text-orange-500">+</span> en bas √† droite pour ouvrir le formulaire.
                <br>‚Ä¢ <strong>Saisie :</strong> Renseignez l'identit√©, le genre et le niveau de l'√©l√®ve, puis enregistrez. La date de naissance est optionnelle.
                <br>‚Ä¢ <strong>Modifier un √©l√®ve :</strong> Cliquez sur le nom de l'√©l√®ve pour ouvrir le formulaire et modifier les informations le concernant.
                <br>‚Ä¢ <strong>Import/Export :</strong> Sauvegardez votre liste sur votre appareil ou transf√©rez-la au format <em>.txt</em> (Pr√©nom;NOM;genre;niveau).
                <br><br><strong>La liste g√©n√©r√©e sera utilis√©e dans toutes les autres rubriques de l'application.</strong>
                <br><br>
                <strong>Onglet "√âdition" :</strong>
                <br>‚Ä¢ <strong>G√©n√©rez</strong> vos listes (PDF ou pointage), vos √©tiquettes ou vos fiches de suivi individuel en un clic.
                <br>‚Ä¢ <strong>Tri :</strong> Pensez √† choisir le tri (par Nom ou Pr√©nom) dans l'onglet Enregistrement avant de g√©n√©rer vos documents.
                <br><br><strong>Pastille <span class="mini-pastille"></span> :</strong> Si elle appara√Æt sur le bouton d'exportation, vos donn√©es locales ont √©t√© modifi√©es depuis votre dernier export. Cliquez sur "üëÜ exporter.txt üëÜ" pour s√©curiser votre liste.
            </div>
            <button id="btn-fermer-aide" onclick="fermerAide()" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest active:scale-95 transition-transform">Fermer</button>
        </div>
    </div>

    <!-- ====================== HEADER ====================== -->
    <header>
        <a href="index.html" id="btn-retour" class="header-btn shadow-lg active:scale-90">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="page-title" class="text-lg font-black tracking-normal uppercase flex-grow text-center">Ma classe</h1>
        <button id="btn-aide" onclick="ouvrirAide()" class="header-btn shadow-lg active:scale-90 text-lg">üí°</button>
    </header>

    <!-- ====================== TABS ====================== -->
    <nav class="tab-nav">
        <div id="tab-btn-classe" class="tab-btn active" onclick="switchTab('classe')">Module Enregistrement</div>
        <div id="tab-btn-editeur" class="tab-btn" onclick="switchTab('editeur')">Module √âdition</div>
    </nav>

    <!-- ====================== MAIN CONTENT ====================== -->
    <div class="max-w-4xl mx-auto p-0 mt-2">
        <!-- Tab Classe -->
        <div id="tab-classe" class="tab-content active">
            <div id="profil-container" class="max-w-md mx-auto light-card p-3 mb-4 border-dotted border-2" style="border-color: var(--header-border)">
                <div class="flex flex-col gap-0">
                    <label class="text-[9px] font-black uppercase opacity-60 ml-1">Nom de l'enseignant :</label>
                    <div class="flex gap-2 items-center">
                        <input type="text" id="nomEnseignant" placeholder="ex: M. PROF" class="input-field flex-grow border-none shadow-inner" style="background: rgba(0,0,0,0.05)">
                        <button id="btn-save-nom" onclick="sauvegarderNomEnseignant()" class="h-[30px] px-3 rounded-lg text-[10px] font-black uppercase transition-transform active:scale-90">OK</button>
                    </div>
                </div>
            </div>

            <button id="fab-plus" onclick="ouvrirFormulaire()" 
                class="fab-add" 
                style="background-color: var(--theme-color); color: white; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.6), 0 8px 10px -6px rgba(0, 0, 0, 0.6);">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" />
                </svg>
            </button>

            <div id="modal-form" onclick="fermerFormulaire(event)">
                <div class="modal-content-form" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="form-title" class="text-sm font-black uppercase tracking-widest" style="color:var(--text-main)">√âl√®ve</h2>
                        <button onclick="document.getElementById('modal-form').style.display='none'" class="text-3xl" style="color:var(--sub-text)">&times;</button>
                    </div>
                    <form id="eleveForm" class="space-y-4">
                        <input type="hidden" id="edit-id">
                        <div class="flex flex-col gap-1">
                            <label class="text-[9px] font-black uppercase opacity-60 ml-1">Identit√© de l'√©l√®ve :</label>
                            <input type="text" id="nomComplet" placeholder="Pr√©nom NOM" class="input-field" required>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[9px] font-black uppercase opacity-60 ml-1">Date de naissance (optionnel) :</label>
                            <div class="grid grid-cols-3 gap-2">
                                <select id="birth-day" class="select-date"></select>
                                <select id="birth-month" class="select-date"></select>
                                <select id="birth-year" class="select-date"></select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="flex flex-col gap-1">
                                <label class="text-[9px] font-black uppercase opacity-60 ml-1">Genre :</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <input type="radio" name="sexe" value="G" id="sexeG" class="card-input input-garcon" checked>
                                        <label for="sexeG" class="card-label">Gar√ßon</label>
                                    </div>
                                    <div>
                                        <input type="radio" name="sexe" value="F" id="sexeF" class="card-input input-fille">
                                        <label for="sexeF" class="card-label">Fille</label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-[9px] font-black uppercase opacity-60 ml-1">Niveau :</label>
                                <div class="relative">
                                    <select id="niveauSelect" class="input-field w-full appearance-none pr-8">
                                        <option value="CP">CP</option>
                                        <option value="CE1">CE1</option>
                                        <option value="CE2">CE2</option>
                                        <option value="CM1">CM1</option>
                                        <option value="CM2">CM2</option>
                                        <option value="AUTRE">AUTRE</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none opacity-50">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" id="btn-submit" class="w-full py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all mt-2">Enregistrer</button>
                    </form>
                </div>
            </div>

            <div id="stats-container" class="max-w-md mx-auto mb-4 flex flex-wrap justify-center gap-2"></div>

            <div id="sort-controls" class="max-w-md mx-auto mb-5 flex justify-center items-center p-1 rounded-xl border border-white/10" style="background: var(--card-bg);">
                <div class="flex items-center gap-3">
                    <span class="text-[9px] font-black uppercase opacity-60">Trier par :</span>
                    <div class="flex gap-2">
                        <button onclick="changerTriApp('prenom')" id="sort-prenom" class="text-[9px] font-black uppercase px-3 py-0.5 rounded-lg border border-white/10">Pr√©nom</button>
                        <button onclick="changerTriApp('nom')" id="sort-nom" class="text-[9px] font-black uppercase px-3 py-0.5 rounded-lg border border-white/10">Nom</button>
                    </div>
                </div>
            </div>

            <div id="listeContainer"></div>

            <div class="max-w-md mx-auto flex flex-col gap-3 mt-6 mb-10">
                <div class="grid grid-cols-2 gap-2"> 
                    <button onclick="importerListe()" class="btn-nav bg-neutral-800 text-white shadow-md">üëá importer .txt üëá</button>
                    <button id="btn-exporter-txt" onclick="exporterListe()" class="btn-nav bg-neutral-800 text-white shadow-md">üëÜ exporter.txt üëÜ</button>
                    <input type="file" id="fileInput" class="hidden" accept=".txt">
                </div>
                <button onclick="toutEffacer()" class="btn-nav bg-red-500 text-red-100 shadow-md">‚ö†Ô∏è effacer la liste</button>
            </div>
        </div>

        <!-- Tab Editeur -->
        <div id="tab-editeur" class="tab-content">
            <div class="max-w-md mx-auto flex flex-col gap-4 mt-4">
                <button onclick="genererPDF()" class="group flex items-center p-4 rounded-2xl shadow-sm border active:scale-95 transition-all" style="background: var(--card-bg); border-color: var(--header-border);">
                    <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-500 mr-4 group-hover:bg-blue-500 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.707.293V21z" /></svg>
                    </div>
                    <div class="text-left">
                        <div class="text-xs font-black uppercase" style="color: var(--text-main);">Liste de classe</div>
                        <div class="text-[10px] opacity-60" style="color: var(--text-main);">Format tableau classique A4</div>
                    </div>
                </button>

                <button onclick="genererEmargement()" class="group flex items-center p-4 rounded-2xl shadow-sm border active:scale-95 transition-all" style="background: var(--card-bg); border-color: var(--header-border);">
                    <div class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-500 mr-4 group-hover:bg-emerald-500 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                    </div>
                    <div class="text-left">
                        <div class="text-xs font-black uppercase" style="color: var(--text-main);">Feuille de pointage</div>
                        <div class="text-[10px] opacity-60" style="color: var(--text-main);">Grille avec 15 cases de suivi</div>
                    </div>
                </button>

                <button onclick="genererEtiquettes()" class="group flex items-center p-4 rounded-2xl shadow-sm border active:scale-95 transition-all" style="background: var(--card-bg); border-color: var(--header-border);">
                    <div class="w-10 h-10 rounded-full bg-amber-500/10 flex items-center justify-center text-amber-500 mr-4 group-hover:bg-amber-500 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 11h.01M7 15h.01M13 7h.01M13 11h.01M13 15h.01M17 7h.01M17 11h.01M17 15h.01" /></svg>
                    </div>
                    <div class="text-left">
                        <div class="text-xs font-black uppercase" style="color: var(--text-main);">Grandes √âtiquettes</div>
                        <div class="text-[10px] opacity-60" style="color: var(--text-main);">8 √©tiquettes par page A4</div>
                    </div>
                </button>

                <button onclick="genererPetitesEtiquettes()" class="group flex items-center p-4 rounded-2xl shadow-sm border active:scale-95 transition-all" style="background: var(--card-bg); border-color: var(--header-border);">
                    <div class="w-10 h-10 rounded-full bg-rose-500/10 flex items-center justify-center text-rose-500 mr-4 group-hover:bg-rose-500 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                    </div>
                    <div class="text-left">
                        <div class="text-xs font-black uppercase" style="color: var(--text-main);">Petites √âtiquettes</div>
                        <div class="text-[10px] opacity-60" style="color: var(--text-main);">27 √©tiquettes par page (Format 3x9)</div>
                    </div>
                </button>

                <button onclick="genererSuiviIndividuel()" class="group flex items-center p-4 rounded-2xl shadow-sm border active:scale-95 transition-all" style="background: var(--card-bg); border-color: var(--header-border);">
                    <div class="w-10 h-10 rounded-full bg-purple-500/10 flex items-center justify-center text-purple-500 mr-4 group-hover:bg-purple-500 group-hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </div>
                    <div class="text-left">
                        <div class="text-xs font-black uppercase" style="color: var(--text-main);">Fiches de suivi</div>
                        <div class="text-[10px] opacity-60" style="color: var(--text-main);">2 fiches A5 par page (Paysage)</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================== CONFIGURATION & CONSTANTS ====================== 
        const COLOR_MAP = {
            'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
            'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
            'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
            'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
            'rose': '#f43f5e', 'gray': '#6b7280'
        };

        const LEVEL_COLORS = {
            'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308',
            'CM1': '#ef4444', 'CM2': '#22c55e', 'AUTRE': '#8b5cf6'
        };

        const LEVEL_ORDER = ['CP', 'CE1', 'CE2', 'CM1', 'CM2', 'AUTRE'];
        const MONTHS_FR = ["Jan.", "F√©v.", "Mar.", "Avr.", "Mai", "Juin", "Juil.", "Ao√ªt", "Sep.", "Oct.", "Nov.", "D√©c."];

        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const THEME_COLOR = themePrefs.inscr || 'lime';
        const THEME_HEX = COLOR_MAP[THEME_COLOR];
        const NEEDS_DARK_TEXT = ['yellow', 'lime', 'amber', 'cyan'].includes(THEME_COLOR);
        const THEME_TEXT_COLOR = NEEDS_DARK_TEXT ? '#000' : '#fff';

        let modeTriApp = localStorage.getItem('tri_eleves_app') || 'prenom';
        let eleves = JSON.parse(localStorage.getItem('maListeEleves')) || [];

        // ====================== MODAL MANAGEMENT ====================== 
        function ouvrirAide() { 
            document.getElementById('modal-aide').style.display = 'flex'; 
        }

        function fermerAide() { 
            document.getElementById('modal-aide').style.display = 'none'; 
        }

        function customConfirm(msg, onAction, buttons) {
            document.getElementById('confirm-msg').innerText = msg;
            const container = document.getElementById('confirm-buttons');
            container.innerHTML = "";
            buttons.forEach(btn => {
                const b = document.createElement('button');
                b.className = "w-full py-3 rounded-full text-[10px] font-black uppercase shadow-sm transition-transform active:scale-95";
                b.innerText = btn.text;
                if (btn.type === 'primary') {
                    b.style.backgroundColor = THEME_HEX;
                    b.style.color = THEME_TEXT_COLOR;
                } else {
                    b.className += " bg-neutral-500 text-white";
                }
                b.onclick = () => {
                    document.getElementById('custom-confirm').style.display = 'none';
                    onAction(btn.value);
                };
                container.appendChild(b);
            });
            document.getElementById('custom-confirm').style.display = 'flex';
        }

        // ====================== TAB MANAGEMENT ====================== 
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            document.getElementById('tab-' + tabId).classList.add('active');
            document.getElementById('tab-btn-' + tabId).classList.add('active');

            const fab = document.getElementById('fab-plus');
            if (fab) {
                fab.style.display = (tabId === 'classe') ? 'flex' : 'none';
            }
        }

        // ====================== FORM MANAGEMENT ====================== 
        function ouvrirFormulaire() {
            const form = document.getElementById('eleveForm');
            form.reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('btn-submit').innerText = "Enregistrer";
            document.getElementById('form-title').innerText = "Nouvel √âl√®ve";
            initDateSelectors();
            document.getElementById('modal-form').style.display = 'flex';
        }

        function fermerFormulaire(e) {
            if (e.target.id === 'modal-form') {
                e.target.style.display = 'none';
            }
        }

        function sauvegarderNomEnseignant() {
            const nom = document.getElementById('nomEnseignant').value;
            localStorage.setItem('nom_enseignant', nom);
            appliquerCouleursTheme();
        }

        // ====================== DATE SELECTORS INITIALIZATION ====================== 
        function initDateSelectors() {
            const daySel = document.getElementById('birth-day');
            const monthSel = document.getElementById('birth-month');
            const yearSel = document.getElementById('birth-year');
            const lastYear = localStorage.getItem('derniereAnneeSaisie') || "";

            daySel.innerHTML = '<option value="">Jour</option>';
            monthSel.innerHTML = '<option value="">Mois</option>';
            yearSel.innerHTML = '<option value="">Ann√©e</option>';

            for (let i = 1; i <= 31; i++) {
                const val = i < 10 ? '0' + i : i;
                daySel.innerHTML += `<option value="${val}">${i}</option>`;
            }

            MONTHS_FR.forEach((month, index) => {
                const val = (index + 1) < 10 ? '0' + (index + 1) : (index + 1);
                monthSel.innerHTML += `<option value="${val}">${month}</option>`;
            });

            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 20; i--) {
                const selected = (String(i) === lastYear) ? "selected" : "";
                yearSel.innerHTML += `<option value="${i}" ${selected}>${i}</option>`;
            }
        }

        // ====================== THEME APPLICATION ====================== 
        function appliquerCouleursSexe() {
            const prefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
            const girlColor = prefs.fille && COLOR_MAP[prefs.fille] ? COLOR_MAP[prefs.fille] : '#f472b6';
            const boyColor = prefs.garcon && COLOR_MAP[prefs.garcon] ? COLOR_MAP[prefs.garcon] : '#60a5fa';
            document.documentElement.style.setProperty('--student-name-girl', girlColor);
            document.documentElement.style.setProperty('--student-name-boy', boyColor);
        }

        function appliquerCouleursTheme() {
            const buttonIds = ['btn-submit', 'btn-retour', 'btn-aide', 'btn-save-nom', 'btn-fermer-aide'];
            buttonIds.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.style.backgroundColor = THEME_HEX;
                    btn.style.color = THEME_TEXT_COLOR;
                }
            });

            const fab = document.getElementById('fab-plus');
            if (fab) {
                fab.style.backgroundColor = THEME_HEX;
                fab.style.color = THEME_TEXT_COLOR;
            }

            const nomInput = document.getElementById('nomEnseignant');
            if (nomInput) {
                nomInput.style.borderColor = THEME_HEX;
                nomInput.style.borderWidth = "1px";
                nomInput.style.borderStyle = "solid";
                if (nomInput.value.trim() !== "") {
                    nomInput.style.backgroundColor = THEME_HEX;
                    nomInput.style.color = THEME_TEXT_COLOR;
                } else {
                    nomInput.style.backgroundColor = "transparent";
                    nomInput.style.color = "inherit";
                }
            }

            const aideTitle = document.getElementById('aide-titre');
            if (aideTitle) aideTitle.style.color = THEME_HEX;

            majBoutonsTri();
        }

        function majBoutonsTri() {
            const btnP = document.getElementById('sort-prenom');
            const btnN = document.getElementById('sort-nom');
            [btnP, btnN].forEach(b => {
                b.style.backgroundColor = 'transparent';
                b.style.color = 'inherit';
                b.style.opacity = '0.4';
                b.style.borderColor = 'rgba(255,255,255,0.1)';
            });

            const active = modeTriApp === 'prenom' ? btnP : btnN;
            active.style.opacity = '1';
            active.style.backgroundColor = THEME_HEX;
            active.style.borderColor = THEME_HEX;
            active.style.color = THEME_TEXT_COLOR;
        }

        function changerTriApp(mode) {
            modeTriApp = mode;
            localStorage.setItem('tri_eleves_app', mode);
            majBoutonsTri();
            render();
        }

        // ====================== STUDENT MANAGEMENT ====================== 
        function formaterIdentite(prenom, nom) {
            const p = prenom.trim();
            const formattedPrenom = p.charAt(0).toUpperCase() + p.slice(1).toLowerCase();
            return formattedPrenom + " " + nom.trim().toUpperCase();
        }

        document.getElementById('eleveForm').onsubmit = (e) => {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const saisie = document.getElementById('nomComplet').value.trim().split(" ");

            const day = document.getElementById('birth-day').value;
            const month = document.getElementById('birth-month').value;
            const year = document.getElementById('birth-year').value;
            let dateStockee = (day && month && year) ? `${day}-${month}-${year}` : "";

            const selectedSexe = document.querySelector('input[name="sexe"]:checked').value;
            const selectedNiveau = document.getElementById('niveauSelect').value;

            const data = {
                identite: formaterIdentite(saisie[0], saisie.slice(1).join(" ")),
                sexe: selectedSexe,
                niveau: selectedNiveau,
                dateNaissance: dateStockee
            };

            if (editId) {
                const idx = eleves.findIndex(el => String(el.id) === String(editId));
                if (idx !== -1) {
                    eleves[idx] = { ...eleves[idx], ...data };
                }
                document.getElementById('edit-id').value = "";
                document.getElementById('btn-submit').innerText = "Enregistrer";
            } else {
                eleves.push({ id: String(Date.now()), ...data });
            }

            localStorage.setItem('maListeEleves', JSON.stringify(eleves));
            if (year) localStorage.setItem('derniereAnneeSaisie', year);

            notifierChangement();
            render();
            e.target.reset();
            initDateSelectors();
            document.getElementById('modal-form').style.display = 'none';
        };

        function preparerModification(id) {
            const el = eleves.find(e => String(e.id) === String(id));
            if (!el) return;

            document.getElementById('edit-id').value = el.id;
            document.getElementById('nomComplet').value = el.identite;

            if (el.sexe === 'G' || el.sexe === 'M') {
                document.getElementById('sexeG').checked = true;
            } else {
                document.getElementById('sexeF').checked = true;
            }

            document.getElementById('niveauSelect').value = el.niveau;

            if (el.dateNaissance && el.dateNaissance.includes("-")) {
                const d = el.dateNaissance.split("-");
                document.getElementById('birth-day').value = d[0];
                document.getElementById('birth-month').value = d[1];
                document.getElementById('birth-year').value = d[2];
            } else {
                document.getElementById('birth-day').value = "";
                document.getElementById('birth-month').value = "";
                document.getElementById('birth-year').value = "";
            }

            document.getElementById('btn-submit').innerText = "Mettre √† jour";
            document.getElementById('form-title').innerText = "Modifier l'√©l√®ve";
            document.getElementById('modal-form').style.display = 'flex';
        }

        function supprimer(id) {
            customConfirm("Supprimer cet √©l√®ve ?", (val) => {
                if (val === 'yes') {
                    eleves = eleves.filter(e => String(e.id) !== String(id));
                    localStorage.setItem('maListeEleves', JSON.stringify(eleves));
                    notifierChangement();
                    render();
                }
            }, [{text: 'Supprimer', value: 'yes', type: 'primary'}, {text: 'Annuler', value: 'no'}]);
        }

        function toutEffacer() {
            customConfirm("‚ö†Ô∏è Supprimer toute la liste ?", (val) => {
                if (val === 'yes') {
                    eleves = [];
                    localStorage.setItem('maListeEleves', JSON.stringify(eleves));
                    notifierChangement();
                    render();
                }
            }, [{text: 'Tout effacer', value: 'yes', type: 'primary'}, {text: 'Annuler', value: 'no'}]);
        }

        // ====================== NOTIFICATION MANAGEMENT ====================== 
        function notifierChangement() {
            localStorage.setItem('needs_export', 'true');
            const btn = document.getElementById('btn-exporter-txt');
            if (btn) {
                btn.classList.add('notif-export');
                btn.innerHTML = 'üëÜ exporter.txt üü†';
            }
        }

        function verifierDernierExport() {
            const lastExport = localStorage.getItem('last_export_inscr');
            const needsExport = localStorage.getItem('needs_export') === 'true';
            const now = new Date().getTime();
            const sevenDays = 7 * 24 * 60 * 60 * 1000;

            if (needsExport || !lastExport || (now - lastExport > sevenDays)) {
                const btn = document.getElementById('btn-exporter-txt');
                if (btn) {
                    btn.classList.add('notif-export');
                    btn.innerHTML = 'üëÜ exporter.txt üü†';
                }
            }
        }

        // ====================== RENDERING ====================== 
        function renderStats() {
            const statsDiv = document.getElementById('stats-container');
            if (!statsDiv) return;
            if (eleves.length === 0) {
                statsDiv.innerHTML = "";
                return;
            }

            const colorBoy = getComputedStyle(document.documentElement).getPropertyValue('--student-name-boy').trim() || '#3b82f6';
            const colorGirl = getComputedStyle(document.documentElement).getPropertyValue('--student-name-girl').trim() || '#ec4899';
            const nbBoys = eleves.filter(e => {
                const s = e.sexe.toUpperCase();
                return s === 'M' || s === 'G';
            }).length;
            const nbGirls = eleves.filter(e => e.sexe.toUpperCase() === 'F').length;

            statsDiv.innerHTML = `
                <div class="stat-pill" style="border-color: var(--text-main); background-color: var(--card-bg); color: var(--text-main);">Nombre d'√©l√®ves : ${eleves.length}</div>
                <div class="stat-pill" style="background-color: ${colorGirl}50; border-color: ${colorGirl}; color: var(--text-main);">${nbGirls} filles</div>
                <div class="stat-pill" style="background-color: ${colorBoy}50; border-color: ${colorBoy}; color: var(--text-main);">${nbBoys} gar√ßons</div>
            `;
        }

        function render() {
            renderStats();
            const container = document.getElementById('listeContainer');
            if (!container) return;

            if (eleves.length === 0) {
                container.innerHTML = `<p class="text-center text-xs py-10 italic" style="color:var(--sub-text)">Aucun √©l√®ve inscrit.</p>`;
                return;
            }

            container.innerHTML = "";
            const groups = {};
            eleves.forEach(el => {
                if (!groups[el.niveau]) groups[el.niveau] = [];
                groups[el.niveau].push(el);
            });

            const levelPresent = Object.keys(groups).sort((a, b) => LEVEL_ORDER.indexOf(a) - LEVEL_ORDER.indexOf(b));
            container.className = levelPresent.length === 2 ? "grid grid-cols-2 gap-4 max-w-4xl mx-auto" : "pinterest-grid max-w-4xl mx-auto";

            levelPresent.forEach(level => {
                const levelColumn = document.createElement('div');
                levelColumn.className = levelPresent.length === 2 ? "w-full" : "pinterest-item";
                const levelColor = LEVEL_COLORS[level] || THEME_HEX;
                levelColumn.innerHTML = `<h3 style="color:${levelColor}" class="text-[11px] font-black uppercase tracking-widest text-center mb-3">${level}</h3>`;

                const list = document.createElement('div');
                list.className = "flex flex-col gap-0.5";

                groups[level].sort((a, b) => {
                    const partsA = a.identite.split(" ");
                    const partsB = b.identite.split(" ");
                    const pA = partsA[0], nA = partsA.slice(1).join(" ");
                    const pB = partsB[0], nB = partsB.slice(1).join(" ");
                    return modeTriApp === 'nom' ? nA.localeCompare(nB) : pA.localeCompare(pB);
                }).forEach(el => {
                    const item = document.createElement('div');
                    const genderClass = el.sexe.toUpperCase() === 'F' ? 'text-girl-custom' : 'text-boy-custom';
                    item.className = `student-item ${genderClass}`;

                    const parts = el.identite.split(" ");
                    const displayName = modeTriApp === 'nom' ? `${parts.slice(1).join(" ")} ${parts[0]}` : `${parts[0]} ${parts.slice(1).join(" ")}`;

                    item.innerHTML = `
                        <div class="flex flex-col flex-grow overflow-hidden" onclick="preparerModification('${el.id}')">
                            <span class="text-[10px] font-black truncate leading-tight">${displayName}</span>
                            ${el.dateNaissance ? `<span class="text-[8px] mt-0.5 text-gray-500">${el.dateNaissance}</span>` : ""}
                        </div>
                        <button onclick="supprimer('${el.id}')" class="ml-1 opacity-20 hover:opacity-100 p-1" style="background:none;border:none;cursor:pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    `;
                    list.appendChild(item);
                });

                levelColumn.appendChild(list);
                container.appendChild(levelColumn);
            });
        }

        // ====================== IMPORT/EXPORT ====================== 
        function exporterListe() {
            if (eleves.length === 0) {
                customConfirm("La liste est vide !", () => {}, [{text: 'D\'accord', value: 'ok', type: 'primary'}]);
                return;
            }

            let content = eleves.map(el => {
                const p = el.identite.split(" ");
                return `${p[0]};${p.slice(1).join(" ")};${el.sexe};${el.niveau};${el.dateNaissance || ''}`;
            }).join("\n");

            const profName = localStorage.getItem('nom_enseignant') || "enseignant";
            const now = new Date();
            const dateFormatted = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            const cleanedName = profName.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_');
            const fileName = `outilsprofs_liste_classe_${cleanedName}_${dateFormatted}.txt`;

            if (window.Android && typeof window.Android.exportTxt === "function") {
                window.Android.exportTxt(content, fileName);
            } else {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
            }

            localStorage.setItem('last_export_inscr', new Date().getTime());
            localStorage.setItem('needs_export', 'false');
            const btn = document.getElementById('btn-exporter-txt');
            if (btn) {
                btn.classList.remove('notif-export');
                btn.innerHTML = 'üëÜ exporter.txt üëÜ';
            }
        }

        function importerListe() {
            customConfirm("Importer une nouvelle liste ?", (val) => {
                if (val === 'yes') {
                    document.getElementById('fileInput').click();
                }
            }, [{text: 'Importer', value: 'yes', type: 'primary'}, {text: 'Annuler', value: 'no'}]);
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const lines = event.target.result.split(/\r?\n/);
                const newStudents = [];
                lines.forEach(line => {
                    const cols = line.split(";");
                    if (cols.length >= 4) {
                        newStudents.push({
                            id: String(Date.now() + Math.random()),
                            identite: formaterIdentite(cols[0], cols[1]),
                            sexe: cols[2],
                            niveau: cols[3],
                            dateNaissance: cols[4] || ""
                        });
                    }
                });

                if (newStudents.length > 0) {
                    eleves = newStudents;
                    localStorage.setItem('maListeEleves', JSON.stringify(eleves));
                    notifierChangement();
                    render();
                }
                e.target.value = "";
            };
            reader.readAsText(file);
        });

        // ====================== PDF GENERATION ====================== 
        function getDateFormatted() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function getCleanedProfName() {
            const profName = localStorage.getItem('nom_enseignant') || "enseignant";
            return profName.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_');
        }

        function groupStudentsByLevel() {
            const groups = {};
            eleves.forEach(el => {
                if (!groups[el.niveau]) groups[el.niveau] = [];
                groups[el.niveau].push(el);
            });
            return groups;
        }

        function getSortedLevels(groups) {
            return Object.keys(groups).sort((a, b) => LEVEL_ORDER.indexOf(a) - LEVEL_ORDER.indexOf(b));
        }

        function sortStudentsInGroup(students) {
            return students.sort((a, b) => {
                const pA = a.identite.split(" ")[0], nA = a.identite.split(" ").slice(1).join(" ");
                const pB = b.identite.split(" ")[0], nB = b.identite.split(" ").slice(1).join(" ");
                return modeTriApp === 'nom' ? nA.localeCompare(nB) : pA.localeCompare(pB);
            });
        }

        function getDisplayName(el) {
            const parts = el.identite.split(" ");
            return modeTriApp === 'nom' ? `${parts.slice(1).join(" ")} ${parts[0]}` : `${parts[0]} ${parts.slice(1).join(" ")}`;
        }

        function finaliserExportPDF(doc, fileName) {
            try {
                if (window.Android && typeof window.Android.savePdfFromBase64 === "function") {
                    const pdfBase64 = doc.output('datauristring').split(',')[1];
                    window.Android.savePdfFromBase64(pdfBase64, fileName);
                } else {
                    doc.save(fileName);
                }
            } catch (e) {
                console.error("Erreur export:", e);
                doc.save(fileName);
            }
        }

        function genererEmargement() {
            if (eleves.length === 0) {
                customConfirm("La liste est vide !", () => {}, [{text: 'D\'accord', value: 'ok', type: 'primary'}]);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const profName = localStorage.getItem('nom_enseignant') || "enseignant";
            const dateFormatted = getDateFormatted();
            const groups = groupStudentsByLevel();
            const levelOrder = getSortedLevels(groups);
            const levelText = levelOrder.join(" / ");

            doc.setFontSize(16);
            doc.text(`Feuille de pointage ${levelText} - ${profName}`, 105, 15, { align: "center" });

            let finalBody = [];
            let counter = 1;

            levelOrder.forEach(level => {
                finalBody.push([{ content: level, colSpan: 17, styles: { fillColor: [160, 160, 160], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'left' } }]);
                sortStudentsInGroup(groups[level]).forEach((el) => {
                    const displayName = getDisplayName(el);
                    finalBody.push([counter++, displayName, ...Array(15).fill('')]);
                });
            });

            doc.autoTable({
                head: [[...Array(17).fill('')]],
                body: finalBody,
                startY: 25,
                theme: 'grid',
                alternateRowStyles: { fillColor: [230, 230, 230] },
                headStyles: { fillColor: [255, 255, 255], lineWidth: 0.1, lineColor: [0, 0, 0], minCellHeight: 16 },
                styles: { fontSize: 7, cellPadding: 1.5, lineColor: [0, 0, 0], textColor: [0, 0, 0] },
                columnStyles: {
                    0: { cellWidth: 7, halign: 'center' },
                    1: { cellWidth: 'auto' },
                    ...Object.fromEntries([...Array(15)].map((_, i) => [i + 2, { cellWidth: 8 }]))
                },
                didParseCell: function (data) {
                    if (data.section === 'head' && (data.column.index === 0 || data.column.index === 1)) {
                        data.cell.styles.lineWidth = 0;
                    }
                    if (data.section === 'body' && data.cell.raw && data.cell.raw.colSpan === 17) {
                        data.cell.styles.fillColor = [160, 160, 160];
                    }
                }
            });

            const fileName = `outilsprofs_liste_pointage_${getCleanedProfName()}_${dateFormatted}.pdf`;
            finaliserExportPDF(doc, fileName);
        }

        function genererPDF() {
            if (eleves.length === 0) {
                customConfirm("La liste est vide !", () => {}, [{text: 'D\'accord', value: 'ok', type: 'primary'}]);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const profName = localStorage.getItem('nom_enseignant') || "enseignant";
            const dateFormatted = getDateFormatted();
            const groups = groupStudentsByLevel();
            const levelOrder = getSortedLevels(groups);

            doc.setFontSize(18);
            doc.text(`Liste de la classe de ${profName}`, 105, 15, { align: "center" });
            doc.setFontSize(12);
            doc.text(levelOrder.join(" / "), 105, 22, { align: "center" });

            let finalBody = [];
            let counter = 1;

            levelOrder.forEach(level => {
                finalBody.push([{ content: level, colSpan: 5, styles: { fillColor: [160, 160, 160], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'left' } }]);
                sortStudentsInGroup(groups[level]).forEach((el) => {
                    const displayName = getDisplayName(el);
                    finalBody.push([counter++, displayName, el.dateNaissance || '-', el.sexe.toUpperCase(), el.niveau]);
                });
            });

            doc.autoTable({
                head: [],
                body: finalBody,
                startY: 30,
                theme: 'grid',
                alternateRowStyles: { fillColor: [230, 230, 230] },
                styles: { fontSize: 9, lineColor: [0, 0, 0] },
                didParseCell: function (data) {
                    if (data.section === 'body' && data.cell.raw && data.cell.raw.colSpan === 5) {
                        data.cell.styles.fillColor = [160, 160, 160];
                    }
                }
            });

            const fileName = `outilsprofs_liste_classe_${getCleanedProfName()}_${dateFormatted}.pdf`;
            if (window.Android && window.Android.savePdfFromBase64) {
                const pdfBase64 = doc.output('datauristring').split(',')[1];
                window.Android.savePdfFromBase64(pdfBase64, fileName);
            } else {
                doc.save(fileName);
            }
        }

        function genererEtiquettes() {
            if (!eleves || eleves.length === 0) {
                customConfirm("La liste est vide !", () => {}, [{text: 'D\'accord', value: 'ok', type: 'primary'}]);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const dateFormatted = getDateFormatted();
            const margin = 10, gap = 10, cols = 2, rows = 4;
            const cardWidth = (210 - (2 * margin) - gap) / cols;
            const cardHeight = (297 - (2 * margin) - (3 * gap)) / rows;

            let col = 0, row = 0;
            const sortedStudents = [...eleves].sort((a, b) => {
                const pA = a.identite.split(" ")[0], pB = b.identite.split(" ")[0];
                return modeTriApp === 'nom' ? a.identite.localeCompare(b.identite) : pA.localeCompare(pB);
            });

            sortedStudents.forEach((el, index) => {
                if (index > 0 && index % (cols * rows) === 0) {
                    doc.addPage();
                    col = 0;
                    row = 0;
                }

                const x = margin + (col * (cardWidth + gap));
                const y = margin + (row * (cardHeight + gap));

                doc.setDrawColor(200);
                doc.roundedRect(x, y, cardWidth, cardHeight, 3, 3, 'S');

                const parts = el.identite.split(" ");
                const prenom = parts[0];
                const nom = parts.slice(1).join(" ");

                doc.setFontSize(24);
                doc.setTextColor(40);
                doc.text(prenom, x + cardWidth / 2, y + cardHeight / 2, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(nom, x + cardWidth / 2, y + cardHeight / 2 + 10, { align: 'center' });

                doc.setFontSize(8);
                doc.text(el.niveau, x + cardWidth - 5, y + cardHeight - 5, { align: 'right' });

                col++;
                if (col === cols) {
                    col = 0;
                    row++;
                }
            });

            const fileName = `outilsprofs_etiquettes_${getCleanedProfName()}_${dateFormatted}.pdf`;
            finaliserExportPDF(doc, fileName);
        }

        function genererPetitesEtiquettes() {
            if (!eleves || eleves.length === 0) {
                customConfirm("La liste est vide !", () => {}, [{text: 'D\'accord', value: 'ok', type: 'primary'}]);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const dateFormatted = getDateFormatted();
            const marginX = 10, marginY = 12, cols = 3, rows = 9, gap = 4;
            const cardWidth = (210 - (2 * marginX) - ((cols - 1) * gap)) / cols;
            const cardHeight = (297 - (2 * marginY) - ((rows - 1) * gap)) / rows;

            let col = 0, row = 0;
            const sortedStudents = [...eleves].sort((a, b) => a.identite.localeCompare(b.identite));

            sortedStudents.forEach((el, index) => {
                if (index > 0 && index % (cols * rows) === 0) {
                    doc.addPage();
                    col = 0;
                    row = 0;
                }

                const x = marginX + (col * (cardWidth + gap));
                const y = marginY + (row * (cardHeight + gap));

                doc.setDrawColor(220);
                doc.setLineWidth(0.1);
                doc.rect(x, y, cardWidth, cardHeight, 'S');

                const parts = el.identite.split(" ");
                const prenom = parts[0];
                const nom = parts.slice(1).join(" ");

                doc.setFont("helvetica", "bold");
                doc.setFontSize(11);
                doc.setTextColor(0);
                doc.text(prenom, x + cardWidth / 2, y + (cardHeight / 2) - 1, { align: 'center' });

                doc.setFont("helvetica", "normal");
                doc.setFontSize(8);
                doc.setTextColor(100);
                doc.text(nom, x + cardWidth / 2, y + (cardHeight / 2) + 4, { align: 'center' });

                doc.setFontSize(6);
                doc.setTextColor(180);
                doc.text(el.niveau, x + cardWidth - 2, y + cardHeight - 2, { align: 'right' });

                col++;
                if (col === cols) {
                    col = 0;
                    row++;
                }
            });

            const fileName = `outilsprofs_petitesetiquettes_${getCleanedProfName()}_${dateFormatted}.pdf`;
            finaliserExportPDF(doc, fileName);
        }

        function genererSuiviIndividuel() {
            if (eleves.length === 0) {
                customConfirm("La liste est vide !", () => {}, [{text: 'D\'accord', value: 'ok', type: 'primary'}]);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const profName = localStorage.getItem('nom_enseignant') || "enseignant";
            const dateFormatted = getDateFormatted();
            const sortedStudents = [...eleves].sort((a, b) => a.identite.localeCompare(b.identite));

            sortedStudents.forEach((el, index) => {
                if (index > 0 && index % 2 === 0) doc.addPage('l');
                const position = index % 2;
                const offsetX = position * 148.5;

                doc.setFillColor(248, 248, 248);
                doc.rect(offsetX + 10, 10, 128.5, 20, 'F');
                doc.setFontSize(8);
                doc.setTextColor(120);
                doc.text(`Suivi P√©dagogique - Classe de ${profName}`, offsetX + 15, 18);
                doc.text(`Ann√©e Scolaire 2025-2026`, offsetX + 15, 24);

                doc.setFontSize(16);
                doc.setTextColor(0);
                doc.setFont("helvetica", "bold");
                doc.text(el.identite, offsetX + 74.25, 45, { align: "center" });

                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                const infoLevel = `Niveau : ${el.niveau}`;
                const infoBirth = el.dateNaissance ? ` - N√©(e) le : ${el.dateNaissance}` : "";
                doc.text(infoLevel + infoBirth, offsetX + 74.25, 52, { align: "center" });

                doc.setDrawColor(200);
                doc.line(offsetX + 30, 58, offsetX + 118, 58);

                doc.setFontSize(9);
                doc.setTextColor(150);
                doc.setFont("helvetica", "italic");
                doc.text("OBSERVATIONS / NOTES :", offsetX + 15, 68);

                doc.setDrawColor(230);
                doc.roundedRect(offsetX + 10, 72, 128.5, 120, 2, 2, 'S');

                doc.setDrawColor(240);
                for (let i = 0; i < 10; i++) {
                    doc.line(offsetX + 15, 85 + (i * 11), offsetX + 133.5, 85 + (i * 11));
                }

                if (position === 0) {
                    doc.setDrawColor(220);
                    doc.setLineDashPattern([2, 2], 0);
                    doc.line(148.5, 5, 148.5, 205);
                    doc.setLineDashPattern([], 0);
                }
            });

            const fileName = `outilsprofs_fiches_suivi_classe_${getCleanedProfName()}_${dateFormatted}.pdf`;
            finaliserExportPDF(doc, fileName);
        }

        // ====================== INITIALIZATION ====================== 
        window.onload = () => {
            const savedName = localStorage.getItem('nom_enseignant') || "";
            document.getElementById('nomEnseignant').value = savedName;
            initDateSelectors();
            appliquerCouleursSexe();
            appliquerCouleursTheme();
            render();
            verifierDernierExport();
        };
    </script>
</body>
</html>