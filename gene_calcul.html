<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Calcul Mental - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s ease; }
        
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }

        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s ease; cursor: pointer; border: none; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }

        .main-wrapper { width: 100%; max-width: 380px; margin: 0 auto; padding: 10px 15px 40px; }
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 20px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 20px; }
        
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border); border-radius: 0.75rem; padding: 10px; font-size: 0.85rem; font-weight: 700; width: 100%; color: var(--text-main); outline: none; text-align: center; }
        
        .btn-add { width: 100%; padding: 14px; border-radius: 50px; font-weight: 900; font-size: 12px; text-transform: uppercase; border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-add:active { transform: scale(0.95); }

        .btn-game-action { height: 40px; border-radius: 9999px; font-size: 10px; font-weight: 900; color: white; transition: all 0.2s ease; text-transform: uppercase; padding: 0 15px; }
        .btn-game-action:active { transform: scale(0.95); }

        .op-btn-frame { border: 2px solid var(--column-border); border-radius: 1rem; padding: 2px; transition: all 0.2s ease; background: var(--input-bg); }
        .op-checkbox:checked + .op-btn-frame, .table-checkbox:checked + .op-btn-frame, .mode-radio:checked + .op-btn-frame, #check-all-tables:checked + .op-btn-frame { 
            border-color: var(--accent-color, #06b6d4); background-color: var(--accent-color, #06b6d4); color: white !important;
        }

        /* --- GRILLE ET CARTES --- */
        #questions-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }

        .q-card { 
            background: var(--card-bg); border-radius: 0.75rem; padding: 6px 8px;
            border: 1px solid var(--column-border); display: flex; align-items: center;
            justify-content: space-between; min-height: 50px; gap: 2px;
        }
            
        .answer-input {
            background: var(--input-bg); border: 1px solid var(--column-border);
            border-radius: 0.4rem; width: 42px; height: 28px; text-align: center;
            font-weight: 800; font-size: 0.75rem; color: var(--text-main); outline: none; flex-shrink: 0;
        }

        .res-text { color: #10b981; font-weight: 800; }
        .solo-text { font-size: 12px !important; white-space: nowrap; letter-spacing: -0.04em; }
        .solo-res { font-size: 11px !important; margin-left: 3px; flex-shrink: 0; }

        /* --- MODE VPI --- */
        .vpi-card { padding: 15px !important; }
        .vpi-text { font-size: 1.9rem !important; white-space: nowrap; letter-spacing: -0.02em; }

        /* --- MODALE AIDE --- */
        .help-section { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--column-border); }
        .help-title { font-size: 10px; font-weight: 900; text-transform: uppercase; color: var(--accent-color); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
        .help-text { font-size: 11px; line-height: 1.5; opacity: 0.9; }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; }

        @media (min-width: 768px) {
            .main-wrapper { max-width: 950px; }
            #setup-zone:not(.hidden) { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: start; }
            #mainAddBtn { grid-column: span 2; }
            #questions-grid { grid-template-columns: repeat(3, 1fr); gap: 15px; }
        }
    </style>
</head>
<body>

<script>if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');</script>

<header>
    <a href="index.html" class="ui-btn-round active:scale-90"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg></a>
    <h1>Calcul Mental</h1>
    <button onclick="ouvrirAide()" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div id="setup-zone" class="light-card space-y-4">
        <div class="space-y-4">
            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Op√©rations</label>
                <div class="grid grid-cols-4 gap-2">
                    <label class="cursor-pointer"><input type="checkbox" class="hidden op-checkbox" value="+" checked><div class="op-btn-frame h-12 flex items-center justify-center rounded-lg font-black text-lg">+</div></label>
                    <label class="cursor-pointer"><input type="checkbox" class="hidden op-checkbox" value="-"><div class="op-btn-frame h-12 flex items-center justify-center rounded-lg font-black text-lg">-</div></label>
                    <label class="cursor-pointer"><input type="checkbox" class="hidden op-checkbox" value="x"><div class="op-btn-frame h-12 flex items-center justify-center rounded-lg font-black text-lg">x</div></label>
                    <label class="cursor-pointer"><input type="checkbox" class="hidden op-checkbox" value=":"><div class="op-btn-frame h-12 flex items-center justify-center rounded-lg font-black text-lg">√∑</div></label>
                </div>
            </div>
            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Tables</label>
                <div id="tables-container" class="space-y-2"></div>
            </div>
        </div>

        <div class="space-y-4">
            <div class="grid grid-cols-3 gap-2">
                <div><label class="block text-[9px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Min</label><input type="number" id="min-val" value="1" class="input-field"></div>
                <div><label class="block text-[9px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Max</label><input type="number" id="max-val" value="10" class="input-field"></div>
                <div><label class="block text-[9px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Nb</label><input type="number" id="nb-val" value="12" class="input-field"></div>
            </div>

            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Mode de jeu</label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="cursor-pointer"><input type="radio" name="game-mode" value="solo" class="hidden mode-radio" checked><div class="op-btn-frame h-12 flex flex-col items-center justify-center rounded-lg"><span class="text-xs font-black">SOLO</span><span class="text-[8px] opacity-60">Individuel</span></div></label>
                    <label class="cursor-pointer"><input type="radio" name="game-mode" value="vpi" class="hidden mode-radio"><div class="op-btn-frame h-12 flex flex-col items-center justify-center rounded-lg"><span class="text-xs font-black">VPI</span><span class="text-[8px] opacity-60">Projection</span></div></label>
                </div>
            </div>
            
            <button id="mainAddBtn" onclick="generateSeries()" class="btn-add">D√©marrer</button>
        </div>
    </div>

    <div id="game-zone" class="hidden space-y-4">
        <div id="questions-grid"></div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 pt-4">
            <button onclick="retourReglages()" class="btn-game-action bg-gray-500">‚¨ÖÔ∏è Retour</button>
            <button id="validate-btn" onclick="showCorrection()" class="btn-game-action bg-green-500">üëÅÔ∏è Correction</button>
            <button onclick="generateSeries()" class="btn-game-action bg-amber-500">üîÑ Nouveau</button>
            <button onclick="exportToPDF()" class="btn-game-action bg-blue-500">üìÑ PDF</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="text-xl font-black uppercase mb-6 flex items-center gap-2">üí° Mode d'emploi</h2>
        <div class="help-section">
            <h3 class="help-title">üë§ Mode Solo (√âl√®ve)</h3>
            <p class="help-text">Calculs sur <strong>2 colonnes</strong> avec saisie. Clique sur <strong>Correction</strong> pour voir ton score.</p>
        </div>
        <div class="help-section">
            <h3 class="help-title">üì∫ Mode VPI (Classe)</h3>
            <p class="help-text">Affichage <strong>g√©ant</strong> pour la projection collective. Id√©al pour l'ardoise.</p>
        </div>
        <div class="help-section border-none">
            <h3 class="help-title">üìÑ Export PDF</h3>
            <p class="help-text">G√©n√®re un fichier <strong>Recto-Verso</strong> (Exercices au recto, Correction au verso).</p>
        </div>
        <button onclick="fermerModal('modal-aide')" class="w-full mt-4 btn-add">C'est compris !</button>
    </div>
</div>

<script>
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#6b7280' };
    let currentCalculs = [];

    function initTables() {
        const container = document.getElementById('tables-container');
        let html = '<div class="flex gap-2 justify-center">';
        for (let i = 2; i <= 6; i++) { html += `<label class="cursor-pointer"><input type="checkbox" class="hidden table-checkbox" value="${i}"><div class="op-btn-frame w-10 h-10 flex items-center justify-center rounded-lg font-black text-xs">${i}</div></label>`; }
        html += '</div><div class="flex gap-2 justify-center mt-2">';
        for (let i = 7; i <= 9; i++) { html += `<label class="cursor-pointer"><input type="checkbox" class="hidden table-checkbox" value="${i}"><div class="op-btn-frame w-10 h-10 flex items-center justify-center rounded-lg font-black text-xs">${i}</div></label>`; }
        html += `<label class="cursor-pointer"><input type="checkbox" id="check-all-tables" class="hidden" onchange="toggleAllTables(this)"><div class="op-btn-frame px-3 h-10 flex items-center justify-center rounded-lg font-black text-[10px] uppercase">Toutes</div></label></div>`;
        container.innerHTML = html;
    }

    function toggleAllTables(source) { document.querySelectorAll('.table-checkbox').forEach(cb => cb.checked = source.checked); }

    function generateSeries() {
        const selectedOps = Array.from(document.querySelectorAll('.op-checkbox:checked')).map(el => el.value);
        const selectedTables = Array.from(document.querySelectorAll('.table-checkbox:checked')).map(el => parseInt(el.value));
        const mode = document.querySelector('input[name="game-mode"]:checked').value;
        if (selectedOps.length === 0) return alert("S√©lectionnez une op√©ration !");
        
        const min = parseInt(document.getElementById('min-val').value) || 1;
        const max = parseInt(document.getElementById('max-val').value) || 10;
        const nb = parseInt(document.getElementById('nb-val').value) || 12;
        const grid = document.getElementById('questions-grid');
        grid.innerHTML = ''; currentCalculs = [];
        const scoreDiv = document.getElementById('score-display'); if (scoreDiv) scoreDiv.remove();

        for (let i = 0; i < nb; i++) {
            const op = selectedOps[i % selectedOps.length];
            let a, b, res = 0;
            if (op === 'x' || op === ':') {
                b = selectedTables.length > 0 ? selectedTables[Math.floor(Math.random() * selectedTables.length)] : Math.floor(Math.random() * 10) + 1;
                const factor = Math.floor(Math.random() * 10) + 1;
                if (op === 'x') { a = factor; res = a * b; } else { res = factor; a = res * b; }
            } else {
                a = Math.floor(Math.random() * (max - min + 1)) + min;
                b = Math.floor(Math.random() * (max - min + 1)) + min;
                if (op === '+') res = a + b; else { if (a < b) [a, b] = [b, a]; res = a - b; }
            }
            currentCalculs.push({ q: `${a} ${op === ':' ? '√∑' : op} ${b}`, r: res });
        }

        currentCalculs.forEach((calc, i) => {
            let cardClass = mode === 'vpi' ? 'vpi-card' : '';
            let textClass = mode === 'vpi' ? 'vpi-text' : 'solo-text';
            const num = mode === 'vpi' ? `<span class="opacity-30 text-[12px] font-bold min-w-[25px] text-left shrink-0">${i+1})</span>` : '';
            let contentRight = '';

            if (mode === 'solo') {
                contentRight = `<div class="flex items-center shrink-0 ml-auto"><input type="text" inputmode="decimal" class="answer-input" placeholder="?"><span class="res-text hidden solo-res font-bold">${calc.r}</span></div>`;
            } else {
                contentRight = `<span class="res-text hidden ${textClass} ml-auto shrink-0" style="color:var(--accent-color); font-weight: 900;">${calc.r}</span>`;
            }
            grid.innerHTML += `<div class="q-card ${cardClass}"><div class="flex items-center overflow-hidden flex-1">${num}<span class="${textClass} font-bold">${calc.q} =</span></div>${contentRight}</div>`;
        });

        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');
    }

    function showCorrection() {
        const inputs = document.querySelectorAll('.answer-input');
        const firstRes = document.querySelector('.res-text');
        const btn = document.getElementById('validate-btn');
        const mode = document.querySelector('input[name="game-mode"]:checked').value;
        if (!firstRes) return;
        const isShowing = !firstRes.classList.contains('hidden');

        if (isShowing) {
            const scoreDiv = document.getElementById('score-display'); if (scoreDiv) scoreDiv.remove();
            document.querySelectorAll('.res-text').forEach(el => el.classList.add('hidden'));
            inputs.forEach(input => { input.style.borderColor = 'var(--column-border)'; input.style.backgroundColor = 'var(--input-bg)'; });
            btn.innerText = "üëÅÔ∏è Correction";
        } else {
            document.querySelectorAll('.res-text').forEach(el => el.classList.remove('hidden'));
            if (mode === 'solo') {
                let score = 0;
                inputs.forEach((input, i) => {
                    const userAns = input.value.trim().replace(',', '.');
                    if (userAns !== "" && parseFloat(userAns) === currentCalculs[i].r) {
                        score++; input.style.borderColor = "#10b981"; input.style.backgroundColor = "rgba(16, 185, 129, 0.1)";
                    } else if (userAns !== "") {
                        input.style.borderColor = "#ef4444"; input.style.backgroundColor = "rgba(239, 68, 68, 0.1)";
                    }
                });
                const scoreHtml = `<div id="score-display" class="w-full text-center p-4 mb-4 rounded-2xl border-2 border-dashed border-[var(--accent-color)]"><span class="text-3xl font-black" style="color:var(--accent-color)">Score : ${score} / ${currentCalculs.length}</span></div>`;
                document.getElementById('questions-grid').insertAdjacentHTML('beforebegin', scoreHtml);
            }
            btn.innerText = "üôà Masquer";
        }
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const maintenant = new Date();
        const dateFmt = `${maintenant.getFullYear()}${String(maintenant.getMonth() + 1).padStart(2, '0')}${String(maintenant.getDate()).padStart(2, '0')}`;
        
        // PAGE 1 : RECTO
        doc.setFont("helvetica", "bold"); doc.setFontSize(18);
        doc.text("Calcul Mental - Exercices", 105, 20, { align: "center" });
        doc.setFontSize(12); doc.setFont("helvetica", "normal");
        let yS = 40, x1 = 20, x2 = 110, cY = yS;
        const half = Math.ceil(currentCalculs.length / 2);
        currentCalculs.forEach((c, i) => {
            let x = (i < half) ? x1 : x2;
            let y = (i < half) ? cY : yS + ((i - half) * 12);
            doc.text(`${i + 1})  ${c.q} = .......`, x, y);
            if (i < half) cY += 12;
        });

        // PAGE 2 : VERSO
        doc.addPage();
        doc.setFont("helvetica", "bold"); doc.setFontSize(18);
        doc.text("Correction", 105, 20, { align: "center" });
        doc.setFontSize(12); doc.setFont("helvetica", "normal");
        cY = yS;
        currentCalculs.forEach((c, i) => {
            let x = (i < half) ? x1 : x2;
            let y = (i < half) ? cY : yS + ((i - half) * 12);
            doc.text(`${i + 1})  ${c.q} = `, x, y);
            doc.setFont("helvetica", "bold");
            doc.text(`${c.r}`, x + doc.getTextWidth(`${i + 1})  ${c.q} = `), y);
            doc.setFont("helvetica", "normal");
            if (i < half) cY += 12;
        });
        doc.save(`outilsprofs_calcul_mental_${dateFmt}.pdf`);
    }

    function retourReglages() { document.getElementById('setup-zone').classList.remove('hidden'); document.getElementById('game-zone').classList.add('hidden'); }
    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }
    function appliquerTheme() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const hexa = mapCouleurs[themePrefs.gen || 'cyan'];
        document.documentElement.style.setProperty('--accent-color', hexa);
        document.querySelectorAll('.btn-add, .ui-btn-round').forEach(el => { el.style.backgroundColor = hexa; el.style.color = '#fff'; });
    }
    window.onload = () => { appliquerTheme(); initTables(); };
</script>
</body>
</html>