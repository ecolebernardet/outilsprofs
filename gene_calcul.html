<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Calcul Mental - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        /* ============================================
           VARIABLES CSS
        ============================================ */
        :root {
            --bg-page: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1);
            --input-bg: #2a2a2a;
            --accent-color: #06b6d4;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee;
            --card-bg: #ffffff;
            --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1);
            --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Styles Plein √âcran */
        body.fullscreen-mode { overflow: hidden; }
        body.fullscreen-mode header { display: none; }
        body.fullscreen-mode .main-wrapper { 
            padding: 20px 15px 40px; 
            height: 100vh; 
            overflow-y: auto; 
            max-width: 80%; 
        }

		/* Positionnement du bouton FS √† droite quand activ√© */
body.fullscreen-mode #container-retour-liste {
    justify-content: flex-end; /* Aligne le bouton √† droite */
    margin-bottom: 20px;
}

        /* ============================================
           STYLES G√âN√âRAUX
        ============================================ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            transition: background 0.3s ease;
        }

        header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--column-border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px;
            width: 100%;
            margin-bottom: 12px;
        }

        header h1 {
            font-size: 1.125rem;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            flex-grow: 1;
        }

        /* ============================================
           BOUTONS
        ============================================ */
        .ui-btn-round {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            flex-shrink: 0;
        }

        .btn-add {
            width: 100%;
            padding: 14px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 12px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-game-action {
            height: 40px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 900;
            color: white;
            transition: all 0.2s ease;
            text-transform: uppercase;
            padding: 0 15px;
        }

        /* ============================================
           CONTENEUR PRINCIPAL
        ============================================ */
        .main-wrapper {
            width: 100%;
            max-width: 380px;
            margin: 0 auto;
            padding: 10px 15px 40px;
        }

        .light-card {
            background: var(--card-bg);
            border-radius: 1.5rem;
            padding: 20px;
            border: 1px solid var(--column-border);
            box-shadow: var(--shadow-custom);
            margin-bottom: 20px;
        }

        /* ============================================
           FORMULAIRES
        ============================================ */
        .input-field {
            background: var(--input-bg);
            border: 1px solid var(--column-border);
            border-radius: 0.75rem;
            padding: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            width: 100%;
            color: var(--text-main);
            outline: none;
            text-align: center;
        }

        /* ============================================
           S√âLECTEURS D'OP√âRATIONS ET TABLES
        ============================================ */
        .op-btn-frame {
            border: 2px solid var(--column-border);
            border-radius: 1rem;
            padding: 2px;
            transition: all 0.2s ease;
            background: var(--input-bg);
        }

        .op-checkbox:checked + .op-btn-frame,
        .table-checkbox:checked + .op-btn-frame,
        .mode-radio:checked + .op-btn-frame,
        #check-all-tables:checked + .op-btn-frame {
            border-color: var(--accent-color, #06b6d4);
            background-color: var(--accent-color, #06b6d4);
            color: white !important;
        }

        /* ============================================
           GRILLE DE QUESTIONS
        ============================================ */
        #questions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .q-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 10px;
            border: 1px solid var(--column-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            overflow: hidden;
            text-align: center;
        }

        .answer-input {
            background: var(--input-bg);
            border: 1px solid var(--column-border);
            border-radius: 0.4rem;
            width: 60px;
            height: 32px;
            text-align: center;
            font-weight: 800;
            font-size: 0.9rem;
            color: var(--text-main);
            outline: none;
            margin-top: 6px;
        }

        .res-text {
            color: #1a8663 !important;
            font-weight: 900;
            line-height: 1.2;
            margin-top: 4px;
            display: block;
            width: 100%;
        }

        .vpi-text {
            font-size: 1.2rem !important;
            white-space: nowrap;
            font-weight: 900;
            letter-spacing: -0.02em;
        }

        .vpi-res {
            font-size: 1.15rem !important;
        }

        /* ============================================
           MODALES
        ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 1.5rem;
            border: 1px solid var(--column-border);
            padding: 25px;
        }

        /* ============================================
           RESPONSIVE
        ============================================ */
        @media (min-width: 768px) {
            .main-wrapper {
                max-width: 950px;
            }

            #setup-zone:not(.hidden) {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 25px;
            }

            #mainAddBtn {
                grid-column: span 2;
            }

            #questions-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }

            .vpi-text {
                font-size: 1.8rem !important;
            }

            .vpi-res {
                font-size: 1.6rem !important;
            }
        }
    </style>
</head>
<body>

<audio id="audio-finish" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
    if (localStorage.getItem('theme_mode') === 'light') {
        document.body.classList.add('light-mode');
    }
</script>

<header>
    <div class="flex items-center gap-2">
        <a href="index.html" class="ui-btn-round active:scale-90">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
    </div>
    <h1>Calcul Mental</h1>
    <button onclick="ouvrirAide()" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div id="container-retour-liste" class="mb-4 flex justify-between items-center">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux g√©n√©rateurs
        </a>
        
        <button id="btn-fullscreen-toggle" onclick="toggleFullscreen()" class="ui-btn-round text-white active:scale-90 shadow-md">
            <svg id="icon-fs-open" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg>
            <svg id="icon-fs-close" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <div id="setup-zone" class="light-card space-y-4">
        <div class="space-y-4">
            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Op√©rations</label>
                <div class="grid grid-cols-4 gap-2">
                    <label class="cursor-pointer">
                        <input type="checkbox" class="hidden op-checkbox" value="+" checked>
                        <div class="op-btn-frame h-12 flex items-center justify-center rounded-lg font-black text-lg">+</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="checkbox" class="hidden op-checkbox" value="-">
                        <div class="op-btn-frame h-12 flex items-center justify-center rounded-lg font-black text-lg">-</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="checkbox" class="hidden op-checkbox" value="x">
                        <div class="op-btn-frame h-12 flex items-center justify-center rounded-lg font-black text-lg">x</div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="checkbox" class="hidden op-checkbox" value=":">
                        <div class="op-btn-frame h-12 flex items-center justify-center rounded-lg font-black text-lg">√∑</div>
                    </label>
                </div>
            </div>

            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Tables</label>
                <div id="tables-container" class="space-y-2"></div>
            </div>

            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Temps imparti</label>
                <div class="flex items-center gap-2 bg-[var(--input-bg)] px-3 py-2 rounded-xl border border-white/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-50 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div class="flex items-center flex-1 justify-center gap-1">
                        <input type="number" id="timer-min" value="1" min="0" max="59" class="bg-transparent w-10 text-right font-black text-sm outline-none">
                        <span class="text-[10px] opacity-40 font-bold mr-1">min &nbsp;&nbsp;</span>
                        <span class="opacity-20 font-black">:</span>
                        <input type="number" id="timer-sec" value="0" min="0" max="59" class="bg-transparent w-10 text-right font-black text-sm outline-none">
                        <span class="text-[10px] opacity-40 font-bold">s&nbsp;&nbsp;</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <div class="grid grid-cols-3 gap-2">
                <div>
                    <label class="block text-[9px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Min</label>
                    <input type="number" id="min-val" value="1" class="input-field">
                </div>
                <div>
                    <label class="block text-[9px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Max</label>
                    <input type="number" id="max-val" value="50" class="input-field">
                </div>
                <div>
                    <label class="block text-[9px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Nb (max 50)</label>
                    <input type="number" id="nb-val" value="10" min="1" max="50" class="input-field">
                </div>
            </div>

            <div>
                <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Mode de jeu</label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="cursor-pointer">
                        <input type="radio" name="game-mode" value="solo" class="hidden mode-radio" checked>
                        <div class="op-btn-frame h-12 flex flex-col items-center justify-center rounded-lg">
                            <span class="text-xs font-black">SOLO</span>
                            <span class="text-[8px] opacity-60">Individuel</span>
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="game-mode" value="vpi" class="hidden mode-radio">
                        <div class="op-btn-frame h-12 flex flex-col items-center justify-center rounded-lg">
                            <span class="text-xs font-black">VPI</span>
                            <span class="text-[8px] opacity-60">Projection</span>
                        </div>
                    </label>
                </div>
            </div>

            <button onclick="prechargerSon(); generateSeries();" id="mainAddBtn" class="btn-add">D√©marrer</button>
        </div>
    </div>

    <div id="game-zone" class="hidden space-y-4">
        <div id="timer-display" class="hidden text-center p-3 rounded-xl bg-amber-500/10 border border-amber-500/20">
            <div id="seconds-left" class="text-2xl font-black text-amber-500">0:00</div>
        </div>
        <div id="questions-grid"></div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 pt-4">
            <button onclick="retourReglages()" class="btn-game-action bg-gray-500">‚¨ÖÔ∏è Retour</button>
            <button id="validate-btn" onclick="showCorrection()" class="btn-game-action bg-green-500">üëÅÔ∏è Correction</button>
            <button onclick="generateSeries()" class="btn-game-action bg-amber-500">üîÑ Nouveau</button>
            <button id="pdf-btn" onclick="exportToPDF()" class="btn-game-action bg-blue-500">üìÑ PDF</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content !max-w-[400px] !p-6" onclick="event.stopPropagation()">
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-[var(--accent-color)] bg-opacity-10 text-2xl mb-2">
                üí°
            </div>
            <h2 class="text-lg font-black uppercase tracking-tighter">
                G√©n√©rateur de calcul mental
            </h2>
            <div class="h-1 w-10 bg-[var(--accent-color)] mx-auto rounded-full mt-1"></div>
        </div>
        
        <div class="text-[11px] leading-relaxed space-y-4 opacity-90 mb-6 overflow-y-auto max-h-[55vh] pr-2 text-left">
            
            <section class="bg-black bg-opacity-5 dark:bg-white dark:bg-opacity-5 p-3 rounded-xl border border-white/5">
                <h3 class="font-black text-[var(--accent-color)] uppercase text-[10px] mb-1.5 flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-[var(--accent-color)]"></span>
                    1. Configuration
                </h3>
                <p>Cochez les <b>op√©rations</b> souhait√©es. Pour la multiplication et division, choisissez vos <b>tables</b>. D√©finissez l'intervalle avec <b>Min/Max</b>.</p>
            </section>

            <section class="bg-black bg-opacity-5 dark:bg-white dark:bg-opacity-5 p-3 rounded-xl border border-white/5">
                <h3 class="font-black text-[var(--accent-color)] uppercase text-[10px] mb-1.5 flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-[var(--accent-color)]"></span>
                    2. Modes d'affichage
                </h3>
                <ul class="space-y-1.5">
                    <li>‚Ä¢ <b class="text-[var(--accent-color)]">SOLO :</b> Zone de saisie pour l'√©l√®ve. Le score est calcul√© automatiquement √† la fin.</li>
                    <li>‚Ä¢ <b class="text-[var(--accent-color)]">VPI :</b> Affichage g√©ant sans saisie, id√©al pour le calcul mental sur ardoise.</li>
                </ul>
            </section>

            <section class="bg-black bg-opacity-5 dark:bg-white dark:bg-opacity-5 p-3 rounded-xl border border-white/5">
                <h3 class="font-black text-[var(--accent-color)] uppercase text-[10px] mb-1.5 flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-[var(--accent-color)]"></span>
                    3. Gestion du Temps
                </h3>
                <p>R√©glez le <b>chronom√®tre</b>. Un signal sonore retentit √† 0:00. Laissez √† <b>0:00</b> pour jouer sans limite de temps.</p>
            </section>

            <section class="bg-black bg-opacity-5 dark:bg-white dark:bg-opacity-5 p-3 rounded-xl border border-white/5">
                <h3 class="font-black text-[var(--accent-color)] uppercase text-[10px] mb-1.5 flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-[var(--accent-color)]"></span>
                    4. Fonctions Utiles
                </h3>
                <p>Utilisez le bouton <b>PDF</b> (mode VPI) pour imprimer la fiche et sa correction. Le mode <b>Plein √âcran</b> (ic√¥ne ‚õ∂) maximise la visibilit√©.</p>
            </section>
        </div>
        
        <button onclick="fermerModal('modal-aide')" class="w-full !py-4 !text-[11px] btn-add shadow-lg hover:scale-[1.02] active:scale-95 transition-transform">
            C'est parti !
        </button>
    </div>
</div>

<div id="modal-fin" class="modal-overlay">
    <div class="modal-content text-center">
        <div class="text-5xl mb-4">‚è∞</div>
        <h2 class="text-xl font-black uppercase mb-2">Temps √©coul√© !</h2>
        <p class="text-sm opacity-90 mb-6">Le chrono est termin√©. Pr√™t √† voir les r√©sultats ?</p>
        <button onclick="validerFinChrono()" class="w-full btn-add">Afficher la correction</button>
    </div>
</div>

<script>
    const COULEURS_THEME = {
        'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
        'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
        'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
        'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
        'rose': '#f43f5e', 'gray': '#6b7280'
    };

    const MAX_CALCULS = 50;
    const MAX_ATTEMPTS_MULTIPLIER = 100;
    const TABLES_DEFAULT = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    let currentCalculs = [];
    let countdown;

    // --- Plein √âcran ---
    function toggleFullscreen() {
    const isFullscreen = document.body.classList.toggle('fullscreen-mode');
    const iconOpen = document.getElementById('icon-fs-open');
    const iconClose = document.getElementById('icon-fs-close');
    const btnRetourListe = document.getElementById('btn-retour-liste');
    const container = document.getElementById('container-retour-liste');

    if (isFullscreen) {
        iconOpen.classList.add('hidden');
        iconClose.classList.remove('hidden');
        if (btnRetourListe) btnRetourListe.classList.add('hidden');
        // On s'assure que le conteneur prend toute la largeur pour aligner √† droite
        container.classList.replace('justify-between', 'justify-end');
    } else {
        iconOpen.classList.remove('hidden');
        iconClose.classList.add('hidden');
        // On r√©tablit la disposition initiale si on n'est pas dans la zone de jeu
        if (!elements.setupZone.classList.contains('hidden')) {
            if (btnRetourListe) btnRetourListe.classList.remove('hidden');
            container.classList.replace('justify-end', 'justify-between');
        }
    }
}

    // --- Initialisation Tables ---
    function initTables() {
        const container = document.getElementById('tables-container');
        let html = '<div class="flex gap-2 justify-center">';
        for (let i = 2; i <= 10; i++) {
            if (i === 7) html += '</div><div class="flex gap-2 justify-center mt-2">';
            html += `<label class="cursor-pointer">
                <input type="checkbox" class="hidden table-checkbox" value="${i}">
                <div class="op-btn-frame w-10 h-10 flex items-center justify-center rounded-lg font-black text-xs">${i}</div>
            </label>`;
        }
        html += `<label class="cursor-pointer">
            <input type="checkbox" id="check-all-tables" class="hidden" onchange="toggleAllTables(this)">
            <div class="op-btn-frame px-3 h-10 flex items-center justify-center rounded-lg font-black text-[10px] uppercase">Toutes</div>
        </label></div>`;
        container.innerHTML = html;
    }

    function toggleAllTables(source) {
        document.querySelectorAll('.table-checkbox').forEach(cb => cb.checked = source.checked);
    }

    // --- Sons ---
    function prechargerSon() {
        const audio = document.getElementById('audio-finish');
        if (audio) {
            audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(() => {});
        }
    }

    function jouerBip() {
        const audio = document.getElementById('audio-finish');
        if (audio) { audio.currentTime = 0; audio.volume = 1.0; audio.play().catch(() => {}); }
    }

    // --- Timer ---
    function startTimer() {
        clearInterval(countdown);
        const mins = parseInt(document.getElementById('timer-min').value) || 0;
        const secs = parseInt(document.getElementById('timer-sec').value) || 0;
        let timeLeft = (mins * 60) + secs;
        if (timeLeft <= 0) { document.getElementById('timer-display').classList.add('hidden'); return; }
        document.getElementById('timer-display').classList.remove('hidden');
        const updateDisplay = () => {
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById('seconds-left').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (timeLeft <= 0) { clearInterval(countdown); jouerBip(); document.getElementById('modal-fin').style.display = 'flex'; }
            timeLeft--;
        };
        updateDisplay();
        countdown = setInterval(updateDisplay, 1000);
    }

    function validerFinChrono() { fermerModal('modal-fin'); showCorrection(); }

    // --- Logique Calculs ---
    function getCalculConfig() {
        const selectedOps = Array.from(document.querySelectorAll('.op-checkbox:checked')).map(el => el.value);
        const selectedTables = Array.from(document.querySelectorAll('.table-checkbox:checked')).map(el => parseInt(el.value));
        const mode = document.querySelector('input[name="game-mode"]:checked').value;
        const min = parseInt(document.getElementById('min-val').value) || 1;
        const max = parseInt(document.getElementById('max-val').value) || 50;
        let nb = Math.min(parseInt(document.getElementById('nb-val').value) || 10, MAX_CALCULS);
        return { selectedOps, selectedTables, mode, min, max, nb };
    }

    function generateCalcul(op, selectedTables, min, max) {
        let a, b, res, q;
        if (op === 'x' || op === ':') {
            const tables = selectedTables.length > 0 ? selectedTables : TABLES_DEFAULT;
            b = tables[Math.floor(Math.random() * tables.length)];
            const f = Math.floor(Math.random() * 10) + 1;
            if (op === 'x') { a = f; res = a * b; q = `${a} x ${b}`; }
            else { a = f * b; res = f; q = `${a} √∑ ${b}`; }
        } else {
            a = Math.floor(Math.random() * (max - min + 1)) + min;
            b = Math.floor(Math.random() * (max - min + 1)) + min;
            if (op === '+') { res = a + b; q = `${a} + ${b}`; }
            else { if (a < b) [a, b] = [b, a]; res = a - b; q = `${a} - ${b}`; }
        }
        return { q, r: res };
    }

    function generateSeries() {
        const config = getCalculConfig();
        currentCalculs = [];
        let attempts = 0;
        while (currentCalculs.length < config.nb && attempts < config.nb * MAX_ATTEMPTS_MULTIPLIER) {
            attempts++;
            const op = config.selectedOps[Math.floor(Math.random() * config.selectedOps.length)];
            const calcul = generateCalcul(op, config.selectedTables, config.min, config.max);
            if (!currentCalculs.some(c => c.q === calcul.q)) currentCalculs.push(calcul);
        }
        renderQuestions(config.mode);
        updateActionButtons(config.mode);
        startTimer();
        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('container-retour-liste').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');
    }

    function renderQuestions(mode) {
        const grid = document.getElementById('questions-grid');
        grid.innerHTML = '';
        const oldScore = document.getElementById('score-display');
        if (oldScore) oldScore.remove();
        currentCalculs.forEach((calc, i) => {
            const textClass = mode === 'vpi' ? 'vpi-text' : 'solo-text';
            const resClass = mode === 'vpi' ? 'vpi-res' : 'solo-res';
            let interactivePart = mode === 'solo' ? `<input type="text" inputmode="decimal" class="answer-input" placeholder="?">` : ``;
            grid.innerHTML += `<div class="q-card relative">
                <span class="absolute top-1 left-2 opacity-50 text-[14px] font-black">${i + 1})</span>
                <div class="flex items-center justify-center w-full"><span class="${textClass}">${calc.q} =</span></div>
                ${interactivePart}<span class="res-text hidden ${resClass}">${calc.r}</span>
            </div>`;
        });
    }

    function updateActionButtons(mode) {
        const pdfBtn = document.getElementById('pdf-btn');
        if (mode === 'solo') pdfBtn.classList.add('hidden');
        else pdfBtn.classList.remove('hidden');
    }

    // --- Correction ---
    function showCorrection() {
        const inputs = document.querySelectorAll('.answer-input');
        const btn = document.getElementById('validate-btn');
        const scoreDiv = document.getElementById('score-display');
        const isShowing = scoreDiv !== null || (inputs.length === 0 && !document.querySelector('.res-text').classList.contains('hidden'));
        if (isShowing) {
            if (scoreDiv) scoreDiv.remove();
            document.querySelectorAll('.res-text').forEach(el => el.classList.add('hidden'));
            inputs.forEach(input => { input.style.borderColor = ""; input.style.backgroundColor = ""; });
            btn.innerText = "üëÅÔ∏è Correction";
        } else {
            clearInterval(countdown);
            if (inputs.length > 0) {
                let score = 0;
                inputs.forEach((input, i) => {
                    const val = input.value.trim().replace(',', '.');
                    const isCorrect = val !== "" && parseFloat(val) === currentCalculs[i].r;
                    const resElement = input.closest('.q-card').querySelector('.res-text');
                    if (isCorrect) {
                        input.style.borderColor = "#10b981"; input.style.backgroundColor = "rgba(16, 185, 129, 0.1)"; score++;
                    } else {
                        input.style.borderColor = "#ef4444"; input.style.backgroundColor = "rgba(239, 68, 68, 0.1)";
                        resElement.classList.remove('hidden');
                    }
                });
                document.getElementById('questions-grid').insertAdjacentHTML('beforebegin', `<div id="score-display" class="w-full text-center p-4 mb-4 rounded-2xl border-2 border-dashed border-[var(--accent-color)]"><span class="text-3xl font-black" style="color:var(--accent-color)">Score : ${score} / ${currentCalculs.length}</span></div>`);
            } else {
                document.querySelectorAll('.res-text').forEach(el => el.classList.remove('hidden'));
            }
            btn.innerText = "üôà Masquer";
        }
    }

    // --- Export PDF ---
    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const dateStr = new Date().toISOString().slice(0,10).replace(/-/g, "");
        drawCalculsPage(doc, false);
        doc.addPage();
        drawCalculsPage(doc, true);
        doc.save(`outilsprofs_calcul_${dateStr}.pdf`);
    }

    function drawCalculsPage(doc, isCorrection) {
        doc.setFont(undefined, 'bold');
        doc.text(isCorrection ? "Correction - Calcul Mental" : "Calcul Mental", 105, 20, { align: "center" });
        doc.setFont(undefined, 'normal');
        currentCalculs.forEach((c, i) => {
            const x = i >= 25 ? 110 : 20;
            const y = 40 + ((i % 25) * 10);
            doc.text(`${i + 1}) ${c.q} = ${isCorrection ? c.r : '.......'}`, x, y);
        });
    }

    // --- Navigation & Th√®me ---
    function retourReglages() {
        clearInterval(countdown);
        document.getElementById('setup-zone').classList.remove('hidden');
        if (!document.body.classList.contains('fullscreen-mode')) {
            document.getElementById('container-retour-liste').classList.remove('hidden');
        }
        document.getElementById('game-zone').classList.add('hidden');
    }

    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }

    function appliquerTheme() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const hexColor = COULEURS_THEME[themePrefs.gen || 'cyan'] || '#06b6d4';
        document.documentElement.style.setProperty('--accent-color', hexColor);
        document.querySelectorAll('.btn-add, .ui-btn-round, #btn-retour-liste, #mainAddBtn, .btn-game-action').forEach(el => {
            if (el && !el.classList.contains('bg-gray-500') && !el.classList.contains('bg-green-500') && !el.classList.contains('bg-amber-500') && !el.classList.contains('bg-blue-500')) {
                el.style.backgroundColor = hexColor;
                el.style.color = '#fff';
            }
        });
    }

    window.onload = () => { appliquerTheme(); initTables(); };
</script>
</body>
</html>