<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Observations - OutilsProfs</title>
    
    <script>
        (function() {
            const mode = localStorage.getItem('theme_mode');
            if (mode === 'light') {
                document.documentElement.classList.add('light-mode-init');
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root { 
            --primary: #ff637e; --bg-page: #121212; --text-main: #ffffff;
            --card-student: #1a1a1a; --header-bg: #1e1e1e; --header-border: rgba(255, 255, 255, 0.1);
            --card-sub: #9ca3af;
            --student-name-girl: #f9a8d4; --student-name-boy: #93c5fd;
        }

        body.light-mode, html.light-mode-init body {
            --bg-page: #eeeeee; --text-main: #111827; --card-student: #ffffff;
            --header-bg: #ffffff; --header-border: #ddd; --card-sub: #4b5563;
        }

        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-page); 
            color: var(--text-main); margin: 0; transition: background 0.3s;
            display: flex; flex-direction: column; align-items: center;
            padding: 0 10px 20px 10px; overflow-x: hidden;
        }

        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--header-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: calc(100% + 20px); margin-bottom: 15px;
        }

        #btn-retour, #btn-aide { 
            display: flex; align-items: center; justify-content: center; 
            width: 38px; height: 38px; border-radius: 50%; 
            transition: all 0.3s ease; border: none; cursor: pointer;
        }

        #mainTitle { text-align: center; font-weight: 900; font-size: 1rem; text-transform: uppercase; flex-grow: 1; }

        /* Barre de contr√¥le g√©n√©rale (au-dessus de la grille) */
        .general-controls {
            display: flex; justify-content: center; gap: 15px; 
            margin-bottom: 20px; width: 100%; max-width: 900px;
        }
        .ctrl-btn-gen {
            font-size: 9px; font-weight: 900; text-transform: uppercase; padding: 5px 12px;
            border-radius: 50px; border: 1.5px solid var(--primary); background: transparent;
            color: var(--primary); cursor: pointer; transition: all 0.2s;
        }
        .ctrl-btn-gen:active { background: var(--primary); color: white; }

        /* Layout Grid 2 Colonnes */
        #listeContainer {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 900px;
            align-items: start;
        }

        .level-group { width: 100%; min-width: 0; }
        .level-title { 
            font-size: 0.75rem; font-weight: 900; text-transform: uppercase; 
            text-align: center; margin-bottom: 12px; padding: 5px; 
            border-radius: 6px; background: rgba(128,128,128,0.1);
        }

        .student-container { margin-bottom: 8px; }
        .student-item { 
            background-color: var(--card-student); padding: 5px 14px; display: flex; 
            justify-content: space-between; align-items: center; cursor: pointer; 
            border-radius: 50px; transition: all 0.2s;
            border: 1.5px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .student-item.active {
            border-color: var(--primary);
            border-radius: 15px 15px 0 0;
        }

        .student-name { font-weight: 800; font-size: 0.8rem; flex: 1; }
        .status-icon { font-size: 0.7rem; opacity: 0.8; margin-left: 5px; }
        .text-girl { color: var(--student-name-girl); }
        .text-boy { color: var(--student-name-boy); }

        .obs-drawer {
            display: none; overflow: hidden;
            background: var(--card-student);
            border: 1.5px solid var(--primary); border-top: none;
            border-radius: 0 0 15px 15px; margin-top: -1px;
        }
        .obs-drawer.open { display: block; }

        .drawer-textarea {
            width: 100%; background: transparent; border: none;
            padding: 12px; font-size: 0.85rem; color: var(--text-main);
            outline: none; resize: none; font-family: 'Inter', sans-serif;
            display: block; overflow: hidden; min-height: 60px;
        }

        .bottom-nav { width: 100%; max-width: 500px; margin-top: 30px; }
        .nav-btn { 
            font-weight: 800; border-radius: 50px; font-size: 10px; padding: 14px; 
            border: none; flex: 1; display: flex; align-items: center; justify-content: center; 
            gap: 5px; cursor: pointer;
        }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-card { background: var(--card-student); padding: 20px; border-radius: 20px; width: 90%; max-width: 400px; }
        .alert-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 2000; }
        .alert-content { background: white; padding: 25px; border-radius: 25px; width: 85%; max-width: 320px; color: #111; text-align: center; }
    </style>
</head>
<body>

    <header>
        <a href="index.html" id="btn-retour">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="mainTitle">OBSERVATIONS</h1>
        <button id="btn-aide" onclick="ouvrirAide()" style="font-size: 1.2rem;">üí°</button>
    </header>

    <div class="general-controls">
        <button class="ctrl-btn-gen" onclick="toggleAllDrawers(true)">Tout ouvrir</button>
        <button class="ctrl-btn-gen" onclick="toggleAllDrawers(false)">Tout fermer</button>
    </div>

    <div id="listeContainer"></div>

    <!-- ====================== FOOTER NAVIGATION ====================== -->
    <footer class="bottom-nav flex flex-col gap-3 px-2">
        <div class="flex gap-2">
            <label class="nav-btn bg-neutral-800 text-white cursor-pointer text-center">
                üëáimporter .txtüëá
                <input type="file" id="importFile" class="hidden" accept=".txt">
            </label>
            <button onclick="exportToFile()" class="nav-btn bg-neutral-800 text-white relative">
                üëÜexporter .txtüëÜ
                <span id="badge-export" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-orange-500 rounded-full animate-pulse border-2 border-white"></span>
            </button>
            <button onclick="genererPDF()" class="nav-btn bg-neutral-800 text-white">üìÑ r√©capitulatif PDF</button>
        </div>
        <button onclick="toutEffacer()" class="nav-btn bg-red-500 text-red-100 shadow-lg">‚ö†Ô∏è effacer les donn√©es</button>
    </footer>

    <div id="modal-aide" class="modal-overlay" onclick="fermerAide()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div id="aide-content"></div>
            <button onclick="fermerAide()" id="btn-fermer-aide" class="w-full py-4 mt-4 font-black rounded-2xl uppercase text-[10px] tracking-widest">Fermer</button>
        </div>
    </div>

    <div id="alertModal" class="alert-overlay">
        <div class="alert-content">
            <h3 id="alertTitle" class="font-black uppercase mb-2">Confirmation</h3>
            <p id="alertText" class="text-xs text-gray-600 mb-6"></p>
            <div class="flex gap-2">
                <button class="flex-1 p-3 bg-gray-100 rounded-xl font-bold" onclick="closeAlert()">Non</button>
                <button id="alertConfirmBtn" class="flex-1 p-3 text-white rounded-xl font-bold">Oui</button>
            </div>
        </div>
    </div>

    <script>
        const COLOR_MAP = {
            'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
            'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
            'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
            'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e'
        };

        const LEVEL_COLORS = { 'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308', 'CM1': '#ef4444', 'CM2': '#22c55e', 'AUTRE': '#8b5cf6' };
        const LEVEL_ORDER = ['CP', 'CE1', 'CE2', 'CM1', 'CM2', 'AUTRE'];

        const STORAGE_KEYS = {
            students: 'maListeEleves',
            observations: 'studentObservations',
            theme: 'theme_tuiles',
            themeMode: 'theme_mode',
            needsExport: 'needsExport_obs'
        };

        let inscribedStudents = JSON.parse(localStorage.getItem(STORAGE_KEYS.students)) || [];
        let savedObservations = JSON.parse(localStorage.getItem(STORAGE_KEYS.observations)) || {};

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        // Action globale sur TOUS les tiroirs
        function toggleAllDrawers(open) {
            document.querySelectorAll('.obs-drawer').forEach(drawer => {
                const item = drawer.previousElementSibling;
                const area = drawer.querySelector('textarea');
                if (open) {
                    drawer.classList.add('open');
                    item.classList.add('active');
                    autoResize(area);
                } else {
                    drawer.classList.remove('open');
                    item.classList.remove('active');
                }
            });
        }

        
		// Fonction utilitaire pour g√©rer l'affichage intelligent des pr√©noms
function formatDisplayName(student, allStudents) {
    const identite = student.identite.trim();
    const parts = identite.split(' ');
    const prenom = parts[0];
    const nom = parts.slice(1).join(' ');

    // On cherche les doublons de pr√©nom dans TOUTE la liste
    const doublons = allStudents.filter(s => s.identite.trim().split(' ')[0].toLowerCase() === prenom.toLowerCase());

    if (doublons.length <= 1) {
        return prenom; // Pr√©nom unique
    }

    // S'il y a des doublons, on v√©rifie l'initiale du nom
    const initialeNom = nom.charAt(0).toUpperCase();
    const memesInitiales = doublons.filter(s => {
        const sNom = s.identite.trim().split(' ').slice(1).join(' ');
        return sNom.charAt(0).toUpperCase() === initialeNom;
    });

    if (memesInitiales.length <= 1) {
        return `${prenom} ${initialeNom}.`; // Pr√©nom + Initiale
    }

    // Si m√™me initiale, on affiche les 2 premi√®res lettres du nom
    const deuxLettresNom = nom.substring(0, 2).toUpperCase();
    return `${prenom} ${deuxLettresNom}.`;
}

function renderStudentList() {
    const container = document.getElementById('listeContainer');
    container.innerHTML = "";
    if (inscribedStudents.length === 0) {
        container.style.display = "block";
        container.innerHTML = `<div class="text-center p-10 text-neutral-500 text-[10px] font-bold uppercase">Aucun √©l√®ve.</div>`;
        return;
    }
    container.style.display = "grid";

    const groups = {};
    inscribedStudents.forEach(s => {
        const lvl = s.niveau.toUpperCase();
        if (!groups[lvl]) groups[lvl] = [];
        groups[lvl].push(s);
    });

    const sortedLevels = Object.keys(groups).sort((a, b) => LEVEL_ORDER.indexOf(a) - LEVEL_ORDER.indexOf(b));

    sortedLevels.forEach(level => {
        const wrapper = document.createElement('div');
        wrapper.className = "level-group";
        wrapper.innerHTML = `<h2 class="level-title" style="color:${LEVEL_COLORS[level] || '#fff'}">${level}</h2>`;

        const list = document.createElement('div');
        // On trie par le nom complet pour garder une coh√©rence, mais on affiche le format court
        groups[level].sort((a, b) => a.identite.localeCompare(b.identite)).forEach(student => {
            const block = document.createElement('div');
            block.className = "student-container";

            // Appel de la fonction de formatage intelligent
            const nomAffiche = formatDisplayName(student, inscribedStudents);

            const item = document.createElement('div');
            item.className = `student-item ${student.sexe.toLowerCase().startsWith('f') ? 'text-girl' : 'text-boy'}`;
            item.innerHTML = `
                <span class="student-name">${nomAffiche}</span>
                <span class="status-icon" id="icon-${student.id}">${savedObservations[student.identite] ? 'üîé' : 'Ôºã'}</span>
            `;

            const drawer = document.createElement('div');
            drawer.className = "obs-drawer";
            
            const area = document.createElement('textarea');
            area.className = "drawer-textarea";
            // Important : on garde l'identite compl√®te comme cl√© de stockage pour ne pas perdre les notes
            area.value = savedObservations[student.identite] || "";
            
            area.oninput = () => {
                savedObservations[student.identite] = area.value;
                if (!area.value.trim()) delete savedObservations[student.identite];
                localStorage.setItem(STORAGE_KEYS.observations, JSON.stringify(savedObservations));
                document.getElementById(`icon-${student.id}`).innerText = savedObservations[student.identite] ? 'üîé' : 'Ôºã';
                autoResize(area);
                updateExportBadge(true);
            };

            item.onclick = () => {
                const isOpen = drawer.classList.contains('open');
                if (isOpen) {
                    drawer.classList.remove('open');
                    item.classList.remove('active');
                } else {
                    drawer.classList.add('open');
                    item.classList.add('active');
                    autoResize(area);
                }
            };

            drawer.appendChild(area);
            block.appendChild(item);
            block.appendChild(drawer);
            list.appendChild(block);
        });
        wrapper.appendChild(list);
        container.appendChild(wrapper);
    });
}


        function updateExportBadge(val) {
            const b = document.getElementById('badge-export');
            if (val) { b.classList.remove('hidden'); localStorage.setItem(STORAGE_KEYS.needsExport, 'true'); }
            else { b.classList.add('hidden'); localStorage.removeItem(STORAGE_KEYS.needsExport); }
        }

        function applyTheme() {
            const savedMode = localStorage.getItem(STORAGE_KEYS.themeMode);
            document.body.classList.toggle('light-mode', savedMode === 'light');
            const prefs = JSON.parse(localStorage.getItem(STORAGE_KEYS.theme)) || {};
            const colorHex = COLOR_MAP[prefs['obs'] || 'green'] || '#22c55e';
            document.documentElement.style.setProperty('--primary', colorHex);
            if (prefs.fille) document.documentElement.style.setProperty('--student-name-girl', COLOR_MAP[prefs.fille]);
            if (prefs.garcon) document.documentElement.style.setProperty('--student-name-boy', COLOR_MAP[prefs.garcon]);
            const txt = ['yellow', 'lime', 'amber', 'cyan'].includes(prefs['obs']) ? 'black' : 'white';
            [document.getElementById('btn-retour'), document.getElementById('btn-aide'), document.getElementById('btn-fermer-aide')].forEach(el => { if(el){el.style.backgroundColor = colorHex; el.style.color = txt;} });
        }

        function exportToFile() {
            if (Object.keys(savedObservations).length === 0) return;
            const content = Object.entries(savedObservations).map(([n, o]) => `${n};${o.replace(/\n/g, '[BR]')}`).join("\n");
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `obs_${new Date().toISOString().slice(0,10)}.txt`; a.click();
            updateExportBadge(false);
        }

        document.getElementById('importFile').onchange = function(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                ev.target.result.split(/\r?\n/).forEach(l => { const p = l.split(";"); if(p.length>=2) savedObservations[p[0]] = p.slice(1).join(";").replace(/\[BR\]/g, "\n"); });
                localStorage.setItem(STORAGE_KEYS.observations, JSON.stringify(savedObservations));
                renderStudentList();
            };
            reader.readAsText(e.target.files[0]);
        };

        function genererPDF() {
            const element = document.createElement('div');
            element.style.padding = '20px'; element.style.color = 'black'; element.style.backgroundColor = 'white';
            let html = `<h1 style="text-align:center; font-size:16px; margin-bottom:20px;">OBSERVATIONS</h1>`;
            Object.keys(savedObservations).sort().forEach(name => {
                html += `<div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:5px;"><b>${name}</b><p style="font-size:11px; white-space:pre-wrap; margin:5px 0;">${savedObservations[name]}</p></div>`;
            });
            element.innerHTML = html;
            html2pdf().from(element).save('observations.pdf');
        }

        function toutEffacer() { showAlert("Effacer ?", "Supprimer tout ?", () => { savedObservations = {}; localStorage.setItem(STORAGE_KEYS.observations, JSON.stringify(savedObservations)); updateExportBadge(true); renderStudentList(); }); }
		
        function ouvrirAide() {
    const aideContent = document.getElementById('aide-content');
    aideContent.innerHTML = `
        <div class="text-left space-y-4 text-[11px] leading-relaxed">
            <h2 class="text-sm font-black uppercase text-center mb-4 tracking-tighter" style="color: var(--primary)">üí° Observations</h2>
            
            <section>
                <p class="font-bold uppercase text-[9px] mb-1 opacity-60">üìù Saisie des notes</p>
                <p>Cliquez sur le nom d'un √©l√®ve pour ouvrir sa fiche. La zone de texte s'agrandit automatiquement. Vous pouvez ouvrir <strong>plusieurs fiches simultan√©ment</strong> pour comparer vos notes.</p>
            </section>

            <section>
                <p class="font-bold uppercase text-[9px] mb-1 opacity-60">‚ö° Contr√¥les Rapides</p>
                <p>Utilisez les boutons <strong>"Tout ouvrir"</strong> ou <strong>"Tout fermer"</strong> en haut de la liste pour g√©rer l'affichage global de votre classe en un clic.</p>
            </section>

            <section>
                <p class="font-bold uppercase text-[9px] mb-1 opacity-60">üíæ Sauvegarde & S√©curit√©</p>
                <p>Les donn√©es sont enregistr√©es <strong>automatiquement</strong> dans votre navigateur. <br>
                <span class="text-orange-500">‚ö†Ô∏è Attention :</span> Si vous changez de t√©l√©phone ou videz le cache, les notes seront perdues.</p>
            </section>

            <section class="bg-black/20 p-3 rounded-xl border border-white/5">
                <p class="font-bold uppercase text-[9px] mb-1 opacity-60 italic">üì§ Exportation & Transfert</p>
                <ul class="list-disc pl-4 space-y-1">
                    <li><strong>Exporter .txt :</strong> T√©l√©charge un fichier contenant toutes vos observations. Pratique pour les r√©cup√©rer sur PC.</li>
                    <li><strong>Importer .txt :</strong> Permet de restaurer vos notes ou de synchroniser vos donn√©es depuis un autre appareil.</li>
                    <li><strong>R√©capitulatif PDF :</strong> G√©n√®re un document propre et pr√™t √† imprimer pour vos dossiers.</li>
                </ul>
            </section>
        </div>
    `;
    document.getElementById('modal-aide').style.display = 'flex';
}

        function fermerAide() { document.getElementById('modal-aide').style.display='none'; }
        function showAlert(t, tx, c) { document.getElementById('alertTitle').innerText=t; document.getElementById('alertText').innerText=tx; const cb=document.getElementById('alertConfirmBtn'); cb.style.backgroundColor=getComputedStyle(document.documentElement).getPropertyValue('--primary'); cb.onclick=()=>{closeAlert(); if(c)c();}; document.getElementById('alertModal').style.display='flex'; }
        function closeAlert() { document.getElementById('alertModal').style.display='none'; }

        window.onload = () => { applyTheme(); renderStudentList(); if (localStorage.getItem(STORAGE_KEYS.needsExport) === 'true') updateExportBadge(true); };
    </script>
</body>
</html>