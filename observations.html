<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Observations - OutilsProfs</title>
    
    <script>
        (function() {
            const mode = localStorage.getItem('theme_mode');
            if (mode === 'light') {
                document.documentElement.classList.add('light-mode-init');
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* ====================== CSS CONFIGURATION ====================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root { 
            --primary: #ff637e; --bg-page: #121212; --text-main: #ffffff;
            --card-student: #1a1a1a; --header-bg: #1e1e1e; --header-border: rgba(255, 255, 255, 0.1);
            --border-color: rgba(255, 255, 255, 0.1); --card-sub: #9ca3af;
            --student-name-girl: #f9a8d4; --student-name-boy: #93c5fd;
        }

        body.light-mode, html.light-mode-init body {
            --bg-page: #eeeeee; --text-main: #111827; --card-student: #ffffff;
            --header-bg: #ffffff; --header-border: #ddd; --card-sub: #4b5563;
        }

        /* Base Styles */
        body { 
            font-family: 'Inter', sans-serif; background: var(--bg-page); 
            color: var(--text-main); padding: 0; margin: 0; transition: background 0.3s;
            display: flex; flex-direction: column; align-items: center;
            padding-left: 15px; padding-right: 15px; padding-bottom: 20px; overflow-x: hidden;
        }

        /* Header */
        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--header-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: calc(100% + 30px); margin-left: -15px; margin-bottom: 10px;
        }

        #btn-retour, #btn-aide { 
            display: flex; align-items: center; justify-content: center; 
            width: 40px; height: 40px; border-radius: 50%; 
            transition: all 0.3s ease; border: none; cursor: pointer;
        }

        #mainTitle { 
            text-align: center; font-weight: 800; font-size: 1.1rem; 
            letter-spacing: 1px; margin: 0; flex-grow: 1; text-transform: uppercase;
        }

        /* Layout Grid */
        .columns-container { 
            column-count: 2; column-gap: 12px; width: 100%; 
            max-width: 600px; margin: 0 auto;
        }

        @media (min-width: 640px) {
            .columns-container { max-width: 95%; }
        }

        /* Level Groups */
        .level-group { 
            break-inside: avoid; margin-bottom: 20px; 
            display: inline-block; width: 100%;
        }

        .level-title { 
            color: var(--text-main); font-size: 0.6875rem; font-weight: 900; 
            text-transform: uppercase; letter-spacing: 0.05em; text-align: center; margin-bottom: 0.5rem;
        }

        /* Student Items */
        .student-item { 
            background-color: var(--card-student); padding: 6px 12px; display: flex; 
            justify-content: space-between; align-items: center; cursor: pointer; 
            border-radius: 50px; margin-bottom: 4px; transition: all 0.1s;
            border: 1.5px solid transparent; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 0; -webkit-tap-highlight-color: transparent; user-select: none;
        }

        body.light-mode .student-item, html.light-mode-init .student-item { 
            border-color: #e5e7eb;
        }

        .student-item:hover { transform: translateY(-1px); }

        .student-name { 
            font-weight: 800; font-size: 0.7rem; overflow: hidden; 
            text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;
        }

        .status-icon { 
            font-size: 0.65rem; opacity: 0.8; margin-left: 5px; flex-shrink: 0;
        }

        .text-girl { color: var(--student-name-girl); }
        .text-boy { color: var(--student-name-boy); }

        /* Navigation */
        .bottom-nav { 
            width: 100%; max-width: 500px; margin: 25px auto 0; padding-bottom: 40px;
        }

        .nav-btn { 
            font-weight: 800; border-radius: 50px; font-size: 9px; padding: 12px; 
            border: none; flex: 1; display: flex; align-items: center; justify-content: center; 
            gap: 5px; cursor: pointer; transition: all 0.2s;
        }

        .nav-btn:active { transform: scale(0.95); }

        /* Modals */
        .modal-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); 
            align-items: center; justify-content: center; z-index: 1000; 
            backdrop-filter: blur(4px); padding: 20px;
        }

        .modal-content { 
            background: var(--card-student); padding: 20px; border-radius: 20px; 
            width: 100%; max-width: 400px; border: 1px solid var(--header-border);
        }

        .modal-title { 
            margin: 0; font-size: 1.1rem; font-weight: 800; 
            color: var(--text-main); margin-bottom: 12px;
        }

        textarea { 
            width: 100%; margin: 10px 0; padding: 12px; border-radius: 12px; 
            border: 1px solid var(--header-border); font-size: 0.85rem; 
            background: var(--card-student); color: var(--text-main); 
            outline: none; resize: none; font-family: 'Inter', sans-serif;
            transition: border-color 0.2s;
        }

        textarea:focus { border-color: var(--primary); }

        body.light-mode textarea { background: #f3f4f6; }

        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }

        .modal-btn { 
            flex: 1; padding: 14px; border: none; border-radius: 50px; 
            font-weight: 900; cursor: pointer; text-transform: uppercase; 
            font-size: 10px; transition: all 0.2s;
        }

        .btn-save { color: white; }
        .btn-cancel { background: #333; color: #ccc; }

        /* Help Modal */
        #modal-aide .modal-card { 
            background-color: var(--card-student); border: 1px solid var(--header-border);
        }

        #aide-content h3 { 
            font-weight: 900; text-transform: uppercase; font-size: 0.8rem; 
            margin-bottom: 10px; margin-top: 0;
        }

        #aide-content p, #aide-content li { 
            font-size: 0.75rem; line-height: 1.5; color: var(--card-sub); 
            margin-bottom: 8px; margin: 0 0 8px 0;
        }

        /* Alert Modal */
        .alert-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            align-items: center; justify-content: center; z-index: 2000; padding: 20px;
        }

        .alert-content { 
            background: white; padding: 25px; border-radius: 24px; 
            width: 100%; max-width: 350px; color: #111;
        }

        .alert-title { 
            font-size: 1rem; font-weight: 900; text-transform: uppercase; 
            text-align: center; margin-bottom: 1rem; margin: 0 0 1rem 0;
        }

        .alert-text { 
            font-size: 0.875rem; font-weight: 600; text-align: center; 
            color: #4b5563; margin-bottom: 1.5rem; margin: 0 0 1.5rem 0;
        }

        .alert-btns { display: flex; gap: 0.5rem; }

        .btn-alert { 
            flex: 1; padding: 14px; border-radius: 15px; font-weight: 900; 
            font-size: 11px; text-transform: uppercase; cursor: pointer; 
            border: none; transition: all 0.2s;
        }

        .btn-alert:active { transform: scale(0.95); }

        /* Animations */
        @keyframes blink-point {
            0% { transform: scale(0.9); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.5; }
        }

        .mini-pastille {
            display: inline-block; width: 8px; height: 8px; 
            background-color: #f97316; border-radius: 50%; margin-left: 4px; 
            margin-right: 2px; box-shadow: 0 0 5px #f97316; 
            animation: blink-point 1.5s infinite;
        }

        .badge-pulse { animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>

    <!-- ====================== HEADER ====================== -->
    <header>
        <a href="index.html" id="btn-retour">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="mainTitle">OBSERVATIONS</h1>
        <button id="btn-aide" onclick="ouvrirAide()" style="font-size: 1.2rem;">üí°</button>
    </header>

    <!-- ====================== MAIN CONTENT ====================== -->
    <div id="listeContainer" class="columns-container"></div>

    <!-- ====================== FOOTER NAVIGATION ====================== -->
    <footer class="bottom-nav flex flex-col gap-3 px-2">
        <div class="flex gap-2">
            <label class="nav-btn bg-neutral-800 text-white cursor-pointer text-center">
                üëáimporter .txtüëá
                <input type="file" id="importFile" class="hidden" accept=".txt">
            </label>
            <button onclick="exportToFile()" class="nav-btn bg-neutral-800 text-white relative">
                üëÜexporter .txtüëÜ
                <span id="badge-export" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-orange-500 rounded-full animate-pulse border-2 border-white"></span>
            </button>
            <button onclick="genererPDF()" class="nav-btn bg-neutral-800 text-white">üìÑ r√©capitulatif PDF</button>
        </div>
        <button onclick="toutEffacer()" class="nav-btn bg-red-500 text-red-100 shadow-lg">‚ö†Ô∏è effacer les donn√©es</button>
    </footer>

    <!-- ====================== COMMENT MODAL ====================== -->
    <div id="modal" class="modal-overlay">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="modal-title" id="modalTitle">√âl√®ve</h2>
            <textarea id="commentInput" rows="8" placeholder="√âcrire une observation..."></textarea>
            <div class="modal-btns">
                <button class="modal-btn btn-save" onclick="saveData()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- ====================== HELP MODAL ====================== -->
    <div id="modal-aide" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[200] hidden items-center justify-center p-6" onclick="fermerAide()">
        <div class="modal-card w-full max-w-sm rounded-3xl p-6 shadow-2xl" onclick="event.stopPropagation()">
            <div id="aide-content"></div>
            <button onclick="fermerAide()" id="btn-fermer-aide" class="w-full py-4 mt-2 font-black rounded-2xl uppercase text-[10px] tracking-widest active:scale-95 transition-all">
                Fermer
            </button>
        </div>
    </div>

    <!-- ====================== ALERT MODAL ====================== -->
    <div id="alertModal" class="alert-overlay">
        <div class="alert-content">
            <h3 id="alertTitle" class="alert-title">Confirmation</h3>
            <p id="alertText" class="alert-text">Message</p>
            <div class="alert-btns">
                <button id="alertCancelBtn" class="btn-alert bg-gray-100 text-gray-500" onclick="closeAlert()">Annuler</button>
                <button id="alertConfirmBtn" class="btn-alert text-white">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // ====================== CONFIGURATION & CONSTANTS ====================== 
        const COLOR_MAP = {
            'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
            'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
            'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
            'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
            'rose': '#f43f5e'
        };

        const LEVEL_COLORS = {
            'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308',
            'CM1': '#ef4444', 'CM2': '#22c55e', 'AUTRE': '#8b5cf6'
        };

        const LEVEL_ORDER = ['CP', 'CE1', 'CE2', 'CM1', 'CM2', 'AUTRE'];

        const STORAGE_KEYS = {
            students: 'maListeEleves',
            observations: 'studentObservations',
            theme: 'theme_tuiles',
            themeMode: 'theme_mode',
            needsExport: 'needsExport_obs',
            lastExport: 'last_export_obs',
            teacherName: 'nom_enseignant'
        };

        const EXPORT_INTERVAL = 7 * 24 * 60 * 60 * 1000; // 7 days
        const LINE_BREAK_MARKER = '[BR]';

        let inscribedStudents = JSON.parse(localStorage.getItem(STORAGE_KEYS.students)) || [];
        let savedObservations = JSON.parse(localStorage.getItem(STORAGE_KEYS.observations)) || {};
        let currentStudentId = "";
        let currentStudentName = "";

        // ====================== UTILITY FUNCTIONS ====================== 
        function formatName(fullName) {
            if (!fullName) return "";
            const parts = fullName.trim().split(' ');
            const first = parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase();
            const last = parts.slice(1).join(' ').toUpperCase();
            return (first + ' ' + last).trim();
        }

        function getNormalizedLevel(student) {
            return student.nivel.toString().toUpperCase();
        }

        function getGenderClass(student) {
            return student.sexe.toLowerCase().startsWith('f') ? 'text-girl' : 'text-boy';
        }

        function hasObservation(studentName) {
            return savedObservations[studentName] && savedObservations[studentName].trim().length > 0;
        }

        function getStatusIcon(studentName) {
            return hasObservation(studentName) ? 'üîé' : 'Ôºã';
        }

        // ====================== EXPORT BADGE MANAGEMENT ====================== 
        function updateExportBadge(needsExport) {
            const badge = document.getElementById('badge-export');
            if (needsExport) {
                badge.classList.remove('hidden');
                localStorage.setItem(STORAGE_KEYS.needsExport, 'true');
            } else {
                badge.classList.add('hidden');
                localStorage.removeItem(STORAGE_KEYS.needsExport);
                localStorage.setItem(STORAGE_KEYS.lastExport, Date.now());
            }
        }

        function checkBadgeStatus() {
            const lastExport = localStorage.getItem(STORAGE_KEYS.lastExport);
            const needsExport = localStorage.getItem(STORAGE_KEYS.needsExport) === 'true';

            if (needsExport) {
                updateExportBadge(true);
                return;
            }

            if (lastExport) {
                if (Date.now() - parseInt(lastExport) > EXPORT_INTERVAL) {
                    updateExportBadge(true);
                }
            } else {
                localStorage.setItem(STORAGE_KEYS.lastExport, Date.now());
            }
        }

        // ====================== THEME APPLICATION ====================== 
        function applyTheme() {
            const savedMode = localStorage.getItem(STORAGE_KEYS.themeMode);
            const isLight = savedMode === 'light';
            document.body.classList.toggle('light-mode', isLight);

            const prefs = JSON.parse(localStorage.getItem(STORAGE_KEYS.theme)) || {};
            const colorName = prefs['obs'] || 'green';
            const colorHex = COLOR_MAP[colorName] || '#22c55e';

            // Apply sex colors
            if (prefs.fille && COLOR_MAP[prefs.fille]) {
                document.documentElement.style.setProperty('--student-name-girl', COLOR_MAP[prefs.fille]);
            }
            if (prefs.garcon && COLOR_MAP[prefs.garcon]) {
                document.documentElement.style.setProperty('--student-name-boy', COLOR_MAP[prefs.garcon]);
            }

            document.getElementById('mainTitle').style.color = isLight ? '#000000' : '#ffffff';

            const isDarkText = ['yellow', 'lime', 'amber', 'cyan'].includes(colorName);
            const textColor = isDarkText ? 'black' : 'white';

            const themeButtons = [
                document.getElementById('btn-retour'),
                document.getElementById('btn-aide'),
                document.querySelector('.btn-save'),
                document.getElementById('btn-fermer-aide')
            ];

            themeButtons.forEach(el => {
                if (el) {
                    el.style.backgroundColor = colorHex;
                    el.style.color = textColor;
                    const svg = el.querySelector('svg');
                    if (svg) svg.style.color = textColor;
                }
            });

            document.documentElement.style.setProperty('--primary', colorHex);
        }

        // ====================== RENDERING ====================== 
        function renderStudentList() {
            const container = document.getElementById('listeContainer');
            container.innerHTML = "";

            if (inscribedStudents.length === 0) {
                container.innerHTML = `<div class="text-center p-10 text-neutral-500 text-[10px] font-bold uppercase w-full" style="column-span: all;">Aucun √©l√®ve inscrit.</div>`;
                return;
            }

            const groups = {};
            inscribedStudents.forEach(student => {
                const level = student.niveau.toUpperCase();
                if (!groups[level]) groups[level] = [];
                groups[level].push(student);
            });

            const levelOrder = Object.keys(groups).sort((a, b) =>
                LEVEL_ORDER.indexOf(a) - LEVEL_ORDER.indexOf(b)
            );

            if (levelOrder.length === 2) {
                container.className = "grid grid-cols-2 gap-3 w-full max-w-[600px] mx-auto";
            } else {
                container.className = "columns-container";
            }

            levelOrder.forEach(level => {
                const levelWrapper = document.createElement('div');
                levelWrapper.className = levelOrder.length === 2 ? "w-full" : "level-group";

                const levelColor = LEVEL_COLORS[level] || '#ffffff';
                const levelTitle = document.createElement('h2');
                levelTitle.className = "level-title";
                levelTitle.style.color = levelColor;
                levelTitle.innerText = level;
                levelWrapper.appendChild(levelTitle);

                const list = document.createElement('div');
                groups[level]
                    .sort((a, b) => a.identite.localeCompare(b.identite))
                    .forEach(student => {
                        const item = document.createElement('div');
                        item.className = `student-item ${getGenderClass(student)}`;
                        item.innerHTML = `<span class="student-name">${formatName(student.identite)}</span><span class="status-icon">${getStatusIcon(student.identite)}</span>`;
                        item.onclick = () => openCommentModal(student);
                        list.appendChild(item);
                    });

                levelWrapper.appendChild(list);
                container.appendChild(levelWrapper);
            });
        }

        // ====================== MODAL MANAGEMENT ====================== 
        function openCommentModal(student) {
            currentStudentId = student.id;
            currentStudentName = student.identite;
            document.getElementById('modalTitle').innerText = formatName(student.identite);
            document.getElementById('commentInput').value = savedObservations[student.identite] || "";
            
            const modal = document.getElementById('modal');
            modal.style.display = 'flex';

            // Si on clique sur le fond noir, on SAUVEGARDE puis on ferme
            modal.onclick = function(e) {
                if (e.target === modal) {
                    saveData();
                }
            };

            setTimeout(() => document.getElementById('commentInput').focus(), 100);
        }

        function closeAllModals() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('modal-aide').style.display = 'none';
            document.getElementById('alertModal').style.display = 'none';
        }

        function saveData() {
            const value = document.getElementById('commentInput').value;
            if (value.trim() === "") {
                delete savedObservations[currentStudentName];
            } else {
                savedObservations[currentStudentName] = value;
            }
            localStorage.setItem(STORAGE_KEYS.observations, JSON.stringify(savedObservations));
            updateExportBadge(true);
            renderStudentList();
            closeAllModals(); // On ferme APRES avoir enregistr√©
        }

        // ====================== EXPORT/IMPORT ====================== 
        function exportToFile() {
            if (Object.keys(savedObservations).length === 0) {
                showAlert("Vide", "Il n'y a aucune observation √† exporter.", null, false);
                return;
            }

            const content = Object.entries(savedObservations)
                .map(([name, obs]) => `${name};${obs.replace(/\n/g, LINE_BREAK_MARKER)}`)
                .join("\n");

            const fileName = `outilsprofs_observations_${new Date().toISOString().split('T')[0]}.txt`;

            if (window.Android && typeof window.Android.exportTxt === "function") {
                window.Android.exportTxt(content, fileName);
            } else {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }

            updateExportBadge(false);
        }

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const lines = event.target.result.split(/\r?\n/);
                    const newObservations = {};

                    lines.forEach(line => {
                        const parts = line.split(";");
                        if (parts.length >= 2) {
                            const name = parts[0];
                            const obs = parts.slice(1).join(";").replace(/\[BR\]/g, "\n");
                            newObservations[name] = obs;
                        }
                    });

                    if (Object.keys(newObservations).length > 0) {
                        showAlert("Importer ?", "Fusionner avec les donn√©es existantes ?", () => {
                            savedObservations = { ...savedObservations, ...newObservations };
                            localStorage.setItem(STORAGE_KEYS.observations, JSON.stringify(savedObservations));
                            updateExportBadge(false);
                            renderStudentList();
                        });
                    }
                } catch (err) {
                    showAlert("Erreur", "Fichier invalide.", null, false);
                }
            };
            reader.readAsText(file);
            this.value = "";
        });

        // ====================== PDF GENERATION ====================== 
        async function genererPDF() {
            if (Object.keys(savedObservations).length === 0) {
                showAlert("Vide", "Aucune observation √† inclure.", null, false);
                return;
            }

            if (typeof html2pdf === 'undefined') {
                alert("Erreur : La biblioth√®que n'est pas charg√©e.");
                return;
            }

            const teacherName = localStorage.getItem(STORAGE_KEYS.teacherName) || "Enseignant";
            const dateStr = new Date().toLocaleDateString('fr-FR');
            const fileName = `observations_${new Date().toISOString().split('T')[0]}.pdf`;

            const element = document.createElement('div');
            element.style.padding = '20px';
            element.style.color = 'black';
            element.style.backgroundColor = 'white';
            element.style.fontFamily = 'Arial, sans-serif';

            let html = `
                <div style="text-align:center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px;">
                    <h1 style="font-size:18px; margin:0;">OBSERVATIONS DES √âL√àVES</h1>
                    <p style="margin:5px 0;">${teacherName} - ${dateStr}</p>
                </div>`;

            const groups = {};
            inscribedStudents.forEach(student => {
                const level = student.niveau.toUpperCase();
                if (savedObservations[student.identite]) {
                    if (!groups[level]) groups[level] = [];
                    groups[level].push(student);
                }
            });

            Object.keys(groups)
                .sort((a, b) => LEVEL_ORDER.indexOf(a) - LEVEL_ORDER.indexOf(b))
                .forEach(level => {
                    html += `<h2 style="background:#f0f0f0; padding:8px; font-size:14px; margin-top:15px; border-left:4px solid #333;">${level}</h2>`;
                    groups[level]
                        .sort((a, b) => a.identite.localeCompare(b.identite))
                        .forEach(student => {
                            html += `
                                <div style="margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:5px; page-break-inside:avoid;">
                                    <b style="font-size:12px;">${formatName(student.identite)}</b><br>
                                    <p style="font-size:11px; margin:4px 0; white-space:pre-wrap;">${savedObservations[student.identite]}</p>
                                </div>`;
                        });
                });

            element.innerHTML = html;

            const opt = {
                margin: 10,
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            if (window.Android && window.Android.savePdfFromBase64) {
                html2pdf().set(opt).from(element).output('datauristring').then((pdfBase64) => {
                    const base64Clean = pdfBase64.split(',')[1];
                    window.Android.savePdfFromBase64(base64Clean, fileName);
                }).catch(err => {
                    alert("Erreur PDF : " + err);
                });
            } else {
                html2pdf().set(opt).from(element).save();
            }
        }

        // ====================== DELETE DATA ====================== 
        function toutEffacer() {
            showAlert("Tout effacer ?", "Supprimer toutes les observations ?", () => {
                savedObservations = {};
                localStorage.setItem(STORAGE_KEYS.observations, JSON.stringify(savedObservations));
                updateExportBadge(true);
                renderStudentList();
            });
        }

        // ====================== HELP MODAL ====================== 
        function ouvrirAide() {
            const prefs = JSON.parse(localStorage.getItem(STORAGE_KEYS.theme)) || {};
            const colorHex = COLOR_MAP[prefs.obs] || '#22c55e';

            const display = document.getElementById('aide-content');
            display.innerHTML = `
                <h3 style="color:${colorHex}">üí° Observations</h3>
                <p>G√©rez ici les remarques li√©es √† vos √©l√®ves.</p>
                <ul class="space-y-2">
                    <li>‚Ä¢ <strong>Icone üîé :</strong> Indique qu'une note est enregistr√©e.</li>
                    <li>‚Ä¢ <strong>Icone Ôºã :</strong> Aucune note pour cet √©l√®ve.</li>
                    <li>‚Ä¢ <strong>Portabilit√© :</strong> L'export et l'import se basent sur le NOM et le PR√âNOM. Vous pouvez transf√©rer vos notes d'un appareil √† l'autre sans probl√®me.</li>
                    <li><strong>Pastille <span class="mini-pastille"></span> :</strong> Si elle appara√Æt sur le bouton export, cela signifie que vos donn√©es locales ne sont pas synchronis√©es avec votre dernier fichier de sauvegarde. Il est alors temps d'utiliser le bouton "üëÜ exporter.txt üëÜ".</li>
                </ul>`;
            document.getElementById('modal-aide').style.display = 'flex';
        }

        function fermerAide() {
            closeAllModals();
        }

        // ====================== ALERT MANAGEMENT ====================== 
        function showAlert(title, text, onConfirm, showCancel = true) {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertText').innerText = text;

            const prefs = JSON.parse(localStorage.getItem(STORAGE_KEYS.theme)) || {};
            const colorHex = COLOR_MAP[prefs.obs || 'green'] || '#22c55e';

            const confirmBtn = document.getElementById('alertConfirmBtn');
            const cancelBtn = document.getElementById('alertCancelBtn');

            confirmBtn.style.backgroundColor = colorHex;
            cancelBtn.style.display = showCancel ? 'block' : 'none';

            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            newBtn.onclick = () => {
                closeAlert();
                if (onConfirm) onConfirm();
            };

            document.getElementById('alertModal').style.display = 'flex';
        }

        function closeAlert() {
            closeAllModals();
        }

		// ====================== GESTION DES TOUCHES CLAVIER ====================== 
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") {
                if (document.getElementById('modal').style.display === 'flex') {
                    saveData();
                } else {
                    closeAllModals();
                }
            }
        });

        // ====================== INITIALIZATION ====================== 
        window.onload = () => {
            applyTheme();
            renderStudentList();
            checkBadgeStatus();
        };
    </script>
</body>
</html>