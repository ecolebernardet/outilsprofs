<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Observations</title>
    
    <script>
        (function() {
            const mode = localStorage.getItem('theme_mode');
            if (mode === 'light') {
                document.documentElement.classList.add('light-mode-init');
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        :root { 
            --primary: #ff637e; 
            --bg-page: #000000; 
            --text-main: #ffffff;
            --card-student: #374151; 
            --header-bg: #000;
            --header-border: #1f2937;
        }

        /* Mode Clair */
        body.light-mode, html.light-mode-init body {
            --bg-page: #eeeeee;
            --text-main: #111827;
            --card-student: #ffffff;
            --header-bg: #ffffff;
            --header-border: #ddd;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-page); 
            color: var(--text-main); 
            padding: 0; margin: 0; 
            transition: background 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-left: 15px;
            padding-right: 15px;
            padding-bottom: 20px;
        }

        header { 
            background: var(--header-bg); 
            border-bottom: 1px solid var(--header-border);
            position: sticky;
            top: 0; 
            z-index: 100; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(env(safe-area-inset-top) + 10px) 10px 10px 10px; 
            width: calc(100% + 30px); 
            margin-left: -15px;
            margin-bottom: 20px;
        }

        #btn-retour { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; transition: all 0.3s ease; }
        #mainTitle { text-align: center; font-weight: 800; font-size: 1.1rem; letter-spacing: 1px; margin: 0; flex-grow: 1; text-transform: uppercase;}
        .header-spacer { width: 40px; }

        .columns-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 600px; margin: 0 auto; align-items: start; padding: 0 10px; }
        
        .level-group { margin-bottom: 1px; }

        .student-item { 
            background-color: var(--card-student); 
            padding: 6px 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            border-radius: 50px; 
            margin-bottom: 3px; 
            transition: all 0.1s;
            border: 1.5px solid transparent;
        }

        body.light-mode .student-item, html.light-mode-init .student-item {
            border-color: #374151;
        }

        .text-girl { color: #f9a8d4; } 
        .text-boy { color: #93c5fd; } 
        
        body.light-mode .text-girl, html.light-mode-init .text-girl { color: #db2777; } 
        body.light-mode .text-boy, html.light-mode-init .text-boy { color: #2563eb; } 
        
        .student-name { font-weight: 800; font-size: 0.65rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .status-icon { font-size: 0.65rem; opacity: 0.8; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: #1a1a1a; padding: 20px; border-radius: 20px; width: 92%; max-width: 400px; border: 1px solid #333; }
        textarea { width: 100%; margin: 10px 0; padding: 12px; border-radius: 12px; border: 1px solid #333; font-size: 0.8rem; background: #000; color: #fff; outline: none; }
        .btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 14px; border: none; border-radius: 50px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 10px; }
        .btn-save { background: var(--primary); color: white; }
        .btn-cancel { background: #333; color: #ccc; }

        /* Correction lisibilit√© Mode Clair */
        body.light-mode .modal-content { background: #ffffff; border-color: #d1d5db; }
        body.light-mode #modalTitle { color: #111827 !important; }
        body.light-mode textarea { background: #f3f4f6; color: #111827; border-color: #d1d5db; }
        body.light-mode .btn-cancel { background: #e5e7eb; color: #374151; }

        .bottom-nav { width: 100%; max-width: 500px; margin: 25px auto 0; padding-bottom: 40px; }
        .nav-btn { font-weight: 800; border-radius: 50px; font-size: 9px; padding: 12px; border: none; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .no-select { -webkit-tap-highlight-color: transparent; user-select: none; }
    </style>
</head>
<body>

    <header>
        <a href="index.html" id="btn-retour">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="mainTitle">OBSERVATIONS</h1>
        <div class="header-spacer"></div>
    </header>

    <div id="listeContainer" class="columns-container"></div>

    <footer class="bottom-nav flex flex-col gap-3 px-2">
        <div class="flex gap-2">
            <label class="nav-btn bg-neutral-800 text-white cursor-pointer text-center">
                üëáimporter .txtüëá
                <input type="file" id="importFile" class="hidden" accept=".txt">
            </label>
            <button onclick="exportToFile()" class="nav-btn bg-neutral-800 text-white ">üëÜexporter .txtüëÜ</button>
        </div>
        <button onclick="toutEffacer()" class="nav-btn bg-red-500 text-red-100">‚ö†Ô∏è effacer les donn√©es</button>
    </footer>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin:0; font-size: 1.1rem; font-weight: 800; color: white;">√âl√®ve</h2>
            <textarea id="commentInput" rows="8" placeholder="√âcrire une observation..."></textarea>
            <div class="btns">
                <button class="modal-btn btn-cancel" onclick="closeAllModals()">Fermer</button>
                <button class="modal-btn btn-save" onclick="saveData()">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        let elevesInscrits = JSON.parse(localStorage.getItem('maListeEleves')) || [];
        let savedComments = JSON.parse(localStorage.getItem('studentObservations')) || {};
        let currentStudentId = "";

        const ordreNiveaux = ['CP', 'CE1', 'CE2', 'CM1', 'CM2', 'AUTRE'];

        const couleurParNiveau = {
            'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308',
            'CM1': '#ef4444', 'CM2': '#22c55e', 'AUTRE': '#8b5cf6'
        };

        const mapCouleurs = {
            'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
            'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
            'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
            'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
            'rose': '#f43f5e', 'gray': '#6b7280'
        };

        function appliquerTheme() {
            const savedMode = localStorage.getItem('theme_mode');
            const isLight = savedMode === 'light';
            
            if (isLight) {
                document.body.classList.add('light-mode');
            } else {
                document.body.classList.remove('light-mode');
            }

            const prefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
            const nomCouleur = prefs['obs'] || 'green';
            const couleurHexa = mapCouleurs[nomCouleur] || '#22c55e';
            
            const mainTitle = document.getElementById('mainTitle');
            const btnRetour = document.getElementById('btn-retour');
            const svgRetour = document.querySelector('#btn-retour svg');
            const btnSave = document.querySelector('.btn-save');

            if(mainTitle) mainTitle.style.color = isLight ? '#000000' : '#ffffff';

            const isLightColor = ['yellow', 'lime', 'amber', 'cyan'].includes(nomCouleur);

            if(btnRetour) {
                btnRetour.style.backgroundColor = couleurHexa;
                if(svgRetour) svgRetour.style.color = isLightColor ? 'black' : 'white';
            }

            if(btnSave) {
                btnSave.style.backgroundColor = couleurHexa;
                btnSave.style.color = isLightColor ? 'black' : 'white';
            }
            document.documentElement.style.setProperty('--primary', couleurHexa);
        }

        function formatName(str) {
            if(!str) return "";
            const parts = str.trim().split(' ');
            const first = parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase();
            const last = parts.slice(1).join(' ').toUpperCase();
            return (first + ' ' + last).trim();
        }

        function renderList() {
            const container = document.getElementById('listeContainer');
            container.innerHTML = "";
            
            if (elevesInscrits.length === 0) {
                container.innerHTML = `<div class="col-span-2 text-center p-10 text-neutral-500 text-[10px] font-bold uppercase">Aucun √©l√®ve inscrit.</div>`;
                return;
            }

            const groupes = {};
            elevesInscrits.forEach(el => {
                const niv = el.niveau.toUpperCase();
                if (!groupes[niv]) groupes[niv] = [];
                groupes[niv].push(el);
            });

            const niveauxPresents = Object.keys(groupes).sort((a, b) => {
                return ordreNiveaux.indexOf(a) - ordreNiveaux.indexOf(b);
            });

            niveauxPresents.forEach(niv => {
                const levelWrapper = document.createElement('div');
                levelWrapper.className = "level-group";
                const colorTitle = couleurParNiveau[niv] || '#ffffff';
                levelWrapper.innerHTML = `<h2 style="color:${colorTitle}" class="text-[11px] font-black uppercase tracking-widest text-center mb-2">${niv}</h2>`;
                
                const list = document.createElement('div');
                groupes[niv].sort((a,b) => a.identite.localeCompare(b.identite)).forEach(el => {
                    const genderClass = (el.sexe.toLowerCase() === 'f') ? 'text-girl' : 'text-boy';
                    const item = document.createElement('div');
                    item.className = `student-item no-select ${genderClass}`;
                    const hasNote = (savedComments[String(el.id)] || "").trim().length > 0;
                    item.innerHTML = `
                        <span class="student-name">${formatName(el.identite)}</span>
                        <span class="status-icon">${hasNote ? 'üîé' : 'Ôºã'}</span>
                    `;
                    item.onclick = () => openCommentModal(String(el.id), formatName(el.identite));
                    list.appendChild(item);
                });
                levelWrapper.appendChild(list);
                container.appendChild(levelWrapper);
            });
        }

        function openCommentModal(id, nom) {
            currentStudentId = String(id);
            document.getElementById('modalTitle').innerText = nom;
            document.getElementById('commentInput').value = savedComments[currentStudentId] || "";
            document.getElementById('modal').style.display = 'flex';
            setTimeout(() => document.getElementById('commentInput').focus(), 100);
        }

        function closeAllModals() { document.getElementById('modal').style.display = 'none'; }

        function saveData() {
            const val = document.getElementById('commentInput').value;
            if(val.trim() === "") delete savedComments[currentStudentId];
            else savedComments[currentStudentId] = val;
            localStorage.setItem('studentObservations', JSON.stringify(savedComments));
            renderList(); closeAllModals();
        }

        function toutEffacer() {
            if(confirm("Attention : Supprimer tous les √©l√®ves et toutes les observations ?")) {
                localStorage.removeItem('maListeEleves');
                localStorage.removeItem('studentObservations');
                elevesInscrits = [];
                savedComments = {};
                renderList();
            }
        }

        function exportToFile() {
            try {
                const eleves = typeof elevesInscrits !== 'undefined' ? elevesInscrits : [];
                const observations = typeof savedComments !== 'undefined' ? savedComments : {};

                let cleanedComments = {};
                eleves.forEach(s => { 
                    const sId = String(s.id);
                    if(observations[sId] && observations[sId].trim() !== "") {
                        cleanedComments[sId] = observations[sId]; 
                    }
                });

                const dateStr = new Date().toISOString().split('T')[0];
                const fileName = `export_observations_${dateStr}.txt`;
                const bundle = {
                    eleves: eleves,
                    observations: cleanedComments,
                    date: new Date().toLocaleDateString(),
                    type: "export_observations"
                };

                const jsonString = JSON.stringify(bundle, null, 2);

                if (window.Android && window.Android.exportTxt) {
                    window.Android.exportTxt(jsonString, fileName);
                } else {
                    const blob = new Blob([jsonString], { type: 'text/plain;charset=utf-8' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                }
            } catch (err) {
                alert("Erreur technique lors de l'export : " + err.message);
            }
        }

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.eleves && confirm("Importer les donn√©es du fichier ?")) {
                        // Correction : Conversion forc√©e des IDs en String pour l'importation
                        const normalizedEleves = data.eleves.map(el => ({
                            ...el,
                            id: String(el.id)
                        }));
                        
                        let normalizedObs = {};
                        if(data.observations) {
                            Object.keys(data.observations).forEach(key => {
                                normalizedObs[String(key)] = data.observations[key];
                            });
                        }
                        
                        localStorage.setItem('maListeEleves', JSON.stringify(normalizedEleves));
                        localStorage.setItem('studentObservations', JSON.stringify(normalizedObs));
                        window.location.reload();
                    }
                } catch (err) { 
                    alert("Erreur lors de l'import : " + err.message); 
                }
            };
            reader.readAsText(file);
        });

        window.onload = () => {
            appliquerTheme();
            renderList();
        };
    </script>
</body>
</html>