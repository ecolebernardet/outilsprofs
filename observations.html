<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Observations - OutilsProfs</title>
    
    <script>
        (function() {
            const mode = localStorage.getItem('theme_mode');
            if (mode === 'light') {
                document.documentElement.classList.add('light-mode-init');
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root { 
            --primary: #ff637e; 
            --bg-page: #121212; 
            --text-main: #ffffff;
            --card-student: #1a1a1a; 
            --header-bg: #1e1e1e;
            --header-border: rgba(255, 255, 255, 0.1);
            --border-color: rgba(255, 255, 255, 0.1);
            --card-sub: #9ca3af;
            --student-name-girl: #f9a8d4;
            --student-name-boy: #93c5fd;
        }

        body.light-mode, html.light-mode-init body {
            --bg-page: #eeeeee;
            --text-main: #111827;
            --card-student: #ffffff;
            --header-bg: #ffffff;
            --header-border: #ddd;
            --card-sub: #4b5563;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-page); 
            color: var(--text-main); 
            padding: 0; margin: 0; 
            transition: background 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-left: 15px;
            padding-right: 15px;
            padding-bottom: 20px;
            overflow-x: hidden;
        }

        header { 
            background: var(--header-bg); 
            border-bottom: 1px solid var(--header-border);
            position: sticky;
            top: 0; 
            z-index: 100; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: calc(100% + 30px); 
            margin-left: -15px;
            margin-bottom: 20px;
        }

        #btn-retour, #btn-aide { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; transition: all 0.3s ease; }
        #mainTitle { text-align: center; font-weight: 800; font-size: 1.1rem; letter-spacing: 1px; margin: 0; flex-grow: 1; text-transform: uppercase;}

        .columns-container { 
            column-count: 2;
            column-gap: 12px;
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto; 
        }

        .level-group { 
            break-inside: avoid;
            margin-bottom: 20px; 
            display: inline-block;
            width: 100%;
        }

        .student-item { 
            background-color: var(--card-student); 
            padding: 6px 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            border-radius: 50px; 
            margin-bottom: 4px; 
            transition: all 0.1s;
            border: 1.5px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 0;
        }

        body.light-mode .student-item, html.light-mode-init .student-item { border-color: #e5e7eb; }

        .text-girl { color: var(--student-name-girl); } 
        .text-boy { color: var(--student-name-boy); } 
        
        .student-name { 
            font-weight: 800; 
            font-size: 0.65rem; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
            flex: 1; 
            min-width: 0;
        }
        
        .status-icon { 
            font-size: 0.65rem; 
            opacity: 0.8; 
            margin-left: 5px; 
            flex-shrink: 0;
        }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: #1a1a1a; padding: 20px; border-radius: 20px; width: 92%; max-width: 400px; border: 1px solid #333; }
        textarea { width: 100%; margin: 10px 0; padding: 12px; border-radius: 12px; border: 1px solid #333; font-size: 0.85rem; background: #000; color: #fff; outline: none; resize: none; }
        .btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 14px; border: none; border-radius: 50px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 10px; }
        .btn-save { background: var(--primary); color: white; }
        .btn-cancel { background: #333; color: #ccc; }

        #modal-aide .modal-card { background-color: var(--card-student); border: 1px solid var(--header-border); }
        #aide-content h3 { font-weight: 900; text-transform: uppercase; font-size: 0.8rem; margin-bottom: 10px; }
        #aide-content p, #aide-content li { font-size: 0.75rem; line-height: 1.5; color: var(--card-sub); margin-bottom: 8px; }

        body.light-mode .modal-content, body.light-mode #modal-aide .modal-card { background: #ffffff; border-color: #d1d5db; }
        body.light-mode textarea { background: #f3f4f6; color: #111827; border-color: #d1d5db; }

        .alert-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .alert-content { background: white; padding: 25px; border-radius: 24px; width: 100%; max-width: 350px; color: #111; }
        .btn-alert { flex: 1; padding: 14px; border-radius: 15px; font-weight: 900; font-size: 11px; text-transform: uppercase; cursor: pointer; border: none; }

        .bottom-nav { width: 100%; max-width: 500px; margin: 25px auto 0; padding-bottom: 40px; }
        .nav-btn { font-weight: 800; border-radius: 50px; font-size: 9px; padding: 12px; border: none; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .no-select { -webkit-tap-highlight-color: transparent; user-select: none; }
		
		@keyframes blink-point {
			0% { transform: scale(0.9); opacity: 0.5; }
			50% { transform: scale(1.2); opacity: 1; }
			100% { transform: scale(0.9); opacity: 0.5; }
		}
		.mini-pastille {
			display: inline-block;
			width: 8px;
			height: 8px;
			background-color: #f97316;
			border-radius: 50%;
			margin-left: 4px;
			margin-right: 2px;
			box-shadow: 0 0 5px #f97316;
			animation: blink-point 1.5s infinite;
		}
		
    </style>
</head>
<body>

    <header>
        <a href="index.html" id="btn-retour">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="mainTitle">OBSERVATIONS</h1>
        <button id="btn-aide" onclick="ouvrirAide()" style="font-size: 1.2rem;">üí°</button>
    </header>

    <div id="listeContainer" class="columns-container"></div>

    <footer class="bottom-nav flex flex-col gap-3 px-2">
        <div class="flex gap-2">
            <label class="nav-btn bg-neutral-800 text-white cursor-pointer text-center">
                üëáimporter .txtüëá
                <input type="file" id="importFile" class="hidden" accept=".txt">
            </label>
            <button onclick="exportToFile()" class="nav-btn bg-neutral-800 text-white relative">
                üëÜexporter .txtüëÜ
                <span id="badge-export" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-orange-500 rounded-full animate-pulse border-2 border-white"></span>
            </button>
            <button onclick="genererPDF()" class="nav-btn bg-neutral-800 text-white ">üìÑ r√©capitulatif PDF</button>
        </div>
        <button onclick="toutEffacer()" class="nav-btn bg-red-500 text-red-100 shadow-lg">‚ö†Ô∏è effacer les donn√©es</button>
    </footer>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin:0; font-size: 1.1rem; font-weight: 800; color: var(--text-main);">√âl√®ve</h2>
            <textarea id="commentInput" rows="8" placeholder="√âcrire une observation..."></textarea>
            <div class="btns">
                <button class="modal-btn btn-save" onclick="saveData()">Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="modal-aide" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[200] hidden items-center justify-center p-6" onclick="fermerAide()">
        <div class="modal-card w-full max-w-sm rounded-3xl p-6 shadow-2xl" onclick="event.stopPropagation()">
            <div id="aide-content"></div>
            <button onclick="fermerAide()" id="btn-fermer-aide" class="w-full py-4 mt-2 font-black rounded-2xl uppercase text-[10px] tracking-widest active:scale-95 transition-all">
                Fermer
            </button>
        </div>
    </div>

    <div id="alertModal" class="alert-overlay">
        <div class="alert-content">
            <h3 id="alertTitle" class="text-lg font-black uppercase text-center mb-2" style="color:#000">Confirmation</h3>
            <p id="alertText" class="text-sm font-semibold text-center text-gray-600 mb-6">Message</p>
            <div class="alert-btns flex gap-2">
                <button id="alertCancelBtn" class="btn-alert bg-gray-100 text-gray-500" onclick="closeAlert()">Annuler</button>
                <button id="alertConfirmBtn" class="btn-alert text-white">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        let elevesInscrits = JSON.parse(localStorage.getItem('maListeEleves')) || [];
        let savedComments = JSON.parse(localStorage.getItem('studentObservations')) || {};
        let currentStudentId = "";
        let currentStudentName = "";

        const ordreNiveaux = ['CP', 'CE1', 'CE2', 'CM1', 'CM2', 'AUTRE'];
        const couleurParNiveau = { 'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308', 'CM1': '#ef4444', 'CM2': '#22c55e', 'AUTRE': '#8b5cf6' };
        const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e' };

        function updateExportBadge(needsExport) {
            const badge = document.getElementById('badge-export');
            if (needsExport) {
                badge.classList.remove('hidden');
                localStorage.setItem('needsExport_obs', 'true');
            } else {
                badge.classList.add('hidden');
                localStorage.removeItem('needsExport_obs');
                localStorage.setItem('last_export_obs', Date.now());
            }
        }

        function checkBadgeStatus() {
            const lastExport = localStorage.getItem('last_export_obs');
            const needsExport = localStorage.getItem('needsExport_obs') === 'true';
            
            if (needsExport) {
                updateExportBadge(true);
                return;
            }

            if (lastExport) {
                const sevenDaysInMs = 7 * 24 * 60 * 60 * 1000;
                if (Date.now() - parseInt(lastExport) > sevenDaysInMs) {
                    updateExportBadge(true);
                }
            } else {
                localStorage.setItem('last_export_obs', Date.now());
            }
        }

        function appliquerTheme() {
            const savedMode = localStorage.getItem('theme_mode');
            const isLight = savedMode === 'light';
            document.body.classList.toggle('light-mode', isLight);

            const prefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
            const nomCouleur = prefs['obs'] || 'green';
            const couleurHexa = mapCouleurs[nomCouleur] || '#22c55e';
            
            if (prefs.fille && mapCouleurs[prefs.fille]) {
                document.documentElement.style.setProperty('--student-name-girl', mapCouleurs[prefs.fille]);
            }
            if (prefs.garcon && mapCouleurs[prefs.garcon]) {
                document.documentElement.style.setProperty('--student-name-boy', mapCouleurs[prefs.garcon]);
            }

            const mainTitle = document.getElementById('mainTitle');
            const btnRetour = document.getElementById('btn-retour');
            const btnAide = document.getElementById('btn-aide');
            const btnSave = document.querySelector('.btn-save');
            const btnFermerAide = document.getElementById('btn-fermer-aide');

            if(mainTitle) mainTitle.style.color = isLight ? '#000000' : '#ffffff';
            const isLightColor = ['yellow', 'lime', 'amber', 'cyan'].includes(nomCouleur);
            const textColor = isLightColor ? 'black' : 'white';

            [btnRetour, btnAide, btnSave, btnFermerAide].forEach(el => {
                if(el) {
                    el.style.backgroundColor = couleurHexa;
                    el.style.color = textColor;
                    const svg = el.querySelector('svg');
                    if(svg) svg.style.color = textColor;
                }
            });
            document.documentElement.style.setProperty('--primary', couleurHexa);
        }

        function formatName(str) {
            if(!str) return "";
            const parts = str.trim().split(' ');
            const first = parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase();
            const last = parts.slice(1).join(' ').toUpperCase();
            return (first + ' ' + last).trim();
        }

        function renderList() {
            const container = document.getElementById('listeContainer');
            container.innerHTML = "";
            if (elevesInscrits.length === 0) {
                container.innerHTML = `<div class="text-center p-10 text-neutral-500 text-[10px] font-bold uppercase w-full" style="column-span: all;">Aucun √©l√®ve inscrit.</div>`;
                return;
            }
            const groupes = {};
            elevesInscrits.forEach(el => {
                const niv = el.niveau.toUpperCase();
                if (!groupes[niv]) groupes[niv] = [];
                groupes[niv].push(el);
            });
            const niveauxPresents = Object.keys(groupes).sort((a, b) => ordreNiveaux.indexOf(a) - ordreNiveaux.indexOf(b));
            
            if (niveauxPresents.length === 2) {
                container.className = "grid grid-cols-2 gap-3 w-full max-w-[600px] mx-auto";
            } else {
                container.className = "columns-container";
            }

            niveauxPresents.forEach(niv => {
                const levelWrapper = document.createElement('div');
                levelWrapper.className = niveauxPresents.length === 2 ? "w-full" : "level-group";
                
                const colorTitle = couleurParNiveau[niv] || '#ffffff';
                levelWrapper.innerHTML = `<h2 style="color:${colorTitle}" class="text-[11px] font-black uppercase tracking-widest text-center mb-2">${niv}</h2>`;
                const list = document.createElement('div');
                groupes[niv].sort((a,b) => a.identite.localeCompare(b.identite)).forEach(el => {
                    const genderClass = (el.sexe.toLowerCase().startsWith('f')) ? 'text-girl' : 'text-boy';
                    const item = document.createElement('div');
                    item.className = `student-item no-select ${genderClass}`;
                    
                    const noteText = savedComments[el.identite] || "";
                    const hasNote = noteText.trim().length > 0;
                    
                    item.innerHTML = `<span class="student-name">${formatName(el.identite)}</span><span class="status-icon">${hasNote ? 'üîé' : 'Ôºã'}</span>`;
                    item.onclick = () => openCommentModal(el);
                    list.appendChild(item);
                });
                levelWrapper.appendChild(list);
                container.appendChild(levelWrapper);
            });
        }

        function openCommentModal(el) {
            currentStudentId = el.id;
            currentStudentName = el.identite;
            document.getElementById('modalTitle').innerText = formatName(el.identite);
            document.getElementById('commentInput').value = savedComments[el.identite] || "";
            document.getElementById('modal').style.display = 'flex';
            setTimeout(() => document.getElementById('commentInput').focus(), 100);
        }

        function closeAllModals() { 
            // La fermeture ne se fait plus que via saveData()
            document.getElementById('modal').style.display = 'none'; 
        }

        function saveData() {
            const val = document.getElementById('commentInput').value;
            if(val.trim() === "") {
                delete savedComments[currentStudentName];
            } else {
                savedComments[currentStudentName] = val;
            }
            localStorage.setItem('studentObservations', JSON.stringify(savedComments));
            updateExportBadge(true);
            renderList(); 
            closeAllModals(); // Seule mani√®re de fermer la modale
        }

        function toutEffacer() {
            showAlert("Tout effacer ?", "Supprimer toutes les observations ?", () => {
                savedComments = {};
                localStorage.setItem('studentObservations', JSON.stringify(savedComments));
                updateExportBadge(true);
                renderList();
            });
        }
        
        async function genererPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const dateStr = new Date().toLocaleDateString('fr-FR');
            
            if (Object.keys(savedComments).length === 0) {
                showAlert("Vide", "Aucune observation √† inclure dans le PDF.", null, false);
                return;
            }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.text("R√âCAPITULATIF DES OBSERVATIONS", 105, 20, { align: "center" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Document g√©n√©r√© le : ${dateStr}`, 105, 28, { align: "center" });
            doc.line(20, 32, 190, 32);

            let y = 45;
            const margin = 20;
            const pageHeight = 280;

            elevesInscrits.forEach((eleve) => {
                const note = savedComments[eleve.identite];
                
                if (note && note.trim() !== "") {
                    if (y > pageHeight - 20) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(12);
                    doc.text(`${formatName(eleve.identite)} (${eleve.niveau})`, margin, y);
                    y += 7;

                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(10);
                    const splitTitle = doc.splitTextToSize(note, 170);
                    doc.text(splitTitle, margin, y);
                    
                    y += (splitTitle.length * 5) + 10;
                }
            });

            const dateFichier = new Date().toISOString().split('T')[0];
            doc.save(`outilsprofs_recap_observations_${dateFichier}.pdf`);
        }
        
        function exportToFile() {
            if (Object.keys(savedComments).length === 0) {
                showAlert("Vide", "Il n'y a aucune observation √† exporter.", null, false);
                return;
            }

            let contenu = Object.entries(savedComments)
                .map(([nom, obs]) => `${nom};${obs.replace(/\n/g, '[BR]')}`)
                .join("\n");

            const blob = new Blob([contenu], { type: 'text/plain;charset=utf-8' });
            const dateStr = new Date().toISOString().split('T')[0];
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `outilsprofs_observations_${dateStr}.txt`; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            updateExportBadge(false);
        }

        document.getElementById('importFile').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const lignes = event.target.result.split(/\r?\n/);
                    const nouveauxComments = {};
                    
                    lignes.forEach(l => {
                        const parts = l.split(";");
                        if (parts.length >= 2) {
                            const nom = parts[0];
                            const obs = parts.slice(1).join(";").replace(/\[BR\]/g, "\n");
                            nouveauxComments[nom] = obs;
                        }
                    });

                    if (Object.keys(nouveauxComments).length > 0) {
                        showAlert("Importer ?", "Fusionner avec les donn√©es existantes ?", () => {
                            savedComments = { ...savedComments, ...nouveauxComments };
                            localStorage.setItem('studentObservations', JSON.stringify(savedComments));
                            updateExportBadge(false);
                            renderList();
                        });
                    }
                } catch (err) { showAlert("Erreur", "Fichier invalide.", null, false); }
            };
            if(e.target.files[0]) reader.readAsText(e.target.files[0]);
            this.value = "";
        });

        function ouvrirAide() {
            const display = document.getElementById('aide-content');
            const prefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
            const couleurObs = mapCouleurs[prefs.obs] || '#22c55e';
            display.innerHTML = `
                <h3 style="color:${couleurObs}">üí° Observations</h3>
                <p>G√©rez ici les remarques li√©es √† vos √©l√®ves.</p>
                <ul class="space-y-2">
                    <li>‚Ä¢ <strong>Icone üîé :</strong> Indique qu'une note est enregistr√©e.</li>
                    <li>‚Ä¢ <strong>Icone Ôºã :</strong> Aucune note pour cet √©l√®ve.</li>
                    <li>‚Ä¢ <strong>Portabilit√© :</strong> L'export et l'import se basent sur le NOM et le PR√âNOM. Vous pouvez transf√©rer vos notes d'un appareil √† l'autre sans probl√®me.</li>
					<li><strong>Pastille <span class="mini-pastille"></span> :</strong> Si elle appara√Æt sur le bouton export, cela signifie que vos donn√©es locales ne sont pas synchronis√©es avec votre dernier fichier de sauvegarde. Il est alors temps d'utiliser le bouton "üëÜ exporter.txt üëÜ".</li>
                 </ul>`;
            document.getElementById('modal-aide').style.display = 'flex';
        }
        function fermerAide() { document.getElementById('modal-aide').style.display = 'none'; }

        function showAlert(title, text, onConfirm, showCancel = true) {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertText').innerText = text;
            const confirmBtn = document.getElementById('alertConfirmBtn');
            const cancelBtn = document.getElementById('alertCancelBtn');
            const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
            const colorHex = mapCouleurs[themePrefs.obs || 'green'] || '#22c55e';
            confirmBtn.style.backgroundColor = colorHex;
            cancelBtn.style.display = showCancel ? 'block' : 'none';
            const newBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
            newBtn.onclick = () => { closeAlert(); if(onConfirm) onConfirm(); };
            document.getElementById('alertModal').style.display = 'flex';
        }
        function closeAlert() { document.getElementById('alertModal').style.display = 'none'; }

        window.onload = () => { 
            appliquerTheme(); 
            renderList(); 
            checkBadgeStatus();
        };
        
        // Suppression du window.onclick global pour emp√™cher la fermeture au clic ext√©rieur
    </script>
</body>
</html>