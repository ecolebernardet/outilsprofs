<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pixel Art - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        /* ===== VARIABLES CSS ===== */
        :root {
            --bg-page: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1);
            --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
            --accent-color: #06b6d4;
        }

        body.light-mode {
            --bg-page: #eeeeee;
            --card-bg: #ffffff;
            --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1);
            --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* ===== BASE ===== */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            transition: background 0.3s ease;
            touch-action: manipulation;
        }
        
        /* ===== HEADER ===== */
        header { 
            background: var(--card-bg);
            border-bottom: 1px solid var(--column-border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px;
            width: 100%;
            margin-bottom: 12px;
        }

        header h1 {
            font-size: 1.125rem;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            flex-grow: 1;
        }

        /* ===== BOUTONS ===== */
        .ui-btn-round {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }

        .btn-add {
            width: 100%;
            padding: 14px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 12px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-add:active {
            transform: scale(0.95);
        }

        /* ===== LAYOUT ===== */
        .main-wrapper {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 10px 15px 40px;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .main-container {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        /* ===== CANVAS PIXEL ===== */
        #pixel-canvas {
            display: grid;
            background: white;
            border: 2px solid var(--column-border);
            margin: 0 auto;
            cursor: crosshair;
            user-select: none;
            box-shadow: var(--shadow-custom);
            touch-action: none;
        }

        .pixel {
            border: 1px solid rgba(0, 0, 0, 0.05);
            aspect-ratio: 1/1;
        }

        /* ===== CONTROLS ===== */
        .controls {
            flex: 1;
            background: var(--card-bg);
            border-radius: 1.5rem;
            padding: 20px;
            border: 1px solid var(--column-border);
            box-shadow: var(--shadow-custom);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            opacity: 0.6;
            margin-bottom: 5px;
            text-align: center;
        }
        
        select {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--column-border);
            color: inherit;
            padding: 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            outline: none;
        }

        /* ===== PALETTE ===== */
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.1s;
        }

        .color-swatch.active {
            border-color: var(--text-main);
            transform: scale(1.15);
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 1.5rem;
            border: 1px solid var(--column-border);
            padding: 25px;
            position: relative;
        }
    </style>
</head>
<body>

<script>
    if (localStorage.getItem('theme_mode') === 'light') {
        document.body.classList.add('light-mode');
    }
</script>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1>Pixel Art</h1>
    <button id="btn-aide" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div class="mb-4">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux g√©n√©rateurs
        </a>
    </div>

    <div class="main-container">
        <div class="flex-1 flex justify-center">
            <div id="pixel-canvas"></div>
        </div>

        <aside class="controls">
            <div class="input-group">
                <label>Mod√®les rapides</label>
                <select id="select-modele">
                    <option value="">-- Nouveau dessin --</option>
                    <option value="coeur">‚ù§Ô∏è C≈ìur</option>
                    <option value="smiley">üòä Smiley</option>
                    <option value="mario">üçÑ Mario</option>
                    <option value="paysage">üèîÔ∏è Paysage</option>
                    <option value="arcenciel">üåàÔ∏è Arc-en-ciel</option>
                    <option value="papillon">ü¶ãÔ∏è Papillon</option>
                </select>
            </div>

            <div class="input-group">
                <label>Taille de la grille</label>
                <div class="flex gap-2">
                    <div class="flex items-center bg-[var(--input-bg)] border border-[var(--column-border)] rounded-xl overflow-hidden flex-1">
                        <button id="btn-decrease-size" class="w-10 h-10 flex items-center justify-center font-black text-lg hover:bg-black/10 active:bg-black/20">-</button>
                        <div id="grid-size-display" class="flex-1 text-center font-bold text-sm">15</div>
                        <button id="btn-increase-size" class="w-10 h-10 flex items-center justify-center font-black text-lg hover:bg-black/10 active:bg-black/20">+</button>
                    </div>
                    <button id="btn-clear" class="bg-red-500/20 text-red-500 px-3 rounded-xl text-[10px] font-black uppercase">Vider</button>
                </div>
                <input type="hidden" id="grid-size" value="15">
            </div>

            <div class="flex items-center justify-center gap-4 mb-4">
                <div class="flex flex-col items-center gap-1">
                    <span class="text-[8px] font-black uppercase opacity-40 tracking-tighter">Gommer</span>
                    <button id="btn-gomme" class="w-10 h-10 rounded-xl border-2 border-dashed border-white/20 flex items-center justify-center text-xl bg-white/5 transition-all active:scale-90">üßº</button>
                </div>
            </div>

            <label class="block text-[10px] font-black uppercase opacity-50 mb-3 tracking-widest text-center">Palette</label>
            <div class="color-palette" id="palette"></div>

            <button id="btn-pdf" class="btn-add">G√©n√©rer Fiche PDF</button>
        </aside>
    </div>
</div>

<!-- Modal Aide -->
<div id="modal-aide" class="modal-overlay">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide" class="text-lg font-black uppercase mb-4 text-center">üí° Aide Pixel Art</h2>
        <div class="text-[11px] leading-relaxed space-y-3 opacity-80 font-semibold">
            <p>1. S√©lectionnez une couleur dans la palette.</p>
            <p>2. Cliquez ou glissez sur la grille pour dessiner. Sur tablette, touchez simplement les cases.</p>
            <p>3. Utilisez l'outil üßº Gomme pour effacer une case.</p>
            <p>4. <b>Export PDF :</b> G√©n√®re une fiche avec le mod√®le en haut et une grille vide en bas pour vos √©l√®ves.</p>
        </div>
        <button id="btn-fermer-aide" class="btn-add mt-6">Fermer</button>
    </div>
</div>

<!-- Modal Confirmation -->
<div id="modal-confirm" class="modal-overlay">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="text-lg font-black uppercase mb-4 text-center" style="color: var(--accent-color)">‚ö†Ô∏è Tout effacer ?</h2>
        <p class="text-[11px] leading-relaxed opacity-80 font-semibold text-center mb-6">
            √ätes-vous s√ªr de vouloir vider toute la grille ? Cette action est irr√©versible.
        </p>
        <div class="flex gap-3">
            <button id="btn-cancel-clear" class="btn-add bg-gray-500/20 !text-current">Annuler</button>
            <button id="btn-confirm-clear" class="btn-add !bg-red-500 !text-white">Effacer</button>
        </div>
    </div>
</div>

<!-- Modal Alerte Taille -->
<div id="modal-alerte-taille" class="modal-overlay">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="text-lg font-black uppercase mb-4 text-center" style="color: var(--accent-color)">Grille non vide</h2>
        <p class="text-[11px] leading-relaxed opacity-80 font-semibold text-center mb-6">
            Vous devez vider la grille avant de pouvoir changer sa taille afin de ne pas perdre votre dessin.
        </p>
        <button id="btn-fermer-alerte" class="btn-add !bg-red-500 !text-white">D'accord</button>
    </div>
</div>

<script>
    // ===== CONFIGURATION =====
    const CONFIG = {
        defaultSize: 15,
        minSize: 5,
        maxSize: 30,
        maxCanvasSize: 400,
        colors: ['#000000', '#ffffff', '#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899', '#78350f'],
        storageKeys: {
            drawing: 'pixelArt_save',
            theme: 'theme_mode',
            themeTiles: 'theme_tuiles'
        }
    };

    const MODELES = {
        coeur: { size: 16, data: {"35":"#ef4444","36":"#ef4444","37":"#ef4444","38":"#ef4444","41":"#ef4444","42":"#ef4444","43":"#ef4444","44":"#ef4444","50":"#ef4444","51":"#ef4444","52":"#ef4444","53":"#ef4444","54":"#ef4444","55":"#ef4444","56":"#ef4444","57":"#ef4444","58":"#ef4444","59":"#ef4444","60":"#ef4444","61":"#ef4444","65":"#ef4444","66":"#ef4444","68":"#ef4444","69":"#ef4444","70":"#ef4444","71":"#ef4444","72":"#ef4444","73":"#ef4444","74":"#ef4444","75":"#ef4444","76":"#ef4444","77":"#ef4444","78":"#ef4444","81":"#ef4444","83":"#ef4444","84":"#ef4444","85":"#ef4444","86":"#ef4444","87":"#ef4444","88":"#ef4444","89":"#ef4444","90":"#ef4444","91":"#ef4444","92":"#ef4444","93":"#ef4444","94":"#ef4444","97":"#ef4444","99":"#ef4444","100":"#ef4444","101":"#ef4444","102":"#ef4444","103":"#ef4444","104":"#ef4444","105":"#ef4444","106":"#ef4444","107":"#ef4444","108":"#ef4444","109":"#ef4444","110":"#ef4444","113":"#ef4444","114":"#ef4444","116":"#ef4444","117":"#ef4444","118":"#ef4444","119":"#ef4444","120":"#ef4444","121":"#ef4444","122":"#ef4444","123":"#ef4444","124":"#ef4444","125":"#ef4444","126":"#ef4444","130":"#ef4444","131":"#ef4444","132":"#ef4444","133":"#ef4444","134":"#ef4444","135":"#ef4444","136":"#ef4444","137":"#ef4444","138":"#ef4444","139":"#ef4444","140":"#ef4444","141":"#ef4444","147":"#ef4444","148":"#ef4444","149":"#ef4444","150":"#ef4444","151":"#ef4444","152":"#ef4444","153":"#ef4444","154":"#ef4444","155":"#ef4444","156":"#ef4444","164":"#ef4444","165":"#ef4444","166":"#ef4444","167":"#ef4444","168":"#ef4444","169":"#ef4444","170":"#ef4444","171":"#ef4444","181":"#ef4444","182":"#ef4444","183":"#ef4444","184":"#ef4444","185":"#ef4444","186":"#ef4444","198":"#ef4444","199":"#ef4444","200":"#ef4444","201":"#ef4444","215":"#ef4444","216":"#ef4444"} },
        mario: { size: 16, data: {"6":"#ef4444","7":"#ef4444","8":"#ef4444","9":"#ef4444","10":"#ef4444","21":"#ef4444","22":"#ef4444","23":"#ef4444","24":"#ef4444","25":"#ef4444","26":"#ef4444","27":"#ef4444","28":"#ef4444","37":"#78350f","38":"#78350f","39":"#78350f","40":"#eab308","41":"#000000","42":"#eab308","52":"#78350f","53":"#eab308","54":"#78350f","55":"#eab308","56":"#eab308","57":"#eab308","58":"#eab308","59":"#eab308","60":"#eab308","68":"#78350f","69":"#eab308","70":"#78350f","71":"#78350f","72":"#eab308","73":"#eab308","74":"#78350f","75":"#eab308","76":"#eab308","77":"#eab308","84":"#78350f","85":"#78350f","86":"#eab308","87":"#eab308","88":"#eab308","89":"#78350f","90":"#78350f","91":"#78350f","92":"#78350f","102":"#eab308","103":"#eab308","104":"#eab308","105":"#eab308","106":"#eab308","117":"#ef4444","118":"#ef4444","119":"#3b82f6","120":"#ef4444","121":"#3b82f6","122":"#ef4444","123":"#ef4444","132":"#ef4444","133":"#ef4444","134":"#ef4444","135":"#3b82f6","136":"#ef4444","137":"#3b82f6","138":"#ef4444","139":"#ef4444","140":"#ef4444","147":"#ef4444","148":"#ef4444","149":"#ef4444","150":"#ef4444","151":"#eab308","152":"#3b82f6","153":"#eab308","154":"#ef4444","155":"#ef4444","156":"#ef4444","157":"#ef4444","163":"#eab308","164":"#eab308","165":"#ef4444","166":"#3b82f6","167":"#3b82f6","168":"#3b82f6","169":"#3b82f6","170":"#3b82f6","171":"#ef4444","172":"#eab308","173":"#eab308","179":"#eab308","180":"#eab308","181":"#eab308","182":"#3b82f6","183":"#3b82f6","184":"#3b82f6","185":"#3b82f6","186":"#3b82f6","187":"#eab308","188":"#eab308","189":"#eab308","195":"#eab308","196":"#eab308","197":"#3b82f6","198":"#3b82f6","199":"#3b82f6","200":"#3b82f6","201":"#3b82f6","202":"#3b82f6","203":"#3b82f6","204":"#eab308","205":"#eab308","213":"#3b82f6","214":"#3b82f6","215":"#3b82f6","217":"#3b82f6","218":"#3b82f6","219":"#3b82f6","229":"#78350f","230":"#78350f","234":"#78350f","235":"#78350f","244":"#78350f","245":"#78350f","246":"#78350f","250":"#78350f","251":"#78350f","252":"#78350f"} },
        smiley: { size: 16, data: {"21":"#eab308","22":"#eab308","23":"#eab308","24":"#eab308","25":"#eab308","26":"#eab308","36":"#eab308","37":"#eab308","38":"#eab308","39":"#eab308","40":"#eab308","41":"#eab308","42":"#eab308","43":"#eab308","51":"#eab308","52":"#eab308","53":"#eab308","54":"#eab308","55":"#eab308","56":"#eab308","57":"#eab308","58":"#eab308","59":"#eab308","60":"#eab308","66":"#eab308","67":"#eab308","68":"#eab308","69":"#eab308","70":"#eab308","71":"#eab308","72":"#eab308","73":"#eab308","74":"#eab308","75":"#eab308","76":"#eab308","77":"#eab308","81":"#eab308","82":"#eab308","83":"#eab308","84":"#000000","85":"#000000","86":"#eab308","87":"#eab308","88":"#eab308","89":"#eab308","90":"#000000","91":"#000000","92":"#eab308","93":"#eab308","94":"#eab308","97":"#eab308","98":"#eab308","99":"#eab308","100":"#000000","101":"#000000","102":"#eab308","103":"#eab308","104":"#eab308","105":"#eab308","106":"#000000","107":"#000000","108":"#eab308","109":"#eab308","110":"#eab308","113":"#eab308","114":"#eab308","115":"#eab308","116":"#eab308","117":"#eab308","118":"#eab308","119":"#eab308","120":"#eab308","121":"#eab308","122":"#eab308","123":"#eab308","124":"#eab308","125":"#eab308","126":"#eab308","129":"#eab308","130":"#eab308","131":"#eab308","132":"#eab308","133":"#eab308","134":"#eab308","135":"#eab308","136":"#eab308","137":"#eab308","138":"#eab308","139":"#eab308","140":"#eab308","141":"#eab308","142":"#eab308","145":"#eab308","146":"#eab308","147":"#eab308","148":"#eab308","149":"#eab308","150":"#eab308","151":"#eab308","152":"#eab308","153":"#eab308","154":"#eab308","155":"#eab308","156":"#eab308","157":"#eab308","158":"#eab308","161":"#eab308","162":"#eab308","163":"#eab308","164":"#000000","165":"#eab308","166":"#eab308","167":"#eab308","168":"#eab308","169":"#eab308","170":"#eab308","171":"#000000","172":"#eab308","173":"#eab308","174":"#eab308","178":"#eab308","179":"#eab308","180":"#eab308","181":"#000000","182":"#eab308","183":"#eab308","184":"#eab308","185":"#eab308","186":"#000000","187":"#eab308","188":"#eab308","189":"#eab308","195":"#eab308","196":"#eab308","197":"#eab308","198":"#000000","199":"#000000","200":"#000000","201":"#000000","202":"#eab308","203":"#eab308","204":"#eab308","212":"#eab308","213":"#eab308","214":"#eab308","215":"#eab308","216":"#eab308","217":"#eab308","218":"#eab308","219":"#eab308","229":"#eab308","230":"#eab308","231":"#eab308","232":"#eab308","233":"#eab308","234":"#eab308"} },
        paysage: { size: 16, data: {"0":"#3b82f6","1":"#3b82f6","2":"#3b82f6","3":"#3b82f6","4":"#3b82f6","5":"#3b82f6","6":"#3b82f6","7":"#3b82f6","8":"#3b82f6","9":"#3b82f6","10":"#3b82f6","11":"#3b82f6","12":"#3b82f6","13":"#eab308","14":"#eab308","15":"#eab308","16":"#3b82f6","17":"#3b82f6","18":"#3b82f6","19":"#3b82f6","20":"#3b82f6","21":"#3b82f6","22":"#3b82f6","23":"#3b82f6","24":"#3b82f6","25":"#3b82f6","26":"#3b82f6","27":"#3b82f6","28":"#3b82f6","29":"#eab308","30":"#eab308","31":"#eab308","32":"#3b82f6","33":"#3b82f6","34":"#3b82f6","35":"#3b82f6","36":"#3b82f6","37":"#3b82f6","38":"#3b82f6","39":"#3b82f6","40":"#3b82f6","41":"#3b82f6","42":"#3b82f6","43":"#3b82f6","44":"#3b82f6","45":"#3b82f6","46":"#eab308","47":"#eab308","48":"#3b82f6","49":"#3b82f6","50":"#3b82f6","53":"#3b82f6","54":"#3b82f6","55":"#3b82f6","56":"#3b82f6","57":"#3b82f6","58":"#3b82f6","59":"#3b82f6","60":"#3b82f6","61":"#3b82f6","62":"#3b82f6","63":"#3b82f6","64":"#3b82f6","65":"#3b82f6","66":"#000000","67":"#78350f","68":"#78350f","70":"#3b82f6","71":"#3b82f6","72":"#3b82f6","73":"#3b82f6","74":"#3b82f6","77":"#3b82f6","78":"#3b82f6","79":"#3b82f6","80":"#3b82f6","81":"#000000","82":"#78350f","83":"#78350f","84":"#78350f","85":"#78350f","86":"#78350f","87":"#3b82f6","88":"#3b82f6","89":"#000000","90":"#000000","91":"#78350f","92":"#78350f","94":"#3b82f6","95":"#3b82f6","96":"#000000","97":"#78350f","98":"#78350f","99":"#78350f","100":"#78350f","101":"#78350f","102":"#78350f","103":"#78350f","104":"#000000","105":"#78350f","106":"#78350f","107":"#78350f","108":"#78350f","109":"#78350f","110":"#78350f","111":"#3b82f6","112":"#78350f","113":"#78350f","114":"#78350f","115":"#78350f","116":"#ef4444","117":"#78350f","118":"#78350f","119":"#000000","120":"#78350f","121":"#78350f","122":"#78350f","123":"#78350f","124":"#78350f","125":"#78350f","126":"#78350f","127":"#78350f","128":"#78350f","129":"#78350f","130":"#78350f","131":"#ef4444","132":"#ef4444","133":"#ef4444","134":"#78350f","135":"#78350f","136":"#78350f","137":"#78350f","138":"#78350f","139":"#78350f","140":"#78350f","141":"#78350f","142":"#78350f","143":"#78350f","144":"#78350f","145":"#78350f","146":"#ef4444","147":"#ef4444","148":"#ef4444","149":"#ef4444","150":"#ef4444","151":"#78350f","152":"#78350f","153":"#78350f","154":"#78350f","155":"#78350f","156":"#78350f","157":"#78350f","158":"#78350f","159":"#78350f","160":"#22c55e","161":"#22c55e","162":"#f97316","163":"#f97316","164":"#f97316","165":"#f97316","166":"#f97316","167":"#22c55e","168":"#22c55e","169":"#22c55e","170":"#22c55e","171":"#22c55e","172":"#22c55e","173":"#22c55e","174":"#22c55e","175":"#22c55e","176":"#22c55e","177":"#22c55e","178":"#f97316","179":"#ef4444","180":"#f97316","181":"#ef4444","182":"#f97316","183":"#22c55e","184":"#eab308","185":"#22c55e","186":"#22c55e","187":"#22c55e","188":"#22c55e","189":"#ec4899","190":"#22c55e","191":"#22c55e","192":"#22c55e","193":"#22c55e","194":"#f97316","195":"#f97316","196":"#f97316","197":"#f97316","198":"#f97316","199":"#22c55e","200":"#22c55e","201":"#22c55e","202":"#22c55e","203":"#eab308","204":"#22c55e","205":"#22c55e","206":"#22c55e","207":"#22c55e","208":"#22c55e","209":"#22c55e","210":"#f97316","211":"#f97316","212":"#ef4444","213":"#ef4444","214":"#f97316","215":"#22c55e","216":"#22c55e","217":"#ec4899","218":"#22c55e","219":"#22c55e","220":"#22c55e","221":"#22c55e","222":"#22c55e","223":"#22c55e","224":"#22c55e","225":"#22c55e","226":"#f97316","227":"#f97316","228":"#ef4444","229":"#ef4444","230":"#f97316","231":"#22c55e","232":"#22c55e","233":"#22c55e","234":"#22c55e","235":"#22c55e","236":"#22c55e","237":"#22c55e","238":"#ec4899","239":"#22c55e","240":"#22c55e","241":"#22c55e","242":"#22c55e","243":"#22c55e","244":"#22c55e","245":"#22c55e","246":"#22c55e","247":"#22c55e","248":"#22c55e","249":"#eab308","250":"#22c55e","251":"#22c55e","252":"#22c55e","253":"#22c55e","254":"#22c55e","255":"#22c55e"} },
        arcenciel: { size: 15, data: {"20":"#ef4444","21":"#ef4444","22":"#ef4444","23":"#ef4444","24":"#ef4444","34":"#ef4444","35":"#f97316","36":"#f97316","37":"#f97316","38":"#f97316","39":"#f97316","40":"#ef4444","48":"#ef4444","49":"#f97316","50":"#eab308","51":"#eab308","52":"#eab308","53":"#eab308","54":"#eab308","55":"#f97316","56":"#ef4444","62":"#ef4444","63":"#f97316","64":"#eab308","65":"#22c55e","66":"#22c55e","67":"#22c55e","68":"#22c55e","69":"#22c55e","70":"#eab308","71":"#f97316","72":"#ef4444","77":"#ef4444","78":"#f97316","79":"#eab308","80":"#22c55e","81":"#3b82f6","82":"#3b82f6","83":"#3b82f6","84":"#22c55e","85":"#eab308","86":"#f97316","87":"#ef4444","91":"#ef4444","92":"#f97316","93":"#eab308","94":"#22c55e","95":"#3b82f6","96":"#8b5cf6","97":"#8b5cf6","98":"#8b5cf6","99":"#3b82f6","100":"#22c55e","101":"#eab308","102":"#f97316","103":"#ef4444","106":"#ef4444","107":"#f97316","108":"#eab308","109":"#22c55e","110":"#3b82f6","111":"#8b5cf6","113":"#8b5cf6","114":"#3b82f6","115":"#22c55e","116":"#eab308","117":"#f97316","118":"#ef4444","121":"#ef4444","122":"#f97316","123":"#eab308","124":"#22c55e","125":"#3b82f6","126":"#8b5cf6","128":"#8b5cf6","129":"#3b82f6","130":"#22c55e","131":"#eab308","132":"#f97316","133":"#ef4444","135":"#ef4444","136":"#f97316","137":"#eab308","138":"#22c55e","139":"#3b82f6","140":"#8b5cf6","144":"#8b5cf6","145":"#3b82f6","146":"#22c55e","147":"#eab308","148":"#f97316","149":"#ef4444","150":"#ef4444","151":"#f97316","152":"#eab308","153":"#22c55e","154":"#3b82f6","155":"#8b5cf6","159":"#8b5cf6","160":"#3b82f6","161":"#22c55e","162":"#eab308","163":"#f97316","164":"#ef4444","165":"#ef4444","166":"#f97316","167":"#eab308","168":"#22c55e","169":"#3b82f6","170":"#8b5cf6","174":"#8b5cf6","175":"#3b82f6","176":"#22c55e","177":"#eab308","178":"#f97316","179":"#ef4444"} },
        papillon: { size: 15, data: {"0":"#22c55e","1":"#22c55e","2":"#22c55e","3":"#22c55e","4":"#22c55e","5":"#22c55e","6":"#22c55e","7":"#22c55e","8":"#22c55e","9":"#22c55e","10":"#22c55e","11":"#22c55e","12":"#22c55e","13":"#22c55e","14":"#22c55e","15":"#22c55e","16":"#22c55e","17":"#22c55e","18":"#3b82f6","19":"#3b82f6","20":"#3b82f6","21":"#22c55e","22":"#22c55e","23":"#22c55e","24":"#3b82f6","25":"#3b82f6","26":"#3b82f6","27":"#22c55e","28":"#22c55e","29":"#22c55e","30":"#22c55e","31":"#22c55e","32":"#3b82f6","33":"#eab308","34":"#eab308","35":"#eab308","36":"#3b82f6","37":"#22c55e","38":"#3b82f6","39":"#eab308","40":"#eab308","41":"#eab308","42":"#3b82f6","43":"#22c55e","44":"#22c55e","45":"#22c55e","46":"#3b82f6","47":"#eab308","48":"#eab308","49":"#eab308","50":"#eab308","51":"#3b82f6","52":"#000000","53":"#3b82f6","54":"#eab308","55":"#eab308","56":"#eab308","57":"#eab308","58":"#3b82f6","59":"#22c55e","60":"#22c55e","61":"#3b82f6","62":"#eab308","63":"#8b5cf6","64":"#8b5cf6","65":"#eab308","66":"#3b82f6","67":"#000000","68":"#3b82f6","69":"#eab308","70":"#8b5cf6","71":"#8b5cf6","72":"#eab308","73":"#3b82f6","74":"#22c55e","75":"#22c55e","76":"#3b82f6","77":"#eab308","78":"#8b5cf6","79":"#ec4899","80":"#8b5cf6","81":"#eab308","82":"#000000","83":"#eab308","84":"#8b5cf6","85":"#ec4899","86":"#8b5cf6","87":"#eab308","88":"#3b82f6","89":"#22c55e","90":"#22c55e","91":"#3b82f6","92":"#eab308","93":"#eab308","94":"#8b5cf6","95":"#8b5cf6","96":"#eab308","97":"#000000","98":"#eab308","99":"#8b5cf6","100":"#8b5cf6","101":"#eab308","102":"#eab308","103":"#3b82f6","104":"#22c55e","105":"#22c55e","106":"#3b82f6","107":"#eab308","108":"#eab308","109":"#eab308","110":"#eab308","111":"#eab308","112":"#000000","113":"#eab308","114":"#eab308","115":"#eab308","116":"#eab308","117":"#eab308","118":"#3b82f6","119":"#22c55e","120":"#22c55e","121":"#22c55e","122":"#3b82f6","123":"#eab308","124":"#eab308","125":"#eab308","126":"#3b82f6","127":"#000000","128":"#3b82f6","129":"#eab308","130":"#eab308","131":"#eab308","132":"#3b82f6","133":"#22c55e","134":"#22c55e","135":"#22c55e","136":"#22c55e","137":"#22c55e","138":"#3b82f6","139":"#3b82f6","140":"#3b82f6","141":"#3b82f6","142":"#000000","143":"#3b82f6","144":"#3b82f6","145":"#3b82f6","146":"#3b82f6","147":"#22c55e","148":"#22c55e","149":"#22c55e","150":"#22c55e","151":"#22c55e","152":"#3b82f6","153":"#ec4899","154":"#ec4899","155":"#ec4899","156":"#3b82f6","157":"#000000","158":"#3b82f6","159":"#ec4899","160":"#ec4899","161":"#ec4899","162":"#3b82f6","163":"#22c55e","164":"#22c55e","165":"#22c55e","166":"#22c55e","167":"#3b82f6","168":"#ec4899","169":"#8b5cf6","170":"#ec4899","171":"#3b82f6","172":"#000000","173":"#3b82f6","174":"#ec4899","175":"#8b5cf6","176":"#ec4899","177":"#3b82f6","178":"#22c55e","179":"#22c55e","180":"#22c55e","181":"#22c55e","182":"#3b82f6","183":"#ec4899","184":"#ec4899","185":"#3b82f6","186":"#3b82f6","187":"#22c55e","188":"#3b82f6","189":"#3b82f6","190":"#ec4899","191":"#ec4899","192":"#3b82f6","193":"#22c55e","194":"#22c55e","195":"#22c55e","196":"#22c55e","197":"#22c55e","198":"#3b82f6","199":"#3b82f6","200":"#3b82f6","201":"#22c55e","202":"#22c55e","203":"#22c55e","204":"#3b82f6","205":"#3b82f6","206":"#3b82f6","207":"#22c55e","208":"#22c55e","209":"#22c55e","210":"#22c55e","211":"#22c55e","212":"#22c55e","213":"#22c55e","214":"#22c55e","215":"#22c55e","216":"#22c55e","217":"#22c55e","218":"#22c55e","219":"#22c55e","220":"#22c55e","221":"#22c55e","222":"#22c55e","223":"#22c55e","224":"#22c55e"} }
    };

    // ===== STATE =====
    let currentColor = CONFIG.colors[0];
    let isDrawing = false;

    // ===== DOM ELEMENTS =====
    const elements = {
        canvas: document.getElementById('pixel-canvas'),
        palette: document.getElementById('palette'),
        gridSizeInput: document.getElementById('grid-size'),
        gridSizeDisplay: document.getElementById('grid-size-display'),
        selectModele: document.getElementById('select-modele'),
        btnGomme: document.getElementById('btn-gomme'),
        btnClear: document.getElementById('btn-clear'),
        btnIncreaseSize: document.getElementById('btn-increase-size'),
        btnDecreaseSize: document.getElementById('btn-decrease-size'),
        btnPdf: document.getElementById('btn-pdf'),
        btnAide: document.getElementById('btn-aide'),
        btnFermerAide: document.getElementById('btn-fermer-aide'),
        btnCancelClear: document.getElementById('btn-cancel-clear'),
        btnConfirmClear: document.getElementById('btn-confirm-clear'),
        btnFermerAlerte: document.getElementById('btn-fermer-alerte'),
        modalAide: document.getElementById('modal-aide'),
        modalConfirm: document.getElementById('modal-confirm'),
        modalAlerteTaille: document.getElementById('modal-alerte-taille')
    };

    // ===== UTILITY FUNCTIONS =====
    function isPixelWhite(pixel) {
        const bg = pixel.style.backgroundColor;
        return bg === 'rgb(255, 255, 255)' || bg === '#ffffff' || bg === '';
    }

    function isGridEmpty() {
        const pixels = document.querySelectorAll('.pixel');
        return Array.from(pixels).every(isPixelWhite);
    }

    function getCurrentDate() {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    // ===== MODAL FUNCTIONS =====
    function openModal(modal) {
        modal.style.display = 'flex';
    }

    function closeModal(modal) {
        modal.style.display = 'none';
    }

    // ===== STORAGE FUNCTIONS =====
    function saveDrawing() {
        const pixels = document.querySelectorAll('.pixel');
        const data = {};
        
        pixels.forEach((pixel, index) => {
            if (!isPixelWhite(pixel)) {
                data[index] = pixel.style.backgroundColor;
            }
        });

        localStorage.setItem(CONFIG.storageKeys.drawing, JSON.stringify({
            size: elements.gridSizeInput.value,
            data: data
        }));
    }

    function loadDrawing() {
        try {
            return JSON.parse(localStorage.getItem(CONFIG.storageKeys.drawing) || '{}');
        } catch {
            return {};
        }
    }

    function clearDrawing() {
        localStorage.removeItem(CONFIG.storageKeys.drawing);
    }

    // ===== PALETTE FUNCTIONS =====
    function initPalette() {
        elements.palette.innerHTML = '';
        
        CONFIG.colors.forEach(color => {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch';
            swatch.style.backgroundColor = color;
            
            if (color === '#ffffff') {
                swatch.style.border = '1px solid #ddd';
            }
            
            swatch.onclick = () => selectColor(color, swatch);
            elements.palette.appendChild(swatch);
        });
        
        elements.palette.firstChild.classList.add('active');
    }

    function selectColor(color, swatch) {
        resetEraserButton();
        document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
        swatch.classList.add('active');
        currentColor = color;
    }

    function resetEraserButton() {
        elements.btnGomme.style.borderColor = 'rgba(255,255,255,0.2)';
        elements.btnGomme.style.backgroundColor = 'rgba(255,255,255,0.05)';
    }

    function activateEraser() {
        currentColor = '#ffffff';
        document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
        elements.btnGomme.style.borderColor = 'var(--accent-color)';
        elements.btnGomme.style.backgroundColor = 'rgba(255,255,255,0.2)';
    }

    // ===== GRID FUNCTIONS =====
    function initGrid() {
        const saved = loadDrawing();
        const size = saved.size ? parseInt(saved.size) : parseInt(elements.gridSizeInput.value);
        
        elements.gridSizeInput.value = size;
        elements.gridSizeDisplay.innerText = size;

        const canvasSize = Math.min(window.innerWidth - 50, CONFIG.maxCanvasSize);
        elements.canvas.style.width = canvasSize + 'px';
        elements.canvas.style.height = canvasSize + 'px';
        elements.canvas.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
        elements.canvas.innerHTML = '';

        for (let i = 0; i < size * size; i++) {
            const pixel = createPixel(i, saved.data);
            elements.canvas.appendChild(pixel);
        }
    }

    function createPixel(index, savedData) {
        const pixel = document.createElement('div');
        pixel.className = 'pixel';
        pixel.style.backgroundColor = (savedData && savedData[index]) ? savedData[index] : '#ffffff';
        
        const paintPixel = (e) => {
            e.preventDefault();
            pixel.style.backgroundColor = currentColor;
            saveDrawing();
        };

        pixel.onmousedown = (e) => {
            isDrawing = true;
            paintPixel(e);
        };

        pixel.onmouseover = () => {
            if (isDrawing) {
                pixel.style.backgroundColor = currentColor;
                saveDrawing();
            }
        };

        pixel.ontouchstart = paintPixel;
        
        return pixel;
    }

    function changeGridSize(delta) {
        if (!isGridEmpty()) {
            openModal(elements.modalAlerteTaille);
            return;
        }

        const newSize = parseInt(elements.gridSizeInput.value) + delta;
        
        if (newSize >= CONFIG.minSize && newSize <= CONFIG.maxSize) {
            elements.gridSizeInput.value = newSize;
            elements.gridSizeDisplay.innerText = newSize;
            initGrid();
        }
    }

    function clearGrid() {
        openModal(elements.modalConfirm);
    }

    function confirmClearGrid() {
        clearDrawing();
        initGrid();
        closeModal(elements.modalConfirm);
    }

    // ===== MODEL FUNCTIONS =====
    function loadModel(key) {
        if (!key) return;
        
        const model = MODELES[key];
        elements.gridSizeInput.value = model.size;
        clearDrawing();
        initGrid();
        
        const pixels = document.querySelectorAll('.pixel');
        Object.entries(model.data).forEach(([index, color]) => {
            if (pixels[index]) {
                pixels[index].style.backgroundColor = color;
            }
        });
        
        saveDrawing();
    }

    // ===== PDF EXPORT =====
    async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const filename = `outilsprofs_pixelart_${getCurrentDate()}.pdf`;
        const size = parseInt(elements.gridSizeInput.value);
        const pixels = document.querySelectorAll('.pixel');
        const cellSize = 100 / size;
        const startX = (210 - 100) / 2;

        // Title
        doc.setFont("helvetica", "bold");
        doc.text("MOD√àLE PIXEL ART", 105, 25, { align: "center" });

        // Draw filled grid
        pixels.forEach((pixel, i) => {
            const x = startX + (i % size) * cellSize;
            const y = 40 + Math.floor(i / size) * cellSize;
            const rgb = pixel.style.backgroundColor.match(/\d+/g);
            
            if (rgb) {
                doc.setFillColor(parseInt(rgb[0]), parseInt(rgb[1]), parseInt(rgb[2]));
            } else {
                doc.setFillColor(255, 255, 255);
            }
            
            doc.rect(x, y, cellSize, cellSize, 'F');
            doc.setDrawColor(200);
            doc.rect(x, y, cellSize, cellSize, 'D');
        });

        // Empty grid title
        doc.text("√Ä TOI DE REPRODUIRE", 105, 160, { align: "center" });
        
        // Draw empty grid
        for (let i = 0; i < size; i++) {
            for (let j = 0; j < size; j++) {
                doc.setDrawColor(180);
                doc.rect(startX + j * cellSize, 175 + i * cellSize, cellSize, cellSize, 'D');
            }
        }

        // Save PDF (Android compatibility)
        if (window.Android && window.Android.savePdfFromBase64) {
            const pdfBase64 = doc.output('datauristring').split(',')[1];
            window.Android.savePdfFromBase64(pdfBase64, filename);
        } else {
            doc.save(filename);
        }
    }

    // ===== THEME FUNCTIONS =====
    function applyTheme() {
        const colorMap = {
            'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
            'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
            'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
            'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
            'rose': '#f43f5e'
        };

        const themeTiles = JSON.parse(localStorage.getItem(CONFIG.storageKeys.themeTiles) || '{}');
        const colorName = themeTiles.gen || 'cyan';
        const accentColor = colorMap[colorName];
        const isDark = ['yellow', 'lime', 'amber', 'cyan'].includes(colorName);
        const contrastColor = isDark ? '#000' : '#fff';

        document.documentElement.style.setProperty('--accent-color', accentColor);

        const themedElements = [
            elements.btnAide,
            elements.btnPdf,
            elements.btnFermerAide,
            document.getElementById('btn-retour-header'),
            document.getElementById('btn-retour-liste')
        ];

        themedElements.forEach(el => {
            if (el) {
                el.style.backgroundColor = accentColor;
                el.style.color = contrastColor;
            }
        });

        const titreAide = document.getElementById('titre-aide');
        if (titreAide) {
            titreAide.style.color = accentColor;
        }
    }

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
        // Grid size
        elements.btnIncreaseSize.onclick = () => changeGridSize(1);
        elements.btnDecreaseSize.onclick = () => changeGridSize(-1);
        
        // Clear
        elements.btnClear.onclick = clearGrid;
        elements.btnConfirmClear.onclick = confirmClearGrid;
        elements.btnCancelClear.onclick = () => closeModal(elements.modalConfirm);
        
        // Eraser
        elements.btnGomme.onclick = activateEraser;
        
        // Model selection
        elements.selectModele.onchange = (e) => loadModel(e.target.value);
        
        // PDF export
        elements.btnPdf.onclick = exportPDF;
        
        // Help modal
        elements.btnAide.onclick = () => openModal(elements.modalAide);
        elements.btnFermerAide.onclick = () => closeModal(elements.modalAide);
        elements.modalAide.onclick = () => closeModal(elements.modalAide);
        
        // Size alert modal
        elements.btnFermerAlerte.onclick = () => closeModal(elements.modalAlerteTaille);
        elements.modalAlerteTaille.onclick = () => closeModal(elements.modalAlerteTaille);
        
        // Confirm modal
        elements.modalConfirm.onclick = () => closeModal(elements.modalConfirm);
        
        // Drawing
        window.onmouseup = () => isDrawing = false;
    }

    // ===== INITIALIZATION =====
    window.onload = () => {
        initPalette();
        initGrid();
        applyTheme();
        setupEventListeners();
    };
</script>

</body>
</html>
