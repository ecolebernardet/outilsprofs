<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Texte √† trous - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
            --accent-color: #06b6d4;
        }
        body.light-mode {
            --bg-page: #eeeeee; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s ease; }
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }
        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; transition: all 0.2s ease; cursor: pointer; border: none; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }
        .main-wrapper { width: 100%; max-width: 500px; margin: 0 auto; padding: 10px 15px 40px; }
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 20px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 20px; }
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border); border-radius: 0.75rem; padding: 12px; font-size: 0.85rem; font-weight: 700; width: 100%; color: var(--text-main); outline: none; }
        #text-editor { min-height: 150px; overflow-y: auto; line-height: 1.6; white-space: pre-wrap; cursor: text; }
        #text-editor:empty:before { content: "Tapez ou collez votre texte ici..."; opacity: 0.3; }
        .word-gap { background-color: var(--accent-color); color: white !important; border-radius: 4px; padding: 0 4px; cursor: pointer; font-weight: 800; }
        .btn-add { width: 100%; padding: 14px; border-radius: 50px; font-weight: 900; font-size: 12px; text-transform: uppercase; border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-game-action { height: 40px; border-radius: 9999px; font-size: 10px; font-weight: 900; color: white; transition: all 0.2s ease; text-transform: uppercase; }
        .gap-input { border-bottom: 2px dashed var(--column-border); background: transparent; outline: none; text-align: center; font-weight: 800; color: var(--accent-color); }
        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
    </style>
</head>
<body>

<script>if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');</script>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" /></svg>
    </a>
    <h1>Texte √† trous</h1>
    <button id="btn-aide" onclick="ouvrirModal('modal-aide')" class="ui-btn-round active:scale-90 text-lg">üí°</button>
</header>

<div class="main-wrapper">
    <div id="container-retour-liste" class="mb-4 text-left">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" /></svg>
            Retour aux g√©n√©rateurs
        </a>
    </div>

    <div id="setup-zone" class="light-card space-y-4">
        <div>
            <label class="block text-[9px] font-black uppercase opacity-50 mb-2 tracking-widest text-center">Double-cliquez sur les mots pour les masquer</label>
            <div id="text-editor" contenteditable="true" class="input-field text-left"></div>
        </div>
        <button id="mainAddBtn" onclick="generateExercise()" class="btn-add">G√©n√©rer l'exercice</button>
    </div>

    <div id="game-zone" class="hidden space-y-6">
        <div id="exercise-content" class="light-card leading-loose text-lg text-left"></div>
        <div class="grid grid-cols-2 gap-4 pt-4">
            <button onclick="retourReglages()" class="btn-game-action bg-gray-500">‚¨ÖÔ∏è retour</button>
            <button id="validate-btn" onclick="showCorrection()" class="btn-game-action bg-green-500">üëÅÔ∏è correction</button>
            <button onclick="exportToPDF()" class="btn-game-action bg-blue-500 col-span-2">üìÑ √©dition PDF</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="titre-aide" class="text-lg font-black uppercase mb-4 text-center">üìñ Guide</h2>
        <div class="text-[12px] leading-relaxed space-y-4 opacity-90">
            <p>1. Tapez votre texte.<br>2. Double-cliquez sur un mot pour le masquer.<br>3. Le PDF g√©n√®re l'exercice et la correction.</p>
        </div>
        <button onclick="fermerModal('modal-aide')" id="btn-fermer-aide" class="mt-6 w-full py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">Fermer</button>
    </div>
</div>

<div id="modal-alerte" class="modal-overlay" onclick="fermerModal('modal-alerte')">
    <div class="modal-content text-center" onclick="event.stopPropagation()">
        <div class="text-4xl mb-2">‚ö†Ô∏è</div>
        <h2 class="text-lg font-black uppercase mb-2">Action requise</h2>
        <p class="text-[12px] opacity-80 mb-6">S√©lectionnez au moins un mot (double-clic) pour cr√©er un trou.</p>
        <button onclick="fermerModal('modal-alerte')" class="btn-add">D'accord</button>
    </div>
</div>

<script>
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#6b7280' };
    const editor = document.getElementById('text-editor');
    let isShowingCorrection = false;
    let savedUserInputs = [];

    editor.addEventListener('dblclick', function(e) {
        const selection = window.getSelection();
        if (e.target.classList.contains('word-gap')) {
            e.target.replaceWith(document.createTextNode(e.target.textContent));
            selection.removeAllRanges(); return;
        }
        if (selection.rangeCount > 0) {
            let range = selection.getRangeAt(0);
            let word = selection.toString();
            if (word.endsWith(' ')) { range.setEnd(range.endContainer, range.endOffset - 1); word = selection.toString(); }
            if (word.includes("'") || word.includes("‚Äô")) {
                const idx = Math.max(word.lastIndexOf("'"), word.lastIndexOf("‚Äô"));
                range.setStart(range.startContainer, range.startOffset + idx + 1);
                word = selection.toString();
            }
            if (word.trim().length > 0) {
                const span = document.createElement('span'); span.className = 'word-gap';
                span.textContent = word.trim(); range.deleteContents(); range.insertNode(span);
                selection.removeAllRanges();
            }
        }
    });

    function generateExercise() {
        if (!editor.innerHTML.includes('word-gap')) { ouvrirModal('modal-alerte'); return; }
        const container = document.getElementById('exercise-content');
        const tempDiv = document.createElement('div'); tempDiv.innerHTML = editor.innerHTML;
        tempDiv.querySelectorAll('.word-gap').forEach(span => {
            const input = document.createElement('input'); input.className = "gap-input";
            input.dataset.answer = span.textContent; input.style.width = (span.textContent.length + 1) + "ch";
            input.oninput = function() { this.style.width = Math.max(this.value.length + 1, this.dataset.answer.length + 1) + 'ch'; };
            span.parentNode.replaceChild(input, span);
        });
        container.innerHTML = tempDiv.innerHTML;
        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('container-retour-liste').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');
    }

    function showCorrection() {
        const inputs = document.querySelectorAll('.gap-input');
        const btn = document.getElementById('validate-btn');
        if (!isShowingCorrection) {
            savedUserInputs = Array.from(inputs).map(i => i.value);
            inputs.forEach(i => {
                const isCorrect = i.value.trim().toLowerCase() === i.dataset.answer.toLowerCase();
                i.value = i.dataset.answer; i.style.color = isCorrect ? '#10b981' : '#ef4444';
                i.disabled = true; i.style.fontWeight = "900";
            });
            btn.innerHTML = "üôà masquer"; btn.classList.replace('bg-green-500', 'bg-orange-500');
            isShowingCorrection = true;
        } else {
            inputs.forEach((i, idx) => { i.value = savedUserInputs[idx] || ""; i.style.color = ""; i.disabled = false; i.style.fontWeight = "800"; });
            btn.innerHTML = "üëÅÔ∏è correction"; btn.classList.replace('bg-orange-500', 'bg-green-500');
            isShowingCorrection = false;
        }
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const now = new Date();
        const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
        const filename = `outilsprofs_texteatrous_${dateStr}.pdf`;
        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();

        const drawPage = (title, isCorrection) => {
            doc.setFont("times", "bold"); doc.setFontSize(18); doc.setTextColor(accent);
            doc.text(title, 105, 20, { align: "center" });
            
            if(!isCorrection) {
                doc.setFontSize(10); doc.setTextColor(100);
                doc.text("Nom : ................................. Pr√©nom : ................................. Date : .................................", 20, 32);
            }

            doc.setFont("times", "normal"); doc.setFontSize(12); doc.setTextColor(0);
            let tempDiv = document.createElement('div'); tempDiv.innerHTML = editor.innerHTML;
            if (!isCorrection) tempDiv.querySelectorAll('.word-gap').forEach(s => s.textContent = " ............................ ");
            const splitText = doc.splitTextToSize(tempDiv.innerText, 170);
            doc.text(splitText, 20, 48, { lineHeightFactor: 1.6 });
        };

        drawPage("Exercice : Texte √† trous", false); doc.addPage(); drawPage("Correction de l'exercice", true);
        if (window.Android && window.Android.savePdfFromBase64) {
            window.Android.savePdfFromBase64(doc.output('datauristring').split(',')[1], filename);
        } else { doc.save(filename); }
    }

    function appliquerTheme() {
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const colPref = themePrefs.gen || 'cyan'; const hexa = mapCouleurs[colPref];
        const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(colPref) ? '#000' : '#fff';
        document.documentElement.style.setProperty('--accent-color', hexa);
        [document.getElementById('btn-retour-header'), document.getElementById('btn-retour-liste'), document.getElementById('btn-aide'), document.getElementById('mainAddBtn'), document.getElementById('btn-fermer-aide')].forEach(el => { if(el) { el.style.backgroundColor = hexa; el.style.color = contrast; } });
        if(document.getElementById('titre-aide')) document.getElementById('titre-aide').style.color = hexa;
    }

    function ouvrirModal(id) { document.getElementById(id).style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }
    function retourReglages() { document.getElementById('setup-zone').classList.remove('hidden'); document.getElementById('container-retour-liste').classList.remove('hidden'); document.getElementById('game-zone').classList.add('hidden'); }
    window.onload = appliquerTheme;
</script>
</body>
</html>