<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Plan de la classe - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root { 
            --bg-page: #121212; --text-page: #ffffff; --column-border: rgba(255, 255, 255, 0.2); 
            --header-bg: #1e1e1e; --card-bg: #1e1e1e;
        }
        body.light-mode { 
            --bg-page: #eeeeee; --text-page: #111827; --column-border: #999; 
            --header-bg: #ffffff; --card-bg: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-page); color: var(--text-page); margin: 0; padding: 0; transition: background 0.3s ease; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--column-border);
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            display: flex; align-items: center; justify-content: space-between; width: 100%; z-index: 100;
        }

        #btn-retour, #btn-aide { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        header h1 { font-size: 1rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; flex-grow: 1; text-align: center; }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        #container-retour-liste {
            position: relative; /* Change de absolute Ã  relative */
            width: 100%;
            pointer-events: auto;
            display: block;
        }
        #btn-retour-liste {
            pointer-events: auto;
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; 
            border-radius: 9999px; font-size: 10px; font-weight: 900; text-transform: uppercase; 
            transition: transform 0.2s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        #canvas-container {
			flex: 1;
			display: flex;
			justify-content: center;
			align-items: center;
			background: var(--bg-page);
			overflow: hidden;
			padding: 0; /* Suppression du padding pour maximiser l'espace */
		}

        svg {
            height: 100%;
            width: auto;
            aspect-ratio: 1800 / 1800;
            max-width: 100%;
            touch-action: none;
            display: block;
            border: none;
        }

        .desk-group { cursor: grab; user-select: none; pointer-events: all; }
        .desk-rect { stroke: rgba(0,0,0,0.3); stroke-width: 2; rx: 5; transition: stroke 0.2s; }
        .desk-group.selected .desk-rect { stroke: var(--theme-color); stroke-width: 8; }
        .desk-label { fill: black; font-size: 30px; font-weight: 900; text-anchor: middle; dominant-baseline: middle; pointer-events: none; text-transform: uppercase; }
        .chair-rect { fill: #2e7d32; rx: 2; }

        /* Nouveaux styles pour les contrÃ´les de zoom sous le plan */
        #zoom-controls {
			display: flex;
			flex-direction: column; /* Boutons l'un au-dessus de l'autre pour plus de discrÃ©tion */
			gap: 10px;
			padding: 0;
			position: absolute;
			right: 20px;
			bottom: calc(env(safe-area-inset-bottom) + 100px); /* Juste au-dessus de la toolbar */
			z-index: 50;
			margin-bottom: 0;
		}

        .toolbar {
			position: fixed; 
			bottom: 0;
			left: 50%; 
			transform: translateX(-50%);
			background: var(--header-bg); 
			width: 100%;
			max-width: 600px; 
			/* Augmentation du padding pour dÃ©coller de la zone de navigation Android */
			padding: 12px 10px calc(env(safe-area-inset-bottom) + 15px) 10px;
			border-radius: 20px 20px 0 0;
			border-top: 1px solid rgba(128,128,128,0.3);
			display: flex; 
			justify-content: space-around; 
			z-index: 9999; /* PrioritÃ© maximale pour passer au-dessus du reste */
			pointer-events: auto; /* Force la rÃ©activitÃ© aux clics */
			touch-action: manipulation; /* Supprime le dÃ©lai de clic sur mobile */
		}

        .btn-tool { flex: 1; height: 42px; border-radius: 12px; font-size: 18px; display: flex; align-items: center; justify-content: center; background: rgba(128,128,128,0.1); transition: all 0.2s; border: none; color: inherit; }
        .btn-tool:disabled { opacity: 0.15; pointer-events: none; }
        
        #add-menu { 
			transition: all 0.2s ease-out; 
			z-index: 9998; 
		}
		#add-menu.hidden { 
			display: none !important; /* Force la disparition totale pour libÃ©rer l'espace tactile */
			pointer-events: none; 
		}
        #add-menu button:active { transform: scale(0.9); }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 420px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
        .btn-modal-action { width: 100%; padding: 14px; border-radius: 12px; font-weight: 900; font-size: 11px; text-transform: uppercase; cursor: pointer; border: none; }
    </style>
</head>
<body>

<header>
    <a href="index.html" id="btn-retour">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1 id="pageTitle">Plan de la classe</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="text-lg">ğŸ’¡</button>
</header>

<div class="main-content">
    <div id="container-retour-liste" class="relative p-4 z-50">
        <a href="outils.html" id="btn-retour-liste">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" /></svg>
            Retour aux outils
        </a>
    </div>

    <div id="canvas-container">
        <svg id="plan-svg" onclick="deselectAll(event)" viewBox="0 0 1800 1800" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
            <g id="main-layer"></g>
        </svg>
    </div>

    <div id="zoom-controls">
        <button onclick="changeZoom(-0.2)" class="w-12 h-12 bg-[var(--header-bg)] border border-[var(--column-border)] rounded-full shadow-lg text-xl font-bold flex items-center justify-center">ï¼</button>
        <button onclick="resetZoom()" class="w-12 h-12 bg-[var(--header-bg)] border border-[var(--column-border)] rounded-full shadow-lg text-[12px] font-black flex items-center justify-center">1:1</button>
        <button onclick="changeZoom(0.2)" class="w-12 h-12 bg-[var(--header-bg)] border border-[var(--column-border)] rounded-full shadow-lg text-xl font-bold flex items-center justify-center">ï¼‹</button>
    </div>
</div>

<div id="add-menu" class="hidden fixed bottom-[95px] left-1/2 -translate-x-1/2 bg-[var(--header-bg)] border border-[var(--column-border)] p-4 rounded-3xl shadow-2xl flex gap-4 z-[300]">
    <button onclick="ajouterMeuble('prof')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-gray-500/10">
        <span class="text-2xl">ğŸ‘¨â€ğŸ«</span>
        <span class="text-[9px] font-bold uppercase">Bureau</span>
    </button>
    <button onclick="ajouterUneTable()" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-gray-500/10">
        <span class="text-2xl">ğŸª‘</span>
        <span class="text-[9px] font-bold uppercase">Ã‰lÃ¨ve</span>
    </button>
    <button onclick="ajouterMeuble('tableau')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-gray-500/10">
        <span class="text-2xl">â¬›</span>
        <span class="text-[9px] font-bold uppercase">Tableau</span>
    </button>
    <button onclick="ajouterMeuble('meuble')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-gray-500/10">
        <span class="text-2xl">ğŸ—„ï¸</span>
        <span class="text-[9px] font-bold uppercase">Meuble</span>
    </button>
    <button onclick="ajouterMeuble('porte')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-gray-500/10">
        <span class="text-2xl">ğŸšª</span>
        <span class="text-[9px] font-bold uppercase">Porte</span>
    </button>
</div>

<div class="toolbar">
    <button class="btn-tool" id="btn-mode" onclick="toggleLock()">ğŸ”“</button>
    <button class="btn-tool" id="btn-undo" onclick="undo()">â†¶</button>
    <button class="btn-tool" id="btn-redo" onclick="redo()">â†·</button>
    <button class="btn-tool" id="btn-add-menu" onclick="toggleAddMenu()" title="Ajouter un Ã©lÃ©ment">â•</button>
    <button class="btn-tool" id="btn-delete-selection" onclick="supprimerSelection()" title="Supprimer la sÃ©lection" disabled>ğŸ§½</button>
    <button class="btn-tool" onclick="genererTablesDepuisClasse()" title="GÃ©nÃ©rer les tables">ğŸ“‹</button>
    <button class="btn-tool" onclick="confirmerToutEffacer()" title="Tout effacer">ğŸ—‘ï¸</button>
    <button class="btn-tool" onclick="exporterPlan()">ğŸ’¾</button>
    <button class="btn-tool" onclick="importerPlan()">ğŸ“‚</button>
    <button class="btn-tool" onclick="exportPDF()" title="TÃ©lÃ©charger PDF">ğŸ“„</button>
</div>

<div id="modal-confirm" class="modal-overlay">
    <div class="modal-content text-center">
        <h2 class="font-black uppercase mb-2 text-red-500">âš ï¸ Attention</h2>
        <p class="text-xs opacity-70 mb-6 font-semibold">Voulez-vous vraiment tout supprimer ?</p>
        <div class="flex gap-2">
            <button onclick="fermerModale('modal-confirm')" class="flex-1 btn-modal-action bg-gray-500/20">Annuler</button>
            <button onclick="toutEffacer()" class="flex-1 btn-modal-action bg-red-600 text-white">Supprimer</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModale('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="font-black uppercase mb-4 flex items-center gap-2">ğŸ’¡ Guide des outils</h2>
        <div class="text-[11px] opacity-90 leading-relaxed max-h-[60vh] overflow-y-auto space-y-4">
            
            <section>
                <h3 class="font-bold border-b border-gray-500/20 mb-1 uppercase text-[10px]">Navigation & Zoom</h3>
                <p><strong>ï¼‹ / ï¼ :</strong> Zoomer ou dÃ©zoomer sur le plan.</p>
                <p><strong>RESET 1:1 :</strong> RÃ©initialise l'affichage pour voir tout le plan.</p>
                <p><strong>DÃ©placement :</strong> En mode zoom, glissez le doigt sur le fond pour naviguer.</p>
            </section>

            <section>
                <h3 class="font-bold border-b border-gray-500/20 mb-1 uppercase text-[10px]">Ã‰dition des Ã©lÃ©ments</h3>
                <p><strong>DÃ©placer :</strong> Touchez et glissez un meuble ou une table.</p>
                <p><strong>Pivoter :</strong> Double-cliquez sur un Ã©lÃ©ment pour une rotation de 45Â°.</p>
                <p><strong>SÃ©lection :</strong> Touchez un Ã©lÃ©ment pour l'activer (contour Ã©pais).</p>
            </section>

            <section>
                <h3 class="font-bold border-b border-gray-500/20 mb-1 uppercase text-[10px]">Barre d'outils</h3>
                <p><strong>ğŸ”“/ğŸ”’ Cadenas :</strong> Verrouille les meubles pour Ã©viter les erreurs de manipulation pendant le zoom.</p>
                <p><strong>â†¶ / â†· FlÃ¨ches :</strong> Annuler ou rÃ©tablir vos derniÃ¨res modifications.</p>
                <p><strong>â• Plus :</strong> Ajouter un bureau Ã©lÃ¨ve, un tableau, un meuble ou une porte.</p>
                <p><strong>ğŸ§½ Ã‰ponge :</strong> Supprime l'Ã©lÃ©ment actuellement sÃ©lectionnÃ©.</p>
                <p><strong>ğŸ“‹ Presse-papier :</strong> GÃ©nÃ¨re automatiquement les tables de vos Ã©lÃ¨ves enregistrÃ©s dans la rubrique "Ma classe".</p>
                <p><strong>ğŸ—‘ï¸ Corbeille :</strong> Efface tout le plan pour recommencer Ã  zÃ©ro.</p>
                <p><strong>ğŸ’¾ / ğŸ“‚ Disquette/Dossier :</strong> Sauvegarder ou charger un fichier de plan (.json).</p>
                <p><strong>ğŸ“„ Fichier :</strong> Exporte votre plan en format PDF pour l'impression.</p>
            </section>
        </div>
        <button onclick="fermerModale('modal-aide')" id="btn-fermer-aide" class="mt-6 btn-modal-action">J'ai compris</button>
    </div>
</div>
</div>

<div id="modal-create" class="modal-overlay">
    <div class="modal-content">
        <h2 class="font-black uppercase mb-2">Nouvelle Table</h2>
        <input type="text" id="input-nom-eleve" class="w-full bg-gray-500/10 border border-gray-500/30 rounded-lg p-3 mb-6 outline-none" placeholder="PrÃ©nom">
        <div class="flex gap-2">
            <button onclick="fermerModale('modal-create')" class="flex-1 btn-modal-action bg-gray-500/20">Annuler</button>
            <button id="btn-valider-create" onclick="validerCreationTable()" class="flex-1 btn-modal-action text-white">Ajouter</button>
        </div>
    </div>
</div>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');

    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e' };
    const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
    const themeColor = mapCouleurs[themePrefs.outils || 'blue'];
    const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(themePrefs.outils || 'blue') ? '#000' : '#fff';
    document.documentElement.style.setProperty('--theme-color', themeColor);
    document.documentElement.style.setProperty('--contrast-color', contrast);

    function appliquerCouleursDynamiques() {
    const ids = ['btn-retour', 'btn-aide', 'btn-retour-liste', 'btn-valider-create', 'btn-fermer-aide'];
    ids.forEach(id => { 
        const el = document.getElementById(id);
        if(el) { 
            el.style.backgroundColor = themeColor; 
            el.style.color = contrast; 
        } 
    });
}

    let isLocked = false;
    let studentData = JSON.parse(localStorage.getItem('plan_vector_v1')) || [];
    let historyStack = [], redoStack = [];
    let selectedIndex = null;

    // Variables Zoom
    let currentScale = 1;
    let translateX = 0;
    let translateY = 0;
    const SPEED_MULTIPLIER = 5; // DÃ©placement plus rapide au doigt en zoom
    
    const SVG_NS = "http://www.w3.org/2000/svg";
    const DESK_W = 180, DESK_H = 100, PROF_W = 360, PROF_H = 180, MEUBLE_W = 320, MEUBLE_H = 80, DOOR_W = 200, DOOR_H = 40, BOARD_W = 900, BOARD_H = 40;

    const couleurParNiveau = { 
        'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308', 'CM1': '#ef4444', 'CM2': '#22c55e', 
        'AUTRE': '#A58F88', 'PROF': '#77615A', 'MEUBLE': '#77615A', 'PORTE': '#577A72', 'TABLEAU': '#1D6353'
    };
    const couleurDefautBureau = '#5d4037';

    function pushHistory() { historyStack.push(JSON.stringify(studentData)); if (historyStack.length > 40) historyStack.shift(); redoStack = []; updateButtons(); }
    function undo() { if (historyStack.length > 0) { redoStack.push(JSON.stringify(studentData)); studentData = JSON.parse(historyStack.pop()); selectedIndex = null; sync(); } }
    function redo() { if (redoStack.length > 0) { historyStack.push(JSON.stringify(studentData)); studentData = JSON.parse(redoStack.pop()); selectedIndex = null; sync(); } }
    function sync() { localStorage.setItem('plan_vector_v1', JSON.stringify(studentData)); drawPlan(); updateButtons(); }
    function updateButtons() { 
        document.getElementById('btn-undo').disabled = historyStack.length === 0; 
        document.getElementById('btn-redo').disabled = redoStack.length === 0; 
        document.getElementById('btn-delete-selection').disabled = selectedIndex === null;
    }
    function toggleAddMenu() { document.getElementById('add-menu').classList.toggle('hidden'); }

    // Fonctions Zoom
    function changeZoom(delta) {
        const newScale = Math.min(Math.max(currentScale + delta, 1), 4);
        if (newScale !== currentScale) {
            currentScale = newScale;
            if (currentScale > 1 && !isLocked) toggleLock();
            if (currentScale === 1) { translateX = 0; translateY = 0; }
            applyTransform();
        }
    }

    function resetZoom() {
        currentScale = 1; translateX = 0; translateY = 0;
        if (isLocked) toggleLock();
        applyTransform();
    }

    function applyTransform() {
        const layer = document.getElementById('main-layer');
        layer.style.transition = "transform 0.15s ease-out";
        layer.style.transformOrigin = "center center";
        layer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
    }

    function ajouterMeuble(type) {
        pushHistory();
        let item = { x: 900, y: 900, r: 0 };
        if(type === 'prof') { item.name = "PROF"; item.niveau = "PROF"; }
        else if(type === 'meuble') { item.name = "MEUBLE"; item.niveau = "MEUBLE"; }
        else if(type === 'porte') { item.name = "PORTE"; item.niveau = "PORTE"; }
        else if(type === 'tableau') { item.name = "TABLEAU"; item.niveau = "TABLEAU"; }
        studentData.push(item);
        sync();
        toggleAddMenu();
    }

    function drawPlan() {
    const layer = document.getElementById('main-layer');
    layer.innerHTML = '';

    const walls = document.createElementNS(SVG_NS, "rect");
    walls.setAttribute("x", 5); walls.setAttribute("y", 5);
    walls.setAttribute("width", 1790); walls.setAttribute("height", 1790);
    walls.setAttribute("fill", "none"); walls.setAttribute("stroke", "var(--column-border)");
    walls.setAttribute("stroke-width", "10"); walls.style.pointerEvents = "none";
    layer.appendChild(walls);

    studentData.forEach((student, index) => {
        const g = document.createElementNS(SVG_NS, "g");
        g.setAttribute("class", "desk-group" + (selectedIndex === index ? " selected" : ""));
        g.setAttribute("id", `desk-${index}`);
        const x = student.x || 900, y = student.y || 900, r = student.r || 0;
        g.setAttribute("transform", `translate(${x},${y}) rotate(${r})`);
        g.setAttribute("data-x", x); g.setAttribute("data-y", y); g.setAttribute("data-r", r);
        
        let currentW = DESK_W, currentH = DESK_H, hasChair = true;
        if (student.niveau === 'PROF') { currentW = PROF_W; currentH = PROF_H; }
        else if (student.niveau === 'MEUBLE') { currentW = MEUBLE_W; currentH = MEUBLE_H; hasChair = false; }
        else if (student.niveau === 'PORTE') { currentW = DOOR_W; currentH = DOOR_H; hasChair = false; }
        else if (student.niveau === 'TABLEAU') { currentW = BOARD_W; currentH = BOARD_H; hasChair = false; }

        const color = couleurParNiveau[student.niveau] || couleurDefautBureau;
        const rect = document.createElementNS(SVG_NS, "rect");
        rect.setAttribute("class", "desk-rect");
        rect.setAttribute("x", -currentW/2); rect.setAttribute("y", -currentH/2);
        rect.setAttribute("width", currentW); rect.setAttribute("height", currentH);
        rect.style.fill = color;
        g.appendChild(rect);

        if (hasChair) {
            const chair = document.createElementNS(SVG_NS, "rect");
            chair.setAttribute("class", "chair-rect");
            chair.setAttribute("x", -30); chair.setAttribute("y", currentH/2 + 5);
            chair.setAttribute("width", 60); chair.setAttribute("height", 15);
            g.appendChild(chair);
        }

        if (student.name) {
            const text = document.createElementNS(SVG_NS, "text");
            text.setAttribute("class", "desk-label");
            if(student.niveau === 'TABLEAU') text.setAttribute("fill", "white");
            text.setAttribute("x", "0"); text.setAttribute("y", "0");
            text.textContent = student.name;
            
            // --- LOGIQUE DE ROTATION DU NOM ---
            // Par dÃ©faut, Ã  0Â°, le texte est face Ã  la chaise (placÃ©e en bas).
            // Ã€ 90Â°, le texte pivote avec le groupe et reste face Ã  la chaise.
            // On ne le retourne (180Â°) que si la table est entre 135Â° et 225Â° 
            // pour Ã©viter que le texte ne soit totalement Ã  l'envers pour le prof.
            if (r > 130 && r < 230) {
                text.setAttribute("transform", `rotate(180)`);
            }
            
            g.appendChild(text);
        }

        g.addEventListener('click', (e) => { e.stopPropagation(); deselectAllManual(); g.classList.add('selected'); selectedIndex = index; updateButtons(); });
        g.addEventListener('dblclick', (e) => { e.stopPropagation(); if(!isLocked) { pushHistory(); student.r = (parseInt(student.r || 0) + 45) % 360; sync(); } });
        layer.appendChild(g);
    });
    setupInteract();
    applyTransform();
}

    function deselectAllManual() { document.querySelectorAll('.desk-group').forEach(el => el.classList.remove('selected')); selectedIndex = null; updateButtons(); }
    function deselectAll(e) { if (e.target.id === 'plan-svg') { deselectAllManual(); document.getElementById('add-menu').classList.add('hidden'); } }

    function setupInteract() {
        interact('.desk-group').draggable({
            onstart: () => { if(!isLocked) pushHistory(); },
            listeners: {
                move(event) {
                    if(isLocked) return;
                    const target = event.target, svg = document.getElementById('plan-svg');
                    const point = svg.createSVGPoint();
                    point.x = event.dx; point.y = event.dy;
                    const ctm = svg.getScreenCTM().inverse();
                    const deltaX = point.x * ctm.a, deltaY = point.y * ctm.d;
                    let x = (parseFloat(target.getAttribute('data-x')) || 0) + deltaX;
                    let y = (parseFloat(target.getAttribute('data-y')) || 0) + deltaY;
                    let r = target.getAttribute('data-r');
                    target.setAttribute('transform', `translate(${x},${y}) rotate(${r})`);
                    target.setAttribute('data-x', x); target.setAttribute('data-y', y);
                },
                end(event) {
                    if(isLocked) return;
                    const idx = event.target.id.split('-')[1];
                    studentData[idx].x = parseFloat(event.target.getAttribute('data-x'));
                    studentData[idx].y = parseFloat(event.target.getAttribute('data-y'));
                    localStorage.setItem('plan_vector_v1', JSON.stringify(studentData));
                }
            }
        });

        // DÃ©placement panoramique (accelerated)
        interact('#plan-svg').draggable({
    listeners: {
        move(event) {
            if (currentScale > 1) {
                // EmpÃªche le dÃ©filement de la page pendant qu'on bouge le plan
                event.preventDefault(); 
                translateX += event.dx * SPEED_MULTIPLIER;
                translateY += event.dy * SPEED_MULTIPLIER;
                applyTransform();
            }
        }
    },
    // EmpÃªche l'interaction de capturer les clics hors de la zone du plan
    allowFrom: '#plan-svg' 
});
    }

    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModale(id) { document.getElementById(id).style.display = 'none'; }
    function ajouterUneTable() { document.getElementById('input-nom-eleve').value = ""; document.getElementById('modal-create').style.display = 'flex'; toggleAddMenu(); setTimeout(() => document.getElementById('input-nom-eleve').focus(), 100); }
    function validerCreationTable() { const nom = document.getElementById('input-nom-eleve').value.trim(); if (nom) { pushHistory(); studentData.push({ name: nom.toUpperCase(), niveau: "AUTRE", x: 900, y: 900, r: 0 }); sync(); fermerModale('modal-create'); } }
    function supprimerSelection() { if (selectedIndex !== null) { pushHistory(); studentData.splice(selectedIndex, 1); selectedIndex = null; sync(); } }
    function confirmerToutEffacer() { document.getElementById('modal-confirm').style.display = 'flex'; }
    function toutEffacer() { pushHistory(); studentData = []; selectedIndex = null; sync(); fermerModale('modal-confirm'); }
    function toggleLock() { isLocked = !isLocked; document.getElementById('btn-mode').textContent = isLocked ? 'ğŸ”’' : 'ğŸ”“'; document.getElementById('btn-mode').style.background = isLocked ? 'var(--theme-color)' : 'rgba(128,128,128,0.1)'; document.getElementById('btn-mode').style.color = isLocked ? 'var(--contrast-color)' : 'inherit'; }

    /* --- REMPLACEZ TOUTE LA FIN DE VOTRE SCRIPT (Ã  partir de exporterPlan) PAR CECI --- */

    function getExportFileName(ext) {
        const nomProf = (localStorage.getItem('nom_enseignant') || 'prof').toLowerCase().replace(/\s+/g, '_');
        const d = new Date();
        const dateStr = d.getFullYear() + String(d.getMonth() + 1).padStart(2, '0') + String(d.getDate()).padStart(2, '0');
        return `outilsprofs_plan_classe_${nomProf}_${dateStr}.${ext}`;
    }

    function exporterPlan() {
        const fileName = getExportFileName('json');
        const content = JSON.stringify(studentData);

        if (window.Android && window.Android.savePdfFromBase64) {
            // Encodage Base64 sÃ©curisÃ© pour Android
            const base64Content = btoa(unescape(encodeURIComponent(content)));
            window.Android.savePdfFromBase64(base64Content, fileName);
        } else {
            // Mode navigateur classique
            const blob = new Blob([content], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();
        }
    }

    async function exportPDF() {
    try {
        const fileName = getExportFileName('pdf');
        if (!window.jspdf || !window.jspdf.jsPDF) return;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("PLAN DE CLASSE", 105, 15, { align: 'center' });

        const svgElement = document.getElementById('plan-svg');
        const svgClone = svgElement.cloneNode(true);
        
        // --- ADAPTATION DYNAMIQUE DE LA TAILLE DU TEXTE ---
        const groups = svgClone.querySelectorAll('.desk-group');
        groups.forEach((group) => {
            const label = group.querySelector('.desk-label');
            const rect = group.querySelector('.desk-rect');
            
            if (label && rect) {
                const rectWidth = parseFloat(rect.getAttribute('width'));
                const studentName = label.textContent || "";
                
                // 1. Calcul de la taille de police
                let fontSize = Math.min(30, rectWidth / (studentName.length * 0.65));
                if (fontSize < 16) fontSize = 16;

                // 2. FORCER LE CENTRAGE ABSOLU
                // text-anchor: middle -> centre horizontalement le texte sur son point X
                // dominant-baseline: central -> centre verticalement le texte sur son point Y
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('dominant-baseline', 'central');
                
                // On s'assure que x et y sont bien Ã  0 (centre du groupe translate)
                label.setAttribute('x', '0');
                label.setAttribute('y', '0');

                label.setAttribute('style', `font-size: ${fontSize}px; font-weight: bold; font-family: Arial, sans-serif;`);
            }
        });

        const svgData = new XMLSerializer().serializeToString(svgClone);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        canvas.width = 1800;
        canvas.height = 1800;

        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);

        img.onload = function() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            doc.addImage(imgData, 'JPEG', 10, 25, 190, 190);
            
            if (window.Android && window.Android.savePdfFromBase64) {
                const base64String = doc.output('datauristring').split(',')[1];
                window.Android.savePdfFromBase64(base64String, fileName);
            } else {
                doc.save(fileName);
            }
            URL.revokeObjectURL(url);
        };

        img.src = url;

    } catch (error) {
        alert("Erreur PDF : " + error.message);
    }
}

    function importerPlan() { 
        const inp = document.createElement('input'); 
        inp.type = 'file'; 
        inp.accept = '.json'; 
        inp.onchange = e => { 
            const reader = new FileReader(); 
            reader.onload = ev => { 
                try {
                    studentData = JSON.parse(ev.target.result); 
                    sync(); 
                } catch(err) {
                    alert("Erreur lors de la lecture du fichier.");
                }
            }; 
            reader.readAsText(e.target.files[0]); 
        }; 
        inp.click(); 
    }

    function genererTablesDepuisClasse() { 
        const list = JSON.parse(localStorage.getItem('maListeEleves') || "[]"); 
        if(list.length) { 
            pushHistory(); 
            studentData = list.map((el, i) => ({ 
                name: el.identite.split(' ')[0], 
                niveau: el.niveau, 
                x: 220 + ((i % 5) * 260), 
                y: 200 + (Math.floor(i / 5) * 240), 
                r: 0 
            })); 
            sync(); 
        } 
    }

    appliquerCouleursDynamiques();
    drawPlan();
</script>
</body>
</html>