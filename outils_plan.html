<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Plan Vectoriel Pro - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root { 
            --bg-page: #121212; --text-page: #ffffff; --column-border: rgba(255, 255, 255, 0.2); 
            --header-bg: #1e1e1e; --card-bg: #1e1e1e;
        }
        body.light-mode { 
            --bg-page: #eeeeee; --text-page: #111827; --column-border: #999; 
            --header-bg: #ffffff; --card-bg: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-page); color: var(--text-page); margin: 0; padding: 0; transition: background 0.3s ease; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--column-border);
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            display: flex; align-items: center; justify-content: space-between; width: 100%; z-index: 100;
        }

        #btn-retour, #btn-aide { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        header h1 { font-size: 1rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; flex-grow: 1; text-align: center; }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        #container-retour-liste { width: 100%; max-width: 2000px; padding: 15px 20px 0 20px; text-align: left; z-index: 50; pointer-events: none; position: absolute; }
        #btn-retour-liste {
            pointer-events: auto;
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; 
            border-radius: 9999px; font-size: 10px; font-weight: 900; text-transform: uppercase; 
            transition: transform 0.2s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        #canvas-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: var(--bg-page);
            overflow: hidden;
            padding: 10px;
            padding-bottom: 90px;
        }

        svg {
            height: 100%;
            width: auto;
            aspect-ratio: 1500 / 1800;
            max-width: 100%;
            background-image: radial-gradient(rgba(128,128,128,0.2) 1.5px, transparent 1.5px);
            background-size: 40px 40px;
            touch-action: none;
            display: block;
            border: none;
        }

        body.light-mode svg { background-image: radial-gradient(rgba(0,0,0,0.1) 1.5px, transparent 1.5px); }

        .desk-group { cursor: grab; user-select: none; }
        .desk-rect { stroke: rgba(0,0,0,0.3); stroke-width: 2; rx: 5; }
        .desk-label { fill: black; font-size: 30px; font-weight: 900; text-anchor: middle; dominant-baseline: middle; pointer-events: none; text-transform: uppercase; }
        .chair-rect { fill: #2e7d32; rx: 2; }

        .toolbar {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
            background: var(--header-bg); width: 96%; max-width: 650px; padding: 6px;
            border-radius: 18px; border: 1px solid rgba(128,128,128,0.3);
            display: flex; justify-content: space-around; gap: 4px; z-index: 200;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .btn-tool { flex: 1; height: 42px; border-radius: 12px; font-size: 18px; display: flex; align-items: center; justify-content: center; background: rgba(128,128,128,0.1); transition: all 0.2s; border: none; color: inherit; }
        .btn-tool:disabled { opacity: 0.15; pointer-events: none; }
        
        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
        .btn-modal-action { width: 100%; padding: 14px; border-radius: 12px; font-weight: 900; font-size: 11px; text-transform: uppercase; cursor: pointer; border: none; }
    </style>
</head>
<body>

<header>
    <a href="index.html" id="btn-retour">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1 id="pageTitle">Plan Vectoriel</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="text-lg">üí°</button>
</header>

<div class="main-content">
    <div id="container-retour-liste">
        <a href="outils.html" id="btn-retour-liste">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" /></svg>
            Retour aux outils
        </a>
    </div>

    <div id="canvas-container">
        <svg id="plan-svg" viewBox="0 0 1500 1800" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
            <g id="main-layer"></g>
        </svg>
    </div>
</div>

<div class="toolbar">
    <button class="btn-tool" id="btn-mode" onclick="toggleLock()">üîì</button>
    <button class="btn-tool" id="btn-undo" onclick="undo()">‚Ü∂</button>
    <button class="btn-tool" id="btn-redo" onclick="redo()">‚Ü∑</button>
    <button class="btn-tool" id="btn-shuffle" style="background: var(--theme-color); color: var(--contrast-color);">üîÄ</button>
    <button class="btn-tool" onclick="genererTablesDepuisClasse()" title="G√©n√©rer les tables">‚ûï</button>
    <button class="btn-tool" onclick="confirmerToutEffacer()" title="Tout effacer">üóëÔ∏è</button>
    <button class="btn-tool" onclick="exporterPlan()">üíæ</button>
    <button class="btn-tool" onclick="importerPlan()">üìÇ</button>
    <button class="btn-tool" onclick="exportPDF()" title="T√©l√©charger PDF">üìÑ</button>
</div>

<div id="modal-confirm" class="modal-overlay">
    <div class="modal-content text-center">
        <h2 class="font-black uppercase mb-2">‚ö†Ô∏è Attention</h2>
        <p class="text-xs opacity-70 mb-6 font-semibold">Voulez-vous vraiment supprimer toutes les tables et vider le plan ?</p>
        <div class="flex gap-2">
            <button onclick="fermerConfirm()" class="flex-1 btn-modal-action bg-gray-500/20">Annuler</button>
            <button onclick="toutEffacer()" class="flex-1 btn-modal-action bg-red-600 text-white">Supprimer</button>
        </div>
    </div>
</div>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');

    const mapCouleurs = { 
        'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 
        'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 
        'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 
        'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 
        'rose': '#f43f5e' 
    };

    const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
    const themeColor = mapCouleurs[themePrefs.outils || 'blue'];
    const isDarkText = ['yellow', 'lime', 'amber', 'cyan'].includes(themePrefs.outils || 'blue');
    const contrast = isDarkText ? '#000' : '#fff';

    document.documentElement.style.setProperty('--theme-color', themeColor);
    document.documentElement.style.setProperty('--contrast-color', contrast);

    const uiElements = [
        document.getElementById('btn-retour'),
        document.getElementById('btn-aide'),
        document.getElementById('btn-retour-liste'),
        document.getElementById('btn-shuffle')
    ];
    uiElements.forEach(el => {
        if(el) { el.style.backgroundColor = themeColor; el.style.color = contrast; }
    });

    let isLocked = false;
    let studentData = JSON.parse(localStorage.getItem('plan_vector_v1')) || [];
    let historyStack = [], redoStack = [];
    
    // Vos dimensions souhait√©es
    const SVG_NS = "http://www.w3.org/2000/svg", DESK_W = 200, DESK_H = 120;
    const couleurParNiveau = { 'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308', 'CM1': '#ef4444', 'CM2': '#22c55e', 'AUTRE': '#8b5cf6' };
    const couleurDefautBureau = '#5d4037';

    function pushHistory() {
        historyStack.push(JSON.stringify(studentData));
        if (historyStack.length > 40) historyStack.shift();
        redoStack = []; updateButtons();
    }

    function undo() { if (historyStack.length > 0) { redoStack.push(JSON.stringify(studentData)); studentData = JSON.parse(historyStack.pop()); sync(); } }
    function redo() { if (redoStack.length > 0) { historyStack.push(JSON.stringify(studentData)); studentData = JSON.parse(redoStack.pop()); sync(); } }
    function sync() { localStorage.setItem('plan_vector_v1', JSON.stringify(studentData)); drawPlan(); updateButtons(); }
    
    function updateButtons() { 
        document.getElementById('btn-undo').disabled = historyStack.length === 0; 
        document.getElementById('btn-redo').disabled = redoStack.length === 0; 
    }

    function drawPlan() {
        const layer = document.getElementById('main-layer');
        layer.innerHTML = '';

        // MURS (Plac√©s en premier pour √™tre en dessous des tables)
        const walls = document.createElementNS(SVG_NS, "rect");
        walls.setAttribute("x", 5); walls.setAttribute("y", 5);
        walls.setAttribute("width", 1490); walls.setAttribute("height", 1790);
        walls.setAttribute("fill", "none");
        walls.setAttribute("stroke", "var(--column-border)");
        walls.setAttribute("stroke-width", "10");
        walls.style.pointerEvents = "none"; // Ne bloque pas le clic sur les tables
        layer.appendChild(walls);

        studentData.forEach((student, index) => {
            const g = document.createElementNS(SVG_NS, "g");
            g.setAttribute("class", "desk-group");
            g.setAttribute("id", `desk-${index}`);
            const x = student.x || 200, y = student.y || 200, r = student.r || 0;
            g.setAttribute("transform", `translate(${x},${y}) rotate(${r})`);
            g.setAttribute("data-x", x); g.setAttribute("data-y", y); g.setAttribute("data-r", r);
            
            const couleurBureau = couleurParNiveau[student.niveau] || couleurDefautBureau;
            
            const rect = document.createElementNS(SVG_NS, "rect");
            rect.setAttribute("class", "desk-rect");
            rect.setAttribute("x", -DESK_W/2); rect.setAttribute("y", -DESK_H/2);
            rect.setAttribute("width", DESK_W); rect.setAttribute("height", DESK_H);
            rect.style.fill = couleurBureau;
            rect.setAttribute("data-color", couleurBureau);
            
            const chair = document.createElementNS(SVG_NS, "rect");
            chair.setAttribute("class", "chair-rect");
            chair.setAttribute("x", -30); chair.setAttribute("y", DESK_H/2 + 5);
            chair.setAttribute("width", 60); chair.setAttribute("height", 15);
            
            const text = document.createElementNS(SVG_NS, "text");
            text.setAttribute("class", "desk-label");
            text.textContent = student.name;
            
            g.appendChild(rect); g.appendChild(chair); g.appendChild(text);
            g.addEventListener('dblclick', () => { if(!isLocked) { pushHistory(); student.r = (parseInt(student.r || 0) + 45) % 360; sync(); } });
            layer.appendChild(g);
        });
        setupInteract();
    }

    function setupInteract() {
        interact('.desk-group').draggable({
            onstart: () => { if(!isLocked) pushHistory(); },
            listeners: {
                move(event) {
                    if(isLocked) return;
                    const target = event.target, svg = document.getElementById('plan-svg');
                    const point = svg.createSVGPoint();
                    point.x = event.dx; point.y = event.dy;
                    const ctm = svg.getScreenCTM().inverse();
                    const deltaX = point.x * ctm.a, deltaY = point.y * ctm.d;
                    let x = (parseFloat(target.getAttribute('data-x')) || 0) + deltaX;
                    let y = (parseFloat(target.getAttribute('data-y')) || 0) + deltaY;
                    let r = target.getAttribute('data-r');
                    target.setAttribute('transform', `translate(${x},${y}) rotate(${r})`);
                    target.setAttribute('data-x', x); target.setAttribute('data-y', y);
                },
                end(event) {
                    const idx = event.target.id.split('-')[1];
                    studentData[idx].x = parseFloat(event.target.getAttribute('data-x'));
                    studentData[idx].y = parseFloat(event.target.getAttribute('data-y'));
                    localStorage.setItem('plan_vector_v1', JSON.stringify(studentData));
                }
            }
        });
    }

    function genererTablesDepuisClasse() {
        const listeBrute = localStorage.getItem('maListeEleves');
        if (!listeBrute) { alert("Aucune liste d'√©l√®ves trouv√©e dans 'Ma Classe'."); return; }
        const elevesMaClasse = JSON.parse(listeBrute);
        if (elevesMaClasse.length === 0) { alert("La liste est vide."); return; }
        pushHistory();
        studentData = elevesMaClasse.map((el, i) => {
            const prenom = el.identite.split(' ')[0];
            const existant = studentData.find(s => s.name === prenom);
            if (existant) return { ...existant, niveau: el.niveau };
            return { name: prenom, niveau: el.niveau, x: 220 + ((i % 5) * 260), y: 200 + (Math.floor(i / 5) * 240), r: 0 };
        });
        sync();
    }

    function confirmerToutEffacer() { document.getElementById('modal-confirm').style.display = 'flex'; }
    function fermerConfirm() { document.getElementById('modal-confirm').style.display = 'none'; }
    function toutEffacer() { pushHistory(); studentData = []; sync(); fermerConfirm(); }

    function exportPDF() {
        const svg = document.getElementById('plan-svg');
        const { jsPDF } = window.jspdf;
        const svgClone = svg.cloneNode(true);
        svgClone.style.backgroundColor = "white";
        svgClone.style.backgroundImage = "none";

        const walls = svgClone.querySelector('#main-layer rect:first-child');
        if (walls && !walls.classList.contains('desk-rect')) {
            walls.setAttribute("stroke", "#333333");
            walls.setAttribute("fill", "white");
        }

        svgClone.querySelectorAll('.desk-rect').forEach(rect => {
            const col = rect.getAttribute('data-color') || "black";
            rect.style.fill = "white"; rect.style.stroke = col; rect.style.strokeWidth = "3px";
        });
        svgClone.querySelectorAll('.desk-label').forEach(text => { text.style.fill = "black"; });
        svgClone.querySelectorAll('.chair-rect').forEach(chair => { chair.style.fill = "#eeeeee"; chair.style.stroke = "#999999"; });
        
        const svgData = new XMLSerializer().serializeToString(svgClone);
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        canvas.width = 1500; canvas.height = 1800;
        img.onload = function() {
            ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0);
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [1500, 1800] });
            pdf.addImage(canvas.toDataURL("image/jpeg", 1.0), 'JPEG', 0, 0, 1500, 1800);
            pdf.save("plan_classe.pdf");
        };
        img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgData);
    }

    document.getElementById('btn-shuffle').onclick = function() {
        pushHistory();
        let names = studentData.map(s => ({n: s.name, niv: s.niveau}));
        for (let i = names.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [names[i], names[j]] = [names[j], names[i]];
        }
        studentData.forEach((s, i) => { s.name = names[i].n; s.niveau = names[i].niv; }); sync();
    };

    function toggleLock() {
        isLocked = !isLocked;
        document.getElementById('btn-mode').textContent = isLocked ? 'üîí' : 'üîì';
        document.getElementById('btn-mode').style.background = isLocked ? 'var(--theme-color)' : 'rgba(128,128,128,0.1)';
        document.getElementById('btn-mode').style.color = isLocked ? 'var(--contrast-color)' : 'inherit';
    }

    function exporterPlan() {
        const blob = new Blob([JSON.stringify(studentData)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'plan_classe.json'; a.click();
    }

    function importerPlan() {
        const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.json';
        inp.onchange = e => {
            const r = new FileReader();
            r.onload = ev => { pushHistory(); studentData = JSON.parse(ev.target.result); sync(); };
            r.readAsText(e.target.files[0]);
        };
        inp.click();
    }

    function ouvrirAide() { alert("‚Ä¢ Glisser : d√©placer\n‚Ä¢ Double-clic : pivoter\n‚Ä¢ üîÄ : M√©langer les places\n‚Ä¢ ‚ûï : G√©n√©rer les tables de Ma Classe\n‚Ä¢ üóëÔ∏è : Tout effacer"); }

    drawPlan();
</script>
</body>
</html>