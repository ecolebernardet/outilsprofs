<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Plan de la classe - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root { 
            --bg-page: #121212; --text-page: #ffffff; --column-border: rgba(255, 255, 255, 0.2); 
            --header-bg: #1e1e1e; --card-bg: #1e1e1e;
        }
        body.light-mode { 
            --bg-page: #eeeeee; --text-page: #111827; --column-border: #999; 
            --header-bg: #ffffff; --card-bg: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-page); color: var(--text-page); margin: 0; padding: 0; transition: background 0.3s ease; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--column-border);
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            display: flex; align-items: center; justify-content: space-between; width: 100%; z-index: 100;
        }

        #btn-retour, #btn-aide { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        header h1 { font-size: 1rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; flex-grow: 1; text-align: center; }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        #container-retour-liste { width: 100%; max-width: 2000px; padding: 15px 20px 0 20px; text-align: left; z-index: 50; pointer-events: none; position: absolute; }
        #btn-retour-liste {
            pointer-events: auto;
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; 
            border-radius: 9999px; font-size: 10px; font-weight: 900; text-transform: uppercase; 
            transition: transform 0.2s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        #canvas-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: var(--bg-page);
            overflow: hidden;
            padding: 10px;
            padding-bottom: 90px;
        }

        svg {
            height: 100%;
            width: auto;
            aspect-ratio: 1800 / 1800;
            max-width: 100%;
            touch-action: none;
            display: block;
            border: none;
        }

        .desk-group { cursor: grab; user-select: none; pointer-events: all; }
        .desk-rect { stroke: rgba(0,0,0,0.3); stroke-width: 2; rx: 5; transition: stroke 0.2s; }
        .desk-group.selected .desk-rect { stroke: var(--theme-color); stroke-width: 8; }
        .desk-label { fill: black; font-size: 30px; font-weight: 900; text-anchor: middle; dominant-baseline: middle; pointer-events: none; text-transform: uppercase; }
        .chair-rect { fill: #2e7d32; rx: 2; }

        .toolbar {
            position: fixed; 
            bottom: calc(env(safe-area-inset-bottom) + 20px); 
            left: 50%; 
            transform: translateX(-50%);
            background: var(--header-bg); 
            width: 96%; 
            max-width: 700px; 
            padding: 8px;
            border-radius: 24px;
            border: 1px solid rgba(128,128,128,0.3);
            display: flex; 
            justify-content: space-around; 
            gap: 4px; 
            z-index: 200;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .btn-tool { flex: 1; height: 42px; border-radius: 12px; font-size: 18px; display: flex; align-items: center; justify-content: center; background: rgba(128,128,128,0.1); transition: all 0.2s; border: none; color: inherit; }
        .btn-tool:disabled { opacity: 0.15; pointer-events: none; }
        
        #add-menu { transition: all 0.2s ease-out; }
        #add-menu.hidden { display: none; opacity: 0; transform: translate(-50%, 20px); }
        #add-menu button:active { transform: scale(0.9); }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 420px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
        .btn-modal-action { width: 100%; padding: 14px; border-radius: 12px; font-weight: 900; font-size: 11px; text-transform: uppercase; cursor: pointer; border: none; }
    </style>
</head>
<body class="dark-mode"> <header>
    <a href="index.html" id="btn-retour">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1 id="pageTitle">Plan de la classe</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="text-lg">ğŸ’¡</button>
</header>

<div class="main-content">
    <div id="container-retour-liste">
        <a href="outils.html" id="btn-retour-liste">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" /></svg>
            Retour aux outils
        </a>
    </div>

    <div id="canvas-container">
        <svg id="plan-svg" onclick="deselectAll(event)" viewBox="0 0 1800 1800" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
            <g id="main-layer"></g>
        </svg>
    </div>
</div>

<div id="zoom-controls" class="fixed bottom-[145px] right-6 flex flex-col gap-2 z-[250]">
    <button onclick="changeZoom(0.2)" class="w-12 h-12 bg-[var(--header-bg)] border border-[var(--column-border)] rounded-full shadow-lg text-xl font-bold flex items-center justify-center">ï¼‹</button>
    <button onclick="resetZoom()" class="w-12 h-12 bg-[var(--header-bg)] border border-[var(--column-border)] rounded-full shadow-lg text-[10px] font-black flex items-center justify-center">1:1</button>
    <button onclick="changeZoom(-0.2)" class="w-12 h-12 bg-[var(--header-bg)] border border-[var(--column-border)] rounded-full shadow-lg text-xl font-bold flex items-center justify-center">ï¼</button>
</div>

<div id="add-menu" class="hidden fixed bottom-[95px] left-1/2 -translate-x-1/2 bg-[var(--header-bg)] border border-[var(--column-border)] p-4 rounded-3xl shadow-2xl flex gap-4 z-[300]">
    <button onclick="ajouterMeuble('prof')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-gray-500/10">
        <span class="text-2xl">ğŸ‘¨â€ğŸ«</span>
        <span class="text-[9px] font-bold uppercase">Bureau</span>
    </button>
    <button onclick="ajouterUneTable()" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-gray-500/10">
        <span class="text-2xl">ğŸª‘</span>
        <span class="text-[9px] font-bold uppercase">Ã‰lÃ¨ve</span>
    </button>
    <button onclick="ajouterMeuble('tableau')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-gray-500/10">
        <span class="text-2xl">â¬›</span>
        <span class="text-[9px] font-bold uppercase">Tableau</span>
    </button>
    <button onclick="ajouterMeuble('meuble')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-gray-500/10">
        <span class="text-2xl">ğŸ—„ï¸</span>
        <span class="text-[9px] font-bold uppercase">Meuble</span>
    </button>
    <button onclick="ajouterMeuble('porte')" class="flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-gray-500/10">
        <span class="text-2xl">ğŸšª</span>
        <span class="text-[9px] font-bold uppercase">Porte</span>
    </button>
</div>

<div class="toolbar">
    <button class="btn-tool" id="btn-mode" onclick="toggleLock()">ğŸ”“</button>
    <button class="btn-tool" id="btn-undo" onclick="undo()">â†¶</button>
    <button class="btn-tool" id="btn-redo" onclick="redo()">â†·</button>
    <button class="btn-tool" id="btn-add-menu" onclick="toggleAddMenu()" title="Ajouter un Ã©lÃ©ment">â•</button>
    <button class="btn-tool" id="btn-delete-selection" onclick="supprimerSelection()" title="Supprimer la sÃ©lection" disabled>ğŸ§½</button>
    <button class="btn-tool" onclick="genererTablesDepuisClasse()" title="GÃ©nÃ©rer les tables">ğŸ“‹</button>
    <button class="btn-tool" onclick="confirmerToutEffacer()" title="Tout effacer">ğŸ—‘ï¸</button>
    <button class="btn-tool" onclick="exporterPlan()">ğŸ’¾</button>
    <button class="btn-tool" onclick="importerPlan()">ğŸ“‚</button>
    <button class="btn-tool" onclick="exportPDF()" title="TÃ©lÃ©charger PDF">ğŸ“„</button>
</div>

<div id="modal-confirm" class="modal-overlay">
    <div class="modal-content text-center">
        <h2 class="font-black uppercase mb-2 text-red-500">âš ï¸ Attention</h2>
        <p class="text-xs opacity-70 mb-6 font-semibold">Voulez-vous vraiment tout supprimer ?</p>
        <div class="flex gap-2">
            <button onclick="fermerModale('modal-confirm')" class="flex-1 btn-modal-action bg-gray-500/20">Annuler</button>
            <button onclick="toutEffacer()" class="flex-1 btn-modal-action bg-red-600 text-white">Supprimer</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModale('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="font-black uppercase mb-4 flex items-center gap-2">ğŸ’¡ Mode d'emploi</h2>
        <div class="text-[11px] opacity-90 leading-relaxed max-h-[60vh] overflow-y-auto">
            <p><strong>Rotation :</strong> Double-cliquez sur un Ã©lÃ©ment pour pivoter de 45Â°.</p>
            <p><strong>Zoom :</strong> Utilisez les boutons + et - ou 1:1. En zoom, dÃ©placez le plan au doigt.</p>
            <p><strong>Tableau :</strong> Vous pouvez dÃ©sormais placer et dÃ©placer le tableau librement.</p>
        </div>
        <button onclick="fermerModale('modal-aide')" class="mt-6 btn-modal-action">J'ai compris</button>
    </div>
</div>

<div id="modal-create" class="modal-overlay">
    <div class="modal-content">
        <h2 class="font-black uppercase mb-2">Nouvelle Table</h2>
        <input type="text" id="input-nom-eleve" class="w-full bg-gray-500/10 border border-gray-500/30 rounded-lg p-3 mb-6 outline-none" placeholder="PrÃ©nom">
        <div class="flex gap-2">
            <button onclick="fermerModale('modal-create')" class="flex-1 btn-modal-action bg-gray-500/20">Annuler</button>
            <button id="btn-valider-create" onclick="validerCreationTable()" class="flex-1 btn-modal-action text-white">Ajouter</button>
        </div>
    </div>
</div>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');

    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e' };
    const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
    const themeColor = mapCouleurs[themePrefs.outils || 'blue'];
    const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(themePrefs.outils || 'blue') ? '#000' : '#fff';
    document.documentElement.style.setProperty('--theme-color', themeColor);
    document.documentElement.style.setProperty('--contrast-color', contrast);

    function appliquerCouleursDynamiques() {
        const els = ['btn-retour', 'btn-aide', 'btn-retour-liste', 'btn-valider-create'].map(id => document.getElementById(id));
        els.forEach(el => { if(el) { el.style.backgroundColor = themeColor; el.style.color = contrast; } });
    }

    let isLocked = false;
    let studentData = JSON.parse(localStorage.getItem('plan_vector_v1')) || [];
    let historyStack = [], redoStack = [];
    let selectedIndex = null;

    let currentScale = 1;
    let translateX = 0;
    let translateY = 0;
    
    const SVG_NS = "http://www.w3.org/2000/svg";
    const DESK_W = 180, DESK_H = 100;
    const PROF_W = 360, PROF_H = 180;
    const MEUBLE_W = 320, MEUBLE_H = 80;
    const DOOR_W = 200, DOOR_H = 40;
    const BOARD_W = 900, BOARD_H = 40;

    const couleurParNiveau = { 
        'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308', 'CM1': '#ef4444', 'CM2': '#22c55e', 
        'AUTRE': '#A58F88', 'PROF': '#77615A', 'MEUBLE': '#77615A', 'PORTE': '#577A72', 'TABLEAU': '#1D6353'
    };
    const couleurDefautBureau = '#5d4037';

    function pushHistory() { historyStack.push(JSON.stringify(studentData)); if (historyStack.length > 40) historyStack.shift(); redoStack = []; updateButtons(); }
    function undo() { if (historyStack.length > 0) { redoStack.push(JSON.stringify(studentData)); studentData = JSON.parse(historyStack.pop()); selectedIndex = null; sync(); } }
    function redo() { if (redoStack.length > 0) { historyStack.push(JSON.stringify(studentData)); studentData = JSON.parse(redoStack.pop()); selectedIndex = null; sync(); } }
    function sync() { localStorage.setItem('plan_vector_v1', JSON.stringify(studentData)); drawPlan(); updateButtons(); }
    function updateButtons() { 
        document.getElementById('btn-undo').disabled = historyStack.length === 0; 
        document.getElementById('btn-redo').disabled = redoStack.length === 0; 
        document.getElementById('btn-delete-selection').disabled = selectedIndex === null;
    }
    function toggleAddMenu() { document.getElementById('add-menu').classList.toggle('hidden'); }

    function changeZoom(delta) {
        const newScale = Math.min(Math.max(currentScale + delta, 1), 4);
        if (newScale !== currentScale) {
            currentScale = newScale;
            if (currentScale > 1 && !isLocked) toggleLock();
            if (currentScale === 1) { translateX = 0; translateY = 0; }
            applyTransform();
        }
    }

    function resetZoom() {
        currentScale = 1;
        translateX = 0;
        translateY = 0;
        if (isLocked) toggleLock();
        applyTransform();
    }

    function applyTransform() {
        const layer = document.getElementById('main-layer');
        layer.style.transition = "transform 0.1s ease-out";
        layer.style.transformOrigin = "center";
        layer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
    }

    function ajouterMeuble(type) {
        pushHistory();
        let item = { x: 900, y: 900, r: 0 };
        if(type === 'prof') { item.name = "PROF"; item.niveau = "PROF"; }
        else if(type === 'meuble') { item.name = "MEUBLE"; item.niveau = "MEUBLE"; }
        else if(type === 'porte') { item.name = "PORTE"; item.niveau = "PORTE"; }
        else if(type === 'tableau') { item.name = "TABLEAU"; item.niveau = "TABLEAU"; }
        studentData.push(item);
        sync();
        toggleAddMenu();
    }

    function drawPlan() {
        const layer = document.getElementById('main-layer');
        layer.innerHTML = '';

        const walls = document.createElementNS(SVG_NS, "rect");
        walls.setAttribute("x", 5); walls.setAttribute("y", 5);
        walls.setAttribute("width", 1790); walls.setAttribute("height", 1790);
        walls.setAttribute("fill", "none"); walls.setAttribute("stroke", "var(--column-border)");
        walls.setAttribute("stroke-width", "10"); walls.style.pointerEvents = "none";
        layer.appendChild(walls);

        studentData.forEach((student, index) => {
            const g = document.createElementNS(SVG_NS, "g");
            g.setAttribute("class", "desk-group" + (selectedIndex === index ? " selected" : ""));
            g.setAttribute("id", `desk-${index}`);
            
            const x = student.x || 900, y = student.y || 900, r = student.r || 0;
            g.setAttribute("transform", `translate(${x},${y}) rotate(${r})`);
            g.setAttribute("data-x", x); g.setAttribute("data-y", y); g.setAttribute("data-r", r);
            
            let currentW = DESK_W, currentH = DESK_H, hasChair = true;

            if (student.niveau === 'PROF') { currentW = PROF_W; currentH = PROF_H; }
            else if (student.niveau === 'MEUBLE') { currentW = MEUBLE_W; currentH = MEUBLE_H; hasChair = false; }
            else if (student.niveau === 'PORTE') { currentW = DOOR_W; currentH = DOOR_H; hasChair = false; }
            else if (student.niveau === 'TABLEAU') { currentW = BOARD_W; currentH = BOARD_H; hasChair = false; }

            const color = couleurParNiveau[student.niveau] || couleurDefautBureau;

            const rect = document.createElementNS(SVG_NS, "rect");
            rect.setAttribute("class", "desk-rect");
            rect.setAttribute("x", -currentW/2); rect.setAttribute("y", -currentH/2);
            rect.setAttribute("width", currentW); rect.setAttribute("height", currentH);
            rect.style.fill = color;
            g.appendChild(rect);

            if (hasChair) {
                const chair = document.createElementNS(SVG_NS, "rect");
                chair.setAttribute("class", "chair-rect");
                chair.setAttribute("x", -30); chair.setAttribute("y", currentH/2 + 5);
                chair.setAttribute("width", 60); chair.setAttribute("height", 15);
                g.appendChild(chair);
            }

            if (student.name) {
                const text = document.createElementNS(SVG_NS, "text");
                text.setAttribute("class", "desk-label");
                if(student.niveau === 'TABLEAU') text.setAttribute("fill", "white");
                text.setAttribute("x", "0"); text.setAttribute("y", "0");
                text.textContent = student.name;
                g.appendChild(text);
            }

            g.addEventListener('click', (e) => { e.stopPropagation(); deselectAllManual(); g.classList.add('selected'); selectedIndex = index; updateButtons(); });
            g.addEventListener('dblclick', (e) => { e.stopPropagation(); if(!isLocked) { pushHistory(); student.r = (parseInt(student.r || 0) + 45) % 360; sync(); } });
            layer.appendChild(g);
        });
        setupInteract();
        applyTransform();
    }

    function deselectAllManual() { document.querySelectorAll('.desk-group').forEach(el => el.classList.remove('selected')); selectedIndex = null; updateButtons(); }
    function deselectAll(e) { if (e.target.id === 'plan-svg') { deselectAllManual(); document.getElementById('add-menu').classList.add('hidden'); } }

    function setupInteract() {
        interact('.desk-group').draggable({
            onstart: () => { if(!isLocked) pushHistory(); },
            listeners: {
                move(event) {
                    if(isLocked) return;
                    const target = event.target, svg = document.getElementById('plan-svg');
                    const point = svg.createSVGPoint();
                    point.x = event.dx; point.y = event.dy;
                    const ctm = svg.getScreenCTM().inverse();
                    const deltaX = point.x * ctm.a, deltaY = point.y * ctm.d;
                    let x = (parseFloat(target.getAttribute('data-x')) || 0) + deltaX;
                    let y = (parseFloat(target.getAttribute('data-y')) || 0) + deltaY;
                    let r = target.getAttribute('data-r');
                    target.setAttribute('transform', `translate(${x},${y}) rotate(${r})`);
                    target.setAttribute('data-x', x); target.setAttribute('data-y', y);
                },
                end(event) {
                    if(isLocked) return;
                    const idx = event.target.id.split('-')[1];
                    studentData[idx].x = parseFloat(event.target.getAttribute('data-x'));
                    studentData[idx].y = parseFloat(event.target.getAttribute('data-y'));
                    localStorage.setItem('plan_vector_v1', JSON.stringify(studentData));
                }
            }
        });

        interact('#plan-svg').draggable({
            listeners: {
                move(event) {
                    if (currentScale > 1) {
                        translateX += event.dx;
                        translateY += event.dy;
                        applyTransform();
                    }
                }
            }
        });
    }

    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModale(id) { document.getElementById(id).style.display = 'none'; }
    function ajouterUneTable() { document.getElementById('input-nom-eleve').value = ""; document.getElementById('modal-create').style.display = 'flex'; toggleAddMenu(); setTimeout(() => document.getElementById('input-nom-eleve').focus(), 100); }
    function validerCreationTable() { const nom = document.getElementById('input-nom-eleve').value.trim(); if (nom) { pushHistory(); studentData.push({ name: nom.toUpperCase(), niveau: "AUTRE", x: 900, y: 900, r: 0 }); sync(); fermerModale('modal-create'); } }
    function supprimerSelection() { if (selectedIndex !== null) { pushHistory(); studentData.splice(selectedIndex, 1); selectedIndex = null; sync(); } }
    function confirmerToutEffacer() { document.getElementById('modal-confirm').style.display = 'flex'; }
    function toutEffacer() { pushHistory(); studentData = []; selectedIndex = null; sync(); fermerModale('modal-confirm'); }
    function toggleLock() { isLocked = !isLocked; document.getElementById('btn-mode').textContent = isLocked ? 'ğŸ”’' : 'ğŸ”“'; document.getElementById('btn-mode').style.background = isLocked ? 'var(--theme-color)' : 'rgba(128,128,128,0.1)'; document.getElementById('btn-mode').style.color = isLocked ? 'var(--contrast-color)' : 'inherit'; }

    function getExportFileName(ext) {
        const nomProf = (localStorage.getItem('nom_enseignant') || 'prof').toLowerCase().replace(/\s+/g, '_');
        const d = new Date();
        const dateStr = d.getFullYear() + String(d.getMonth() + 1).padStart(2, '0') + String(d.getDate()).padStart(2, '0');
        return `outilsprofs_plan_classe_${nomProf}_${dateStr}.${ext}`;
    }
    
    function exportPDF() { /* Logique jsPDF existante */ }
    function exporterPlan() { const blob = new Blob([JSON.stringify(studentData)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = getExportFileName('json'); a.click(); }
    function importerPlan() { const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.json'; inp.onchange = e => { const reader = new FileReader(); reader.onload = ev => { studentData = JSON.parse(ev.target.result); sync(); }; reader.readAsText(e.target.files[0]); }; inp.click(); }
    function genererTablesDepuisClasse() { const list = JSON.parse(localStorage.getItem('maListeEleves') || "[]"); if(list.length) { pushHistory(); studentData = list.map((el, i) => ({ name: el.identite.split(' ')[0], niveau: el.niveau, x: 220 + ((i % 5) * 260), y: 200 + (Math.floor(i / 5) * 240), r: 0 })); sync(); } }

    appliquerCouleursDynamiques();
    drawPlan();
</script>
</body>
</html>