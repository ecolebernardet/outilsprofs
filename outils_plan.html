<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Plan de la classe - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root { 
            --bg-page: #121212; --text-page: #ffffff; --column-border: rgba(255, 255, 255, 0.2); 
            --header-bg: #1e1e1e; --card-bg: #1e1e1e;
        }
        body.light-mode { 
            --bg-page: #eeeeee; --text-page: #111827; --column-border: #999; 
            --header-bg: #ffffff; --card-bg: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-page); color: var(--text-page); margin: 0; padding: 0; transition: background 0.3s ease; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        header { 
            background: var(--header-bg); border-bottom: 1px solid var(--column-border);
            padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            display: flex; align-items: center; justify-content: space-between; width: 100%; z-index: 100;
        }

        #btn-retour, #btn-aide { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        header h1 { font-size: 1rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; flex-grow: 1; text-align: center; }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        #container-retour-liste { width: 100%; max-width: 2000px; padding: 15px 20px 0 20px; text-align: left; z-index: 50; pointer-events: none; position: absolute; }
        #btn-retour-liste {
            pointer-events: auto;
            display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; 
            border-radius: 9999px; font-size: 10px; font-weight: 900; text-transform: uppercase; 
            transition: transform 0.2s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        #canvas-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: var(--bg-page);
            overflow: hidden;
            padding: 10px;
            padding-bottom: 90px;
        }

        svg {
            height: 100%;
            width: auto;
            aspect-ratio: 1800 / 1800;
            max-width: 100%;
            background-image: radial-gradient(rgba(128,128,128,0.2) 1.5px, transparent 1.5px);
            background-size: 40px 40px;
            touch-action: none;
            display: block;
            border: none;
        }

        body.light-mode svg { background-image: radial-gradient(rgba(0,0,0,0.1) 1.5px, transparent 1.5px); }

        .desk-group { cursor: grab; user-select: none; pointer-events: all; }
        .desk-rect { stroke: rgba(0,0,0,0.3); stroke-width: 2; rx: 5; transition: stroke 0.2s; }
        .desk-group.selected .desk-rect { stroke: var(--theme-color); stroke-width: 8; }
        .desk-label { fill: black; font-size: 30px; font-weight: 900; text-anchor: middle; dominant-baseline: middle; pointer-events: none; text-transform: uppercase; }
        .chair-rect { fill: #2e7d32; rx: 2; }

        .toolbar {
            position: fixed; 
            /* On remplace bottom: 15px par un calcul dynamique */
            bottom: calc(env(safe-area-inset-bottom) + 20px); 
            left: 50%; 
            transform: translateX(-50%);
            background: var(--header-bg); 
            width: 96%; 
            max-width: 700px; 
            padding: 8px; /* Un peu plus de padding pour le confort */
            border-radius: 24px; /* Arrondi plus prononcÃ© pour un look moderne */
            border: 1px solid rgba(128,128,128,0.3);
            display: flex; 
            justify-content: space-around; 
            gap: 4px; 
            z-index: 200;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .btn-tool { flex: 1; height: 42px; border-radius: 12px; font-size: 18px; display: flex; align-items: center; justify-content: center; background: rgba(128,128,128,0.1); transition: all 0.2s; border: none; color: inherit; }
        .btn-tool:disabled { opacity: 0.15; pointer-events: none; }
        
        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 420px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
        .btn-modal-action { width: 100%; padding: 14px; border-radius: 12px; font-weight: 900; font-size: 11px; text-transform: uppercase; cursor: pointer; border: none; }
    </style>
</head>
<body>

<header>
    <a href="index.html" id="btn-retour">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1 id="pageTitle">Plan de la classe</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="text-lg">ğŸ’¡</button>
</header>

<div class="main-content">
    <div id="container-retour-liste">
        <a href="outils.html" id="btn-retour-liste">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" /></svg>
            Retour aux outils
        </a>
    </div>

    <div id="canvas-container">
        <svg id="plan-svg" onclick="deselectAll(event)" viewBox="0 0 1800 1800" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
            <g id="main-layer"></g>
        </svg>
    </div>
</div>

<div class="toolbar">
    <button class="btn-tool" id="btn-mode" onclick="toggleLock()">ğŸ”“</button>
    <button class="btn-tool" id="btn-undo" onclick="undo()">â†¶</button>
    <button class="btn-tool" id="btn-redo" onclick="redo()">â†·</button>
    <button class="btn-tool" onclick="ajouterUneTable()" title="Ajouter une table">ğŸª‘</button>
    <button class="btn-tool" id="btn-delete-selection" onclick="supprimerSelection()" title="Supprimer la sÃ©lection" disabled>ğŸ§½</button>
    <button class="btn-tool" onclick="genererTablesDepuisClasse()" title="GÃ©nÃ©rer les tables">â•</button>
    <button class="btn-tool" onclick="confirmerToutEffacer()" title="Tout effacer">ğŸ—‘ï¸</button>
    <button class="btn-tool" onclick="exporterPlan()">ğŸ’¾</button>
    <button class="btn-tool" onclick="importerPlan()">ğŸ“‚</button>
    <button class="btn-tool" onclick="exportPDF()" title="TÃ©lÃ©charger PDF">ğŸ“„</button>
</div>

<div id="modal-confirm" class="modal-overlay">
    <div class="modal-content text-center">
        <h2 class="font-black uppercase mb-2 text-red-500">âš ï¸ Attention</h2>
        <p class="text-xs opacity-70 mb-6 font-semibold">Voulez-vous vraiment supprimer toutes les tables et vider le plan ?</p>
        <div class="flex gap-2">
            <button onclick="fermerModale('modal-confirm')" class="flex-1 btn-modal-action bg-gray-500/20">Annuler</button>
            <button onclick="toutEffacer()" class="flex-1 btn-modal-action bg-red-600 text-white">Supprimer</button>
        </div>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModale('modal-aide')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 class="font-black uppercase mb-4 flex items-center gap-2">
            <span class="text-xl">ğŸ’¡</span> Mode d'emploi
        </h2>
        <div class="text-[11px] space-y-4 opacity-90 leading-relaxed overflow-y-auto max-h-[60vh] pr-2">
            <section>
                <p class="font-bold text-blue-500 uppercase mb-1 border-b border-blue-500/20">ğŸ–±ï¸ Manipulation</p>
                <ul class="list-disc pl-4 space-y-1">
                    <li><strong>SÃ©lection :</strong> Cliquez une fois sur une table.</li>
                    <li><strong>DÃ©placement :</strong> Maintenez et glissez une table.</li>
                    <li><strong>Rotation :</strong> Double-cliquez pour pivoter de 45Â°.</li>
                </ul>
            </section>
            <section>
                <p class="font-bold text-green-500 uppercase mb-1 border-b border-green-500/20">ğŸ› ï¸ Barre d'outils</p>
                <ul class="space-y-1">
                    <li><strong>ğŸ”“ / ğŸ”’ :</strong> Verrouille les tables pour figer le plan.</li>
                    <li><strong>ğŸª‘ Ajouter :</strong> CrÃ©er une table individuelle (nommÃ©e).</li>
                    <li><strong>ğŸ§½ Supprimer :</strong> Supprime la table sÃ©lectionnÃ©e.</li>
                    <li><strong>â• GÃ©nÃ©rer :</strong> Importe les Ã©lÃ¨ves de "Ma Classe".</li>
                    <li><strong>ğŸ—‘ï¸ Vider :</strong> Efface tout le plan.</li>
                </ul>
            </section>
            <section>
                <p class="font-bold text-purple-500 uppercase mb-1 border-b border-purple-500/20">ğŸ’¾ Export</p>
                <ul class="space-y-1">
                    <li><strong>ğŸ’¾ / ğŸ“‚ :</strong> Sauvegarde/Charge le fichier .json.</li>
                    <li><strong>ğŸ“„ PDF :</strong> Version imprimable (fond blanc).</li>
                </ul>
            </section>
        </div>
        <button id="btn-close-aide" onclick="fermerModale('modal-aide')" class="mt-6 btn-modal-action">J'ai compris</button>
    </div>
</div>

<div id="modal-create" class="modal-overlay">
    <div class="modal-content">
        <h2 class="font-black uppercase mb-2">Nouvelle Table</h2>
        <p class="text-[10px] opacity-60 mb-4 font-semibold uppercase">PrÃ©nom de l'Ã©lÃ¨ve</p>
        <input type="text" id="input-nom-eleve" class="w-full bg-gray-500/10 border border-gray-500/30 rounded-lg p-3 mb-6 outline-none focus:border-[var(--theme-color)]" placeholder="Ex: Jean">
        <div class="flex gap-2">
            <button onclick="fermerModale('modal-create')" class="flex-1 btn-modal-action bg-gray-500/20">Annuler</button>
            <button id="btn-valider-create" onclick="validerCreationTable()" class="flex-1 btn-modal-action">Ajouter</button>
        </div>
    </div>
</div>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');

    const mapCouleurs = { 
        'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 
        'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 
        'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 
        'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 
        'rose': '#f43f5e' 
    };

    const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
    const themeColor = mapCouleurs[themePrefs.outils || 'blue'];
    const isDarkText = ['yellow', 'lime', 'amber', 'cyan'].includes(themePrefs.outils || 'blue');
    const contrast = isDarkText ? '#000' : '#fff';

    document.documentElement.style.setProperty('--theme-color', themeColor);
    document.documentElement.style.setProperty('--contrast-color', contrast);

    // Initialisation couleurs dynamiques
    function appliquerCouleursDynamiques() {
        const uiElements = [
            document.getElementById('btn-retour'),
            document.getElementById('btn-aide'),
            document.getElementById('btn-retour-liste')
        ];
        uiElements.forEach(el => {
            if(el) { el.style.backgroundColor = themeColor; el.style.color = contrast; }
        });
        
        // Boutons de validation des modales
        const validButtons = [document.getElementById('btn-close-aide'), document.getElementById('btn-valider-create')];
        validButtons.forEach(btn => {
            if(btn) { btn.style.backgroundColor = themeColor; btn.style.color = contrast; }
        });
    }

    let isLocked = false;
    let studentData = JSON.parse(localStorage.getItem('plan_vector_v1')) || [];
    let historyStack = [], redoStack = [];
    let selectedIndex = null;
    
    const SVG_NS = "http://www.w3.org/2000/svg", DESK_W = 200, DESK_H = 120;
    const couleurParNiveau = { 'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308', 'CM1': '#ef4444', 'CM2': '#22c55e', 'AUTRE': '#8b5cf6' };
    const couleurDefautBureau = '#5d4037';

    function pushHistory() {
        historyStack.push(JSON.stringify(studentData));
        if (historyStack.length > 40) historyStack.shift();
        redoStack = []; updateButtons();
    }

    function undo() { if (historyStack.length > 0) { redoStack.push(JSON.stringify(studentData)); studentData = JSON.parse(historyStack.pop()); selectedIndex = null; sync(); } }
    function redo() { if (redoStack.length > 0) { historyStack.push(JSON.stringify(studentData)); studentData = JSON.parse(redoStack.pop()); selectedIndex = null; sync(); } }
    function sync() { localStorage.setItem('plan_vector_v1', JSON.stringify(studentData)); drawPlan(); updateButtons(); }
    
    function updateButtons() { 
        document.getElementById('btn-undo').disabled = historyStack.length === 0; 
        document.getElementById('btn-redo').disabled = redoStack.length === 0; 
        document.getElementById('btn-delete-selection').disabled = selectedIndex === null;
    }

    function drawPlan() {
        const layer = document.getElementById('main-layer');
        layer.innerHTML = '';

        const walls = document.createElementNS(SVG_NS, "rect");
        walls.setAttribute("x", 5); walls.setAttribute("y", 5);
        walls.setAttribute("width", 1790); walls.setAttribute("height", 1790);
        walls.setAttribute("fill", "none");
        walls.setAttribute("stroke", "var(--column-border)");
        walls.setAttribute("stroke-width", "10");
        walls.style.pointerEvents = "none";
        layer.appendChild(walls);

		// --- AJOUT DU TABLEAU ---
        const boardW = 900; // 50% de 1800px
        const boardH = 40;  // Ã‰paisseur du tableau
        const board = document.createElementNS(SVG_NS, "rect");
        board.setAttribute("x", (1800 - boardW) / 2); // Centrage horizontal
        board.setAttribute("y", 10); // PlaquÃ© contre le mur du haut
        board.setAttribute("width", boardW);
        board.setAttribute("height", boardH);
        board.setAttribute("rx", "5"); // Coins lÃ©gÃ¨rement arrondis
        // Style : On utilise une couleur grise ou le thÃ¨me
        board.setAttribute("fill", "#4b5563"); 
        board.setAttribute("stroke", "var(--column-border)");
        board.setAttribute("stroke-width", "2");
        layer.appendChild(board);

        // Texte "TABLEAU" (optionnel)
        const boardText = document.createElementNS(SVG_NS, "text");
        boardText.setAttribute("x", 900);
        boardText.setAttribute("y", 35);
        boardText.setAttribute("text-anchor", "middle");
        boardText.setAttribute("fill", "white");
        boardText.style.fontSize = "20px";
        boardText.style.fontWeight = "900";
        boardText.style.pointerEvents = "none";
        boardText.textContent = "TABLEAU";
        layer.appendChild(boardText);
        // --- FIN AJOUT TABLEAU ---
		
        studentData.forEach((student, index) => {
            const g = document.createElementNS(SVG_NS, "g");
            g.setAttribute("class", "desk-group" + (selectedIndex === index ? " selected" : ""));
            g.setAttribute("id", `desk-${index}`);
            const x = student.x || 200, y = student.y || 200, r = student.r || 0;
            g.setAttribute("transform", `translate(${x},${y}) rotate(${r})`);
            g.setAttribute("data-x", x); g.setAttribute("data-y", y); g.setAttribute("data-r", r);
            
            const couleurBureau = couleurParNiveau[student.niveau] || couleurDefautBureau;
            const rect = document.createElementNS(SVG_NS, "rect");
            rect.setAttribute("class", "desk-rect");
            rect.setAttribute("x", -DESK_W/2); rect.setAttribute("y", -DESK_H/2);
            rect.setAttribute("width", DESK_W); rect.setAttribute("height", DESK_H);
            rect.style.fill = couleurBureau;
            rect.setAttribute("data-color", couleurBureau);
            
            const chair = document.createElementNS(SVG_NS, "rect");
            chair.setAttribute("class", "chair-rect");
            chair.setAttribute("x", -30); chair.setAttribute("y", DESK_H/2 + 5);
            chair.setAttribute("width", 60); chair.setAttribute("height", 15);
            
            const text = document.createElementNS(SVG_NS, "text");
            text.setAttribute("class", "desk-label");
			text.setAttribute("x", "0"); // Centre par rapport au milieu du groupe
			text.setAttribute("y", "0"); // Aligne verticalement au centre du groupe
			text.setAttribute("text-anchor", "middle"); // Doublon de sÃ©curitÃ© pour le PDF
			text.setAttribute("dominant-baseline", "central"); // Centrage vertical prÃ©cis
            text.textContent = student.name;
            
            g.appendChild(rect); g.appendChild(chair); g.appendChild(text);

            g.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.desk-group').forEach(el => el.classList.remove('selected'));
                g.classList.add('selected');
                selectedIndex = index;
                updateButtons();
            });

            g.addEventListener('dblclick', (e) => { 
                e.stopPropagation();
                if(!isLocked) { pushHistory(); student.r = (parseInt(student.r || 0) + 45) % 360; sync(); } 
            });

            layer.appendChild(g);
        });
        setupInteract();
    }

    function deselectAll(e) {
        if (e.target.id === 'plan-svg') {
            selectedIndex = null;
            document.querySelectorAll('.desk-group').forEach(el => el.classList.remove('selected'));
            updateButtons();
        }
    }

    function setupInteract() {
        interact('.desk-group').draggable({
            onstart: () => { if(!isLocked) pushHistory(); },
            listeners: {
                move(event) {
                    if(isLocked) return;
                    const target = event.target, svg = document.getElementById('plan-svg');
                    const point = svg.createSVGPoint();
                    point.x = event.dx; point.y = event.dy;
                    const ctm = svg.getScreenCTM().inverse();
                    const deltaX = point.x * ctm.a, deltaY = point.y * ctm.d;
                    let x = (parseFloat(target.getAttribute('data-x')) || 0) + deltaX;
                    let y = (parseFloat(target.getAttribute('data-y')) || 0) + deltaY;
                    let r = target.getAttribute('data-r');
                    target.setAttribute('transform', `translate(${x},${y}) rotate(${r})`);
                    target.setAttribute('data-x', x); target.setAttribute('data-y', y);
                },
                end(event) {
                    const idx = event.target.id.split('-')[1];
                    studentData[idx].x = parseFloat(event.target.getAttribute('data-x'));
                    studentData[idx].y = parseFloat(event.target.getAttribute('data-y'));
                    localStorage.setItem('plan_vector_v1', JSON.stringify(studentData));
                }
            }
        });
    }

    // Fonctions Modales
    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModale(id) { document.getElementById(id).style.display = 'none'; }

    function ajouterUneTable() {
        const input = document.getElementById('input-nom-eleve');
        input.value = "";
        document.getElementById('modal-create').style.display = 'flex';
        setTimeout(() => input.focus(), 100);
    }

    function validerCreationTable() {
        const nom = document.getElementById('input-nom-eleve').value.trim();
        if (nom) {
            pushHistory();
            studentData.push({ name: nom.toUpperCase(), niveau: "AUTRE", x: 750, y: 900, r: 0 });
            sync();
            fermerModale('modal-create');
        }
    }

    document.getElementById('input-nom-eleve').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') validerCreationTable();
    });

    function supprimerSelection() {
        if (selectedIndex !== null) {
            pushHistory();
            studentData.splice(selectedIndex, 1);
            selectedIndex = null;
            sync();
        }
    }

    function genererTablesDepuisClasse() {
        const listeBrute = localStorage.getItem('maListeEleves');
        if (!listeBrute) { alert("Aucune liste d'Ã©lÃ¨ves trouvÃ©e."); return; }
        const eleves = JSON.parse(listeBrute);
        pushHistory();
        studentData = eleves.map((el, i) => {
            const prenom = el.identite.split(' ')[0];
            return { name: prenom, niveau: el.niveau, x: 220 + ((i % 5) * 260), y: 200 + (Math.floor(i / 5) * 240), r: 0 };
        });
        sync();
    }

    function confirmerToutEffacer() { document.getElementById('modal-confirm').style.display = 'flex'; }
    function toutEffacer() { pushHistory(); studentData = []; selectedIndex = null; sync(); fermerModale('modal-confirm'); }

function getExportFileName(extension) {
    // RÃ©cupÃ©ration du nom de l'enseignant depuis le localStorage
    // (ClÃ© utilisÃ©e dans maclasse.html pour l'input #nomEnseignant)
    const nomEnregistre = localStorage.getItem('nom_enseignant') || "enseignant";
    
    // Nettoyage du nom : minuscule, remplace espaces par underscores, retire les caractÃ¨res spÃ©ciaux
    const nomPropre = nomEnregistre
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // EnlÃ¨ve les accents
        .replace(/[^a-z0-9]/g, '_') // Remplace tout ce qui n'est pas alphanumÃ©rique par _
        .replace(/_+/g, '_'); // Ã‰vite les doubles underscores
    
    // Date au format AAAAMMJJ
    const maintenant = new Date();
    const dateStr = maintenant.getFullYear() + 
                    String(maintenant.getMonth() + 1).padStart(2, '0') + 
                    String(maintenant.getDate()).padStart(2, '0');
    
    return `outilsprofs_plan_de_la_classe_${nomPropre}_${dateStr}.${extension}`;
}

    function exportPDF() {
        const svg = document.getElementById('plan-svg');
        const { jsPDF } = window.jspdf;
        const svgClone = svg.cloneNode(true);
        const filename = getExportFileName('pdf');
        
        svgClone.querySelectorAll('.desk-label').forEach(label => {
            label.style.fontSize = "45px"; 
        });

        svgClone.style.backgroundColor = "white";
        svgClone.querySelectorAll('.desk-group').forEach(g => g.classList.remove('selected'));
        
        const svgData = new XMLSerializer().serializeToString(svgClone);
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        
        canvas.width = 1800; 
        canvas.height = 1800;
        
        img.onload = function() {
            setTimeout(() => {
                ctx.fillStyle = "white"; 
                ctx.fillRect(0, 0, canvas.width, canvas.height); 
                ctx.drawImage(img, 0, 0);
                
                const pdf = new jsPDF({ 
                    orientation: 'portrait', 
                    unit: 'pt', 
                    format: [1800, 1800] 
                });
                
                pdf.addImage(canvas.toDataURL("image/jpeg", 0.95), 'JPEG', 0, 0, 1500, 1800);

                // --- MODIFICATION ANDROID ---
                const pdfBase64 = pdf.output('datauristring').split(',')[1];
                if (window.Android && window.Android.savePdfFromBase64) {
                    window.Android.savePdfFromBase64(pdfBase64, filename);
                } else {
                    pdf.save(filename);
                }
            }, 100);
        };
        img.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgData);
    }

    function toggleLock() {
        isLocked = !isLocked;
        document.getElementById('btn-mode').textContent = isLocked ? 'ğŸ”’' : 'ğŸ”“';
        document.getElementById('btn-mode').style.background = isLocked ? 'var(--theme-color)' : 'rgba(128,128,128,0.1)';
        document.getElementById('btn-mode').style.color = isLocked ? 'var(--contrast-color)' : 'inherit';
    }

    function exporterPlan() {
        const jsonString = JSON.stringify(studentData);
        const filename = getExportFileName('json');

        // Conversion en Base64 (compatible UTF-8 pour les accents des prÃ©noms)
        const base64Content = btoa(unescape(encodeURIComponent(jsonString)));

        if (window.Android && window.Android.savePdfFromBase64) {
            // On utilise la mÃªme passerelle Android
            window.Android.savePdfFromBase64(base64Content, filename);
        } else {
            // Secours navigateur
            const blob = new Blob([jsonString], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
        }
    }

    function importerPlan() {
        const inp = document.createElement('input'); 
        inp.type = 'file'; 
        inp.accept = '.json';
        
        inp.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const importedData = JSON.parse(ev.target.result);
                    if (Array.isArray(importedData)) {
                        pushHistory();
                        studentData = importedData;
                        selectedIndex = null;
                        sync();
                    } else {
                        alert("Le fichier JSON n'est pas au bon format.");
                    }
                } catch (err) {
                    alert("Erreur lors de la lecture du fichier : " + err.message);
                }
            };
            reader.readAsText(file);
            
            // On retire l'Ã©lÃ©ment aprÃ¨s usage
            inp.remove();
        };
        
        inp.click();
    }

    appliquerCouleursDynamiques();
    drawPlan();
</script>
</body>
</html>