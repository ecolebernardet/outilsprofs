<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mots MÃªlÃ©s - OutilsProfs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        :root {
            --bg-page: #121212; --card-bg: #1e1e1e; --text-main: #ffffff;
            --column-border: rgba(255, 255, 255, 0.1); --input-bg: #2a2a2a;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }

        body.light-mode {
            --bg-page: #eeeeee; --card-bg: #ffffff; --text-main: #111827;
            --column-border: rgba(0, 0, 0, 0.1); --input-bg: #f3f4f6;
            --shadow-custom: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; transition: background 0.3s ease; }
        
        header { 
            background: var(--card-bg); border-bottom: 1px solid var(--column-border);
            position: sticky; top: 0; z-index: 100; display: flex; align-items: center;
            justify-content: space-between; padding: calc(env(safe-area-inset-top) + 10px) 15px 10px 15px; 
            width: 100%; margin-bottom: 12px;
        }

        .ui-btn-round { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 50%; flex-shrink: 0; transition: all 0.2s ease; cursor: pointer; border: none; }
        header h1 { font-size: 1.125rem; font-weight: 900; text-transform: uppercase; text-align: center; flex-grow: 1; }

        .main-wrapper { 
            width: 100%; 
            max-width: 1000px; /* AugmentÃ© lÃ©gÃ¨rement pour laisser de la place au duo grille+mots */
            margin: 0 auto; 
            padding: 10px 15px 40px; 
        }
		
        .light-card { background: var(--card-bg); border-radius: 1.5rem; padding: 20px; border: 1px solid var(--column-border); box-shadow: var(--shadow-custom); margin-bottom: 20px; }
        
        .input-field { background: var(--input-bg); border: 1px solid var(--column-border); border-radius: 0.75rem; padding: 12px; font-size: 0.85rem; font-weight: 700; width: 100%; color: var(--text-main); outline: none; }
        
        .btn-add { width: 100%; padding: 14px; border-radius: 50px; font-weight: 600; font-size: 12px; 
            border: none; cursor: pointer; transition: transform 0.1s; }
        .btn-add:active { transform: scale(0.95); }

        .grid-container {
    position: relative;
    display: flex;         /* Active Flexbox */
    justify-content: center; /* Centre horizontalement */
    align-items: center;     /* Centre verticalement */
    margin: 20px auto;
    width: 100%;
    min-height: 300px;     /* Ajustez selon vos besoins */
    overflow: hidden;      /* Ã‰vite les dÃ©bordements sur petit Ã©cran */
}
		
        #word-grid {
    display: grid;
    gap: 2px;
    z-index: 10;
    pointer-events: auto;
}

        .grid-cell { width: 100%; height: 100%; background: var(--card-bg); display: flex; align-items: center; justify-content: center; font-weight: 800; text-transform: uppercase; position: relative; z-index: 3; cursor: pointer; user-select: none; transition: background 0.2s; }
        .grid-cell.selected { color: white; border-radius: 4px; }

        .word-found { text-decoration: line-through; opacity: 0.3; transition: all 0.3s ease; color: gray !important; }

        #correction-canvas {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Centre parfaitement par rapport au milieu du parent */
    z-index: 5;
    pointer-events: none;
}

        .bottom-nav { width: 100%; max-width: 600px; margin: 20px auto 0; display: flex; flex-direction: column; gap: 8px; }
        .nav-group { display: flex; gap: 8px; width: 100%; }
        .nav-btn { font-weight: 900; border-radius: 50px; font-size: 9px; padding: 12px; border: none; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; }

        .modal-overlay { display: none; position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; border-radius: 1.5rem; border: 1px solid var(--column-border); padding: 25px; position: relative; }
    </style>
</head>
<body>

<script>
    if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
</script>

<header>
    <a href="index.html" id="btn-retour-header" class="ui-btn-round active:scale-90">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
        </svg>
    </a>
    <h1>Mots MÃªlÃ©s</h1>
    <button id="btn-aide" onclick="ouvrirAide()" class="ui-btn-round active:scale-90 text-lg">ğŸ’¡</button>
</header>

<div class="main-wrapper">
    <div class="mb-4">
        <a href="generateurs.html" id="btn-retour-liste" class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-transform active:scale-95 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux gÃ©nÃ©rateurs
        </a>
    </div>
    
    <div id="setup-zone" class="light-card space-y-6">
        <div>
            <label class="block text-[10px] font-black uppercase opacity-50 mb-2 tracking-widest">ThÃ©matiques rapides</label>
            <select id="theme-selector" onchange="appliquerThematique()" class="input-field">
                <option value="">-- Choisir un thÃ¨me --</option>
                <option value="animaux">ğŸ¾ Animaux</option>
                <option value="ecole">ğŸ« Ã‰cole</option>
                <option value="corps">ğŸ‘¤ Corps Humain</option>
                <option value="noel">ğŸ„ NoÃ«l</option>
                <option value="fruits">ğŸ Fruits & LÃ©gumes</option>
                <option value="pays">ğŸŒ Pays</option>
                <option value="sports">âš½ Sports</option>
                <option value="musique">ğŸ¸ Instruments</option>
                <option value="espace">ğŸš€ Espace</option>
                <option value="couleurs">ğŸ¨ Couleurs</option>
                <option value="voiture">ğŸš— Voiture</option>
                <option value="cuisine">ğŸ³ Cuisine</option>
                <option value="metiers">ğŸ‘· MÃ©tiers</option>
                <option value="vetements">ğŸ‘• VÃªtements</option>
                <option value="maison">ğŸ  Maison</option>
                <option value="meteo">â˜ï¸ MÃ©tÃ©o</option>
                <option value="insectes">ğŸ Insectes</option>
                <option value="ocean">ğŸŒŠ OcÃ©an</option>
                <option value="geometrie">ğŸ“ GÃ©omÃ©trie</option>
            </select>
        </div>

        <div>
            <label class="block text-[10px] font-black uppercase opacity-50 mb-2 tracking-widest">Titre de la grille</label>
            <input type="text" id="grid-title" placeholder="Ex: Les Animaux" class="input-field text-left">
        </div>

        <div>
            <div class="flex justify-between items-end mb-2">
                <label class="text-[10px] font-black uppercase opacity-50 tracking-widest">Liste des mots</label>
                <span id="word-count" class="text-[10px] font-black opacity-50">0 MOTS</span>
            </div>
            <textarea id="word-list" rows="4" class="input-field text-left" placeholder="Lion, Tigre, Elephant..."></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-[10px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">Taille (Max 20)</label>
                <input type="number" id="grid-size" value="10" min="5" max="20" class="input-field text-center">
            </div>
            <div>
                <label class="block text-[10px] font-black uppercase opacity-50 mb-1 tracking-widest text-center">DifficultÃ©</label>
                <select id="difficulty" class="input-field">
                    <option value="easy">Facile (H/V Ã  l'endroit)</option>
                    <option value="hard">Difficile (+ Diagonales)</option>
                    <option value="expert">Expert (Toutes directions + Envers)</option>
                </select>
            </div>
        </div>

        <div class="flex flex-col gap-2">
            <button onclick="viderSiRempli()" class="text-[10px] font-black uppercase opacity-40 hover:opacity-100 transition-opacity py-2">
                ğŸ—‘ï¸ Vider le formulaire
            </button>
            <button id="mainAddBtn" onclick="generateWordSearch()" class="btn-add">GÃ©nÃ©rer la grille</button>
            <label class="btn-add bg-black text-white cursor-pointer flex items-center justify-center gap-2 mt-2">
                ğŸ‘‡ charger un fichier .txt ğŸ‘‡
                <input type="file" class="hidden" accept=".txt" onchange="importData(event)">
            </label>
        </div>
    </div>
    
    <div id="game-zone" class="hidden space-y-6">
        <h2 id="display-title" class="text-center font-black uppercase tracking-widest text-xl"></h2>
        
        <div id="game-layout" class="flex flex-col md:flex-row md:items-start md:justify-center gap-8">
            <div class="grid-container !m-0">
                <canvas id="correction-canvas"></canvas>
                <div id="word-grid"></div>
            </div>

            <div id="words-to-find" class="grid grid-cols-3 md:grid-cols-2 gap-x-4 gap-y-1 text-[10px] font-bold opacity-70 w-full md:max-w-[250px]"></div>
        </div>

        <div class="flex flex-col items-center gap-3 mt-10">
            <button id="btn-reveal" onclick="toggleCorrection()" class="flex items-center gap-2 px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest hover:scale-105 transition-transform shadow-md">
                ğŸ‘ï¸ Afficher la correction
            </button>
            <button id="btn-shuffle" onclick="generateWordSearch()" class="flex items-center gap-2 px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest hover:scale-105 transition-transform shadow-md opacity-50">
                ğŸ”„ MÃ©langer la grille
            </button>
        </div>

        <footer class="bottom-nav">
            <div class="nav-group">
                <button onclick="exportToTXT()" class="nav-btn bg-black text-white flex-1">ğŸ‘† sauvegarder .txt ğŸ‘†</button>
                <button onclick="exportToPDF()" class="nav-btn bg-black text-white flex-1">ğŸ“„ Ã©diter .pdf</button>
            </div>
            <button onclick="retourReglages()" class="nav-btn bg-gray-500 text-white shadow-lg text-xs">â¬…ï¸ retour aux rÃ©glages</button>
        </footer>
    </div>
</div>

<div id="modal-aide" class="modal-overlay" onclick="fermerModal('modal-aide')">
    <div class="modal-content !max-w-[450px] max-h-[90vh] overflow-y-auto !p-0 flex flex-col" onclick="event.stopPropagation()">
        <div class="p-6 border-b border-black border-opacity-5 sticky top-0 bg-inherit z-10">
            <h2 class="text-xl font-black uppercase tracking-tighter flex items-center gap-3">
                <span id="aide-emoji">ğŸ’¡</span> <span id="aide-titre-dynamique">Les mots mÃªlÃ©s</span>
            </h2>
        </div>
        <div class="p-6 space-y-6 text-[11px] leading-relaxed opacity-100">
            <div class="space-y-2">
                <p class="font-black uppercase text-[9px] opacity-100 tracking-widest flex items-center gap-2">
                    <span>ğŸ“</span> 1. CrÃ©ation
                </p>
                <p>Saisissez vos mots sÃ©parÃ©s par une <b>virgule</b>, choisissez la taille de la grille et la difficultÃ©, puis cliquez sur <b>GÃ©nÃ©rer</b>.</p>
            </div>

            <div class="space-y-2">
                <p class="font-black uppercase text-[9px] opacity-100 tracking-widest flex items-center gap-2">
                    <span>ğŸ”</span> 2. Recherche
                </p>
                <p>Cliquez sur une lettre pour la <b>surligner</b>. Si vous faites une erreur, cliquez Ã  nouveau sur la lettre pour la <b>dÃ©sÃ©lectionner</b>.</p>
            </div>

            <div class="space-y-2">
                <p class="font-black uppercase text-[9px] opacity-100 tracking-widest flex items-center gap-2">
                    <span>âœ…</span> 3. Progression
                </p>
                <p>Lorsqu'un mot est entiÃ¨rement trouvÃ©, il se <b>barre automatiquement</b> dans la liste situÃ©e sous la grille.</p>
            </div>

            <div class="space-y-2">
                <p class="font-black uppercase text-[9px] opacity-100 tracking-widest flex items-center gap-2">
                    <span>ğŸ†</span> 4. Victoire & Export
                </p>
                <p>Trouvez tous les mots pour gagner ! Vous pouvez aussi <b>exporter votre grille en PDF</b> pour l'imprimer ou en <b>TXT</b> pour la sauvegarder.</p>
            </div>
        </div>
        <div class="p-6 pt-0">
            <button onclick="fermerModal('modal-aide')" id="btn-fermer-aide" class="w-full py-4 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-lg transition-transform active:scale-95">
                C'est compris !
            </button>
        </div>
    </div>
</div>

<div id="modal-bravo" class="modal-overlay" onclick="fermerModal('modal-bravo')">
    <div class="modal-content text-center">
        <div class="text-6xl mb-4">ğŸ†</div>
        <h2 class="text-2xl font-black uppercase mb-2" id="bravo-titre">Bravo !</h2>
        <p class="opacity-70 text-sm mb-6">Vous avez trouvÃ© tous les mots de la grille.</p>
        <button onclick="fermerModal('modal-bravo')" class="btn-add bg-black text-white">Continuer</button>
    </div>
</div>

<script>
    const mapCouleurs = { 'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308', 'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6', 'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1', 'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899', 'rose': '#f43f5e', 'gray': '#6b7280' };
    const themes = {Â animaux: "Lion, Tigre, Elephant, Girafe, Zebre, Singe, Kangourou, Panda, Renard, Loup, Ours, Lapin, tortue, vipere, aigle, moineau, grenouille, sardine", ecole: "Crayon, Cahier, Gomme, Stylo, Maitre, Classe, Bureau, Ardoise, Ecole, Livre, Cartable, Regle, cour, recreation, francais, mathematiques, histoire, geographie, sciences", corps: "Tete, Epaule, Genou, Pied, Main, Bras, Jambe, Doigt, Ventre, Dos, Bouche, Nez, Oreille, Yeux, cheville, coude, cou", noel: "Sapin, Cadeau, Lutin, Traineau, Etoile, Boule, Guirlande, Flocon, Neige, Hotte, Renne, Noel, lumiere, cheminee", fruits: "Pomme, Banane, Fraise, Orange, Poire, Cerise, Raisin, Ananas, Melon, Peche, Kiwi, Citron, abricot, framboise, myrtille, groseille", pays: "France, Italie, Espagne, Belgique, Suisse, Monaco, Andorre, Allemagne, Canada, Japon, Bresil, Maroc, Algerie, Tunisie, Turquie, Chine, Inde, Pakistan, Suede, Norvege, Mexique", sports: "Football, Basket, Tennis, Judo, Natation, Rugby, Karate, Escrime, Boxe, Danse, Yoga, Ski, handball, gymnastique, surf", musique: "Piano, Guitare, Violon, Flute, Trompette, Batterie, Harpe, Saxophone, Orgue, Violoncelle, Tambour", espace: "Soleil, Lune, Terre, Mars, Jupiter, Saturne, Planete, Etoile, Galaxie, Comete, Fusee, Astronaute", couleurs: "Rouge, Bleu, Vert, Jaune, Orange, Violet, Marron, Rose, Blanc, Noir, Gris, Beige", voiture: "Volant, Roue, Vitesse, Pedale, Frein, Porte, Siege, Coffre, Moteur, Embrayage", cuisine: "PoÃªle, Casserole, Couteau, Four, Mixeur, Tablier, Recette, Assiette, Cuillere, Fourchette", metiers: "Docteur, Pompier, Policier, Boulanger, Avocat, Pilote, Facteur, Artiste, Juge, Marin", vetements: "Pantalon, Chemise, Robe, Jupe, Veste, Bonnet, Echarpe, Gants, Chaussette, Chaussure", maison: "Cuisine, Salon, Chambre, Jardin, Fenetre, Escalier, Toiture, Garage, Balcon, Entree", meteo: "Soleil, Nuage, Pluie, Orage, Eclair, Tempete, Brouillard, Neige, Ouragan, Arcenciel", insectes: "Abeille, Fourmi, Mouche, Papillon, Grillon, Cafard, Cigale, GuÃªpe, Libellule, Luciole", ocean: "Baleine, Requin, Dauphin, Tortue, Pieuvre, Corail, Algue, Meduse, Crevette, Etoile", geometrie: "Carre, Cercle, Triangle, Losange, Ovale, Cube, Sphere, Pyramide, Angle, Droite" };

    let finalGrid = [];
    let gridSize = 10;
    let isRevealed = false;
    window.placedWords = [];

    document.getElementById('word-list').addEventListener('input', (e) => {
        const count = e.target.value.split(',').map(w => w.trim()).filter(w => w.length > 0).length;
        document.getElementById('word-count').innerText = `${count} MOTS`;
    });

    function appliquerThematique() {
        const select = document.getElementById('theme-selector');
        const themeKey = select.value;
        if (themeKey && themes[themeKey]) {
            document.getElementById('word-list').value = themes[themeKey];
            document.getElementById('grid-title').value = select.options[select.selectedIndex].text.replace(/^[^\s]+\s/, '');
            document.getElementById('word-count').innerText = `${themes[themeKey].split(',').length} MOTS`;
        }
    }

    function viderSiRempli() {
        if (confirm("Voulez-vous vider le formulaire ?")) {
            document.getElementById('grid-title').value = "";
            document.getElementById('word-list').value = "";
            document.getElementById('grid-size').value = 10;
            document.getElementById('word-count').innerText = "0 MOTS";
        }
    }

    function cleanStringForFilename(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/gi, '');
    }

    function canPlace(word, r, c, dr, dc) {
        const lastR = r + (word.length - 1) * dr;
        const lastC = c + (word.length - 1) * dc;
        if (lastR >= gridSize || lastR < 0 || lastC >= gridSize || lastC < 0) return false;
        for (let i = 0; i < word.length; i++) {
            const current = finalGrid[r + i * dr][c + i * dc];
            if (current !== '' && current.char !== word[i]) return false;
        }
        return true;
    }

    function generateWordSearch() {
        const title = document.getElementById('grid-title').value || "Mots MÃªlÃ©s";
        const rawWords = document.getElementById('word-list').value;
        gridSize = parseInt(document.getElementById('grid-size').value) || 10;
        if (!rawWords.trim()) return;

        const words = rawWords.split(',').map(w => w.trim().toUpperCase()).filter(w => w.length > 0 && w.length <= gridSize).sort(() => Math.random() - 0.5); 
        finalGrid = Array(gridSize).fill().map(() => Array(gridSize).fill(''));
        window.placedWords = [];
        isRevealed = false;
        const wordsActuallyPlaced = [];

        words.forEach(word => {
            let placed = false, attempts = 0;
            const diff = document.getElementById('difficulty').value;
            while (!placed && attempts < 150) {
                let dr = 0, dc = 0;
                if (diff === 'easy') { Math.random() < 0.5 ? dc = 1 : dr = 1; } 
                else if (diff === 'hard') { let r = Math.random(); if (r < 0.33) dc = 1; else if (r < 0.66) dr = 1; else { dr = 1; dc = 1; } } 
                else { const dirs = [[0,1],[0,-1],[1,0],[-1,0],[1,1],[-1,-1],[1,-1],[-1,1]]; const d = dirs[Math.floor(Math.random() * dirs.length)]; dr = d[0]; dc = d[1]; }
                let r = Math.floor(Math.random() * gridSize), c = Math.floor(Math.random() * gridSize);
                if (canPlace(word, r, c, dr, dc)) {
                    for (let i = 0; i < word.length; i++) finalGrid[r + i * dr][c + i * dc] = { char: word[i], isSolution: true };
                    window.placedWords.push({ r1: r, c1: c, r2: r + (word.length - 1) * dr, c2: c + (word.length - 1) * dc });
                    wordsActuallyPlaced.push(word);
                    placed = true;
                }
                attempts++;
            }
        });

        for (let r = 0; r < gridSize; r++) {
            for (let c = 0; c < gridSize; c++) {
                if (finalGrid[r][c] === '') finalGrid[r][c] = { char: String.fromCharCode(65 + Math.floor(Math.random() * 26)), isSolution: false };
            }
        }
        renderGrid(title, wordsActuallyPlaced);
    }

    function renderGrid(title, words) {
        const gridEl = document.getElementById('word-grid');
        const canvas = document.getElementById('correction-canvas');
        
        document.getElementById('setup-zone').classList.add('hidden');
        document.getElementById('game-zone').classList.remove('hidden');

        const isDesktop = window.innerWidth > 768;
        const gap = 2;
        
        // On rÃ©cupÃ¨re la largeur disponible rÃ©elle du parent
        const containerWidth = document.querySelector('.main-wrapper').clientWidth - 40;
        
        // Calcul prÃ©cis : (Largeur totale - espaces entre cellules) / nombre de cellules
        const maxCellSize = Math.floor((containerWidth - (gridSize - 1) * gap) / gridSize);
        
        // On limite la taille sur PC, mais sur mobile on utilise le maximum possible
        const cellSize = isDesktop ? Math.min(42, maxCellSize) : maxCellSize;
        const fontSize = Math.max(10, cellSize * 0.55);
        
        gridEl.style.gridTemplateColumns = `repeat(${gridSize}, ${cellSize}px)`;
        gridEl.style.gap = `${gap}px`; // On s'assure que le gap est bien appliquÃ©
        
        gridEl.innerHTML = finalGrid.flat().map(obj => 
            `<div class="grid-cell" onclick="toggleCell(this)" data-sol="${obj.isSolution}" style="font-size: ${fontSize}px; width:${cellSize}px; height:${cellSize}px;">${obj.char}</div>`
        ).join('');
        
        // Calcul du total pour le canvas de correction
        const totalSize = (gridSize * cellSize) + ((gridSize - 1) * gap);
        canvas.width = totalSize; 
        canvas.height = totalSize;
        
        document.getElementById('display-title').innerText = title;

        const sortedWords = words.sort((a, b) => a.localeCompare(b, 'fr'));
        const nbMots = sortedWords.length;
        const nbCols = isDesktop ? 2 : 3;
        const nbParCol = Math.ceil(nbMots / nbCols);
        
        let htmlWords = '';
        for (let i = 0; i < nbParCol; i++) {
            for (let j = 0; j < nbCols; j++) {
                const index = i + (j * nbParCol);
                if (index < nbMots) htmlWords += `<span class="truncate">â€¢ ${sortedWords[index]}</span>`;
                else htmlWords += `<span></span>`; 
            }
        }
        document.getElementById('words-to-find').innerHTML = htmlWords;
        
        document.getElementById('btn-reveal').innerHTML = "ğŸ‘ï¸ Afficher la correction";
        appliquerTheme();
    }

    function toggleCell(cell) {
        if (isRevealed) return;
        cell.classList.toggle('selected');
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const hexa = mapCouleurs[themePrefs.gen || 'cyan'];
        cell.style.backgroundColor = cell.classList.contains('selected') ? hexa : "";
        checkVictory();
    }

    function checkVictory() {
        const wordSpans = document.querySelectorAll('#words-to-find span');
        const selectedCells = Array.from(document.querySelectorAll('.grid-cell.selected'));
        const selectedCoords = selectedCells.map(cell => {
            const index = Array.from(cell.parentNode.children).indexOf(cell);
            return { r: Math.floor(index / gridSize), c: index % gridSize };
        });

        window.placedWords.forEach((wordObj) => {
            const dr = wordObj.r2 === wordObj.r1 ? 0 : (wordObj.r2 > wordObj.r1 ? 1 : -1);
            const dc = wordObj.c2 === wordObj.c1 ? 0 : (wordObj.c2 > wordObj.c1 ? 1 : -1);
            const len = Math.max(Math.abs(wordObj.r2 - wordObj.r1), Math.abs(wordObj.c2 - wordObj.c1)) + 1;
            let allLettersSelected = true;
            let wordString = "";
            for(let i=0; i<len; i++) {
                const currR = wordObj.r1 + (i * dr); const currC = wordObj.c1 + (i * dc);
                wordString += finalGrid[currR][currC].char;
                if (!selectedCoords.some(cp => cp.r === currR && cp.c === currC)) allLettersSelected = false;
            }
            wordSpans.forEach(span => {
                const cleanSpanText = span.innerText.replace('â€¢ ', '').trim();
                if (cleanSpanText === wordString) span.classList.toggle('word-found', allLettersSelected);
            });
        });

        const solCells = document.querySelectorAll('.grid-cell[data-sol="true"]');
        const selSolCells = document.querySelectorAll('.grid-cell.selected[data-sol="true"]');
        const wrongCells = document.querySelectorAll('.grid-cell.selected[data-sol="false"]');
        if (solCells.length > 0 && solCells.length === selSolCells.length && wrongCells.length === 0) {
            const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
            document.getElementById('bravo-titre').style.color = mapCouleurs[themePrefs.gen || 'cyan'];
            document.getElementById('modal-bravo').style.display = 'flex';
        }
    }

    function toggleCorrection() {
        const canvas = document.getElementById('correction-canvas');
        const ctx = canvas.getContext('2d');
        const btn = document.getElementById('btn-reveal');
        const cells = document.querySelectorAll('.grid-cell');
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const hexa = mapCouleurs[themePrefs.gen || 'cyan'];
        const cellSize = parseFloat(cells[0].style.width);
        const gap = 2;
        isRevealed = !isRevealed;

        if (isRevealed) {
            btn.innerHTML = "ğŸ™ˆ Cacher la correction";
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = hexa; ctx.lineWidth = cellSize * 0.8; ctx.lineCap = "round"; ctx.globalAlpha = 0.5;
            window.placedWords.forEach(w => {
                const x1 = gap + w.c1 * (cellSize + gap) + cellSize/2; const y1 = gap + w.r1 * (cellSize + gap) + cellSize/2;
                const x2 = gap + w.c2 * (cellSize + gap) + cellSize/2; const y2 = gap + w.r2 * (cellSize + gap) + cellSize/2;
                ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
            });
            cells.forEach(c => c.style.background = "transparent");
        } else {
            btn.innerHTML = "ğŸ‘ï¸ Afficher la correction";
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            cells.forEach(c => c.style.backgroundColor = c.classList.contains('selected') ? hexa : "");
        }
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // --- GESTION DE LA DATE ET DU NOM DE FICHIER ---
        const maintenant = new Date();
        const yyyy = maintenant.getFullYear();
        const mm = String(maintenant.getMonth() + 1).padStart(2, '0');
        const dd = String(maintenant.getDate()).padStart(2, '0');
        const dateStr = `${yyyy}-${mm}-${dd}`;
        
        const rawTitle = document.getElementById('grid-title').value || "Mots MÃªlÃ©s";
        const nomFichier = `outilsprofs_motsmeles_${cleanStringForFilename(rawTitle)}_${dateStr}.pdf`;
        
        const mots = document.getElementById('word-list').value.split(',').map(w => w.trim().toUpperCase()).filter(w => w.length > 0).sort((a,b)=>a.localeCompare(b,'fr'));
        const cellSize = 8;
        const startX = (210 - (gridSize * cellSize)) / 2;
        const startY = 40;

        const dessinerListeMots = (yDepart) => {
            doc.setTextColor(0).setFont("helvetica", "bold").setFontSize(12).text("Mots Ã  trouver :", startX, yDepart + 15);
            doc.setFont("helvetica", "normal").setFontSize(10);
            const nbParCol = Math.ceil(mots.length / 3);
            mots.forEach((mot, i) => {
                doc.text("â€¢ " + mot, startX + (Math.floor(i / nbParCol) * 50), yDepart + 22 + ((i % nbParCol) * 5));
            });
        };

        // --- PAGE 1 : LA GRILLE VIERGE ---
        doc.setFont("helvetica", "bold").setFontSize(18).text(rawTitle, 105, 20, { align: "center" });
        finalGrid.forEach((row, r) => row.forEach((obj, c) => {
            const x = startX + (c * cellSize), y = startY + (r * cellSize);
            doc.setDrawColor(180).setLineWidth(0.1).rect(x, y, cellSize, cellSize);
            doc.setTextColor(0).setFontSize(11).text(obj.char, x + (cellSize / 2), y + (cellSize / 2) + 1.5, { align: "center" });
        }));
        dessinerListeMots(startY + (gridSize * cellSize));

        // --- PAGE 2 : LA CORRECTION ---
        doc.addPage().setFont("helvetica", "bold").setFontSize(18).text(rawTitle + " (CORRECTION)", 105, 20, { align: "center" });
        
        doc.setGState(new doc.GState({ opacity: 0.3 }));
        doc.setDrawColor(150, 150, 150); 
        doc.setLineCap("round");
        doc.setLineWidth(cellSize - 4); 

        window.placedWords.forEach((w) => {
            const x1 = startX + (w.c1 * cellSize) + (cellSize / 2);
            const y1 = startY + (w.r1 * cellSize) + (cellSize / 2);
            const x2 = startX + (w.c2 * cellSize) + (cellSize / 2);
            const y2 = startY + (w.r2 * cellSize) + (cellSize / 2);
            doc.line(x1, y1, x2, y2);
        });

        doc.setGState(new doc.GState({ opacity: 1 })); 
        finalGrid.forEach((row, r) => row.forEach((obj, c) => {
            const x = startX + (c * cellSize), y = startY + (r * cellSize);
            doc.setDrawColor(200).setLineWidth(0.1).rect(x, y, cellSize, cellSize);
            doc.setTextColor(0).setFont("helvetica", "bold").setFontSize(11);
            doc.text(obj.char, x + (cellSize / 2), y + (cellSize / 2) + 1.5, { align: "center" });
        }));

        dessinerListeMots(startY + (gridSize * cellSize));

        // --- GESTION COMPATIBILITÃ‰ ANDROID / NAVIGATEUR ---
        if (window.Android && window.Android.savePdfFromBase64) {
            const pdfBase64 = doc.output('datauristring').split(',')[1];
            window.Android.savePdfFromBase64(pdfBase64, nomFichier);
        } else {
            doc.save(nomFichier);
        }
    }

    function exportToTXT() {
    const maintenant = new Date();
    const yyyy = maintenant.getFullYear();
    const mm = String(maintenant.getMonth() + 1).padStart(2, '0');
    const dd = String(maintenant.getDate()).padStart(2, '0');
    const dateStr = `${yyyy}-${mm}-${dd}`;

    const rawTitle = document.getElementById('grid-title').value || "grille";
    const nomFichier = `outilsprofs_motsmeles_${cleanStringForFilename(rawTitle)}_${dateStr}.txt`;
    
    const data = { 
        title: rawTitle, 
        words: document.getElementById('word-list').value, 
        size: gridSize, 
        diff: document.getElementById('difficulty').value 
    };
    
    const jsonString = JSON.stringify(data);

    // GESTION ANDROID
    if (window.Android && window.Android.savePdfFromBase64) {
        // On convertit la chaÃ®ne JSON en Base64 via btoa (compatible UTF-8 avec unescape)
        const base64String = btoa(unescape(encodeURIComponent(jsonString)));
        // On rÃ©utilise la mÃªme fonction Android (elle accepte n'importe quel Base64 avec le bon nom de fichier)
        window.Android.savePdfFromBase64(base64String, nomFichier);
    } else {
        // GESTION NAVIGATEUR CLASSIQUE
        const blob = new Blob([jsonString], { type: 'text/plain' });
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob);
        a.download = nomFichier; 
        a.click();
        URL.revokeObjectURL(a.href);
    }
}

    function importData(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                document.getElementById('grid-title').value = d.title || "";
                document.getElementById('word-list').value = d.words || "";
                document.getElementById('grid-size').value = d.size || 10;
                document.getElementById('difficulty').value = d.diff || "easy";
                document.getElementById('word-count').innerText = `${(d.words || "").split(',').filter(w=>w.trim()).length} MOTS`;
                retourReglages();
            } catch(err) { alert("Fichier invalide"); }
        };
        reader.readAsText(event.target.files[0]);
    }

    function appliquerTheme() {
        if (localStorage.getItem('theme_mode') === 'light') document.body.classList.add('light-mode');
        else document.body.classList.remove('light-mode');
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const hexa = mapCouleurs[themePrefs.gen || 'cyan'];
        const contrast = ['yellow', 'lime', 'amber', 'cyan'].includes(themePrefs.gen || 'cyan') ? '#000' : '#fff';
        if (document.getElementById('aide-titre-dynamique')) document.getElementById('aide-titre-dynamique').style.color = hexa;
        if (document.getElementById('btn-fermer-aide')) { document.getElementById('btn-fermer-aide').style.backgroundColor = hexa; document.getElementById('btn-fermer-aide').style.color = contrast; }
        [document.getElementById('btn-retour-header'), document.getElementById('btn-retour-liste'), document.getElementById('btn-aide'), document.getElementById('mainAddBtn'), document.getElementById('btn-shuffle'), document.getElementById('btn-reveal')].forEach(el => {
            if(el) { el.style.backgroundColor = hexa; el.style.color = contrast; }
        });
        document.querySelectorAll('.grid-cell.selected').forEach(el => el.style.backgroundColor = hexa);
    }

    function retourReglages() { document.getElementById('setup-zone').classList.remove('hidden'); document.getElementById('game-zone').classList.add('hidden'); }
    function ouvrirAide() { document.getElementById('modal-aide').style.display = 'flex'; }
    function fermerModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onload = appliquerTheme;
</script>
</body>
</html>